{"version":3,"sources":["webpack:////home/anon/projects/Viewers/extensions/cornerstone/src/utils/formatStudy.js","webpack:////home/anon/projects/Viewers/extensions/cornerstone/src/components/OHIFCornerstoneViewportOverlay.js","webpack:////home/anon/projects/Viewers/extensions/cornerstone/src/ConnectedCornerstoneViewport.js","webpack:////home/anon/projects/Viewers/extensions/cornerstone/src/OHIFCornerstoneViewport.js"],"names":["formatNumberPrecision","number","precision","parseFloat","toFixed","OHIFCornerstoneViewportOverlay","this","props","imageId","scale","windowWidth","windowCenter","inconsistencyWarnings","value","zoomPercentage","seriesMetadata","cornerstone","metaData","get","imagePlaneModule","rows","columns","sliceThickness","sliceLocation","seriesNumber","seriesDescription","generalStudyModule","studyDate","studyTime","studyDescription","patientModule","patientId","patientName","instanceNumber","frameRate","frameTime","compression","generalImageModule","lossyImageCompression","lossyImageCompressionRatio","lossyImageCompressionMethod","getCompression","wwwc","imageDimensions","imageIndex","stackSize","inconsistencyWarningsOn","length","getWarningContent","warningList","Array","isArray","listedWarnings","map","warn","index","key","Fragment","normal","className","name","replace","trim","formatPN","date","strFormat","moment","format","formatDICOMDate","time","formatDICOMTime","placement","overlay","id","classNames","Icon","getWarningInfo","isNaN","PureComponent","PropTypes","isRequired","oneOfType","string","array","OHIF","redux","actions","setViewportActive","setViewportSpecificData","measurements","MeasurementHandlers","onAdded","onRemoved","onModified","MEASUREMENT_ACTION_MAP","added","removed","modified","throttle","event","ConnectedCornerstoneViewport","connect","state","ownProps","dataFromStore","extensions","viewportIndex","isActive","viewports","activeViewportIndex","viewportSpecificData","isPlaying","cine","cineFrameRate","isStackPrefetchEnabled","dispatch","data","onElementEnabled","enabledElement","detail","element","setEnabledElement","plugin","onMeasurementsChanged","action","CornerstoneViewport","StackManager","utils","OHIFCornerstoneViewport","viewportData","studies","StudyInstanceUID","displaySetInstanceUID","SOPInstanceUID","frameIndex","stack","getCornerstoneStack","console","log","clearStacks","Error","study","find","displaySet","displaySets","set","storedStack","findOrCreateStack","Object","assign","currentImageIdIndex","imageIds","findIndex","sopClassUIDs","getViewportData","then","setState","setStateFromProps","prevProps","prevDisplaySet","childrenWithProps","children","child","React","cloneElement","imageIdIndex","onNewImageDebounced","sopInstanceUid","onNewImage","onNewImageDebounceTime","viewportOverlayComponent","customProps","Component","object","node"],"mappings":"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","file":"16.bundle.c6bf83898f1f11034549.js","sourcesContent":["import moment from 'moment';\n\n/**\n * Checks if value is valid.\n *\n * @param {number} value\n * @returns {boolean} is valid.\n */\nfunction isValidNumber(value) {\n  return typeof value === 'number' && !isNaN(value);\n}\n\n/**\n * Formats number precision.\n *\n * @param {number} number\n * @param {number} precision\n * @returns {number} formatted number.\n */\nfunction formatNumberPrecision(number, precision) {\n  if (number !== null) {\n    return parseFloat(number).toFixed(precision);\n  }\n}\n\n/**\n * Formats DICOM date.\n *\n * @param {string} date\n * @param {string} strFormat\n * @returns {string} formatted date.\n */\nfunction formatDICOMDate(date, strFormat = 'MMM D, YYYY') {\n  return moment(date, 'YYYYMMDD').format(strFormat);\n}\n\n/**\n *    DICOM Time is stored as HHmmss.SSS, where:\n *      HH 24 hour time:\n *        m mm        0..59   Minutes\n *        s ss        0..59   Seconds\n *        S SS SSS    0..999  Fractional seconds\n *\n *        Goal: '24:12:12'\n *\n * @param {*} time\n * @param {string} strFormat\n * @returns {string} formatted name.\n */\nfunction formatDICOMTime(time, strFormat = 'HH:mm:ss') {\n  return moment(time, 'HH:mm:ss').format(strFormat);\n}\n\n/**\n * Formats a patient name for display purposes\n *\n * @param {string} name\n * @returns {string} formatted name.\n */\nfunction formatPN(name) {\n  if (!name) {\n    return;\n  }\n\n  // Convert the first ^ to a ', '. String.replace() only affects\n  // the first appearance of the character.\n  const commaBetweenFirstAndLast = name.replace('^', ', ');\n\n  // Replace any remaining '^' characters with spaces\n  const cleaned = commaBetweenFirstAndLast.replace(/\\^/g, ' ');\n\n  // Trim any extraneous whitespace\n  return cleaned.trim();\n}\n\n/**\n * Gets compression type\n *\n * @param {number} imageId\n * @returns {string} comrpession type.\n */\nfunction getCompression(imageId) {\n  const generalImageModule =\n    cornerstone.metaData.get('generalImageModule', imageId) || {};\n  const {\n    lossyImageCompression,\n    lossyImageCompressionRatio,\n    lossyImageCompressionMethod,\n  } = generalImageModule;\n\n  if (lossyImageCompression === '01' && lossyImageCompressionRatio !== '') {\n    const compressionMethod = lossyImageCompressionMethod || 'Lossy: ';\n    const compressionRatio = formatNumberPrecision(\n      lossyImageCompressionRatio,\n      2\n    );\n    return compressionMethod + compressionRatio + ' : 1';\n  }\n\n  return 'Lossless / Uncompressed';\n}\n\nexport { isValidNumber,\n  formatNumberPrecision,\n  formatDICOMDate,\n  formatDICOMTime,\n  formatPN,\n  getCompression\n};\n","import { PureComponent } from 'react';\nimport React from 'react';\nimport PropTypes from 'prop-types';\nimport cornerstone from 'cornerstone-core';\nimport './OHIFCornerstoneViewportOverlay.css';\nimport {\n  isValidNumber,\n  formatNumberPrecision,\n  formatDICOMDate,\n  formatDICOMTime,\n  formatPN,\n  getCompression\n} from '../utils/formatStudy';\nimport classNames from 'classnames';\nimport { Icon } from '@ohif/ui/src/elements/Icon';\nimport { Tooltip } from '@ohif/ui/src/components/tooltip';\nimport { OverlayTrigger } from '@ohif/ui/src/components/overlayTrigger';\n\nclass OHIFCornerstoneViewportOverlay extends PureComponent {\n  static propTypes = {\n    scale: PropTypes.number.isRequired,\n    windowWidth: PropTypes.oneOfType([\n      PropTypes.number.isRequired,\n      PropTypes.string.isRequired,\n    ]),\n    windowCenter: PropTypes.oneOfType([\n      PropTypes.number.isRequired,\n      PropTypes.string.isRequired,\n    ]),\n    imageId: PropTypes.string.isRequired,\n    imageIndex: PropTypes.number.isRequired,\n    stackSize: PropTypes.number.isRequired,\n    inconsistencyWarnings: PropTypes.array.isRequired\n  };\n\n  render() {\n    const { imageId, scale, windowWidth, windowCenter, inconsistencyWarnings } = this.props;\n\n    if (!imageId) {\n      return null;\n    }\n\n    const zoomPercentage = formatNumberPrecision(scale * 100, 0);\n    const seriesMetadata =\n      cornerstone.metaData.get('generalSeriesModule', imageId) || {};\n    const imagePlaneModule =\n      cornerstone.metaData.get('imagePlaneModule', imageId) || {};\n    const { rows, columns, sliceThickness, sliceLocation } = imagePlaneModule;\n    const { seriesNumber, seriesDescription } = seriesMetadata;\n\n    const generalStudyModule =\n      cornerstone.metaData.get('generalStudyModule', imageId) || {};\n    const { studyDate, studyTime, studyDescription } = generalStudyModule;\n\n    const patientModule =\n      cornerstone.metaData.get('patientModule', imageId) || {};\n    const { patientId, patientName } = patientModule;\n\n    const generalImageModule =\n      cornerstone.metaData.get('generalImageModule', imageId) || {};\n    const { instanceNumber } = generalImageModule;\n\n    const cineModule = cornerstone.metaData.get('cineModule', imageId) || {};\n    const { frameTime } = cineModule;\n\n    const frameRate = formatNumberPrecision(1000 / frameTime, 1);\n    const compression = getCompression(imageId);\n    const wwwc = `W: ${\n      windowWidth.toFixed ? windowWidth.toFixed(0) : windowWidth\n    } L: ${windowWidth.toFixed ? windowCenter.toFixed(0) : windowCenter}`;\n    const imageDimensions = `${columns} x ${rows}`;\n\n    const { imageIndex, stackSize } = this.props;\n\n    const inconsistencyWarningsOn = inconsistencyWarnings && inconsistencyWarnings.length !== 0 ? true : false;\n    const getWarningContent = (warningList) => {\n      if (Array.isArray(warningList)) {\n        const listedWarnings = warningList.map((warn, index) => {\n          return <li key={index}>{warn}</li>;\n        });\n\n        return <ol>{listedWarnings}</ol>;\n      } else {\n        return <React.Fragment>{warningList}</React.Fragment>;\n      }\n    };\n\n    const getWarningInfo = (seriesNumber, inconsistencyWarnings) => {\n      return(\n        <React.Fragment>\n        {inconsistencyWarnings.length != 0 ? (\n          <OverlayTrigger\n            key={seriesNumber}\n            placement=\"left\"\n            overlay={\n              <Tooltip\n                placement=\"left\"\n                className=\"in tooltip-warning\"\n                id=\"tooltip-left\"\n              >\n                <div className=\"warningTitle\">Series Inconsistencies</div>\n                <div className=\"warningContent\">{getWarningContent(inconsistencyWarnings)}</div>\n              </Tooltip>\n            }\n          >\n            <div className={classNames('warning')}>\n              <span className=\"warning-icon\">\n                <Icon name=\"exclamation-triangle\" />\n              </span>\n            </div>\n          </OverlayTrigger>\n        ) : (\n          <React.Fragment></React.Fragment>\n          )}\n      </React.Fragment>\n      );\n    };\n\n    const normal = (\n      <React.Fragment>\n        <div className=\"top-left overlay-element\">\n          <div>{formatPN(patientName)}</div>\n          <div>{patientId}</div>\n        </div>\n        <div className=\"top-right overlay-element\">\n          <div>{studyDescription}</div>\n          <div>\n            {formatDICOMDate(studyDate)} {formatDICOMTime(studyTime)}\n          </div>\n        </div>\n        <div className=\"bottom-right overlay-element\">\n          <div>Zoom: {zoomPercentage}%</div>\n          <div>{wwwc}</div>\n          <div className=\"compressionIndicator\">{compression}</div>\n        </div>\n        <div className=\"bottom-left2 warning\">\n          <div>{inconsistencyWarningsOn ? getWarningInfo(seriesNumber, inconsistencyWarnings) : ''}</div>\n        </div>\n        <div className=\"bottom-left overlay-element\">\n          <div>{seriesNumber >= 0 ? `Ser: ${seriesNumber}` : ''}</div>\n          <div>\n            {stackSize > 1\n              ? `Img: ${instanceNumber} ${imageIndex}/${stackSize}`\n              : ''}\n          </div>\n          <div>\n            {frameRate >= 0 ? `${formatNumberPrecision(frameRate, 2)} FPS` : ''}\n            <div>{imageDimensions}</div>\n            <div>\n              {isValidNumber(sliceLocation)\n                ? `Loc: ${formatNumberPrecision(sliceLocation, 2)} mm `\n                : ''}\n              {sliceThickness\n                ? `Thick: ${formatNumberPrecision(sliceThickness, 2)} mm`\n                : ''}\n            </div>\n            <div>{seriesDescription}</div>\n          </div>\n        </div>\n      </React.Fragment>\n    );\n\n    return <div className=\"OHIFCornerstoneViewportOverlay\">{normal}</div>;\n  }\n}\n\nexport default OHIFCornerstoneViewportOverlay;\n","import CornerstoneViewport from 'react-cornerstone-viewport';\nimport OHIF from '@ohif/core';\nimport { connect } from 'react-redux';\nimport throttle from 'lodash.throttle';\nimport { setEnabledElement } from './state';\n\nconst { setViewportActive, setViewportSpecificData } = OHIF.redux.actions;\nconst {\n  onAdded,\n  onRemoved,\n  onModified,\n} = OHIF.measurements.MeasurementHandlers;\n\n// TODO: Transition to enums for the action names so that we can ensure they stay up to date\n// everywhere they're used.\nconst MEASUREMENT_ACTION_MAP = {\n  added: onAdded,\n  removed: onRemoved,\n  modified: throttle(event => {\n    return onModified(event);\n  }, 300),\n};\n\nconst mapStateToProps = (state, ownProps) => {\n  let dataFromStore;\n\n  // TODO: This may not be updated anymore :thinking:\n  if (state.extensions && state.extensions.cornerstone) {\n    dataFromStore = state.extensions.cornerstone;\n  }\n\n  // If this is the active viewport, enable prefetching.\n  const { viewportIndex } = ownProps; //.viewportData;\n  const isActive = viewportIndex === state.viewports.activeViewportIndex;\n  const viewportSpecificData =\n    state.viewports.viewportSpecificData[viewportIndex] || {};\n\n  // CINE\n  let isPlaying = false;\n  let frameRate = 24;\n\n  if (viewportSpecificData && viewportSpecificData.cine) {\n    const cine = viewportSpecificData.cine;\n\n    isPlaying = cine.isPlaying === true;\n    frameRate = cine.cineFrameRate || frameRate;\n  }\n\n  return {\n    // layout: state.viewports.layout,\n    isActive,\n    // TODO: Need a cleaner and more versatile way.\n    // Currently justing using escape hatch + commands\n    // activeTool: activeButton && activeButton.command,\n    ...dataFromStore,\n    isStackPrefetchEnabled: isActive,\n    isPlaying,\n    frameRate,\n    //stack: viewportSpecificData.stack,\n    // viewport: viewportSpecificData.viewport,\n  };\n};\n\nconst mapDispatchToProps = (dispatch, ownProps) => {\n  const { viewportIndex } = ownProps;\n\n  return {\n    setViewportActive: () => {\n      dispatch(setViewportActive(viewportIndex));\n    },\n\n    setViewportSpecificData: data => {\n      dispatch(setViewportSpecificData(viewportIndex, data));\n    },\n\n    /**\n     * Our component \"enables\" the underlying dom element on \"componentDidMount\"\n     * It listens for that event, and then emits the enabledElement. We can grab\n     * a reference to it here, to make playing with cornerstone's native methods\n     * easier.\n     */\n    onElementEnabled: event => {\n      const enabledElement = event.detail.element;\n      setEnabledElement(viewportIndex, enabledElement);\n      dispatch(\n        setViewportSpecificData(viewportIndex, {\n          // TODO: Hack to make sure our plugin info is available from the outset\n          plugin: 'cornerstone',\n        })\n      );\n    },\n\n    onMeasurementsChanged: (event, action) => {\n      return MEASUREMENT_ACTION_MAP[action](event);\n    },\n  };\n};\n\nconst ConnectedCornerstoneViewport = connect(\n  mapStateToProps,\n  mapDispatchToProps\n)(CornerstoneViewport);\n\nexport default ConnectedCornerstoneViewport;\n","import React, { Component } from 'react';\n\nimport OHIFCornerstoneViewportOverlay from './components/OHIFCornerstoneViewportOverlay'\nimport ConnectedCornerstoneViewport from './ConnectedCornerstoneViewport';\nimport OHIF from '@ohif/core';\nimport PropTypes from 'prop-types';\nimport cornerstone from 'cornerstone-core';\n\nconst { StackManager } = OHIF.utils;\n\nclass OHIFCornerstoneViewport extends Component {\n  state = {\n    viewportData: null,\n  };\n\n  static defaultProps = {\n    customProps: {},\n  };\n\n  static propTypes = {\n    studies: PropTypes.object,\n    displaySet: PropTypes.object,\n    viewportIndex: PropTypes.number,\n    children: PropTypes.node,\n    customProps: PropTypes.object,\n  };\n\n  static id = 'OHIFCornerstoneViewport';\n\n  static init() {\n    console.log('OHIFCornerstoneViewport init()');\n  }\n\n  static destroy() {\n    console.log('OHIFCornerstoneViewport destroy()');\n    StackManager.clearStacks();\n  }\n\n  /**\n   * Obtain the CornerstoneTools Stack for the specified display set.\n   *\n   * @param {Object[]} studies\n   * @param {String} StudyInstanceUID\n   * @param {String} displaySetInstanceUID\n   * @param {String} [SOPInstanceUID]\n   * @param {Number} [frameIndex=1]\n   * @return {Object} CornerstoneTools Stack\n   */\n  static getCornerstoneStack(\n    studies,\n    StudyInstanceUID,\n    displaySetInstanceUID,\n    SOPInstanceUID,\n    frameIndex = 0\n  ) {\n    if (!studies || !studies.length) {\n      throw new Error('Studies not provided.');\n    }\n\n    if (!StudyInstanceUID) {\n      throw new Error('StudyInstanceUID not provided.');\n    }\n\n    if (!displaySetInstanceUID) {\n      throw new Error('StudyInstanceUID not provided.');\n    }\n\n    // Create shortcut to displaySet\n    const study = studies.find(\n      study => study.StudyInstanceUID === StudyInstanceUID\n    );\n\n    if (!study) {\n      throw new Error('Study not found.');\n    }\n\n    const displaySet = study.displaySets.find(set => {\n      return set.displaySetInstanceUID === displaySetInstanceUID;\n    });\n\n    if (!displaySet) {\n      throw new Error('Display Set not found.');\n    }\n\n    // Get stack from Stack Manager\n    const storedStack = StackManager.findOrCreateStack(study, displaySet);\n\n    // Clone the stack here so we don't mutate it\n    const stack = Object.assign({}, storedStack);\n    stack.currentImageIdIndex = frameIndex;\n\n    if (SOPInstanceUID) {\n      const index = stack.imageIds.findIndex(imageId => {\n        const imageIdSOPInstanceUID = cornerstone.metaData.get(\n          'SOPInstanceUID',\n          imageId\n        );\n\n        return imageIdSOPInstanceUID === SOPInstanceUID;\n      });\n\n      if (index > -1) {\n        stack.currentImageIdIndex = index;\n      } else {\n        console.warn(\n          'SOPInstanceUID provided was not found in specified DisplaySet'\n        );\n      }\n    }\n\n    return stack;\n  }\n\n  getViewportData = async (\n    studies,\n    StudyInstanceUID,\n    displaySetInstanceUID,\n    SOPInstanceUID,\n    frameIndex\n  ) => {\n    let viewportData;\n\n    const stack = OHIFCornerstoneViewport.getCornerstoneStack(\n      studies,\n      StudyInstanceUID,\n      displaySetInstanceUID,\n      SOPInstanceUID,\n      frameIndex\n    );\n\n    viewportData = {\n      StudyInstanceUID,\n      displaySetInstanceUID,\n      stack,\n    };\n\n    return viewportData;\n  };\n\n  setStateFromProps() {\n    const { studies, displaySet } = this.props.viewportData;\n    const {\n      StudyInstanceUID,\n      displaySetInstanceUID,\n      sopClassUIDs,\n      SOPInstanceUID,\n      frameIndex,\n    } = displaySet;\n\n    if (!StudyInstanceUID || !displaySetInstanceUID) {\n      return;\n    }\n\n    if (sopClassUIDs && sopClassUIDs.length > 1) {\n      console.warn(\n        'More than one SOPClassUID in the same series is not yet supported.'\n      );\n    }\n\n    this.getViewportData(\n      studies,\n      StudyInstanceUID,\n      displaySetInstanceUID,\n      SOPInstanceUID,\n      frameIndex\n    ).then(viewportData => {\n      this.setState({\n        viewportData,\n      });\n    });\n  }\n\n  componentDidMount() {\n    this.setStateFromProps();\n  }\n\n  componentDidUpdate(prevProps) {\n    const { displaySet } = this.props.viewportData;\n    const prevDisplaySet = prevProps.viewportData.displaySet;\n\n    if (\n      displaySet.displaySetInstanceUID !==\n      prevDisplaySet.displaySetInstanceUID ||\n      displaySet.SOPInstanceUID !== prevDisplaySet.SOPInstanceUID ||\n      displaySet.frameIndex !== prevDisplaySet.frameIndex\n    ) {\n      this.setStateFromProps();\n    }\n  }\n\n  render() {\n    let childrenWithProps = null;\n\n    if (!this.state.viewportData) {\n      return null;\n    }\n    const { viewportIndex } = this.props;\n    const { inconsistencyWarnings } = this.props.viewportData.displaySet;\n    const {\n      imageIds,\n      currentImageIdIndex,\n      // If this comes from the instance, would be a better default\n      // `FrameTime` in the instance\n      // frameRate = 0,\n    } = this.state.viewportData.stack;\n\n    // TODO: Does it make more sense to use Context?\n    if (this.props.children && this.props.children.length) {\n      childrenWithProps = this.props.children.map((child, index) => {\n        return (\n          child &&\n          React.cloneElement(child, {\n            viewportIndex: this.props.viewportIndex,\n            key: index,\n          })\n        );\n      });\n    }\n\n    const newImageHandler = ({ currentImageIdIndex, sopInstanceUid }) => {\n      const { displaySet } = this.props.viewportData;\n      const { StudyInstanceUID } = displaySet;\n\n      if (currentImageIdIndex >= 0) {\n        this.props.onNewImage({\n          StudyInstanceUID,\n          SOPInstanceUID: sopInstanceUid,\n          frameIndex: currentImageIdIndex,\n          activeViewportIndex: viewportIndex,\n        });\n      }\n    };\n\n    const warningsOverlay = props => {\n      return <OHIFCornerstoneViewportOverlay {...props} inconsistencyWarnings={inconsistencyWarnings} />\n    };\n\n    return (\n      <>\n        <ConnectedCornerstoneViewport\n          viewportIndex={viewportIndex}\n          imageIds={imageIds}\n          imageIdIndex={currentImageIdIndex}\n          onNewImageDebounced={newImageHandler}\n          onNewImageDebounceTime={300}\n          viewportOverlayComponent={warningsOverlay}\n          // ~~ Connected (From REDUX)\n          // frameRate={frameRate}\n          // isPlaying={false}\n          // isStackPrefetchEnabled={true}\n          // onElementEnabled={() => {}}\n          // setViewportActive{() => {}}\n          {...this.props.customProps}\n        />\n        {childrenWithProps}\n      </>\n    );\n  }\n}\n\nexport default OHIFCornerstoneViewport;\n"],"sourceRoot":""}