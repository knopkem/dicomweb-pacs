"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[236],{1904:(e,t,n)=>{n.d(t,{A:()=>i});const i=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]]},55965:(e,t,n)=>{n.r(t),n.d(t,{COLOR_LUT:()=>i.A});var i=n(1904)},40233:(e,t,n)=>{n.r(t),n.d(t,{hideElementCursor:()=>l,initElementCursor:()=>a,resetElementCursor:()=>r,setElementCursor:()=>s});var i=n(32916);const o=Symbol("ElementCursorsMap");function a(e,t){d(e)[0]=t,s(e,t)}function s(e,t){const n=d(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof i.MouseCursor?t:i.MouseCursor.getDefinedCursor("auto")).getStyleProperty()}function r(e){s(e,d(e)[1])}function l(e){s(e,i.MouseCursor.getDefinedCursor("none"))}function d(e){let t=d[o];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(d,o,{value:t}));let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}},32916:(e,t,n)=>{n.r(t),n.d(t,{CursorNames:()=>M,CursorSVG:()=>f,ImageMouseCursor:()=>d,MouseCursor:()=>a,SVGMouseCursor:()=>D,elementCursor:()=>R,registerCursor:()=>I,setCursorForElement:()=>O});const i=Symbol("DefinedCursors"),o=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class a{constructor(e,t){this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){const{fallback:t}=this;return t instanceof a?`${e}, ${t.getStyleProperty()}`:e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){const t=s(a,i);let n=t.get(e);return n instanceof a?n:o.has(e)?(n=new a(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){if(t instanceof a){return s(a,i).set(e,t),!0}return!1}}function s(e,t){let n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}const r=o.values();var l=n(92136);class d extends a{constructor(e,t,n,i,o){super(i||d.getUniqueInstanceName("image-cursor"),o),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}getStyleProperty(){const{url:e,x:t,y:n}=this;let i=`url('${e}')`;return t>=0&&n>=0&&(t>0||n>0)&&(i+=` ${t} ${n}`),this.addFallbackStyleProperty(i)}static getUniqueInstanceName(e){return`${e}-${l.utilities.getRuntimeId(d)}`}}var c=n(84901);const h={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},g={x:127,y:60},u='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',m='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',v='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',p='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',E='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',f={Angle:w(h,{iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:w(h,{iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:w(h,{iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:w(h,{iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:w(h,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:w(h,{iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:w(h,{iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:w(h,{iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:w(h,{iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Probe:w(h,{iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:w(h,{iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:w(h,{iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:w(h,{iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:w(h,{iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:w(h,{iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:w(h,{iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:w(h,{iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:w(h,{iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:w(h,{iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:w(h,{iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:w(h,{iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:w(h,{iconContent:`${v} ${u}`,viewBox:g}),SegmentationFreeHandFillInside:w(h,{iconContent:`${v} ${m}`,viewBox:g}),SegmentationFreeHandEraseOutside:w(h,{iconContent:`${v} ${u}`,viewBox:g}),SegmentationFreeHandFillOutside:w(h,{iconContent:`${v} ${m}`,viewBox:g}),SegmentationRectangleEraseInside:w(h,{iconContent:`${p} ${u}`,viewBox:g}),RectangleScissor:w(h,{iconContent:`${p} ${m}`,viewBox:g}),"RectangleScissor.FILL_INSIDE":w(h,{iconContent:`${p} ${m}`,viewBox:g}),"RectangleScissor.FILL_OUTSIDE":w(h,{iconContent:`${p} ${m}`,viewBox:g}),"RectangleScissor.ERASE_OUTSIDE":w(h,{iconContent:`${p} ${u}`,viewBox:g}),"RectangleScissor.ERASE_INSIDE":w(h,{iconContent:`${p} ${u}`,viewBox:g}),CircleScissor:w(h,{iconContent:`${E} ${m}`,viewBox:g}),"CircleScissor.FILL_INSIDE":w(h,{iconContent:`${E} ${m}`,viewBox:g}),"CircleScissor.ERASE_OUTSIDE":w(h,{iconContent:`${E} ${u}`,viewBox:g}),"CircleScissor.FILL_OUTSIDE":w(h,{iconContent:`${E} ${m}`,viewBox:g})};function w(e,t){return Object.assign(Object.create(e),t)}function I(e,t,n){f[e]=w(h,{iconContent:t,viewBox:n})}const C=Object.keys(f);var T=n(28664);const _=c.AnnotationStyleStates.Highlighted,S=c.ToolModes.Active;class D extends d{constructor(e,t,n,i,o){super(e,t,n,i,o)}static getDefinedCursor(e,t=!1,n){n||(n=(0,T.h)("color",{},_,S));const i=function(e,t,n){const i=t?"pointer":"cursor";return`${i}:${e}/${n}`}(e,t,n);let o=super.getDefinedCursor(i);if(!o){const a=function(e){return f[e]}(e);a&&(o=function(e,t,n,i,o){const{x:a,y:s}=e.mousePoint;return new D(function(e,t,n){return URL.createObjectURL(function(e,t,n){const i=(t?y:b)(e,n);return new Blob([i],{type:"image/svg+xml"})}(e,t,n))}(e,n,{color:i}),a,s,t,o)}(a,i,t,n,super.getDefinedCursor("default")),super.setDefinedCursor(i,o))}return o}}function A(e,t){const n=Object(t),i=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,((e,t)=>i(t)?n[t]+"":""))}function b(e,t){const{iconContent:n,iconSize:i,viewBox:o}=e;return A(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${i}" height="${i}" viewBox="0 0\n      ${o.x} ${o.y}">\n      ${n}\n    </svg>`,t)}function y(e,t){const{iconContent:n,iconSize:i,viewBox:o,mousePointerGroupString:a}=e,s=16+i;return A(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${s}" height="${s}" viewBox="0 0 ${s} ${s}">\n      <g>${a}</g>\n      <g transform="translate(16, 16) scale(${i/Math.max(o.x,o.y,1)})">${n}</g>\n    </svg>`,t)}var R=n(40233);const O=function(e,t){let n=D.getDefinedCursor(t,!0);n||(n=a.getDefinedCursor(t)),n||(console.log(`Cursor ${t} is not defined either as SVG or as a standard cursor.`),n=a.getDefinedCursor(t)),(0,R.setElementCursor)(e,n)},M=[...C,...r]},2746:(e,t,n)=>{n.r(t),n.d(t,{draw:()=>i.A,drawArrow:()=>T,drawCircle:()=>r,drawEllipse:()=>d,drawEllipseByCoordinates:()=>l,drawHandle:()=>c,drawHandles:()=>h,drawLine:()=>g,drawLinkedTextBox:()=>I,drawPath:()=>m,drawPolyline:()=>u,drawRect:()=>C,drawRedactionRect:()=>_,drawTextBox:()=>E,setAttributesIfNecessary:()=>a,setNewAttributesIfValid:()=>s});var i=n(79697);const o=function(e,t,n){return`${e}::${t}::${n}`};const a=function(e,t){Object.keys(e).forEach((n=>{const i=t.getAttribute(n),o=e[n];void 0===o||""===o?t.removeAttribute(n):i!==o&&t.setAttribute(n,o)}))};const s=function(e,t){Object.keys(e).forEach((n=>{const i=e[n];void 0!==i&&""!==i&&t.setAttribute(n,i)}))};const r=function(e,t,n,i,r,l={},d=""){const{color:c,fill:h,width:g,lineWidth:u,lineDash:m,fillOpacity:v,strokeOpacity:p}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},l),E=u||g,f=o(t,"circle",n),w=e.getSvgNode(f),I={cx:`${i[0]}`,cy:`${i[1]}`,r:`${r}`,stroke:c,fill:h,"stroke-width":E,"stroke-dasharray":m,"fill-opacity":v,"stroke-opacity":p};if(w)a(I,w),e.setNodeTouched(f);else{const t=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==d&&t.setAttribute("data-id",d),s(I,t),e.appendNode(t,f)}};const l=function(e,t,n,i,r={},l=""){const{color:d,width:c,lineWidth:h,lineDash:g}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},r),u=h||c,m=o(t,"ellipse",n),v=e.getSvgNode(m),[p,E,f,w]=i,I=Math.hypot(f[0]-w[0],f[1]-w[1]),C=Math.hypot(E[0]-p[0],E[1]-p[1]),T=180*Math.atan2(f[1]-w[1],f[0]-w[0])/Math.PI,_=[(f[0]+w[0])/2,(E[1]+p[1])/2],S={cx:`${_[0]}`,cy:`${_[1]}`,rx:`${I/2}`,ry:`${C/2}`,stroke:d,fill:"transparent",transform:`rotate(${T} ${_[0]} ${_[1]})`,"stroke-width":u,"stroke-dasharray":g};if(v)a(S,v),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==l&&t.setAttribute("data-id",l),s(S,t),e.appendNode(t,m)}};const d=function(e,t,n,i,o,a={},s=""){const r=[(i[0]+o[0])/2,i[1]],d=[(i[0]+o[0])/2,o[1]],c=[i[0],(i[1]+o[1])/2],h=[o[0],(i[1]+o[1])/2];l(e,t,n,[d,r,c,h],{},"")};const c=function(e,t,n,i,r={},l){const{color:d,handleRadius:c,width:h,lineWidth:g,fill:u,type:m,opacity:v}=Object.assign({color:"rgb(0, 255, 0)",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},r),p=g||h,E=o(t,"handle",`hg-${n}-index-${l}`);let f;if("circle"===m)f={cx:`${i[0]}`,cy:`${i[1]}`,r:c,stroke:d,fill:u,"stroke-width":p,opacity:v};else{if("rect"!==m)throw new Error(`Unsupported handle type: ${m}`);{const e=1.5*parseFloat(c);f={x:`${i[0]-.5*e}`,y:`${i[1]-.5*e}`,width:`${e}`,height:`${e}`,stroke:d,fill:u,"stroke-width":p,rx:""+.1*e,opacity:v}}}const w=e.getSvgNode(E);if(w)a(f,w),e.setNodeTouched(E);else{const t=document.createElementNS("http://www.w3.org/2000/svg",m);s(f,t),e.appendNode(t,E)}};const h=function(e,t,n,i,o={}){i.forEach(((i,a)=>{c(e,t,n,i,o,a)}))};function g(e,t,n,i,r,l={},d=""){if(isNaN(i[0])||isNaN(i[1])||isNaN(r[0])||isNaN(r[1]))return;const{color:c,width:h,lineWidth:g,lineDash:u,shadow:m}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},l),v=g||h,p=o(t,"line",n),E=e.getSvgNode(p),f=m?`filter:url(#shadow-${e.svgLayerElement.id});`:"",w={x1:`${i[0]}`,y1:`${i[1]}`,x2:`${r[0]}`,y2:`${r[1]}`,stroke:c,style:f,"stroke-width":v,"stroke-dasharray":u};if(E)a(w,E),e.setNodeTouched(p);else{const t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==d&&t.setAttribute("data-id",d),s(w,t),e.appendNode(t,p)}}function u(e,t,n,i,r){if(i.length<2)return;const{color:l="rgb(0, 255, 0)",width:d=10,fillColor:c="none",fillOpacity:h=0,lineWidth:g,lineDash:u,closePath:m=!1}=r,v=g||d,p=o(t,"polyline",n),E=e.getSvgNode(p);let f="";for(const e of i)f+=`${e[0].toFixed(1)}, ${e[1].toFixed(1)} `;if(m){const e=i[0];f+=`${e[0]}, ${e[1]}`}const w={points:f,stroke:l,fill:c,"fill-opacity":h,"stroke-width":v,"stroke-dasharray":u};if(E)a(w,E),e.setNodeTouched(p);else{const t=document.createElementNS("http://www.w3.org/2000/svg","polyline");s(w,t),e.appendNode(t,p)}}function m(e,t,n,i,r){const l=i.length&&i[0].length&&Array.isArray(i[0][0])?i:[i],{color:d="rgb(0, 255, 0)",width:c=10,fillColor:h="none",fillOpacity:g=0,lineWidth:u,lineDash:m,closePath:v=!1}=r,p=u||c,E=o(t,"path",n),f=e.getSvgNode(E);let w="";for(let e=0,t=l.length;e<t;e++){const t=l[e],n=t.length;if(!(n<2)){for(let e=0;e<n;e++){const n=t[e];w+=`${e?"L":"M"} ${n[0].toFixed(1)}, ${n[1].toFixed(1)} `}v&&(w+="Z ")}}if(!w)return;const I={d:w,stroke:d,fill:h,"fill-opacity":g,"stroke-width":p,"stroke-dasharray":m};if(f)a(I,f),e.setNodeTouched(E);else{const t=document.createElementNS("http://www.w3.org/2000/svg","path");s(I,t),e.appendNode(t,E)}}function v(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function p(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||(n=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.setAttribute("class","background"),e.insertBefore(n,e.firstChild));const i=e.getBBox(),o={x:`${i.x}`,y:`${i.y}`,width:`${i.width}`,height:`${i.height}`,fill:t};return a(o,n),i}const E=function(e,t,n,i,s,r={}){return function(e,t,n,i=[""],s,r){const{padding:l,color:d,fontFamily:c,fontSize:h,background:g}=r;let u;const[m,E]=[s[0]+l,s[1]+l],f="http://www.w3.org/2000/svg",w=o(t,"text",n),I=e.getSvgNode(w);if(I){const t=I.querySelector("text"),n=Array.from(t.children);for(let e=0;e<n.length;e++){const t=n[e],o=i[e]||"";t.textContent=o}if(i.length>n.length){for(let e=0;e<i.length-n.length;e++){const o=v(i[e+n.length]);t.appendChild(o)}I.appendChild(t),e.appendNode(I,w)}const o={transform:`translate(${m} ${E})`};a({fill:d,"font-size":h,"font-family":c},t),a(o,I),u=p(I,g),e.setNodeTouched(w)}else{const t=document.createElementNS(f,"g");t.setAttribute("transform",`translate(${m} ${E})`);const n=function(e,t){const{color:n,fontFamily:i,fontSize:o}=t,a="http://www.w3.org/2000/svg",s=document.createElementNS(a,"text"),r="user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);",l=`filter:url(#shadow-${e.svgLayerElement.id});`,d=`${r}${l}`;return s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("fill",n),s.setAttribute("font-family",i),s.setAttribute("font-size",o),s.setAttribute("style",d),s}(e,r);for(let e=0;e<i.length;e++){const t=v(i[e]);n.appendChild(t)}t.appendChild(n),e.appendNode(t,w),u=p(t,g)}return Object.assign({},u,{x:m,y:E,height:u.height+l,width:u.width+l})}(e,t,n,i,s,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},r))};var f=n(87658);const w=function(e,t,n,i,o,a,s={}){const r=i.length>0?(0,f.A)(i,o):o,l=function(e){const{x:t,y:n,height:i,width:o}=e,a=o/2,s=i/2;return[[t+a,n],[t,n+s],[t+a,n+i],[t+o,n+s]]}(a);g(e,t,`link-${n}`,r,(0,f.A)(l,r),Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},s))};const I=function(e,t,n,i,o,a,s,r={}){const l=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},r),d=E(e,t,n,i,o,l);return w(e,t,n,a,o,d,l),d};function C(e,t,n,i,r,l={},d=""){const{color:c,width:h,lineWidth:g,lineDash:u}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},l),m=g||h,v=o(t,"rect",n),p=e.getSvgNode(v),E=[Math.min(i[0],r[0]),Math.min(i[1],r[1])],f=Math.abs(i[0]-r[0]),w=Math.abs(i[1]-r[1]),I={x:`${E[0]}`,y:`${E[1]}`,width:`${f}`,height:`${w}`,stroke:c,fill:"transparent","stroke-width":m,"stroke-dasharray":u};if(p)a(I,p),e.setNodeTouched(v);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==d&&t.setAttribute("data-id",d),s(I,t),e.appendNode(t,v)}}function T(e,t,n,i,o,a={}){if(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))return;const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a);g(e,t,n,i,o,{color:s,width:r,lineWidth:l,lineDash:d});const c=Math.atan2(o[1]-i[1],o[0]-i[0]),h={start:[o[0]-10*Math.cos(c-Math.PI/7),o[1]-10*Math.sin(c-Math.PI/7)],end:o},u={start:[o[0]-10*Math.cos(c+Math.PI/7),o[1]-10*Math.sin(c+Math.PI/7)],end:o};g(e,t,"2",h.start,h.end,{color:s,width:r,lineWidth:l}),g(e,t,"3",u.start,u.end,{color:s,width:r,lineWidth:l})}function _(e,t,n,i,r,l={}){const{color:d,width:c,lineWidth:h,lineDash:g}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},l),u=h||c,m=o(t,"rect",n),v=e.getSvgNode(m),p=[Math.min(i[0],r[0]),Math.min(i[1],r[1])],E=Math.abs(i[0]-r[0]),f=Math.abs(i[1]-r[1]),w={x:`${p[0]}`,y:`${p[1]}`,width:`${E}`,height:`${f}`,stroke:d,fill:"black","stroke-width":u,"stroke-dasharray":g};if(v)a(w,v),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");s(w,t),e.appendNode(t,m)}}},42111:(e,t,n)=>{var i;n.d(t,{A:()=>o}),function(e){e.Interaction="Interaction",e.HandlesUpdated="HandlesUpdated",e.StatsUpdated="StatsUpdated",e.InitialSetup="InitialSetup",e.Completed="Completed",e.InterpolationUpdated="InterpolationUpdated"}(i||(i={}));const o=i},28117:(e,t,n)=>{var i;n.d(t,{A:()=>o}),function(e){e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.TOOLGROUP_VIEWPORT_ADDED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_ADDED",e.TOOLGROUP_VIEWPORT_REMOVED="CORNERSTONE_TOOLS_TOOLGROUP_VIEWPORT_REMOVED",e.TOOL_MODE_CHANGED="CORNERSTONE_TOOLS_TOOL_MODE_CHANGED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_INTERPOLATION_PROCESS_COMPLETED",e.INTERPOLATED_ANNOTATIONS_REMOVED="CORNERSTONE_TOOLS_INTERPOLATED_ANNOTATIONS_REMOVED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE"}(i||(i={}));const o=i},83946:(e,t,n)=>{var i;n.d(t,{A:()=>o}),function(e){e.Labelmap="LABELMAP",e.Contour="CONTOUR",e.Surface="SURFACE"}(i||(i={}));const o=i},75117:(e,t,n)=>{var i;n.d(t,{A:()=>o}),function(e){e.OnInteractionStart="onInteractionStart",e.OnInteractionEnd="onInteractionEnd",e.Preview="preview",e.RejectPreview="rejectPreview",e.AcceptPreview="acceptPreview",e.Fill="fill",e.StrategyFunction="strategyFunction",e.CreateIsInThreshold="createIsInThreshold",e.Initialize="initialize",e.INTERNAL_setValue="setValue",e.ComputeInnerCircleRadius="computeInnerCircleRadius"}(i||(i={}));const o=i},79825:(e,t,n)=>{var i;n.d(t,{H:()=>i}),function(e){e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT"}(i||(i={}))},84901:(e,t,n)=>{var i,o;n.r(t),n.d(t,{AnnotationStyleStates:()=>r,ChangeTypes:()=>u.A,Events:()=>d.A,KeyboardBindings:()=>o,MouseBindings:()=>i,SegmentationRepresentations:()=>c.A,StrategyCallbacks:()=>g.A,Swipe:()=>h.H,ToolModes:()=>s.A,WorkerTypes:()=>m}),function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button"}(i||(i={})),function(e){e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta"}(o||(o={}));var a,s=n(12468);!function(e){e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e.AutoGenerated="AutoGenerated"}(a||(a={}));const r=a;var l,d=n(28117),c=n(83946),h=n(79825),g=n(75117),u=n(42111);!function(e){e.POLYSEG_CONTOUR_TO_LABELMAP="polySeg/convertContourToVolumeLabelmap",e.POLYSEG_SURFACE_TO_LABELMAP="polySeg/convertSurfacesToVolumeLabelmap",e.POLYSEG_CONTOUR_TO_SURFACE="polySeg/convertContourToSurface",e.POLYSEG_LABELMAP_TO_SURFACE="polySeg/convertLabelmapToSurface",e.SURFACE_CLIPPING="surfaceClipping"}(l||(l={}));const m=l},44926:(e,t,n)=>{n.d(t,{dj:()=>b,aB:()=>f,In:()=>s,z5:()=>_,V$:()=>h,n6:()=>d,$m:()=>D});var i=n(92136),o=n(6805);const a=function(e){(0,o.Ay)(e.detail.element)},s={enable:function(e){e.addEventListener(i.Enums.Events.IMAGE_RENDERED,a)},disable:function(e){e.removeEventListener(i.Enums.Events.IMAGE_RENDERED,a)}};var r=n(28117),l=n(39375);const d={enable:function(e){e.addEventListener(r.A.MOUSE_CLICK,l.q_),e.addEventListener(r.A.MOUSE_DOWN,l.cT),e.addEventListener(r.A.MOUSE_DOWN_ACTIVATE,l.Xd),e.addEventListener(r.A.MOUSE_DOUBLE_CLICK,l.LM),e.addEventListener(r.A.MOUSE_DRAG,l.al),e.addEventListener(r.A.MOUSE_MOVE,l.tG),e.addEventListener(r.A.MOUSE_UP,l.Je),e.addEventListener(r.A.MOUSE_WHEEL,l.rO)},disable:function(e){e.removeEventListener(r.A.MOUSE_CLICK,l.q_),e.removeEventListener(r.A.MOUSE_DOWN,l.cT),e.removeEventListener(r.A.MOUSE_DOWN_ACTIVATE,l.Xd),e.removeEventListener(r.A.MOUSE_DOUBLE_CLICK,l.LM),e.removeEventListener(r.A.MOUSE_DRAG,l.al),e.removeEventListener(r.A.MOUSE_MOVE,l.tG),e.removeEventListener(r.A.MOUSE_UP,l.Je),e.removeEventListener(r.A.MOUSE_WHEEL,l.rO)}};var c=n(93858);const h={enable:function(e){e.addEventListener(r.A.KEY_DOWN,c.u),e.addEventListener(r.A.KEY_UP,c.L)},disable:function(e){e.removeEventListener(r.A.KEY_DOWN,c.u),e.removeEventListener(r.A.KEY_UP,c.L)}};var g=n(84901),u=n(31437);const{Active:m,Passive:v,Enabled:p}=g.ToolModes,E=function(e){(0,u.A)(e,[m,v,p]).forEach((t=>{t.onCameraModified&&t.onCameraModified(e)}))},f={enable:function(e){e.addEventListener(i.Enums.Events.CAMERA_MODIFIED,E)},disable:function(e){e.removeEventListener(i.Enums.Events.CAMERA_MODIFIED,E)}},{Active:w,Passive:I,Enabled:C}=g.ToolModes,T=function(e){(0,u.A)(e,[w,I,C]).forEach((t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)}))},_={enable:function(e){e.addEventListener(i.Enums.Events.IMAGE_SPACING_CALIBRATED,T)},disable:function(e){e.removeEventListener(i.Enums.Events.IMAGE_SPACING_CALIBRATED,T)}};var S=n(50734);const D={enable:function(e){e.addEventListener(r.A.TOUCH_START,S.gX),e.addEventListener(r.A.TOUCH_START_ACTIVATE,S.$F),e.addEventListener(r.A.TOUCH_DRAG,S.Oz),e.addEventListener(r.A.TOUCH_END,S.ls),e.addEventListener(r.A.TOUCH_TAP,S.lI),e.addEventListener(r.A.TOUCH_PRESS,S.x5)},disable:function(e){e.removeEventListener(r.A.TOUCH_START,S.gX),e.removeEventListener(r.A.TOUCH_START_ACTIVATE,S.$F),e.removeEventListener(r.A.TOUCH_DRAG,S.Oz),e.removeEventListener(r.A.TOUCH_END,S.ls),e.removeEventListener(r.A.TOUCH_PRESS,S.x5)}};var A=n(33836);const b={enable:function(){i.eventTarget.addEventListener(r.A.ANNOTATION_COMPLETED,A.A.handleAnnotationCompleted),i.eventTarget.addEventListener(r.A.ANNOTATION_MODIFIED,A.A.handleAnnotationUpdate),i.eventTarget.addEventListener(r.A.ANNOTATION_REMOVED,A.A.handleAnnotationDelete)},disable:function(){i.eventTarget.removeEventListener(r.A.ANNOTATION_COMPLETED,A.A.handleAnnotationCompleted),i.eventTarget.removeEventListener(r.A.ANNOTATION_MODIFIED,A.A.handleAnnotationUpdate),i.eventTarget.removeEventListener(r.A.ANNOTATION_REMOVED,A.A.handleAnnotationDelete)}}},90202:(e,t,n)=>{n.d(t,{A:()=>v,r:()=>f});var i=n(92136),o=n(65903),a=n(74119),s=n(90252),r=n(38296),l=n(75534),d=n(7259),c=n(61738),h=n(81848),g=n(96950),u=n(54177);const m="PlanarFreehandContourSegmentationTool";async function v(e){const t=e.detail.annotation;if(!d.isContourSegmentationAnnotation(t))return;const n=function(e){const t=(0,o.A)(e),n=t.find((e=>p(e,!0)));return n??t[0]}(t),v=function(e,t){const{annotationUID:n}=t;return(0,r.getAllAnnotations)().filter((i=>i.annotationUID&&i.annotationUID!==n&&d.isContourSegmentationAnnotation(i)&&d.areSameSegment(i,t)&&e.isReferenceViewable(i.metadata)))}(n,t);if(!v.length)return;const w=E(t.data.contour.polyline,n),I=function(e,t,n){const i=a.math.polyline.getAABB(t);for(let o=0;o<n.length;o++){const s=n[o],r=E(s.data.contour.polyline,e),l=a.math.polyline.getAABB(r),d=a.math.aabb.intersectAABB(i,l),c=d&&a.math.polyline.intersectPolyline(t,r),h=d&&!c&&a.math.polyline.containsPoints(r,t);if(c||h)return{targetAnnotation:s,targetPolyline:r,isContourHole:h}}}(n,w,v);if(!I)return;const{targetAnnotation:C,targetPolyline:T,isContourHole:_}=I;if(_){const{contourHoleProcessingEnabled:i=!1}=e.detail;if(!i)return;f(n,C,t)}else!function(e,t,n,o,v){if(!(0,c.J2)(h.PlanarFreehandContourSegmentationTool))return void console.warn(`${h.PlanarFreehandContourSegmentationTool.toolName} is not registered in cornerstone`);if(!p(e))return;const f=v[0],w=a.math.polyline.containsPoint(n,f),I=function(e,t){return(0,r.getChildAnnotations)(t).map((t=>({annotation:t,polyline:E(t.data.contour.polyline,e)})))}(e,t),C=new Set(I),T=new Map,_=(e,t)=>{let n=T.get(e);n||(n=[],T.set(e,n)),n.push(t),C.delete(t)},S=[];if(w){const e=a.math.polyline.mergePolylines(n,v);S.push(e),Array.from(C.keys()).forEach((t=>_(e,t)))}else{a.math.polyline.subtractPolylines(n,v).forEach((e=>{S.push(e),Array.from(C.keys()).forEach((t=>{a.math.polyline.containsPoints(e,t.polyline)&&(_(e,t),C.delete(t))}))}))}Array.from(T.values()).forEach((e=>e.forEach((e=>(0,r.clearParentAnnotation)(e.annotation)))));const{element:D}=e,A=(0,i.getEnabledElement)(D),{metadata:b,data:y}=t,{handles:R,segmentation:O}=y,{textBox:M}=R;(0,r.removeAnnotation)(o.annotationUID),(0,r.removeAnnotation)(t.annotationUID);for(let n=0;n<S.length;n++){const o=S[n],a=e.canvasToWorld(o[0]),s=e.canvasToWorld(o[o.length-1]),c={metadata:{...b,toolName:m,originalToolName:b.originalToolName||b.toolName},data:{cachedStats:{},handles:{points:[a,s],textBox:M?{...M}:void 0},contour:{polyline:[],closed:!0},spline:t.data.spline,segmentation:{...O}},annotationUID:i.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:t.interpolationUID,interpolationCompleted:t.interpolationCompleted};l.updateContourPolyline(c,{points:o,closed:!0,targetWindingDirection:g.W.Clockwise},e),(0,r.addAnnotation)(c,D),d.addContourSegmentationAnnotation(c),(0,u.XF)(c,e.element),T.get(o)?.forEach((e=>(0,r.addChildAnnotation)(c,e.annotation)))}!function(e,t,n){const{viewport:i}=e,{element:o}=i,{renderingEngine:r}=e,l=new Set([m,t.metadata.toolName,n.metadata.toolName]);for(const e of l.values()){const t=(0,s.getViewportIdsWithToolToRender)(o,e);(0,a.triggerAnnotationRenderForViewportIds)(r,t)}new Promise((e=>window.requestAnimationFrame(e)))}(A,t,o)}(n,C,T,t,w)}function p(e,t=!1){const{toolName:n}=h.PlanarFreehandContourSegmentationTool,i=c.dU.getToolGroupForViewport(e.id,e.renderingEngineId);let o;return i.hasTool(n)?i.getToolOptions(n)||(o=`Tool ${n} must be in active/passive state`):o=`Tool ${n} not added to ${i.id} toolGroup`,o&&!t&&console.warn(o),!o}function E(e,t){const n=e.length,i=new Array(n);for(let o=0;o<n;o++)i[o]=t.worldToCanvas(e[o]);return i}function f(e,t,n){const{windingDirection:o}=t.data.contour,{windingDirection:l}=n.data.contour;o===l&&(n.data.contour.polyline.reverse(),n.data.contour.windingDirection=-1*o),(0,r.addChildAnnotation)(t,n),d.removeContourSegmentationAnnotation(n);const{element:c}=e,h=(0,i.getEnabledElement)(c),{renderingEngine:g}=h,u=new Set([m,t.metadata.toolName,n.metadata.toolName]);for(const e of u.values()){const t=(0,s.getViewportIdsWithToolToRender)(c,e);(0,a.triggerAnnotationRenderForViewportIds)(g,t)}}},60878:(e,t,n)=>{n.d(t,{tQ:()=>N,nm:()=>W,Gg:()=>H,ge:()=>k,_9:()=>x,kt:()=>v.A,bH:()=>r,qI:()=>_,sp:()=>A,Xm:()=>E,u1:()=>S,F_:()=>h,CG:()=>m});var i=n(81387),o=n(37054),a=n(65263);function s(e){e.removeEventListener("dblclick",i.A),e.removeEventListener("mousedown",o.Ay),e.removeEventListener("mousemove",a.A),e.removeEventListener("dblclick",o.DF,{capture:!0})}const r={enable:function(e){s(e),e.addEventListener("dblclick",i.A),e.addEventListener("mousedown",o.Ay),e.addEventListener("mousemove",a.A),e.addEventListener("dblclick",o.DF,{capture:!0})},disable:s};var l=n(38738),d=n(80285);function c(e){l.A.disable(e),e.removeEventListener("touchstart",d.A)}const h={enable:function(e){c(e),l.A.enable(e),e.addEventListener("touchstart",d.A,{passive:!1})},disable:c};var g=n(79445);function u(e){e.removeEventListener("wheel",g.A)}const m={enable:function(e){u(e),e.addEventListener("wheel",g.A,{passive:!1})},disable:u};var v=n(9147),p=n(49521);const E=function(e){const{toolGroupId:t}=e.detail;(0,p.Ay)(t)};var f=n(83946),w=n(30322),I=n(92136),C=n(52610);const T=function(e){const{segmentationId:t,modifiedSlicesToUse:n}=e.detail,{representationData:i,type:o}=w.getSegmentation(t),a=w.getToolGroupIdsWithSegmentation(t),s=i[o];"volumeId"in s&&function({modifiedSlicesToUse:e,representationData:t,type:n}){const i=I.cache.getVolume(t[n].volumeId);if(!i)return void console.warn("segmentation not found in cache");const{imageData:o,vtkOpenGLTexture:a}=i;let s;if(e&&Array.isArray(e))s=e;else{const e=o.getDimensions()[2];s=[...Array(e).keys()]}s.forEach((e=>{a.setUpdatedFrame(e)})),o.modified()}({modifiedSlicesToUse:n,representationData:i,type:o}),"imageIdReferenceMap"in s&&function({toolGroupIds:e,segmentationId:t,representationData:n,type:i}){e.forEach((e=>{const o=w.getSegmentationRepresentations(e),a=(0,C.getToolGroup)(e).getViewportsInfo();o.forEach((e=>{e.segmentationId===t&&a.forEach((({viewportId:t,renderingEngineId:o})=>{const a=(0,I.getEnabledElementByIds)(t,o).viewport;if(a instanceof I.VolumeViewport)return;const s=a.getActor(e.segmentationRepresentationUID);if(!s)return;const r=a.getCurrentImageId(),l=s.actor.getMapper().getInputData(),{imageIdReferenceMap:d}=n[i],c=d.get(r),h=I.cache.getImage(c);l.modified(),I.utilities.updateVTKImageDataWithCornerstoneImage(l,h)}))}))}))}({toolGroupIds:a,segmentationId:t,representationData:i,type:o})},_=function(e){const{segmentationId:t}=e.detail,{type:n}=w.getSegmentation(t),i=w.getToolGroupIdsWithSegmentation(t);n===f.A.Labelmap&&T(e),i.forEach((e=>{(0,p.Ay)(e)}))},S=function(e){const{toolGroupId:t,segmentationRepresentationUID:n}=e.detail;(0,p.Ay)(t)};var D=n(87682);const A=function(e){const{segmentationId:t}=e.detail;(0,w.getToolGroupIdsWithSegmentation)(t).forEach((e=>{(0,w.getSegmentationRepresentations)(e).forEach((n=>{n.segmentationId===t&&(0,D.triggerSegmentationRepresentationModified)(e,n.segmentationRepresentationUID)}))}))};var b=n(45128),y=n(51250),R=n(16124);const O=new Map;function M(e){const t=e.detail,{viewportId:n,renderingEngineId:i}=t,{viewport:o}=(0,I.getEnabledElementByIds)(n,i),a=(0,C.getToolGroupForViewport)(n,i);if(!a)return;let s=w.getSegmentationRepresentations(a.id)||[];if(s=s.filter((e=>e.type===f.A.Labelmap)),!s?.length)return;const r={};s.forEach((e=>{const t=w.getSegmentation(e.segmentationId);if(!t||!t.representationData?.LABELMAP)return;const n=t.representationData.LABELMAP;if((0,R.r)(n,o))return;const{imageIdReferenceMap:i}=n;r[e.segmentationRepresentationUID]={imageIdReferenceMap:i}}));const l=Object.keys(r),d=o.getCurrentImageId(),c=o.getActors();c.find((e=>!!l.includes(e.uid)))?c.forEach((t=>{if(!l.includes(t.uid))return;const n=t.actor,{imageIdReferenceMap:i}=r[t.uid],s=i.get(d),c=n.getMapper().getInputData();if(!s){if(c.setDerivedImage)return void c.setDerivedImage(null);const e=b.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:new Uint8Array(c.getNumberOfPoints())}),t=y.Ay.newInstance();return t.getPointData().setScalars(e),void n.getMapper().setInputData(t)}const h=I.cache.getImage(s),{dimensions:g,spacing:u,direction:m}=o.getImageDataMetadata(h),v=I.cache.getImage(d)||{imageId:d},{origin:E}=o.getImageDataMetadata(v),f=E;if(c.setOrigin(f),c.modified(),c.getDimensions()[0]!==g[0]||c.getDimensions()[1]!==g[1])return o.removeActors([t.uid]),o.addImages([{imageId:s,actorUID:t.uid,callback:({imageActor:e})=>{const t=b.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:[...h.getPixelData()]}),n=y.Ay.newInstance();n.setDimensions(g[0],g[1],1),n.setSpacing(u),n.setDirection(m),n.setOrigin(f),n.getPointData().setScalars(t),e.getMapper().setInputData(n)}}],!0,!1),void(0,p.Ay)(a.id);c.setDerivedImage?c.setDerivedImage(h):I.utilities.updateVTKImageDataWithCornerstoneImage(c,h),o.render(),e.type===I.Enums.Events.IMAGE_RENDERED&&o.element.removeEventListener(I.Enums.Events.IMAGE_RENDERED,M)})):O.has(a.id)||(O.set(a.id,!0),(0,p.Ay)(a.id))}const x={enable:function(e){const{viewport:t}=(0,I.getEnabledElement)(e);t instanceof I.BaseVolumeViewport||(e.addEventListener(I.Enums.Events.STACK_NEW_IMAGE,M),e.addEventListener(I.Enums.Events.IMAGE_RENDERED,M))},disable:function(e){e.removeEventListener(I.Enums.Events.STACK_NEW_IMAGE,M),e.removeEventListener(I.Enums.Events.IMAGE_RENDERED,M)}};var L=n(7259),U=n(90202);function N(e){const t=e.detail.annotation;L.isContourSegmentationAnnotation(t)&&(0,U.A)(e)}var P=n(74119);const k=function(e){if(!e.detail.removed.length)return;(0,I.getRenderingEngines)().forEach((e=>{const t=e.getViewports().map((e=>e.id));(0,P.triggerAnnotationRenderForViewportIds)(e,t)}))};var V=n(23072);const W=function(e){const{viewportId:t,renderingEngineId:n}=e.detail,i=(0,I.getRenderingEngine)(n);(0,V.A)(i,[t])};function H(e){const t=e.detail.annotation;L.isContourSegmentationAnnotation(t)&&function(e){const t=e.detail.annotation;(0,L.removeContourSegmentationAnnotation)(t)}(e)}},39371:(e,t,n)=>{n.r(t),n.d(t,{AdvancedMagnifyTool:()=>u.M$,AngleTool:()=>u.yT,AnnotationDisplayTool:()=>u.wh,AnnotationTool:()=>u.EC,ArrowAnnotateTool:()=>u.ao,BaseTool:()=>u.oS,BidirectionalTool:()=>u.Mu,BrushTool:()=>u.ls,CONSTANTS:()=>a,CircleROIStartEndThresholdTool:()=>u.pq,CircleROITool:()=>u.Vl,CircleScissorsTool:()=>u.G2,CobbAngleTool:()=>u.EV,CrosshairsTool:()=>u.ep,DragProbeTool:()=>u.j$,EllipticalROITool:()=>u.qD,Enums:()=>v,EraserTool:()=>u.dB,KeyImageTool:()=>u.Np,LengthTool:()=>u.LW,LivewireContourSegmentationTool:()=>u.Ix,LivewireContourTool:()=>u.Ys,MIPJumpToClickTool:()=>u.uJ,MagnifyTool:()=>u.eh,OrientationMarkerTool:()=>u.Xr,OverlayGridTool:()=>u.Nk,PaintFillTool:()=>u.Uj,PanTool:()=>u.CH,PlanarFreehandContourSegmentationTool:()=>u.PlanarFreehandContourSegmentationTool,PlanarFreehandROITool:()=>u.ex,PlanarRotateTool:()=>u.A5,ProbeTool:()=>u.N7,RectangleROIStartEndThresholdTool:()=>u.mX,RectangleROIThresholdTool:()=>u.TR,RectangleROITool:()=>u.E0,RectangleScissorsTool:()=>u.td,ReferenceCursors:()=>u.xI,ReferenceLines:()=>u.LL,ReferenceLinesTool:()=>u.X8,ScaleOverlayTool:()=>u.FE,SegmentSelectTool:()=>u.IX,SegmentationDisplayTool:()=>u.t0,SegmentationIntersectionTool:()=>u.cN,SphereScissorsTool:()=>u.zH,SplineContourSegmentationTool:()=>u.qT,SplineROITool:()=>u.J2,StackScrollMouseWheelTool:()=>u.uf,StackScrollTool:()=>u.ae,Synchronizer:()=>o.xW,SynchronizerManager:()=>o._K,ToolGroupManager:()=>o.dU,TrackballRotateTool:()=>u.So,Types:()=>c,UltrasoundDirectionalTool:()=>u.oi,VideoRedactionTool:()=>m.A,VolumeRotateMouseWheelTool:()=>u.Y1,WindowLevelTool:()=>u.Du,ZoomTool:()=>u.OQ,addTool:()=>o.Gx,annotation:()=>h,cancelActiveManipulations:()=>o.BU,cursors:()=>d,destroy:()=>i.zr,drawing:()=>r,init:()=>i.Ts,removeTool:()=>o.Bl,segmentation:()=>g,state:()=>o.wk,synchronizers:()=>s,utilities:()=>l});var i=n(35373),o=n(61738),a=n(55965),s=n(42375),r=n(2746),l=n(74119),d=n(32916),c=n(40969),h=n(45238),g=n(63421),u=n(81848),m=n(65043),v=n(84901)},35373:(e,t,n)=>{n.d(t,{Ts:()=>u,zr:()=>m});var i=n(92136),o=n(38296),a=n(30322),s=n(84901),r=n(61738),l=n(55588),d=n(60878),c=n(44926),h=n(52610);let g=!1;function u(e={}){g||(!function(){v();const e=i.Enums.Events.ELEMENT_ENABLED,t=i.Enums.Events.ELEMENT_DISABLED;i.eventTarget.addEventListener(e,r.D0),i.eventTarget.addEventListener(t,r.kq),c.dj.enable()}(),p(),i.eventTarget.addEventListener(s.Events.ANNOTATION_COMPLETED,d.tQ),i.eventTarget.addEventListener(s.Events.ANNOTATION_MODIFIED,d.nm),i.eventTarget.addEventListener(s.Events.ANNOTATION_SELECTION_CHANGE,d.ge),i.eventTarget.addEventListener(s.Events.ANNOTATION_SELECTION_CHANGE,d.ge),i.eventTarget.addEventListener(s.Events.ANNOTATION_REMOVED,d.Gg),i.eventTarget.addEventListener(s.Events.SEGMENTATION_MODIFIED,d.sp),i.eventTarget.addEventListener(s.Events.SEGMENTATION_DATA_MODIFIED,d.qI),i.eventTarget.addEventListener(s.Events.SEGMENTATION_REPRESENTATION_MODIFIED,d.Xm),i.eventTarget.addEventListener(s.Events.SEGMENTATION_REPRESENTATION_REMOVED,d.u1),g=!0)}function m(){v(),p(),h.destroy(),(0,l.qh)();const e=(0,o.getAnnotationManager)(),t=(0,a.getDefaultSegmentationStateManager)();e.restoreAnnotations({}),t.resetState(),g=!1}function v(){const e=i.Enums.Events.ELEMENT_ENABLED,t=i.Enums.Events.ELEMENT_DISABLED;i.eventTarget.removeEventListener(e,r.D0),i.eventTarget.removeEventListener(t,r.kq),c.dj.disable()}function p(){i.eventTarget.removeEventListener(s.Events.ANNOTATION_COMPLETED,d.tQ),i.eventTarget.removeEventListener(s.Events.ANNOTATION_MODIFIED,d.nm),i.eventTarget.removeEventListener(s.Events.ANNOTATION_SELECTION_CHANGE,d.ge),i.eventTarget.removeEventListener(s.Events.ANNOTATION_SELECTION_CHANGE,d.ge),i.eventTarget.removeEventListener(s.Events.SEGMENTATION_MODIFIED,d.sp),i.eventTarget.removeEventListener(s.Events.SEGMENTATION_DATA_MODIFIED,d.qI),i.eventTarget.removeEventListener(s.Events.SEGMENTATION_REPRESENTATION_MODIFIED,d.Xm),i.eventTarget.removeEventListener(s.Events.SEGMENTATION_REPRESENTATION_REMOVED,d.u1)}},16122:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(92136),o=n(28117),a=n(38296);class s{constructor(){this.annotationUIDs=new Set,this._isVisible=!0,this.visibleFilter=this.unboundVisibleFilter.bind(this)}unboundVisibleFilter(e){return!this._isVisible||!this.annotationUIDs.has(e)}has(e){return this.annotationUIDs.has(e)}setVisible(e=!0,t,n){this._isVisible!==e&&(this._isVisible=e,this.annotationUIDs.forEach((s=>{const r=(0,a.getAnnotation)(s);if(!r)return void this.annotationUIDs.delete(s);if(r.isVisible===e)return;if(!e&&!1===n?.(s))return;r.isVisible=e;const l={...t,annotation:r};(0,i.triggerEvent)(i.eventTarget,o.A.ANNOTATION_MODIFIED,l)})))}get isVisible(){return this._isVisible}findNearby(e,t){const n=[...this.annotationUIDs];if(0===n.length)return null;if(!e)return n[1===t?0:n.length-1];const i=n.indexOf(e);return-1===i||i+t<0||i+t>=n.length?null:n[i+t]}add(...e){e.forEach((e=>this.annotationUIDs.add(e)))}remove(...e){e.forEach((e=>this.annotationUIDs.delete(e)))}clear(){this.annotationUIDs.clear()}}},22581:(e,t,n)=>{n.d(t,{A:()=>c,H:()=>d});var i=n(48463),o=n.n(i),a=n(92136),s=n(48428),r=n(21009);class l{constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;const t=e,n=(0,a.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{const t=e.detail,{FrameOfReferenceUID:n}=t,i=this.annotations[n];i&&Object.keys(i).forEach((e=>{i[e].forEach((e=>{void 0!==e.invalidated&&(e.invalidated=!0)}))}))},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{const n=this.annotations;return n[e]?t?n[e][t]?n[e][t]:[]:n[e]:[]},this.getAnnotation=e=>{const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){const n=i[t];for(const t of n)if(e===t.annotationUID)return t}}},this.getNumberOfAnnotations=(e,t)=>{const n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let i=0;for(const e in n)i+=n[e].length;return i},this.addAnnotation=(e,t)=>{const{metadata:n}=e,{FrameOfReferenceUID:i,toolName:o}=n;t=t||i;const a=this.annotations;let l=a[t];l||(a[t]={},l=a[t]);let d=l[o];d||(l[o]=[],d=l[o]),d.push(e),(0,s.checkAndDefineIsLockedProperty)(e),(0,r.checkAndDefineIsVisibleProperty)(e)},this.removeAnnotation=e=>{const{annotations:t}=this;for(const n in t){const i=t[n];for(const t in i){const n=i[t],o=n.findIndex((t=>t.annotationUID===e));-1!==o&&(n.splice(o,1),0===n.length&&delete i[t])}0===Object.keys(i).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{const n=this.annotations;n[e]&&(t?delete n[e][t]:delete n[e])},this.saveAnnotations=(e,t)=>{const n=this.annotations;if(e&&t){const i=n[e];if(!i)return;const a=i[t];return o()(a)}if(e){const t=n[e];return o()(t)}return o()(n)},this.restoreAnnotations=(e,t,n)=>{const i=this.annotations;if(t&&n){let o=i[t];o||(i[t]={},o=i[t]),o[n]=e}else t?i[t]=e:this.annotations=o()(e)},this.getAllAnnotations=()=>Object.values(this.annotations).map((e=>Object.values(e))).flat(2),this.getNumberOfAllAnnotations=()=>{let e=0;const t=this.annotations;for(const n in t){const i=t[n];for(const t in i){e+=i[t].length}}return e},this.removeAllAnnotations=()=>{this.annotations={}},e||(e=a.utilities.uuidv4()),this.annotations={},this.uid=e,a.eventTarget.addEventListener(a.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}}const d=new l("DEFAULT"),c=l},48428:(e,t,n)=>{n.r(t),n.d(t,{checkAndDefineIsLockedProperty:()=>h,getAnnotationsLocked:()=>l,getAnnotationsLockedCount:()=>c,isAnnotationLocked:()=>d,setAnnotationLocked:()=>s,unlockAllAnnotations:()=>r});var i=n(92136),o=n(84901);const a=new Set;function s(e,t=!0){const n=g();e&&(t?function(e,t,n){t.has(e)||(t.add(e),n.added.push(e))}(e,a,n):u(e,a,n)),m(n,a)}function r(){const e=g();!function(e,t){e.forEach((n=>{u(n,e,t)}))}(a,e),m(e,a)}function l(){return Array.from(a)}function d(e){return a.has(e)}function c(){return a.size}function h(e){if(e){const t=!!e.isLocked;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isLocked");if(t)return t.configurable&&(t.set!==v||t.get!==p);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:v,get:p}),s(e,t)}}function g(){return Object.freeze({added:[],removed:[],locked:[]})}function u(e,t,n){t.delete(e)&&n.removed.push(e)}function m(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.locked.push(t)})),(0,i.triggerEvent)(i.eventTarget,o.Events.ANNOTATION_LOCK_CHANGE,e))}function v(e){s(this,e)}function p(){return d(this)}},42351:(e,t,n)=>{n.r(t),n.d(t,{deselectAnnotation:()=>l,getAnnotationsSelected:()=>d,getAnnotationsSelectedByToolName:()=>c,getAnnotationsSelectedCount:()=>g,isAnnotationSelected:()=>h,setAnnotationSelected:()=>r});var i=n(92136),o=n(84901),a=n(38296);const s=new Set;function r(e,t=!0,n=!1){t?function(e,t=!1){const n=u();t||m(s,n);e&&!s.has(e)&&(s.add(e),n.added.push(e));v(n,s)}(e,n):l(e)}function l(e){const t=u();e?s.delete(e)&&t.removed.push(e):m(s,t),v(t,s)}function d(){return Array.from(s)}function c(e){return d().filter((t=>{const n=(0,a.getAnnotation)(t);return n?.metadata?.toolName===e}))}function h(e){return s.has(e)}function g(){return s.size}function u(){return Object.freeze({added:[],removed:[],selection:[]})}function m(e,t){e.forEach((n=>{e.delete(n)&&t.removed.push(n)}))}function v(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((t=>{e.selection.push(t)})),(0,i.triggerEvent)(i.eventTarget,o.Events.ANNOTATION_SELECTION_CHANGE,e))}},38296:(e,t,n)=>{n.r(t),n.d(t,{addAnnotation:()=>E,addChildAnnotation:()=>m,clearParentAnnotation:()=>u,getAllAnnotations:()=>g,getAnnotation:()=>I,getAnnotationManager:()=>l,getAnnotations:()=>h,getChildAnnotations:()=>p,getNumberOfAnnotations:()=>f,getParentAnnotation:()=>v,invalidateAnnotation:()=>T,removeAllAnnotations:()=>C,removeAnnotation:()=>w,resetAnnotationManager:()=>c,setAnnotationManager:()=>d});var i=n(92136),o=n(84901),a=n(22581),s=n(54177);let r=a.H;function l(){return r}function d(e){r=e}function c(){r=a.H}function h(e,t){const n=l(),i=n.getGroupKey(t);return n.getAnnotations(i,e)}function g(){return l().getAllAnnotations()}function u(e){const{annotationUID:t,parentAnnotationUID:n}=e;if(!n)return;const i=I(n),o=i.childAnnotationUIDs.indexOf(t);i.childAnnotationUIDs.splice(o,1),e.parentAnnotationUID=void 0}function m(e,t){const{annotationUID:n}=e,{annotationUID:i}=t;u(t),e.childAnnotationUIDs||(e.childAnnotationUIDs=[]),e.childAnnotationUIDs.includes(i)||(e.childAnnotationUIDs.push(i),t.parentAnnotationUID=n)}function v(e){return e.parentAnnotationUID?I(e.parentAnnotationUID):void 0}function p(e){return e.childAnnotationUIDs?.map((e=>I(e)))??[]}function E(e,t){e.annotationUID||(e.annotationUID=i.utilities.uuidv4());const n=l();if(t instanceof HTMLDivElement){const i=n.getGroupKey(t);n.addAnnotation(e,i),(0,s.$f)(e,t)}else n.addAnnotation(e),(0,s._3)(e);return e.annotationUID}function f(e,t){const n=l(),i=n.getGroupKey(t);return n.getNumberOfAnnotations(i,e)}function w(e){if(!e)return;const t=l(),n=t.getAnnotation(e);if(!n)return;n.childAnnotationUIDs?.forEach((e=>w(e))),t.removeAnnotation(e);const a=o.Events.ANNOTATION_REMOVED,s={annotation:n,annotationManagerUID:t.uid};(0,i.triggerEvent)(i.eventTarget,a,s)}function I(e){return l().getAnnotation(e)}function C(){l().removeAllAnnotations()}function T(e){let t=e;for(;t;)t.invalidated=!0,t=t.parentAnnotationUID?I(t.parentAnnotationUID):void 0}},21009:(e,t,n)=>{n.r(t),n.d(t,{checkAndDefineIsVisibleProperty:()=>h,isAnnotationVisible:()=>c,setAnnotationVisibility:()=>l,showAllAnnotations:()=>d});var i=n(92136),o=n(38296),a=n(84901),s=n(42351);const r=new Set;function l(e,t=!0){const n=g();e&&(t?u(e,r,n):function(e,t,n){t.has(e)||(t.add(e),(0,s.isAnnotationSelected)(e)&&(0,s.deselectAnnotation)(e),n.lastHidden.push(e))}(e,r,n)),m(n)}function d(){const e=g();r.forEach((t=>{u(t,r,e)})),m(e)}function c(e){if((0,o.getAnnotation)(e))return!r.has(e)}function h(e){if(e){const t=e.isVisible??!0;(function(e){const t=Object.getOwnPropertyDescriptor(e,"isVisible");if(t)return t.configurable&&(t.set!==v||t.get!==p);return Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:v,get:p}),l(e.annotationUID,t)}}function g(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function u(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function m(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(r.forEach((t=>{e.hidden.push(t)})),(0,i.triggerEvent)(i.eventTarget,a.Events.ANNOTATION_VISIBILITY_CHANGE,e))}function v(e){l(this.annotationUID,e)}function p(){return c(this.annotationUID)}},31862:(e,t,n)=>{n.d(t,{A:()=>i});const i=new class{constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){const{annotationUID:n,viewportId:i,toolGroupId:o,toolName:a}=t;return this._getToolStyle(e,n,i,o,a)}_getToolStyle(e,t,n,i,o){if(t){const n=this.getAnnotationToolStyles(t);if(n&&void 0!==n[e])return n[e]}if(n){const t=this.getViewportToolStyles(n);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}if(i){const t=this.getToolGroupToolStyles(i);if(t){if(t[o]&&void 0!==t[o][e])return t[o][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}const a=this.getDefaultToolStyles();return a[o]&&void 0!==a[o][e]?a[o][e]:a.global&&void 0!==a.global[e]?a.global[e]:void 0}_initializeConfig(e){const t={};for(const n in e)t[n]=e[n];this.config={default:{global:t}}}}},80456:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(28664);const o=function(e,t,n){return`${(0,i.h)("textBoxFontSize",e,t,n)}px ${(0,i.h)("textBoxFontFamily",e,t,n)}`}},70692:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(48428),o=n(42351),a=n(84901);const s=function(e){if(e){if(e.data&&e.highlighted)return a.AnnotationStyleStates.Highlighted;if((0,o.isAnnotationSelected)(e.annotationUID))return a.AnnotationStyleStates.Selected;if((0,i.isAnnotationLocked)(e))return a.AnnotationStyleStates.Locked;if(e.data&&e.autoGenerated)return a.AnnotationStyleStates.AutoGenerated}return a.AnnotationStyleStates.Default}},28664:(e,t,n)=>{n.d(t,{h:()=>o});var i=n(31862);function o(e,t,n,o){const a=function(e,t,n){const i=[`${e}`];return t&&i.push(`${i[0]}${t}`),n&&i.push(`${i[i.length-1]}${n}`),i}(e,n,o);for(let e=a.length-1;e>=0;--e){const n=i.A.getStyleProperty(a[e],t);if(void 0!==n)return n}}},35837:(e,t,n)=>{n.r(t),n.d(t,{getFont:()=>o.A,getState:()=>i.A,style:()=>a.A});var i=n(70692),o=n(80456),a=n(31862)},54177:(e,t,n)=>{n.d(t,{$f:()=>s,PS:()=>c,XF:()=>l,_3:()=>r,dZ:()=>d});var i=n(92136),o=n(84901),a=n(52610);function s(e,t){const n=(0,i.getEnabledElement)(t),{renderingEngine:a,viewportId:s}=n,r=o.Events.ANNOTATION_ADDED,l={annotation:e,viewportId:s,renderingEngineId:a.id};(0,i.triggerEvent)(i.eventTarget,r,l)}function r(e){const{toolName:t}=e.metadata,n=(0,a.getToolGroupsWithToolName)(t);if(!n.length)return;const s=[];n.forEach((t=>{t.viewportsInfo.forEach((t=>{const{renderingEngineId:n,viewportId:o}=t,{FrameOfReferenceUID:a}=(0,i.getEnabledElementByIds)(o,n);e.metadata.FrameOfReferenceUID===a&&s.push(t)}))}));const r=o.Events.ANNOTATION_ADDED,l={annotation:e};s.length?s.forEach((({renderingEngineId:e,viewportId:t})=>{l.viewportId=t,l.renderingEngineId=e,(0,i.triggerEvent)(i.eventTarget,r,l)})):(0,i.triggerEvent)(i.eventTarget,r,l)}function l(e,t,n=o.ChangeTypes.HandlesUpdated){const a=(0,i.getEnabledElement)(t),{viewportId:s,renderingEngineId:r}=a,l=o.Events.ANNOTATION_MODIFIED,d={annotation:e,viewportId:s,renderingEngineId:r,changeType:n};(0,i.triggerEvent)(i.eventTarget,l,d)}function d(e){h({annotation:e})}function c(e,t=!1){h({annotation:e,contourHoleProcessingEnabled:t})}function h(e){const t=o.Events.ANNOTATION_COMPLETED;(0,i.triggerEvent)(i.eventTarget,t,e)}},45238:(e,t,n)=>{n.r(t),n.d(t,{AnnotationGroup:()=>d.A,FrameOfReferenceSpecificAnnotationManager:()=>l.A,config:()=>i,locking:()=>o,selection:()=>a,state:()=>s,visibility:()=>r});var i=n(35837),o=n(48428),a=n(42351),s=n(38296),r=n(21009),l=n(22581),d=n(16122)},71065:(e,t,n)=>{n.r(t),n.d(t,{getActiveSegmentation:()=>s,getActiveSegmentationRepresentation:()=>a,setActiveSegmentationRepresentation:()=>r});var i=n(30322),o=n(87682);function a(e){const t=(0,i.getDefaultSegmentationStateManager)().getSegmentationRepresentations(e);if(!t)return;return t.find((e=>e.active))}function s(e){const t=a(e);if(!t)return;return(0,i.getSegmentation)(t.segmentationId)}function r(e,t){(0,i.getDefaultSegmentationStateManager)().setActiveSegmentationRepresentation(e,t),(0,o.triggerSegmentationRepresentationModified)(e,t)}},23308:(e,t,n)=>{n.r(t),n.d(t,{getSegmentVisibility:()=>c,getSegmentationVisibility:()=>r,setSegmentVisibility:()=>d,setSegmentationVisibility:()=>s,setSegmentsVisibility:()=>l});var i=n(30322),o=n(10351),a=n(87682);function s(e,t,n){const s=(0,i.getSegmentationRepresentations)(e);if(!s)return;const r=s.find((e=>e.segmentationRepresentationUID===t));if(!r)return;const{segmentsHidden:l,segmentationId:d}=r,c=(0,o.getUniqueSegmentIndices)(d);n?l.clear():c.forEach((e=>{l.add(e)})),(0,a.triggerSegmentationRepresentationModified)(e,r.segmentationRepresentationUID)}function r(e,t){const n=(0,i.getSegmentationRepresentations)(e).find((e=>e.segmentationRepresentationUID===t));if(!n)return;const{segmentsHidden:a,segmentationId:s}=n,r=(0,o.getUniqueSegmentIndices)(s),l=new Set(r);return a.forEach((e=>l.delete(e))),!!l.size}function l(e,t,n,o){const s=i.getSegmentationRepresentationByUID(e,t);s&&(n.forEach((e=>{o?s.segmentsHidden.delete(e):s.segmentsHidden.add(e)})),(0,a.triggerSegmentationRepresentationModified)(e,t))}function d(e,t,n,o){const s=i.getSegmentationRepresentationByUID(e,t);s&&(o?s.segmentsHidden.delete(n):s.segmentsHidden.add(n),(0,a.triggerSegmentationRepresentationModified)(e,t))}function c(e,t,n){const o=i.getSegmentationRepresentationByUID(e,t);return!!o&&!o.segmentsHidden.has(n)}},58555:(e,t,n)=>{n.d(t,{NL:()=>h,jU:()=>g});var i=n(92136),o=n(84901),a=n(74119),s=n(65807);const r=(0,i.getWebWorkerManager)(),l=new Map,d=new Map,c=(e,t)=>{(0,i.triggerEvent)(e,i.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:o.WorkerTypes.SURFACE_CLIPPING})};async function h(e,t,n){(0,s.b)();const o=t.getSlicesClippingPlanes?.();if(!o)return;const h=t.getSliceIndex();o.sort(((e,t)=>Math.abs(e.sliceIndex-h)-Math.abs(t.sliceIndex-h))),c(i.eventTarget,0),await async function(e){const t=e.filter((e=>!d.has(e.id)));if(!t.length)return;const n=await r.executeTask("polySeg","getSurfacesAABBs",{surfacesInfo:t},{callbacks:[({progress:e})=>{c(i.eventTarget,e)}]});n.forEach(((e,t)=>{d.set(t,e)}))}(e);const g=new Map;e.forEach((e=>{g.set(e.id,d.get(e.id))}));const u=t.getCamera();return await r.executeTask("polySeg","cutSurfacesIntoPlanes",{surfacesInfo:e,planesInfo:o,surfacesAABB:g},{callbacks:[({progress:e})=>{c(i.eventTarget,e)},({sliceIndex:e,polyDataResults:i})=>{i.forEach(((i,o)=>{const s=`${n}_${o}`,r=function(e,t,n){return`${e.id}-${(0,a.pointToString)(t)}-${n}`}(t,u.viewPlaneNormal,e);!function(e,t,n){const{points:i,lines:o,numberOfCells:a}=n;let s=l.get(e);s||(s=new Map,l.set(e,s));s.set(t,{points:i,lines:o,numberOfCells:a})}(s,r,i)}))}]}).catch((e=>{console.error(e)})),c(i.eventTarget,1),l}function g(e,t){return`${e}_${t}`}},63421:(e,t,n)=>{n.r(t),n.d(t,{activeSegmentation:()=>G,addRepresentationData:()=>P,addSegmentationRepresentations:()=>N,addSegmentations:()=>E,config:()=>a,convertStackToVolumeSegmentation:()=>H,convertVolumeToStackSegmentation:()=>F,polySeg:()=>s,removeSegmentationsFromToolGroup:()=>h,segmentIndex:()=>J,segmentLocking:()=>i,state:()=>c,triggerSegmentationEvents:()=>V});var i={};n.r(i),n.d(i,{getLockedSegments:()=>z,isSegmentIndexLocked:()=>$,setSegmentIndexLocked:()=>q});var o={};n.r(o),n.d(o,{addColorLUT:()=>Z,getColorForSegmentIndex:()=>j,setColorForSegmentIndex:()=>Y,setColorLUT:()=>K});var a={};n.r(a),n.d(a,{color:()=>o,getGlobalConfig:()=>I,getGlobalRepresentationConfig:()=>T,getSegmentSpecificConfig:()=>y,getSegmentationRepresentationSpecificConfig:()=>A,getToolGroupSpecificConfig:()=>S,setGlobalConfig:()=>C,setGlobalRepresentationConfig:()=>_,setSegmentSpecificConfig:()=>R,setSegmentationRepresentationSpecificConfig:()=>b,setToolGroupSpecificConfig:()=>D,visibility:()=>X});var s={};n.r(s),n.d(s,{canComputeRequestedRepresentation:()=>Me,computeAndAddContourRepresentation:()=>Re,computeAndAddLabelmapRepresentation:()=>_e,computeAndAddSurfaceRepresentation:()=>ge});var r=n(83946),l=n(94318),d=n(2884),c=n(30322);const h=function(e,t,n){const i=(0,c.getSegmentationRepresentations)(e);if(!i||0===i.length)return;const o=i.map((e=>e.segmentationRepresentationUID));let a=t;if(a){const e=t.filter((e=>!o.includes(e)));if(e.length>0)throw new Error(`The following segmentationRepresentationUIDs are not part of the toolGroup: ${JSON.stringify(e)}`)}else a=o;a.forEach((t=>{!function(e,t,n){const i=(0,c.getSegmentationRepresentationByUID)(e,t),{type:o}=i;if(o===r.A.Labelmap)l.Zy.removeSegmentationRepresentation(e,t,n);else{if(o!==r.A.Contour)throw new Error(`The representation ${o} is not supported yet`);d.T.removeSegmentationRepresentation(e,t,n)}}(e,t,n)}))};var g=n(48463),u=n.n(g),m=n(84901),v=n(11654);const p=function(e){if(!e||0===e.length)throw new Error("The segmentationInputArray is undefined or an empty array");e.forEach((e=>{if(void 0===e.segmentationId)throw new Error("Undefined segmentationInput.segmentationId. Please provide a valid segmentationId");if(void 0===e.representation)throw new Error("Undefined segmentationInput.representation. Please provide a valid representation");e.representation.type===m.SegmentationRepresentations.Labelmap&&(0,v.y)(e)}))};const E=function(e){p(e),e.map((e=>{const t=u()(e);(0,c.addSegmentation)(t)}))};var f=n(52610),w=n(92136);function I(){return c.getGlobalConfig()}function C(e){c.setGlobalConfig(e)}function T(e){return I().representations[e]}function _(e,t){const n=I();C({...n,representations:{...n.representations,[e]:{...n.representations[e],...t}}})}function S(e){return c.getToolGroupSpecificConfig(e)}function D(e,t){c.setToolGroupSpecificConfig(e,t)}function A(e,t){return c.getSegmentationRepresentationSpecificConfig(e,t)}function b(e,t,n){c.setSegmentationRepresentationSpecificConfig(e,t,n)}function y(e,t,n){return c.getSegmentSpecificRepresentationConfig(e,t,n)}function R(e,t,n){c.setSegmentSpecificRepresentationConfig(e,t,n)}var O=n(44956);function M(e){const{type:t}=e;return t===r.A.Labelmap?(0,O.iA)():{}}var x=n(1904),L=n(74119);async function U(e,t,n){const{segmentationId:i,options:o={}}=t,a=t.options?.segmentationRepresentationUID||w.utilities.uuidv4(),s=new Set,r=function(e={}){const t=e.colorLUTOrIndex;let n;if("number"==typeof t)n=t;else{const e=(0,c.getNextColorLUTIndex)(),i=Array.isArray(t)?t:x.A;(0,c.addColorLUT)(i,e),n=e}return n}(o),l={segmentationId:i,segmentationRepresentationUID:a,type:t.type,segmentsHidden:s,colorLUTIndex:r,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:M(t),polySeg:o.polySeg};if(n){const t=S(e),i=w.utilities.deepMerge(t,n);D(e,{renderInactiveSegmentations:i.renderInactiveSegmentations||!0,representations:{...i.representations}})}return(0,c.addSegmentationRepresentation)(e,l),t.type===m.SegmentationRepresentations.Contour&&(0,f.getToolGroup)(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{const n=(0,w.getRenderingEngine)(t);(0,L.triggerAnnotationRenderForViewportIds)(n,[e])})),a}const N=async function(e,t,n){if(!(0,f.getToolGroup)(e))throw new Error(`No tool group found for toolGroupId: ${e}`);const i=t.map((t=>U(e,t,n)));return await Promise.all(i)};const P=function({segmentationId:e,type:t,data:n}){const i=(0,c.getSegmentation)(e);switch(i.representationData[t]&&console.warn(`Representation data of type ${t} already exists for segmentation ${e}, overwriting it.`),t){case r.A.Labelmap:case r.A.Contour:case r.A.Surface:n&&(i.representationData[t]=n);break;default:throw new Error(`Invalid representation type ${t}`)}};var k=n(10351),V=n(87682);async function W({imageIdReferenceMap:e,options:t}){const n=Array.from(e.values()),i={imageIdReferenceMap:e},o=t?.volumeId??w.utilities.uuidv4();return await w.volumeLoader.createAndCacheVolumeFromImages(o,n,{additionalDetails:i}),{volumeId:o}}async function H({segmentationId:e,options:t}){const n=(0,c.getSegmentation)(e).representationData.LABELMAP,{volumeId:i}=await W({imageIdReferenceMap:n.imageIdReferenceMap,options:t});await async function({segmentationId:e,toolGroupId:t,volumeId:n,options:i}){const o=(0,c.getSegmentation)(e);if(i?.removeOriginal){const e=o.representationData.LABELMAP.imageIdReferenceMap;Array.from(e.values()).forEach((e=>{w.cache.removeImageLoadObject(e)})),o.representationData.LABELMAP={volumeId:n}}else o.representationData.LABELMAP={...o.representationData.LABELMAP,volumeId:n};await N(t,[{segmentationId:e,type:m.SegmentationRepresentations.Labelmap}]),(0,k.triggerSegmentationRender)(t),w.eventTarget.addEventListenerOnce(m.Events.SEGMENTATION_RENDERED,(()=>(0,V.triggerSegmentationDataModified)(e)))}({segmentationId:e,toolGroupId:t.toolGroupId,options:t,volumeId:i})}async function B({volumeId:e}){const t=w.cache.getVolume(e);let n=!1;t.imageCacheOffsetMap.size>0&&(n=t.imageIds.every((e=>w.cache.getImage(e))));const i=(0,w.getRenderingEngines)()[0].getVolumeViewports().find((t=>t.hasVolumeId(e)));t.decache(!i&&n);const o=function(e){if(e.additionalDetails?.imageIdReferenceMap)return e.additionalDetails.imageIdReferenceMap;if(e.referencedImageIds?.length&&!e.referencedImageIds[0].startsWith("derived")){const t=e.referencedImageIds,n=e.imageIds;return(0,k.createImageIdReferenceMap)(t,[...n].reverse())}{const t=e.referencedVolumeId,n=w.cache.getVolume(t);if(!n)throw new Error("Cannot convert volumetric segmentation without referenced volume to stack segmentation yet");if(!n?.imageIds?.length)throw new Error("Cannot convert volumetric segmentation without imageIds to stack segmentation yet");if(n.imageIds?.[0].startsWith("derived"))throw new Error("Cannot convert volume segmentation that is derived from another segmentation\n         to stack segmentation yet, include the additionalDetails.imageIdReferenceMap\n         in the volume segmentation in case you need it for the conversion");const i=n.imageIds;let o=e.imageIds;return o?.length||(o=e.convertToImageSlicesAndCache()),(0,k.createImageIdReferenceMap)(i,[...o].reverse())}}(t);return{imageIdReferenceMap:o}}async function F({segmentationId:e,options:t}){const n=(0,c.getSegmentation)(e).representationData.LABELMAP,{imageIdReferenceMap:i}=await B({volumeId:n.volumeId});await async function({segmentationId:e,toolGroupId:t,imageIdReferenceMap:n,options:i}){const o=(0,c.getSegmentation)(e);if(i?.removeOriginal){const e=o.representationData.LABELMAP;w.cache.getVolume(e.volumeId)&&w.cache.removeVolumeLoadObject(e.volumeId),o.representationData.LABELMAP={imageIdReferenceMap:n}}else o.representationData.LABELMAP={...o.representationData.LABELMAP,imageIdReferenceMap:n};await N(t,[{segmentationId:e,type:m.SegmentationRepresentations.Labelmap}]),(0,k.triggerSegmentationRender)(t),w.eventTarget.addEventListenerOnce(m.Events.SEGMENTATION_RENDERED,(()=>(0,V.triggerSegmentationDataModified)(e)))}({segmentationId:e,toolGroupId:t.toolGroupId,imageIdReferenceMap:i,options:t})}var G=n(71065);function $(e,t){const n=(0,c.getSegmentation)(e);if(!n)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:i}=n;return i.has(t)}function q(e,t,n=!0){const i=(0,c.getSegmentation)(e);if(!i)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:o}=i;n?o.add(t):o.delete(t),(0,V.triggerSegmentationModified)(e)}function z(e){const t=(0,c.getSegmentation)(e);if(!t)throw new Error(`No segmentation state found for ${e}`);const{segmentsLocked:n}=t;return Array.from(n)}function Z(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");w.utilities.isEqual(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),c.addColorLUT(e,t)}function K(e,t,n){const i=c.getSegmentationRepresentationByUID(e,t);if(!i)throw new Error(`setColorLUT: could not find segmentation representation with UID ${t}`);if(!c.getColorLUT(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);i.colorLUTIndex=n,(0,V.triggerSegmentationRepresentationModified)(e,t)}function j(e,t,n){const i=c.getSegmentationRepresentationByUID(e,t);if(!i)throw new Error(`segmentation representation with UID ${t} does not exist for tool group ${e}`);const{colorLUTIndex:o}=i,a=c.getColorLUT(o);let s=a[n];if(!s){if("number"!=typeof n)throw new Error(`Can't create colour for LUT index ${n}`);s=a[n]=[0,0,0,0]}return s}function Y(e,t,n,i){const o=j(e,t,n);for(let e=0;e<i.length;e++)o[e]=i[e];(0,V.triggerSegmentationRepresentationModified)(e,t)}var X=n(23308),J=n(96834),Q=n(65807);const ee=new Map;async function te(e,t,n,i){(0,Q.b)();const o=await n();P({segmentationId:e,type:t,data:o}),ee.has(e)||ee.set(e,[]);const a=ee.get(e);return a.includes(t)||a.push(t),function(e){const t=t=>{ne(t,e)};e._debouncedUpdateFunction=t,w.eventTarget.removeEventListener(m.Events.SEGMENTATION_DATA_MODIFIED,e._debouncedUpdateFunction),w.eventTarget.addEventListener(m.Events.SEGMENTATION_DATA_MODIFIED,e._debouncedUpdateFunction)}(i),(0,V.triggerSegmentationModified)(e),o}const ne=(0,L.debounce)(((e,t)=>{const n=e.detail.segmentationId,i=ee.get(n);i&&i.length&&(t(n),i.length&&(0,V.triggerSegmentationModified)(n))}),300);var ie=n(38296);const oe=(0,w.getWebWorkerManager)(),ae=(e,t)=>{(0,w.triggerEvent)(e,w.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:m.WorkerTypes.POLYSEG_CONTOUR_TO_SURFACE})};async function se(e,t,n={}){let i,o;n.segmentationRepresentationUID&&({segmentationRepresentation:i,toolGroupId:o}=(0,c.findSegmentationRepresentationByUID)(n.segmentationRepresentationUID));const a=(0,c.getSegmentation)(e),s=new Map,r=Object.keys(t).map((async e=>{const n=t[e],r=n.segmentIndex,l=i;if(j(o,i.segmentationRepresentationUID,r).slice(0,3),!l)throw new Error("No color found for segment index, unable to create surface");const d={id:`segmentation_${a.segmentationId}_surface_${r}`,color:l,frameOfReferenceUID:"test-frameOfReferenceUID",data:{points:n.data.points,polys:n.data.polys}},c=d.id;return s.set(r,c),w.geometryLoader.createAndCacheGeometry(c,{type:w.Enums.GeometryType.SURFACE,geometryData:d})}));return await Promise.all(r),{geometryIds:s}}var re=n(16124);const le=(0,w.getWebWorkerManager)(),de=(e,t)=>{(0,w.triggerEvent)(e,w.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:m.WorkerTypes.POLYSEG_LABELMAP_TO_SURFACE})};async function ce(e,t={}){const n=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e);let i;const o=(0,c.getSegmentation)(e),a=o.representationData;try{a.CONTOUR?i=await async function(e,t={}){const n=(0,c.getSegmentation)(e),i=n.representationData.CONTOUR,o=t.segmentIndices||(0,k.getUniqueSegmentIndices)(e),a=o.map((async e=>{const t=await async function(e,t){const{annotationUIDsMap:n}=e,i=[],o=[],a=n.get(t);for(const e of a){const t=(0,ie.getAnnotation)(e),{polyline:n}=t.data.contour;o.push(n.length),n.forEach((e=>i.push(...e)))}ae(w.eventTarget,0);const s=await oe.executeTask("polySeg","convertContourToSurface",{polylines:i,numPointsArray:o},{callbacks:[e=>{ae(w.eventTarget,e)}]});return ae(w.eventTarget,1),s}(i,e);return{segmentIndex:e,data:t}}));return await Promise.all(a)}(e,{segmentIndices:n,...t}):a.LABELMAP&&(i=await he(o.segmentationId,{segmentIndices:n,...t}))}catch(e){throw console.error(e),e}if(!i)throw new Error("Not enough data to convert to surface, currently only support converting volume labelmap to surface if available");return await se(e,i,t)}async function he(e,t={}){const n=(0,c.getSegmentation)(e);if(!n?.representationData?.LABELMAP)return void console.warn("Only support surface update from labelmaps");const i=(0,re.r)(n.representationData.LABELMAP),o=n.representationData.LABELMAP,a=t.segmentIndices||(0,k.getUniqueSegmentIndices)(e),s=a.map((e=>{const t=async function(e,t,n=!0){let i;if(n)i=e.volumeId;else{const{imageIdReferenceMap:t}=e;({volumeId:i}=await W({imageIdReferenceMap:t}))}const o=w.cache.getVolume(i),a=o.getScalarData(),{dimensions:s,spacing:r,origin:l,direction:d}=o;de(w.eventTarget,0);const c=await le.executeTask("polySeg","convertLabelmapToSurface",{scalarData:a,dimensions:s,spacing:r,origin:l,direction:d,segmentIndex:t},{callbacks:[e=>{de(w.eventTarget,e)}]});return de(w.eventTarget,1),c}(o,e,i);return t})),r=await Promise.allSettled(s),l=r.filter((e=>"rejected"===e.status));if(l.length>0)throw console.error(l),new Error("Failed to convert labelmap to surface");return r.map(((e,t)=>{if("fulfilled"===e.status)return{segmentIndex:a[t],data:e.value}})).filter(Boolean)}function ge(e,t={}){return te(e,m.SegmentationRepresentations.Surface,(()=>ce(e,t)),(()=>async function(e){const t=await he(e);if(!t)return;const n=(0,c.getSegmentation)(e),i=(0,k.getUniqueSegmentIndices)(e);if(!i.length)return n.representationData.SURFACE.geometryIds.forEach((e=>{const t=w.cache.getGeometry(e).data;t.setPoints([]),t.setPolys([])})),void(0,V.triggerSegmentationModified)(e);const o=t.map((({data:t,segmentIndex:o})=>{const a=`segmentation_${e}_surface_${o}`,s=w.cache.getGeometry(a);if(!s)return(0,c.getToolGroupIdsWithSegmentation)(e).map((i=>(0,c.getSegmentationRepresentations)(i).map((i=>{if(i.type===m.SegmentationRepresentations.Surface)return n.representationData.SURFACE.geometryIds.set(o,a),se(e,[{segmentIndex:o,data:t}],{segmentationRepresentationUID:i.segmentationRepresentationUID})}))));if(i.includes(o)){const e=s.data;e.setPoints(t.points),e.setPolys(t.polys)}else{const e=s.data;e.setPoints([]),e.setPolys([])}}));await Promise.all(o),(0,V.triggerSegmentationModified)(e)}(e)))}var ue=n(44753),me=n(95778);const ve=(0,w.getWebWorkerManager)(),pe=(e,t)=>{(0,w.triggerEvent)(e,w.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:m.WorkerTypes.POLYSEG_CONTOUR_TO_LABELMAP})};async function Ee(e,t={}){const{viewport:n}=t,i=w.utilities.getViewportImageIds(n);if(!i)throw new Error("No imageIds found, labelmap computation from contour requires viewports with imageIds");const o=w.utilities.uuidv4(),a=w.utilities.generateVolumePropsFromImageIds(i,o),{metadata:s,dimensions:r,origin:l,direction:d,spacing:c,scalarData:h}=a,g=await w.volumeLoader.createLocalSegmentationVolume({dimensions:r,origin:l,direction:d,spacing:c,metadata:s,imageIds:i.map((e=>`generated://${e}`)),referencedImageIds:i},o),{segmentIndices:u,annotationUIDsInSegmentMap:m}=we(e,t);pe(w.eventTarget,0);const v=await ve.executeTask("polySeg","convertContourToVolumeLabelmap",{segmentIndices:u,dimensions:r,scalarData:h,origin:l,direction:d,spacing:c,annotationUIDsInSegmentMap:m},{callbacks:[e=>{pe(w.eventTarget,e)}]});return pe(w.eventTarget,1),g.imageData.getPointData().getScalars().setData(v),g.imageData.modified(),g.modified(),{volumeId:g.volumeId}}async function fe(e,t={}){if(!t.viewport)throw new Error("No viewport provided, labelmap computation from contour requires viewports");const n=t.viewport.getImageIds();if(!n)throw new Error("No imageIds found, labelmap computation from contour requires viewports with imageIds");n.forEach((e=>{if(!w.cache.getImageLoadObject(e))throw new Error("ImageIds must be cached before converting contour to labelmap")}));const{imageIds:i}=await w.imageLoader.createAndCacheDerivedSegmentationImages(n),{segmentIndices:o,annotationUIDsInSegmentMap:a}=we(e,t),s=new Map;i.forEach(((e,t)=>{const i=w.cache.getImage(e),o=w.metaData.get(w.Enums.MetadataModules.IMAGE_PLANE,e);let{columnCosines:a,rowCosines:r,rowPixelSpacing:l,columnPixelSpacing:d,imagePositionPatient:c}=o;a=a??[0,1,0],r=r??[1,0,0],l=l??1,d=d??1,c=c??[0,0,0];const h=ue.eR.fromValues(r[0],r[1],r[2]),g=ue.eR.fromValues(a[0],a[1],a[2]),u=ue.eR.create();ue.eR.cross(u,h,g);const m=[...h,...g,...u],v=[l,d,1],p=c;s.set(n[t],{direction:m,spacing:v,origin:p,scalarData:i.getPixelData(),imageId:e,dimensions:[i.width,i.height,1]})})),pe(w.eventTarget,0);const r=await ve.executeTask("polySeg","convertContourToStackLabelmap",{segmentationsInfo:s,annotationUIDsInSegmentMap:a,segmentIndices:o},{callbacks:[e=>{pe(w.eventTarget,e)}]});pe(w.eventTarget,1);const l=new Map;return r.forEach((({scalarData:e},t)=>{const n=s.get(t),{imageId:i}=n,o=w.cache.getImage(i);o.getPixelData().set(e),o.imageFrame?.pixelData?.set(e),l.set(t,i)})),{imageIdReferenceMap:l}}function we(e,t={}){const n=e.annotationUIDsMap,i=t.segmentIndices?.length?t.segmentIndices:Array.from(n.keys()),o=new Map;return i.forEach((e=>{const t=n.get(e);let i=Array.from(t);i=i.filter((e=>!(0,me.gw)(e).parentAnnotationUID));const a=i.map((e=>{const t=(0,me.gw)(e),n=t.childAnnotationUIDs?.length;return{polyline:t.data.contour.polyline,referencedImageId:t.metadata.referencedImageId,holesPolyline:n&&t.childAnnotationUIDs.map((e=>(0,me.gw)(e).data.contour.polyline))}}));o.set(e,a)})),{segmentIndices:i,annotationUIDsInSegmentMap:o}}const Ie=(0,w.getWebWorkerManager)(),Ce=(e,t)=>{(0,w.triggerEvent)(e,w.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:m.WorkerTypes.POLYSEG_SURFACE_TO_LABELMAP})};async function Te(e,t={}){const n=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e);let i;const o=(0,c.getSegmentation)(e),a=o.representationData;try{a.CONTOUR?i=await async function(e,t={}){const n=t.viewport instanceof w.VolumeViewport??!0;if(n&&!t.viewport)throw new Error("Cannot compute labelmap from contour segmentation without providing the viewport");const i=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e),o=(0,c.getSegmentation)(e),a=o.representationData.CONTOUR,s=n?Ee:fe,r=await s(a,{segmentIndices:i,segmentationRepresentationUID:t.segmentationRepresentationUID,viewport:t.viewport});return r}(e,{segmentIndices:n,...t}):a.SURFACE&&(i=await async function(e,t={}){const n=t.viewport instanceof w.VolumeViewport??!0,i=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e),o=(0,c.getSegmentation)(e),a=new Map,s=o.representationData.SURFACE;if(s.geometryIds.forEach(((e,t)=>{i.includes(t)&&a.set(t,e)})),n&&!t.viewport)throw new Error("Cannot compute labelmap from surface segmentation without providing the viewport");let r;if(n){const e=t.viewport.getDefaultActor(),{uid:n}=e;r=await w.volumeLoader.createAndCacheDerivedSegmentationVolume(n)}else{const e=t.viewport.getImageIds(),n="generatedSegmentationVolumeId",i=w.utilities.generateVolumePropsFromImageIds(e,n);delete i.imageIds,r=await w.volumeLoader.createLocalSegmentationVolume({...i,scalarData:i.scalarData,referencedImageIds:e},n)}const l=await async function(e,t){const{geometryIds:n}=e;if(!n?.size)throw new Error("No geometry IDs found for surface representation");const i=new Map;n.forEach(((e,t)=>{const n=w.cache.getGeometry(e).data,o=n.getPoints(),a=n.getPolys();i.set(t,{points:o,polys:a})}));const{dimensions:o,direction:a,origin:s,spacing:r}=t;Ce(w.eventTarget,0);const l=await Ie.executeTask("polySeg","convertSurfacesToVolumeLabelmap",{segmentsInfo:i,dimensions:o,spacing:r,direction:a,origin:s},{callbacks:[e=>{Ce(w.eventTarget,e)}]});return Ce(w.eventTarget,1),t.imageData.getPointData().getScalars().setData(l),t.imageData.modified(),t.modified(),{volumeId:t.volumeId}}({geometryIds:a},r);if(n)return l;return await B({volumeId:r.volumeId})}(o.segmentationId,{segmentIndices:n,...t}))}catch(e){throw console.error(e),e}if(!i)throw new Error("Not enough data to convert to surface, currently only support converting volume labelmap to surface if available");return i}function _e(e,t={}){return te(e,m.SegmentationRepresentations.Labelmap,(()=>Te(e,t)),(()=>{}))}var Se=n(58555);function De(e,t){const n=new Map;for(const[i,o]of e){const e=i.split("_")[1];for(const[i,a]of o){if(!a)continue;const i=Number(e)||t?.get(e);i&&(n.has(i)||n.set(i,[]),n.get(i).push(a))}}return n}var Ae=n(81848);const be=e=>{const{numberOfCells:t,lines:n}=e,i=[],o=[];for(let e=0;e<n.length;){const a=n[e];if(o.push(a),i.push(n.slice(e+1,e+a+1)),e+=a+1,i.length===t)break}return{lineSegments:i,linesNumberOfPoints:o}};async function ye(e,t={}){const n=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e);let i;const o=(0,c.getSegmentation)(e).representationData;try{o.SURFACE?i=await async function(e,t={}){if(!t.viewport)throw new Error("Viewport is required to compute contour from surface");const{viewport:n,segmentationRepresentationUID:i}=t,o=t.segmentIndices?.length?t.segmentIndices:(0,k.getUniqueSegmentIndices)(e),a=new Map,s=new Map,r=(0,c.getSegmentation)(e),l=r.representationData.SURFACE,d=[];l.geometryIds.forEach(((e,t)=>{if(o.includes(t)){a.set(t,e);const n=w.cache.getGeometry(e)?.data;n&&d.push({id:e,points:n.getPoints(),polys:n.getPolys()})}})),a.forEach(((e,t)=>{s.set(e,t)}));const h=await(0,Se.NL)(d,n,i);return De(h,s)}(e,{segmentIndices:n,...t}):o.LABELMAP&&(i=await async function(e,t={}){if(!t.viewport)throw new Error("Viewport is required to compute contour from labelmap");const n=await he(e,t);if(!n?.length)return void console.error("Failed to convert labelmap to surface or labelmap is empty");const{viewport:i,segmentationRepresentationUID:o}=t,a=n.map((e=>({id:e.segmentIndex.toString(),points:e.data.points,polys:e.data.polys,segmentIndex:e.segmentIndex}))),s=await(0,Se.NL)(a,i,o);return De(s)}(e,{segmentIndices:n,...t}))}catch(e){throw console.error(e),e}if(!i)throw new Error("Not enough data to convert to contour, currently only support converting volume labelmap to contour if available");const{viewport:a,segmentationRepresentationUID:s}=t,r=function(e,t,n){const i=new Map;for(const[o,a]of e)for(const e of a){const{points:a}=e,{lineSegments:s,linesNumberOfPoints:r}=be(e);for(let e=0;e<s.length;e++){const l=s[e],d=[];for(let t=0;t<r[e];t++){const e=l[t];d.push([a[3*e],a[3*e+1],a[3*e+2]])}if(d.length<3)continue;const c={annotationUID:w.utilities.uuidv4(),data:{contour:{closed:!0,polyline:d},segmentation:{segmentationId:n,segmentIndex:o},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:Ae.PlanarFreehandContourSegmentationTool.toolName,...t.getViewReference()}};(0,ie.addAnnotation)(c,t.element);const h=i.get(o)||new Set;h.add(c.annotationUID),i.set(o,h)}}return i}(i,a,e),l=(0,f.getToolGroupForViewport)(a.id)?.id;return(0,c.setSegmentationRepresentationSpecificConfig)(l,s,{CONTOUR:{fillAlpha:0}}),{annotationUIDsMap:r}}function Re(e,t={}){return te(e,m.SegmentationRepresentations.Contour,(()=>ye(e,t)),(()=>{}))}const Oe=new Map([[m.SegmentationRepresentations.Labelmap,new Set([m.SegmentationRepresentations.Surface,m.SegmentationRepresentations.Contour])],[m.SegmentationRepresentations.Contour,new Set([m.SegmentationRepresentations.Labelmap,m.SegmentationRepresentations.Surface])],[m.SegmentationRepresentations.Surface,new Set([m.SegmentationRepresentations.Labelmap])]]);function Me(e){const t=(0,c.findSegmentationRepresentationByUID)(e);if(!t?.segmentationRepresentation)return!1;const{segmentationRepresentation:n}=t,{type:i,polySeg:o}=n;if(!o||!o.enabled)return!1;const{representationData:a}=(0,c.getSegmentation)(n.segmentationId),s=function(e){const t=[];return Object.keys(e).forEach((n=>{const i=e[n];let o;if(n===m.SegmentationRepresentations.Labelmap)o=l.ji;if(o)try{o(i),t.push(n)}catch(e){console.warn(`Validation failed for labelmap of type ${n}`)}else t.push(n)})),t}(a);return s.some((e=>async function(e,t){return Oe.get(e)?.has(t)||!1}(e,i)))}},65807:(e,t,n)=>{n.d(t,{b:()=>a});var i=n(92136);let o=!1;function a(){if(o)return;o=!0;(0,i.getWebWorkerManager)().registerWorker("polySeg",(()=>new Worker(new URL(n.p+n.u(572),n.b),{name:"polySeg"})),{maxWorkerInstances:1,autoTerminateOnIdle:{enabled:!0,idleTimeThreshold:2e3}})}},96834:(e,t,n)=>{n.r(t),n.d(t,{getActiveSegmentIndex:()=>r,setActiveSegmentIndex:()=>s});var i=n(10351),o=n(30322),a=n(87682);function s(e,t){const n=(0,o.getSegmentation)(e);"string"==typeof t&&(console.warn("segmentIndex is a string, converting to number"),t=Number(t)),n?.activeSegmentIndex!==t&&(n.activeSegmentIndex=t,(0,a.triggerSegmentationModified)(e));(0,o.getToolGroupIdsWithSegmentation)(e).forEach((e=>{(0,i.invalidateBrushCursor)(e)}))}function r(e){const t=(0,o.getSegmentation)(e);if(t)return t.activeSegmentIndex}},30322:(e,t,n)=>{n.r(t),n.d(t,{addColorLUT:()=>G,addSegmentation:()=>I,addSegmentationRepresentation:()=>L,findSegmentationRepresentationByUID:()=>S,getAllSegmentationRepresentations:()=>T,getColorLUT:()=>B,getDefaultSegmentationStateManager:()=>E,getGlobalConfig:()=>U,getNextColorLUTIndex:()=>F,getSegmentSpecificRepresentationConfig:()=>O,getSegmentation:()=>f,getSegmentationIdRepresentations:()=>_,getSegmentationRepresentationByUID:()=>P,getSegmentationRepresentationSpecificConfig:()=>R,getSegmentationRepresentations:()=>C,getSegmentations:()=>w,getToolGroupIdFromSegmentationRepresentationUID:()=>x,getToolGroupIdsWithSegmentation:()=>D,getToolGroupSpecificConfig:()=>A,removeColorLUT:()=>H,removeSegmentation:()=>k,removeSegmentationRepresentation:()=>V,removeSegmentationRepresentations:()=>W,setGlobalConfig:()=>N,setSegmentSpecificRepresentationConfig:()=>M,setSegmentationRepresentationSpecificConfig:()=>y,setToolGroupSpecificConfig:()=>b});var i=n(48463),o=n.n(i),a=n(92136),s=n(84901),r=n(20652),l=n(44350),d=n(68492);const c=(0,l.A)(),h=(0,r.A)(),g=(0,d.A)(),u={colorLUT:[],segmentations:[],globalConfig:{renderInactiveSegmentations:!0,representations:{[s.SegmentationRepresentations.Labelmap]:c,[s.SegmentationRepresentations.Contour]:h,[s.SegmentationRepresentations.Surface]:g}},toolGroups:{}};const m=new class{constructor(e){e||(e=a.utilities.uuidv4()),this.state=o()(u),this.uid=e}getState(){return this.state}getToolGroups(){return Object.keys(this.state.toolGroups)}getColorLUT(e){return this.state.colorLUT[e]}getNextColorLUTIndex(){return this.state.colorLUT.length}resetState(){this.state=o()(u)}getSegmentation(e){return this.state.segmentations.find((t=>t.segmentationId===e))}addSegmentation(e){if(this.getSegmentation(e.segmentationId))throw new Error(`Segmentation with id ${e.segmentationId} already exists`);this.state.segmentations.push(e)}getSegmentationRepresentations(e){const t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}getAllSegmentationRepresentations(){const e={};return Object.entries(this.state.toolGroups).forEach((([t,n])=>{e[t]=n.segmentationRepresentations})),e}addSegmentationRepresentation(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}getGlobalConfig(){return this.state.globalConfig}setGlobalConfig(e){this.state.globalConfig=e}getSegmentationRepresentationByUID(e,t){const n=this.getSegmentationRepresentations(e),i=n?.find((e=>e.segmentationRepresentationUID===t));return i}removeSegmentation(e){this.state.segmentations=this.state.segmentations.filter((t=>t.segmentationId!==e))}removeSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No viewport specific segmentation state found for viewport ${e}`);const i=n.findIndex((e=>e.segmentationRepresentationUID===t));-1===i&&console.warn(`No viewport specific segmentation state data found for viewport ${e} and segmentation data UID ${t}`);const o=n[i];n.splice(i,1),this._handleActiveSegmentation(e,o)}setActiveSegmentationRepresentation(e,t){const n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error(`No segmentation data found for toolGroupId: ${e}`);const i=n.find((e=>e.segmentationRepresentationUID===t));if(!i)throw new Error(`No segmentation data found for segmentation data UID ${t}`);i.active=!0,this._handleActiveSegmentation(e,i)}getToolGroupSpecificConfig(e){const t=this.state.toolGroups[e];if(t)return t.config}getSegmentationRepresentationSpecificConfig(e,t){const n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}setSegmentationRepresentationSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);i&&(i.segmentationRepresentationSpecificConfig=n)}getSegmentSpecificConfig(e,t,n){const i=this.getSegmentationRepresentationByUID(e,t);if(i)return i.segmentSpecificConfig[n]}setSegmentSpecificConfig(e,t,n,i){const o=this.getSegmentationRepresentationByUID(e,t);o&&(o.segmentSpecificConfig&&!i?.clear||(o.segmentSpecificConfig={}),Object.keys(n).forEach((e=>{o.segmentSpecificConfig[e]=n[e]})))}setSegmentationRepresentationConfig(e,t){let n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config={...n.config,...t}}addColorLUT(e,t){this.state.colorLUT[t]&&console.warn("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=o()(e)}removeColorLUT(e){delete this.state.colorLUT[e]}_handleActiveSegmentation(e,t){const n=this.getSegmentationRepresentations(e);if(0===n.length)return;if(1===n.length)return void(n[0].active=!0);0!==n.filter((e=>e.active)).length?t.active&&n.forEach((e=>{e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})):n[0].active=!0}}("DEFAULT");var v=n(87682);const p=function(e){const{segmentationId:t,representation:n}=e,i=n.type===s.SegmentationRepresentations.Contour;let o=n.data?{...n.data}:null;if(o=!o&&i?{}:o,!o)throw new Error("Segmentation representation data may not be undefined");if(i){const e=o;e.geometryIds=e.geometryIds??[],e.annotationUIDsMap=e.annotationUIDsMap??new Map}return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:{[n.type]:{...o}}}};function E(){return m}function f(e){return E().getSegmentation(e)}function w(){return E().getState().segmentations}function I(e,t){const n=E(),i=p(e);n.addSegmentation(i),t||(0,v.triggerSegmentationModified)(i.segmentationId)}function C(e){return E().getSegmentationRepresentations(e)}function T(){return E().getAllSegmentationRepresentations()}function _(e){const t=T()||{},n=[];for(const i in t){const o=t[i].find((t=>t.segmentationId===e));o&&n.push(o)}return n}function S(e){const t=T()||[],n=Object.keys(t);for(const t of n){const n=T()[t].find((t=>t.segmentationRepresentationUID===e));if(n)return{segmentationRepresentation:n,toolGroupId:t}}}function D(e){if(!e)throw new Error("getToolGroupIdsWithSegmentation: segmentationId is empty");const t=E(),n=t.getState(),i=Object.keys(n.toolGroups),o=[];return i.forEach((n=>{t.getSegmentationRepresentations(n).forEach((t=>{t.segmentationId===e&&o.push(n)}))})),o}function A(e){return E().getToolGroupSpecificConfig(e)}function b(e,t,n){E().setSegmentationRepresentationConfig(e,t),n||(0,v.triggerSegmentationRepresentationModified)(e)}function y(e,t,n,i=!1){E().setSegmentationRepresentationSpecificConfig(e,t,n),i||(0,v.triggerSegmentationRepresentationModified)(e,t)}function R(e,t){return E().getSegmentationRepresentationSpecificConfig(e,t)}function O(e,t,n){return E().getSegmentSpecificConfig(e,t,n)}function M(e,t,n,i=!1){E().setSegmentSpecificConfig(e,t,n),i||(0,v.triggerSegmentationRepresentationModified)(e,t)}function x(e){const t=T()||[],n=Object.keys(t);for(const t of n){if(T()[t].find((t=>t.segmentationRepresentationUID===e)))return t}}function L(e,t,n){E().addSegmentationRepresentation(e,t),n||(0,v.triggerSegmentationRepresentationModified)(e,t.segmentationRepresentationUID)}function U(){return E().getGlobalConfig()}function N(e,t){E().setGlobalConfig(e),t||(0,v.triggerSegmentationModified)()}function P(e,t){return E().getSegmentationRepresentationByUID(e,t)}function k(e){E().removeSegmentation(e),(0,v.triggerSegmentationRemoved)(e)}function V(e,t){E().removeSegmentationRepresentation(e,t),(0,v.triggerSegmentationRepresentationRemoved)(e,t)}function W(e){(C(e)||[]).forEach((t=>{V(e,t.segmentationRepresentationUID)}))}function H(e){E().removeColorLUT(e)}function B(e){return E().getColorLUT(e)}function F(){return E().getNextColorLUTIndex()}function G(e,t){E().addColorLUT(e,t)}},87682:(e,t,n)=>{n.r(t),n.d(t,{triggerSegmentationDataModified:()=>h,triggerSegmentationModified:()=>c,triggerSegmentationRemoved:()=>r,triggerSegmentationRepresentationModified:()=>d,triggerSegmentationRepresentationRemoved:()=>l});var i=n(92136),o=n(84901),a=n(30322),s=n(94510);function r(e){const t={segmentationId:e};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_REMOVED,t)}function l(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_REPRESENTATION_REMOVED,n)}function d(e,t){const n={toolGroupId:e,segmentationRepresentationUID:t};if(t)return void(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_REPRESENTATION_MODIFIED,n);((0,a.getSegmentationRepresentations)(e)||[]).forEach((t=>{const{segmentationRepresentationUID:n}=t,a={toolGroupId:e,segmentationRepresentationUID:n};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_REPRESENTATION_MODIFIED,a)}))}function c(e){let t;t=e?[e]:(0,a.getSegmentations)().map((({segmentationId:e})=>e)),t.forEach((e=>{const t={segmentationId:e};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_MODIFIED,t)}))}function h(e,t){const n={segmentationId:e,modifiedSlicesToUse:t};(0,s.HM)(e),(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_DATA_MODIFIED,n)}},30765:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(92136);function o(e,t){return e.findIndex((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))}function a(e,t){return e.some((e=>e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId))}const s=class{constructor(e,t,n,o){this._viewportOptions={},this._onEvent=e=>{if(!0===this._ignoreFiredEvents)return;if(!this._targetViewports.length)return;const t=(0,i.getEnabledElement)(e.currentTarget);if(!t)return;const{renderingEngineId:n,viewportId:o}=t;this._sourceViewports.find((e=>e.viewportId===o))&&this.fireEvent({renderingEngineId:n,viewportId:o},e)},this._enabled=!0,this._eventName=t,this._eventHandler=n,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=o||{},this._auxiliaryEventNames=this._options.auxiliaryEventNames||[],this.id=e}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(e,t={}){this._viewportOptions[e]=t}setEnabled(e){this._enabled=e}getOptions(e){return this._viewportOptions[e]}add(e){this.addTarget(e),this.addSource(e)}addSource(e){if(a(this._sourceViewports,e))return;const{renderingEngineId:t,viewportId:n}=e,o=(0,i.getRenderingEngine)(t).getViewport(n);if(!o)return void console.warn(`Synchronizer.addSource: No viewport for ${t} ${n}`);const s=o.element;s.addEventListener(this._eventName,this._onEvent.bind(this)),this._auxiliaryEventNames.length&&this._auxiliaryEventNames.forEach((e=>{s.addEventListener(e,this._onEvent.bind(this))})),this._updateDisableHandlers(),this._sourceViewports.push(e)}addTarget(e){a(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach((e=>this.removeSource(e))),this._targetViewports.forEach((e=>this.removeTarget(e)))}remove(e){this.removeTarget(e),this.removeSource(e)}removeSource(e){const t=o(this._sourceViewports,e);if(-1===t)return;const n=function(e){const t=(0,i.getRenderingEngine)(e.renderingEngineId);if(!t)throw new Error(`No RenderingEngine for Id: ${e.renderingEngineId}`);return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._auxiliaryEventNames&&this._auxiliaryEventNames.forEach((e=>{n.removeEventListener(e,this._eventHandler)})),this._updateDisableHandlers()}removeTarget(e){const t=o(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}hasSourceViewport(e,t){return a(this._sourceViewports,{renderingEngineId:e,viewportId:t})}hasTargetViewport(e,t){return a(this._targetViewports,{renderingEngineId:e,viewportId:t})}fireEvent(e,t){if(this.isDisabled()||this._ignoreFiredEvents)return;this._ignoreFiredEvents=!0;const n=[];try{for(let i=0;i<this._targetViewports.length;i++){const o=this._targetViewports[i];if(e.viewportId===o.viewportId)continue;const a=this._eventHandler(this,e,o,t,this._options);a instanceof Promise&&n.push(a)}}catch(e){console.warn(`Synchronizer, for: ${this._eventName}`,e)}finally{n.length?Promise.allSettled(n).then((()=>{this._ignoreFiredEvents=!1})):this._ignoreFiredEvents=!1}}_hasSourceElements(){return 0!==this._sourceViewports.length}_updateDisableHandlers(){const e=function(e,t){const n=[],i=e.concat(t);for(let e=0;e<i.length;e++){const t=i[e];n.some((e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId))||n.push(t)}return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=e=>{t(e.detail.element)};e.forEach((function(e){const t=(0,i.getRenderingEngine)(e.renderingEngineId);if(!t)return;const o=t.getViewport(e.viewportId);if(!o)return;const{element:a}=o;a.removeEventListener(i.Enums.Events.ELEMENT_DISABLED,n),a.addEventListener(i.Enums.Events.ELEMENT_DISABLED,n)}))}}},74267:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(61738);const o=function(e,t){const n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(let o=0;o<i.wk.synchronizers.length;o++){const a=i.wk.synchronizers[o],s=!a.isDisabled(),r=a.hasSourceViewport(t,e),l=a.hasTargetViewport(t,e);s&&(r||l)&&n.push(a)}return n}},45114:(e,t,n)=>{n.r(t),n.d(t,{createSynchronizer:()=>a,destroy:()=>s,destroySynchronizer:()=>c,getAllSynchronizers:()=>d,getSynchronizer:()=>l,getSynchronizersForViewport:()=>r.A});var i=n(61738),o=n(30765);const a=function(e,t,n,a){if(i.wk.synchronizers.some((t=>t.id===e)))throw new Error(`Synchronizer with id '${e}' already exists.`);const s=new o.A(e,t,n,a);return i.wk.synchronizers.push(s),s};const s=function(){for(;i.wk.synchronizers.length>0;){i.wk.synchronizers.pop().destroy()}};var r=n(74267);const l=function(e){return i.wk.synchronizers.find((t=>t.id===e))};const d=function(){return i.wk.synchronizers};const c=function(e){const t=i.wk.synchronizers.findIndex((t=>t.id===e));if(t>-1){i.wk.synchronizers[t].destroy(),i.wk.synchronizers.splice(t,1)}}},63776:(e,t,n)=>{n.d(t,{A:()=>a});var i=n(92136),o=n(61738);const a=function(e,t){t||(t=(0,i.getRenderingEngines)().find((t=>t.getViewports().find((t=>t.id===e))))?.id);const n=o.wk.toolGroups.filter((n=>n.viewportsInfo.some((n=>n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)))));if(n.length){if(n.length>1)throw new Error(`Multiple tool groups found for renderingEngineId: ${t} and viewportId: ${e}. You should only\n      have one tool group per viewport in a renderingEngine.`);return n[0]}}},52610:(e,t,n)=>{n.r(t),n.d(t,{createToolGroup:()=>i.A,destroy:()=>a.A,destroyToolGroup:()=>o.A,getAllToolGroups:()=>l.A,getToolGroup:()=>s.A,getToolGroupForViewport:()=>r.A,getToolGroupsWithToolName:()=>d.A});var i=n(27630),o=n(59755),a=n(648),s=n(29697),r=n(63776),l=n(3193),d=n(64109)},61738:(e,t,n)=>{n.d(t,{xW:()=>_.A,_K:()=>D,dU:()=>S,D0:()=>c,Gx:()=>o,BU:()=>T,J2:()=>a,kq:()=>C,Bl:()=>s,wk:()=>i.Ay});var i=n(55588);function o(e){const t=e.toolName,n=void 0!==i.wk.tools[t];if(!t)throw new Error(`No Tool Found for the ToolClass ${e.name}`);if(n)throw new Error(`${t} has already been added globally`);i.wk.tools[t]={toolClass:e}}function a(e){const t=e.toolName;return!(!t||!i.wk.tools[t])}function s(e){const t=e.toolName;if(!t)throw new Error(`No tool found for: ${e.name}`);if(void 0===!i.wk.tools[t])throw new Error(`${t} cannot be removed because it has not been added`);delete i.wk.tools[t]}var r=n(60878),l=n(44926),d=n(6805);function c(e){const{element:t,viewportId:n}=e.detail,o=function(e){const t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),i=`svg-layer-${e}`;n.classList.add("svg-layer"),n.setAttribute("id",i),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";const o=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),s=document.createElementNS(t,"feOffset"),r=document.createElementNS(t,"feColorMatrix"),l=document.createElementNS(t,"feBlend");return a.setAttribute("id",`shadow-${i}`),a.setAttribute("filterUnits","userSpaceOnUse"),s.setAttribute("result","offOut"),s.setAttribute("in","SourceGraphic"),s.setAttribute("dx","0.5"),s.setAttribute("dy","0.5"),r.setAttribute("result","matrixOut"),r.setAttribute("in","offOut"),r.setAttribute("in2","matrix"),r.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),l.setAttribute("in","SourceGraphic"),l.setAttribute("in2","matrixOut"),l.setAttribute("mode","normal"),a.appendChild(s),a.appendChild(r),a.appendChild(l),o.appendChild(a),n.appendChild(o),n}(n);var a;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;i.wk.svgNodeCache[o]={}}(t),a=o,t.querySelector("div.viewport-element").appendChild(a),d.ou.addViewportElement(n,t),r.bH.enable(t),r.CG.enable(t),r.F_.enable(t),r.kt.enable(t),r._9.enable(t),l.In.enable(t),l.aB.enable(t),l.z5.enable(t),l.n6.enable(t),l.V$.enable(t),l.$m.enable(t),i.wk.enabledElements.push(t)}var h=n(92136),g=n(9933),u=n(42360),m=n(84901),v=(n(95778),n(74267)),p=n(63776);const E="viewport-element";const f=e=>{const t=(0,h.getEnabledElement)(e);(0,v.A)(t.viewportId,t.renderingEngineId).forEach((e=>{e.remove(t)}))},w=e=>{const{renderingEngineId:t,viewportId:n}=(0,h.getEnabledElement)(e),i=(0,p.A)(n,t);i&&i.removeViewports(t,n)};const I=function(e){const t=i.wk.enabledElements.findIndex((t=>t===e));t>-1&&i.wk.enabledElements.splice(t,1)},C=function(e){const{element:t,viewportId:n}=e.detail;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;delete i.wk.svgNodeCache[o]}(t),function(e){const t=e.querySelector(`div.${E}`),n=t.querySelector("svg");n&&t.removeChild(n)}(t),d.ou.removeViewportElement(n,t),r.bH.disable(t),r.CG.disable(t),r.F_.disable(t),r.kt.disable(t),r._9.disable(t),l.In.disable(t),l.aB.disable(t),l.z5.disable(t),l.n6.disable(t),l.V$.disable(t),l.$m.disable(t),f(t),w(t),I(t)};function T(e){const t=(0,u.A)(e,[m.ToolModes.Active,m.ToolModes.Passive]),n=(0,g.A)(e,t);for(const{tool:t}of n){const n=t.cancel(e);if(n)return n}}var _=n(30765),S=(n(34913),n(52610)),D=n(45114)},55588:(e,t,n)=>{n.d(t,{Ay:()=>r,qh:()=>l,wk:()=>r});var i=n(34913),o=n(48463),a=n.n(o);const s={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:i.A,enabledElements:[],handleRadius:6};let r={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:i.A,enabledElements:[],handleRadius:6};function l(){(0,i.e)(),r={...a()({...s,svgNodeCache:{}}),svgNodeCache:{...s.svgNodeCache}}}},34913:(e,t,n)=>{n.d(t,{A:()=>a,e:()=>o});let i={};function o(){i={}}const a=i},42375:(e,t,n)=>{n.r(t),n.d(t,{createCameraPositionSynchronizer:()=>r,createImageSliceSynchronizer:()=>T,createPresentationViewSynchronizer:()=>c,createSlabThicknessSynchronizer:()=>D,createStackImageSynchronizer:()=>A,createVOISynchronizer:()=>g,createZoomPanSynchronizer:()=>v});var i=n(45114),o=n(92136);function a(e,t,n,i){const{camera:a}=i.detail,s=(0,o.getRenderingEngine)(n.renderingEngineId);if(!s)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const r=s.getViewport(n.viewportId);r.setCamera(a),r.render()}const{CAMERA_MODIFIED:s}=o.Enums.Events;function r(e){return(0,i.createSynchronizer)(e,s,a)}function l(e,t,n,i,a){const s=(0,o.getRenderingEngine)(n.renderingEngineId);if(!s)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const r=s.getViewport(n.viewportId),l=s.getViewport(t.viewportId).getViewPresentation(a);r.setView(null,l),r.render()}const{CAMERA_MODIFIED:d}=o.Enums.Events;function c(e,t){return(0,i.createSynchronizer)(e,d,l,t)}function h(e,t,n,i,a){const s=i.detail,{volumeId:r,range:l,invertStateChanged:d,invert:c,colormap:h}=s,g=(0,o.getRenderingEngine)(n.renderingEngineId);if(!g)throw new Error(`Rendering Engine does not exist: ${n.renderingEngineId}`);const u=g.getViewport(n.viewportId),m={voiRange:l};if(a?.syncInvertState&&d&&(m.invert=c),a?.syncColormap&&h&&(m.colormap=h),u instanceof o.BaseVolumeViewport){u._actors&&u._actors.size>1?u.setProperties(m,r):u.setProperties(m)}else{if(!(u instanceof o.StackViewport))throw new Error("Viewport type not supported.");u.setProperties(m)}u.render()}function g(e,t){t=Object.assign({syncInvertState:!0,syncColormap:!0},t);return(0,i.createSynchronizer)(e,o.Enums.Events.VOI_MODIFIED,h,{auxiliaryEventNames:[o.Enums.Events.COLORMAP_MODIFIED],...t})}function u(e,t,n){const i=(0,o.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const a=e.getOptions(n.viewportId),s=i.getViewport(n.viewportId),r=i.getViewport(t.viewportId);if(!1!==a?.syncZoom){const e=r.getZoom();s.setZoom(e)}if(!1!==a?.syncPan){const e=r.getPan();s.setPan(e)}s.render()}const{CAMERA_MODIFIED:m}=o.Enums.Events;function v(e){return(0,i.createSynchronizer)(e,m,u)}var p=n(44753),E=n(74119);const f=(e,t)=>o.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",e,t);async function w(e,t,n){const i=(0,o.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const a=i.getViewport(t.viewportId),s=e.getOptions(n.viewportId);if(s?.disabled)return;const r=i.getViewport(n.viewportId),l=a.getCurrentImageId(),d=o.metaData.get("imagePlaneModule",l).imagePositionPatient,c=r.getImageIds();if(!function(e,t){const{viewPlaneNormal:n}=e.getCamera(),{viewPlaneNormal:i}=t.getCamera(),o=p.eR.dot(n,i);return Math.abs(o)>.9}(a,r))return;let h=f(n.viewportId,t.viewportId);if(!h){if(a.getFrameOfReferenceUID()===r.getFrameOfReferenceUID()&&!1!==s?.useInitialPosition?h=p.pB.identity(p.pB.create()):(o.utilities.calculateViewportsSpatialRegistration(a,r),h=f(n.viewportId,t.viewportId)),!h)return}const g=p.eR.transformMat4(p.eR.create(),d,h),u=(m=g,c.reduce(((e,t,n)=>{const{imagePositionPatient:i}=o.metaData.get("imagePlaneModule",t),a=p.eR.distance(i,m);return a<e.distance?{distance:a,index:n}:e}),{distance:1/0,index:-1}));var m;let v=u.index;r instanceof o.VolumeViewport&&(v=c.length-u.index-1),-1!==u.index&&r.getCurrentImageIdIndex()!==u.index&&await(0,E.jumpToSlice)(r.element,{imageIndex:v})}const{STACK_NEW_IMAGE:I,VOLUME_NEW_IMAGE:C}=o.Enums.Events;function T(e){return(0,i.createSynchronizer)(e,I,w,{auxiliaryEventNames:[C]})}function _(e,t,n){const i=(0,o.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const a=i.getViewport(n.viewportId),s=i.getViewport(t.viewportId),r=s.getSlabThickness?.();r&&(a.setSlabThickness?.(r),a.render())}const{CAMERA_MODIFIED:S}=o.Enums.Events;function D(e){return(0,i.createSynchronizer)(e,S,_)}const A=T},73168:(e,t,n)=>{n.d(t,{A:()=>f});var i,o=n(96214),a=n(92136),s=n(38296),r=n(48428),l=n(21009),d=n(54177),c=n(2746),h=n(61738),g=n(84901),u=n(90252),m=n(40233),v=n(23072),p=n(75162),E=n(69847);!function(e){e.ShowZoomFactorsList="showZoomFactorsList"}(i||(i={}));class f extends o.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:3,zoomFactorList:[1.5,2,2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:{showZoomFactorsList:{method:"showZoomFactorsList",bindings:[{mouseButton:g.MouseBindings.Secondary,modifierKey:g.KeyboardBindings.Shift}]}}}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=(0,a.getEnabledElement)(i),{viewport:r,renderingEngine:l}=o,d=n.world,c=n.canvas,{magnifyingGlass:h}=this.configuration,{radius:g,zoomFactor:m,autoPan:p}=h,E=this._getCanvasHandlePoints(c,g),f=r.getCamera(),{viewPlaneNormal:w,viewUp:I}=f,C=this.getReferencedImageId(r,d,w,I),T=a.utilities.uuidv4(),_=a.utilities.uuidv4(),S=r.getFrameOfReferenceUID(),D={annotationUID:T,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...w],viewUp:[...I],FrameOfReferenceUID:S,referencedImageId:C},data:{sourceViewportId:r.id,magnifyViewportId:_,zoomFactor:m,isCanvasAnnotation:!0,handles:{points:E,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(D,{magnifyViewportId:_,sourceEnabledElement:o,position:c,radius:g,zoomFactor:m,autoPan:{enabled:p.enabled,padding:p.padding,callback:e=>{const t=D.data.handles.points,{canvas:n}=e.delta;for(let e=0,i=t.length;e<i;e++){const i=t[e];i[0]+=n[0],i[1]+=n[1],D.invalidated=!0}}}}),(0,s.addAnnotation)(D,i);const A=(0,u.getViewportIdsWithToolToRender)(i,this.getToolName());return e.preventDefault(),(0,v.A)(l,A),D},this.onSetToolDisabled=()=>{this.magnifyViewportManager.dispose();(0,s.getAllAnnotations)().forEach((e=>{e.metadata.toolName===this.getToolName()&&(0,s.removeAnnotation)(e.annotationUID)}))},this.isPointNearTool=(e,t,n,i)=>{const{data:o}=t,{points:a}=o.handles,s=a,r=s[0],l=s[2],d=s[3],c=.5*Math.abs(l[1]-r[1]),h=[d[0]+c,r[1]+c],g=(0,p.r)([h,n]);return Math.abs(g-c)<2*i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const o=(0,u.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:o},(0,m.hideElementCursor)(i),this._activateModify(i);const s=(0,a.getEnabledElement)(i),{renderingEngine:r}=s;(0,v.A)(r,o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i,{data:s}=t;t.highlighted=!0;const{points:r}=s.handles,l=r.findIndex((e=>e===n)),d=(0,u.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:l},this._activateModify(o),(0,m.hideElementCursor)(o);const c=(0,a.getEnabledElement)(o),{renderingEngine:h}=c;(0,v.A)(h,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:s}=this.editData,{data:r}=i;r.handles.activeHandleIndex=null,this._deactivateModify(n),(0,m.resetElementCursor)(n);const l=(0,a.getEnabledElement)(n),{renderingEngine:c}=l;this.editData=null,this.isDrawing=!1,(0,v.A)(c,o),s&&(0,d.dZ)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n,deltaPoints:i}=t,o=i?.canvas??[0,0,0],s=(0,a.getEnabledElement)(n),{renderingEngine:r}=s,{annotation:l,viewportIdsToRender:d}=this.editData,{points:c}=l.data.handles;c.forEach((e=>{e[0]+=o[0],e[1]+=o[1]})),l.invalidated=!0,this.editData.hasMoved=!0,(0,v.A)(r,d)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:s}=this.editData,{data:r}=i;if(void 0===s){const{deltaPoints:e}=t,n=e.canvas;r.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const l=(0,a.getEnabledElement)(n),{renderingEngine:d}=l;(0,v.A)(d,o)},this._dragHandle=e=>{const t=e.detail,{annotation:n}=this.editData,{data:i}=n,{points:o}=i.handles,a=o,s=a[0],r=a[2],l=a[3],d=.5*Math.abs(r[1]-s[1]),c=[l[0]+d,s[1]+d],{currentPoints:h}=t,g=h.canvas,u=(0,p.r)([c,g]),m=this._getCanvasHandlePoints(c,u);o[0]=m[0],o[1]=m[1],o[2]=m[2],o[3]=m[3]},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),(0,m.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;t.highlighted=!1,o.handles.activeHandleIndex=null;const s=(0,a.getEnabledElement)(e),{renderingEngine:r}=s;return(0,v.A)(r,n),i&&(0,d.dZ)(t),this.editData=null,t.annotationUID},this._activateModify=e=>{h.wk.isInteractingWithTool=!0,e.addEventListener(g.Events.MOUSE_UP,this._endCallback),e.addEventListener(g.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(g.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(g.Events.TOUCH_END,this._endCallback),e.addEventListener(g.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(g.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{h.wk.isInteractingWithTool=!1,e.removeEventListener(g.Events.MOUSE_UP,this._endCallback),e.removeEventListener(g.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(g.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(g.Events.TOUCH_END,this._endCallback),e.removeEventListener(g.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(g.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,s.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;a=a?.filter((e=>e.data.sourceViewportId===i.id));const d=this.filterInteractableAnnotationsForElement(o,a);if(!d?.length)return n;const h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<d.length;e++){const o=d[e],{annotationUID:a,data:s}=o,{magnifyViewportId:g,zoomFactor:u,handles:m}=s,{points:v,activeHandleIndex:p}=m;h.annotationUID=a;this.getStyle("lineWidth",h,o),this.getStyle("lineDash",h,o);const E=this.getStyle("color",h,o),f=v,w=f[0],I=f[2],C=f[3],T=.5*Math.abs(I[1]-w[1]),_=[C[0]+T,w[1]+T];if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let S;if(!(0,l.isAnnotationVisible)(a))continue;if((0,r.isAnnotationLocked)(o)||this.editData||null===p||(S=[f[p]]),S){const e="0";(0,c.drawHandles)(t,a,e,S,{color:E})}const D=`${a}-advancedMagnify`,A="0";(0,c.drawCircle)(t,a,A,_,T,{color:E,lineWidth:5},D);const b=this.magnifyViewportManager.getViewport(g);b.position=_,b.radius=T,b.zoomFactor=u,b.update(),n=!0}return n},this._getCanvasHandlePoints=(e,t)=>[[e[0],e[1]-t,0],[e[0]+t,e[1],0],[e[0],e[1]+t,0],[e[0]-t,e[1],0]],this.magnifyViewportManager=E.A.getInstance()}static{this.Actions=i}showZoomFactorsList(e,t){const{element:n,currentPoints:i}=e.detail,o=(0,a.getEnabledElement)(n),{viewport:s}=o,{canvas:r}=i,l=n.querySelector(":scope .viewport-element"),d=t.data.zoomFactor,c=this._getZoomFactorsListDropdown(d,(e=>{void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),c.parentElement.removeChild(c),s.render()}));Object.assign(c.style,{left:`${r[0]}px`,top:`${r[1]}px`}),l.appendChild(c),c.focus()}_getZoomFactorsListDropdown(e,t){const{zoomFactorList:n}=this.configuration.magnifyingGlass,i=document.createElement("select");return i.size=5,Object.assign(i.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach((e=>{i.addEventListener(e,(e=>e.stopPropagation()))})),i.addEventListener("change",(e=>{e.stopPropagation(),t(i.value)})),i.addEventListener("keydown",(e=>{((e.keyCode??27===e.which)||"escape"===e.key?.toLowerCase())&&(e.stopPropagation(),t())})),n.forEach((t=>{const n=document.createElement("option");n.label=t,n.title=`Zoom factor ${t.toFixed(1)}`,n.value=t,n.defaultSelected=t===e,i.add(n)})),i}}f.toolName="AdvancedMagnify"},7336:(e,t,n)=>{n.d(t,{A:()=>l});var i=n(96214),o=n(61738),a=n(38296),s=n(42351);class r extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>this._deleteNearbyAnnotations(e,"mouse"),this.preTouchStartCallback=e=>this._deleteNearbyAnnotations(e,"touch")}_deleteNearbyAnnotations(e,t){const{renderingEngineId:n,viewportId:i,element:r,currentPoints:l}=e.detail,d=o.dU.getToolGroupForViewport(i,n);if(!d)return!1;const c=d._toolInstances,h=[];for(const e in c){const n=c[e];if("function"!=typeof n.isPointNearTool||"function"!=typeof n.filterInteractableAnnotationsForElement)continue;const i=(0,a.getAnnotations)(e,r);if(!i)continue;const o=n.filterInteractableAnnotationsForElement(r,i);for(const e of o)n.isPointNearTool(r,e,l.canvas,10,t)&&h.push(e.annotationUID)}for(const e of h)(0,s.setAnnotationSelected)(e),(0,a.removeAnnotation)(e);return e.preventDefault(),!0}}r.toolName="Eraser";const l=r},91976:(e,t,n)=>{n.d(t,{A:()=>y});var i=n(44753),o=n(61199),a=n(52961),s=n(96214),r=n(92136),l=n(52610),d=n(38296),c=n(2746),h=n(61738),g=n(84901),u=n(90252),m=n(40233),v=n(86981),p=n(21954),E=n(48428),f=n(23072);const{RENDERING_DEFAULTS:w}=r.CONSTANTS;function I(){return"rgb(0, 200, 0)"}function C(){return!0}function T(){return!0}function _(){return!0}const S=1,D=2,A=3;class b extends s.EC{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:r.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}}){super(e,t),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{const n=(0,r.getEnabledElementByIds)(t,e),{FrameOfReferenceUID:i,viewport:o}=n,{element:a}=o,{position:s,focalPoint:l,viewPlaneNormal:c}=o.getCamera();let h=this._getAnnotations(n);h=this.filterInteractableAnnotationsForElement(a,h),h.length&&(0,d.removeAnnotation)(h[0].annotationUID);const g={highlighted:!1,metadata:{cameraPosition:[...s],cameraFocalPoint:[...l],FrameOfReferenceUID:i,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:t}};return(0,d.addAnnotation)(g,a),{normal:c,point:o.canvasToWorld([o.canvas.clientWidth/2,o.canvas.clientHeight/2])}},this._getViewportsInfo=()=>(0,l.getToolGroup)(this.toolGroupId).viewportsInfo,this.resetCrosshairs=()=>{const e=this._getViewportsInfo();e.forEach((({viewportId:e,renderingEngineId:t})=>{const n=(0,r.getEnabledElementByIds)(e,t),{viewport:i}=n,{element:o}=i;let a=this._getAnnotations(n);a=this.filterInteractableAnnotationsForElement(o,a),a.length&&(0,d.removeAnnotation)(a[0].annotationUID)})),this.computeToolCenter(e)},this.computeToolCenter=e=>{if(!e.length||1===e.length)return void console.warn("For crosshairs to operate, at least two viewports must be given.");const[t,n,o]=e,{normal:a,point:s}=this.initializeViewport(t),{normal:l,point:d}=this.initializeViewport(n);let c=[0,0,0],h=i.eR.create();o?({normal:c,point:h}=this.initializeViewport(o)):(i.eR.add(h,s,d),i.eR.scale(h,h,.5),i.eR.cross(c,a,l));const g=r.utilities.planar.planeEquation(a,s),u=r.utilities.planar.planeEquation(l,d),m=r.utilities.planar.planeEquation(c,h);this.toolCenter=r.utilities.planar.threePlaneIntersection(g,u,m);const{renderingEngine:v}=(0,r.getEnabledElementByIds)(e[0].viewportId,e[0].renderingEngineId);(0,f.A)(v,e.map((({viewportId:e})=>e)))},this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,{currentPoints:i}=t,o=i.world,a=(0,r.getEnabledElement)(n),{viewport:s}=a;this._jump(a,o);const l=this._getAnnotations(a),d=this.filterInteractableAnnotationsForElement(s.element,l),{data:c}=d[0],{rotationPoints:h}=c.handles,g=[];for(let e=0;e<h.length-1;++e){const t=h[e][1],n=this._getReferenceLineControllable(t.id),i=this._getReferenceLineDraggableRotatable(t.id);n&&i&&(g.push(t.id),e++)}return c.activeViewportIds=[...g],c.handles.activeOperation=S,e.preventDefault(),(0,m.hideElementCursor)(n),this._activateModify(n),d[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0,this._activateModify(i),(0,m.hideElementCursor)(i),e.preventDefault()},this.isPointNearTool=(e,t,n,i)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const i=e.detail,{element:o}=i;t.highlighted=!0,this._activateModify(o),(0,m.hideElementCursor)(o),e.preventDefault()},this.onCameraModified=e=>{const t=e.detail,{element:n}=t,i=(0,r.getEnabledElement)(n),{renderingEngine:a}=i,s=i.viewport,d=this._getAnnotations(i),c=this.filterInteractableAnnotationsForElement(n,d)[0];if(!c)return;const h=s.getCamera(),g=c.metadata.cameraPosition,m=[0,0,0];o.Ay.subtract(h.position,g,m);const v=c.metadata.cameraFocalPoint,p=[0,0,0];o.Ay.subtract(h.focalPoint,v,p),c.metadata.cameraPosition=[...h.position],c.metadata.cameraFocalPoint=[...h.focalPoint];const E=this._getReferenceLineControllable(s.id),w=this._getReferenceLineDraggableRotatable(s.id);if(!r.utilities.isEqual(h.position,g,.001)&&E&&w){let e=!1;r.utilities.isEqual(m,p,.001)||(e=!0);const t=Math.abs(o.Ay.dot(m,h.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=m[0],this.toolCenter[1]+=m[1],this.toolCenter[2]+=m[2])}if(this.configuration.autoPan?.enabled){(0,l.getToolGroupForViewport)(s.id,a.id).getViewportIds().filter((e=>e!==s.id)).forEach((e=>{this._autoPanViewportIfNecessary(e,a)}))}const I=(0,u.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,f.A)(a,I)},this.mouseMoveCallback=(e,t)=>{const{element:n,currentPoints:i}=e.detail,o=i.canvas;let a=!1;for(let e=0;e<t.length;e++){const i=t[e];if((0,E.isAnnotationLocked)(i))continue;const{data:s,highlighted:r}=i;if(!s.handles)continue;const l=s.handles.activeOperation,d=s.activeViewportIds&&s.activeViewportIds.length>0?[...s.activeViewportIds]:[];s.activeViewportIds=[],s.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,i,o,6)||this._pointNearTool(n,i,o,6);c&&!r||!c&&r?(i.highlighted=!r,a=!0):s.handles.activeOperation===l&&this._areViewportIdArraysEqual(s.activeViewportIds,d)||(a=!0)}return a},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,r.getEnabledElement)(e),{viewportId:i}=n;return t.filter((e=>e.data.viewportId===i))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:s,renderingEngine:r}=e,{element:l}=s,d=this._getAnnotations(e),h=s.getCamera(),g=this.filterInteractableAnnotationsForElement(l,d)[0];if(!d?.length||!g?.data)return n;const u=g.annotationUID,{clientWidth:m,clientHeight:p}=s.canvas,E=Math.sqrt(m*m+p*p),f=Math.min(m,p),w=g.data,I=s.worldToCanvas(this.toolCenter),C=this._filterAnnotationsByUniqueViewportOrientations(e,d),T=[],_=[0,0,m,p];C.forEach((e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=r.getViewport(t.viewportId),l=n.getCamera(),d=this._getReferenceLineControllable(n.id),c=this._getReferenceLineDraggableRotatable(n.id),g=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:u,clientHeight:m}=n.canvas,p=Math.sqrt(u*u+m*m),w=[.5*u,.5*m],S=n.canvasToWorld(w),D=[0,0,0];o.Ay.cross(h.viewPlaneNormal,l.viewPlaneNormal,D),o.Ay.normalize(D),o.Ay.multiplyScalar(D,p);const A=[0,0,0];o.Ay.add(S,D,A);const b=[0,0,0];o.Ay.subtract(S,D,b);const y=s.worldToCanvas(A),R=s.worldToCanvas(S),O=i.Zc.create();i.Zc.subtract(O,y,R),i.Zc.normalize(O,O);const M=i.Zc.create();i.Zc.scale(M,O,100*E);const x=i.Zc.create();i.Zc.scale(x,O,.4*f);const L=i.Zc.create();i.Zc.scale(L,O,.2*f);const U=i.Zc.create(),N=this.configuration.referenceLinesCenterGapRadius;i.Zc.scale(U,O,2===C.length?N:0);const P=i.Zc.create(),k=i.Zc.create(),V=i.Zc.create(),W=i.Zc.create();let H=i.Zc.clone(I);c&&d||(H=i.Zc.clone(R)),i.Zc.add(P,H,U),i.Zc.add(k,H,M),i.Zc.subtract(V,H,U),i.Zc.subtract(W,H,M),(0,v.A)(P,k,_),(0,v.A)(V,W,_);const B=i.Zc.create();i.Zc.subtract(B,I,x);const F=i.Zc.create();i.Zc.add(F,I,x);let G=i.Zc.clone(I);!c&&g&&(G=i.Zc.clone(R));let $=[...this.toolCenter];!c&&g&&($=[...S]);const q=[0,0,0];o.Ay.subtract(A,b,q),o.Ay.normalize(q);const{viewPlaneNormal:z}=h,{matrix:Z}=a.A.buildFromDegree().rotate(90,z),K=[0,0,0];i.eR.transformMat4(K,q,Z);const j=n.getSlabThickness(),Y=[...K];o.Ay.multiplyScalar(Y,j);const X=[0,0,0];o.Ay.add($,Y,X);const J=s.worldToCanvas(X),Q=i.Zc.create();i.Zc.subtract(Q,G,J);const ee=i.Zc.create();i.Zc.subtract(ee,G,M),i.Zc.add(ee,ee,Q);const te=i.Zc.create();i.Zc.add(te,G,M),i.Zc.add(te,te,Q),(0,v.A)(ee,te,_);const ne=i.Zc.create();i.Zc.add(ne,G,M),i.Zc.subtract(ne,ne,Q);const ie=i.Zc.create();i.Zc.subtract(ie,G,M),i.Zc.subtract(ie,ie,Q),(0,v.A)(ne,ie,_);const oe=i.Zc.create(),ae=i.Zc.create(),se=i.Zc.create(),re=i.Zc.create();i.Zc.subtract(oe,G,L),i.Zc.add(oe,oe,Q),i.Zc.add(ae,G,L),i.Zc.add(ae,ae,Q),i.Zc.subtract(se,G,L),i.Zc.subtract(se,se,Q),i.Zc.add(re,G,L),i.Zc.subtract(re,re,Q),T.push([n,P,k,V,W,ee,te,ne,ie,B,F,oe,ae,se,re])}));const b=[],y=[],R=this._getReferenceLineColor(s.id),O=void 0!==R?R:"rgb(200, 200, 200)";if(T.forEach(((e,n)=>{const i=e[0],o=this._getReferenceLineColor(i.id),a=this._getReferenceLineControllable(i.id),r=this._getReferenceLineDraggableRotatable(i.id)||this.configuration.mobile?.enabled,l=this._getReferenceLineSlabThicknessControlsOn(i.id)||this.configuration.mobile?.enabled,d=w.activeViewportIds.find((e=>e===i.id));let h=void 0!==o?o:"rgb(200, 200, 200)",g=1;const m=null!==w.handles.activeOperation&&w.handles.activeOperation===S&&d;m&&(g=2.5);let v=`${n}`;if(a&&r?(v=`${n}One`,(0,c.drawLine)(t,u,v,e[1],e[2],{color:h,lineWidth:g}),v=`${n}Two`,(0,c.drawLine)(t,u,v,e[3],e[4],{color:h,lineWidth:g})):(0,c.drawLine)(t,u,v,e[2],e[4],{color:h,lineWidth:g}),a){h=void 0!==o?o:"rgb(200, 200, 200)";const a=w.handles.activeOperation===D,g=[e[9],e[10]],p=[s.canvasToWorld(e[9]),i,e[1],e[2]],E=[s.canvasToWorld(e[10]),i,e[3],e[4]];b.push(p,E);const f=w.handles.activeOperation===A,I=[e[11],e[12],e[13],e[14]],C=[s.canvasToWorld(e[11]),i,e[5],e[6]],T=[s.canvasToWorld(e[12]),i,e[5],e[6]],_=[s.canvasToWorld(e[13]),i,e[7],e[8]],S=[s.canvasToWorld(e[14]),i,e[7],e[8]];if(y.push(C,T,_,S),(m||this.configuration.mobile?.enabled)&&!a&&!f&&r&&l){let e=`${n}One`;(0,c.drawHandles)(t,u,e,g,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"}),e=`${n}Two`,(0,c.drawHandles)(t,u,e,I,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(m&&!a&&!f&&r){const e=`${n}`;(0,c.drawHandles)(t,u,e,g,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"circle"})}else if(d&&!a&&!f&&l){const e=`${n}`;(0,c.drawHandles)(t,u,e,I,{color:h,handleRadius:this.configuration.mobile?.enabled?this.configuration.mobile?.handleRadius:3,opacity:this.configuration.mobile?.enabled?this.configuration.mobile?.opacity:1,type:"rect"})}else if(a&&r){const e=`${n}`;(0,c.drawHandles)(t,u,e,g,{color:h,handleRadius:2,fill:h,type:"circle"})}else f&&d&&l&&(0,c.drawHandles)(t,u,v,I,{color:h,handleRadius:2,fill:h,type:"rect"});i.getSlabThickness()>.5&&l&&(v=`${n}STOne`,(0,c.drawLine)(t,u,v,e[5],e[6],{color:h,width:1,lineDash:[2,3]}),v=`${n}STTwo`,(0,c.drawLine)(t,u,v,e[7],e[8],{color:h,width:e,lineDash:[2,3]}))}})),n=!0,w.handles.rotationPoints=b,w.handles.slabThicknessPoints=y,this.configuration.viewportIndicators){const e=[.95*m,.05*p],n=.01*E,i="0";(0,c.drawCircle)(t,u,i,e,n,{color:O,fill:O})}return n},this._getAnnotations=e=>{const{viewport:t}=e,n=(0,d.getAnnotations)(this.getToolName(),t.element)||[],i=this._getViewportsInfo().map((({viewportId:e})=>e));return n.filter((e=>{const{data:t}=e;return i.includes(t.viewportId)}))},this._onNewVolume=e=>{const t=this._getViewportsInfo();this.computeToolCenter(t)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach((e=>{let n=!1;for(let i=0;i<t.length;++i)if(e===t[i]){n=!0;break}if(!1===n)return!1})),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:i,viewport:o}=e,a=t.filter((e=>e.data.viewportId!==n));if(!a||!a.length)return[];const s=o.getCamera(),{viewPlaneNormal:l,position:d}=s,c=a.filter((e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera();return!(r.utilities.isEqual(n.viewPlaneNormal,l,.01)&&r.utilities.isEqual(n.position,d,1))}));return c},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:i}=e,{data:a}=t,s=i.getViewport(a.viewportId),l=n.filter((e=>{const{data:t}=e,n=i.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)}));if(!l||!l.length)return[];const d=s.getCamera(),c=d.viewPlaneNormal;o.Ay.normalize(c);return l.filter((e=>{const{viewportId:t}=e.data,n=i.getViewport(t).getCamera(),a=n.viewPlaneNormal;return o.Ay.normalize(a),r.utilities.isEqual(c,a,.01)&&r.utilities.isEqual(d.viewUp,n.viewUp,.01)}))},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{const{renderingEngine:n,viewport:i}=e,a=i.getCamera().viewPlaneNormal;o.Ay.normalize(a);const s=t.filter((e=>{const{data:t}=e,o=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(o.id);return i!==o&&!0===a})),l=[];for(let e=0;e<s.length;++e){const t=s[e],{viewportId:i}=t.data,d=n.getViewport(i).getCamera(),c=d.viewPlaneNormal;if(o.Ay.normalize(c),r.utilities.isEqual(a,c,.01)||r.utilities.isOpposite(a,c,.01))continue;let h=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();r.utilities.isEqual(o.viewPlaneNormal,d.viewPlaneNormal,.01)&&r.utilities.isEqual(o.position,d.position,1)&&(h=!0)}h||l.push(t)}const d=t.filter((e=>{const{data:t}=e,o=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(o.id);return i!==o&&!0!==a}));for(let e=0;e<d.length;++e){const t=d[e],{viewportId:i}=t.data,s=n.getViewport(i).getCamera(),c=s.viewPlaneNormal;if(o.Ay.normalize(c),r.utilities.isEqual(a,c,.01)||r.utilities.isOpposite(a,c,.01))continue;let h=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();r.utilities.isEqual(o.viewPlaneNormal,s.viewPlaneNormal,.01)&&r.utilities.isEqual(o.position,s.position,1)&&(h=!0)}h||l.push(t)}const c=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<c.length;++e){const t=c[e];if(l.some((e=>e===t)))continue;const{viewportId:i}=t.data,s=n.getViewport(i).getCamera(),d=s.viewPlaneNormal;if(o.Ay.normalize(d),r.utilities.isEqual(a,d,.01)||r.utilities.isOpposite(a,d,.01))continue;let h=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:i}=t.data,o=n.getViewport(i).getCamera();r.utilities.isEqual(o.viewPlaneNormal,s.viewPlaneNormal,.01)&&r.utilities.isEqual(o.position,s.position,1)&&(h=!0)}h||l.push(t)}return l},this._checkIfViewportsRenderingSameScene=(e,t)=>{const n=e.getActors(),i=t.getActors();let o=!0;return n.forEach((e=>{n.length===i.length&&void 0!==i.find((({uid:t})=>t===e.uid))||(o=!1)})),o},this._jump=(e,t)=>{h.wk.isInteractingWithTool=!0;const{viewport:n,renderingEngine:i}=e,a=this._getAnnotations(e),s=[0,0,0];o.Ay.subtract(t,this.toolCenter,s);const r=this._getAnnotationsForViewportsWithDifferentCameras(e,a).filter((e=>{const{data:t}=e,o=i.getViewport(t.viewportId),a=this._checkIfViewportsRenderingSameScene(n,o);return this._getReferenceLineControllable(o.id)&&this._getReferenceLineDraggableRotatable(o.id)&&a}));return 0===r.length?(h.wk.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(i,r,s),h.wk.isInteractingWithTool=!1,!0)},this._activateModify=e=>{h.wk.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(g.Events.MOUSE_UP,this._endCallback),e.addEventListener(g.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(g.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(g.Events.TOUCH_END,this._endCallback),e.addEventListener(g.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(g.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{h.wk.isInteractingWithTool=!1,e.removeEventListener(g.Events.MOUSE_UP,this._endCallback),e.removeEventListener(g.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(g.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(g.Events.TOUCH_END,this._endCallback),e.removeEventListener(g.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(g.Events.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),(0,m.resetElementCursor)(n),this.editData=null;const i=(0,r.getEnabledElement)(n),{renderingEngine:o}=i,a=(0,u.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,f.A)(o,a)},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:s}=t,d=(0,r.getEnabledElement)(s),{renderingEngine:c,viewport:h}=d,g=this._getAnnotations(d),u=this.filterInteractableAnnotationsForElement(s,g)[0];if(!u)return;const{handles:m}=u.data,{currentPoints:v}=e.detail,p=v.canvas;if(m.activeOperation===S){const e=this._getAnnotationsForViewportsWithDifferentCameras(d,g).filter((e=>{const{data:t}=e,n=c.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o&&u.data.activeViewportIds.find((e=>e===n.id))}));this._applyDeltaShiftToSelectedViewportCameras(c,e,n)}else if(m.activeOperation===D){const e=this._getAnnotationsForViewportsWithDifferentCameras(d,g).filter((e=>{const{data:t}=e,n=c.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineDraggableRotatable(n.id);return!0===i&&!0===o})),n=i.Zc.create(),o=i.Zc.create(),s=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],r=h.worldToCanvas(s),l=t.currentPoints.canvas,u=i.Zc.create();i.Zc.sub(u,l,t.deltaPoints.canvas),i.Zc.sub(n,u,r),i.Zc.sub(o,l,r);let m=i.Zc.angle(n,o);this._isClockWise(r,u,l)&&(m*=-1),m=Math.round(100*m)/100;const v=h.getCamera().viewPlaneNormal,{matrix:p}=a.A.buildFromRadian().translate(s[0],s[1],s[2]).rotate(m,v).translate(-s[0],-s[1],-s[2]),E=[];e.forEach((e=>{const{data:t}=e;t.handles.toolCenter=s;const n=c.getViewport(t.viewportId),o=n.getCamera(),{viewUp:a,position:r,focalPoint:l}=o;a[0]+=r[0],a[1]+=r[1],a[2]+=r[2],i.eR.transformMat4(l,l,p),i.eR.transformMat4(r,r,p),i.eR.transformMat4(a,a,p),a[0]-=r[0],a[1]-=r[1],a[2]-=r[2],n.setCamera({position:r,viewUp:a,focalPoint:l}),E.push(n.id)})),c.renderViewports(E)}else if(m.activeOperation===A){const e=this._getAnnotationsForViewportsWithDifferentCameras(d,g).filter((e=>{const{data:t}=e,n=c.getViewport(t.viewportId),i=this._getReferenceLineControllable(n.id),o=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===i&&!0===o&&u.data.activeViewportIds.find((e=>e===n.id))}));if(0===e.length)return;const a=this._filterViewportWithSameOrientation(d,e[0],g),s=[];s.push(h.id),a.forEach((e=>{const{data:a}=e,d=c.getViewport(a.viewportId),g=d.getCamera().viewPlaneNormal,m=o.Ay.dot(n,g),v=[...g];if(o.Ay.multiplyScalar(v,m),Math.abs(v[0])>.001||Math.abs(v[1])>.001||Math.abs(v[2])>.001){const e=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]),n=t.lastPoints.world,a=[0,0,0],m=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(d.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter((e=>e[1].uid===d.id));if(2===t.length){const e=h.canvasToWorld(t[0][3]),n=h.canvasToWorld(t[1][3]);o.Ay.add(e,n,m),o.Ay.multiplyScalar(m,.5)}}o.Ay.subtract(n,m,a);const E=o.Ay.dot(a,g),f=[...g];o.Ay.multiplyScalar(f,E);const I=[f[0],f[1],f[2]];i.eR.normalize(I,I);const C=[v[0],v[1],v[2]];i.eR.normalize(C,C);let T=d.getSlabThickness();r.utilities.isOpposite(I,C,.001)?T-=e:T+=e,T=Math.abs(T),T=Math.max(w.MINIMUM_SLAB_THICKNESS,T);this._pointNearReferenceLine(u,p,6,d)&&(T=w.MINIMUM_SLAB_THICKNESS);(0,l.getToolGroupForViewport)(d.id,c.id).getToolInstance(this.getToolName()).setSlabThickness(d,T),s.push(d.id)}})),c.renderViewports(s)}},this._pointNearReferenceLine=(e,t,n,i)=>{const{data:o}=e,{rotationPoints:a}=o.handles;for(let e=0;e<a.length-1;++e){const o=a[e][1];if(o.id!==i.id)continue;if(!this._getReferenceLineControllable(o.id))continue;const s={start:{x:a[e][2][0],y:a[e][2][1]},end:{x:a[e][3][0],y:a[e][3][1]}},r=p.distanceToPoint([s.start.x,s.start.y],[s.end.x,s.end.y],[t[0],t[1]]),l={start:{x:a[e+1][2][0],y:a[e+1][2][1]},end:{x:a[e+1][3][0],y:a[e+1][3][1]}},d=p.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(r<=n||d<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||I,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||C,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||T,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||_}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this.computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach((({renderingEngineId:e,viewportId:t})=>{const n=(0,r.getEnabledElementByIds)(t,e);if(!n)return;const i=this._getAnnotations(n);i?.length&&i.forEach((e=>{(0,d.removeAnnotation)(e.annotationUID)}))}))}getHandleNearImagePoint(e,t,n,i){const o=(0,r.getEnabledElement)(e),{viewport:a}=o;let s=this._getRotationHandleNearImagePoint(a,t,n,i);return null!==s?s:(s=this._getSlabThicknessHandleNearImagePoint(a,t,n,i),null!==s?s:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,r.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(r.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_subscribeToViewportNewVolumeSet(e){e.forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,r.getEnabledElementByIds)(e,t),{element:i}=n;i.addEventListener(r.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)}))}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:i,clientHeight:o}=n.canvas,a=n.worldToCanvas(this.toolCenter),s=this.configuration.autoPan.panSize,r=[a[0],a[1]];if(a[0]<0?r[0]=s:a[0]>i&&(r[0]=i-s),a[1]<0?r[1]=s:a[1]>o&&(r[1]=o-s),r[0]===a[0]&&r[1]===a[1])return;const l=n.canvasToWorld(r),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:h,position:g}=c,u=[g[0]-d[0],g[1]-d[1],g[2]-d[2]],m=[h[0]-d[0],h[1]-d[1],h[2]-d[2]];n.setCamera({focalPoint:m,position:u}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:i}=this.configuration;i&&i.length>0&&(n=i);let o=this.configuration.slabThicknessBlendMode;t===w.MINIMUM_SLAB_THICKNESS&&(o=r.Enums.BlendModes.COMPOSITE);e.setBlendMode(o,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach((t=>{this._applyDeltaShiftToViewportCamera(e,t,n)}))}_applyDeltaShiftToViewportCamera(e,t,n){const{data:i}=t,a=e.getViewport(i.viewportId),s=a.getCamera(),r=s.viewPlaneNormal,l=o.Ay.dot(n,r),d=[...r];if(o.Ay.multiplyScalar(d,l),Math.abs(d[0])>.001||Math.abs(d[1])>.001||Math.abs(d[2])>.001){const e=[0,0,0],t=[0,0,0];o.Ay.add(s.focalPoint,d,e),o.Ay.add(s.position,d,t),a.setCamera({focalPoint:e,position:t}),a.render()}}_getRotationHandleNearImagePoint(e,t,n,o){const{data:a}=t,{rotationPoints:s}=a.handles;for(let r=0;r<s.length;r++){const l=s[r][0],d=s[r][1];if(!this._getReferenceLineControllable(d.id))continue;if(!this._getReferenceLineDraggableRotatable(d.id))continue;const c=e.worldToCanvas(l);if(i.Zc.distance(n,c)<o)return a.handles.activeOperation=D,this.editData={annotation:t},l}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,o){const{data:a}=t,{slabThicknessPoints:s}=a.handles;for(let r=0;r<s.length;r++){const l=s[r][0],d=s[r][1];if(!this._getReferenceLineControllable(d.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(d.id))continue;const c=e.worldToCanvas(l);if(i.Zc.distance(n,c)<o)return a.handles.activeOperation=A,a.activeViewportIds=[d.id],this.editData={annotation:t},l}return null}_pointNearTool(e,t,n,o){const a=(0,r.getEnabledElement)(e),{viewport:s}=a,{clientWidth:l,clientHeight:d}=s.canvas,c=Math.sqrt(l*l+d*d),{data:h}=t,{rotationPoints:g}=h.handles,{slabThicknessPoints:u}=h.handles,m=[];for(let e=0;e<g.length-1;++e){const t=g[e][1],i=this._getReferenceLineControllable(t.id),a=this._getReferenceLineDraggableRotatable(t.id);if(!i||!a)continue;const s={start:{x:g[e][2][0],y:g[e][2][1]},end:{x:g[e][3][0],y:g[e][3][1]}},r=p.distanceToPoint([s.start.x,s.start.y],[s.end.x,s.end.y],[n[0],n[1]]),l={start:{x:g[e+1][2][0],y:g[e+1][2][1]},end:{x:g[e+1][3][0],y:g[e+1][3][1]}},d=p.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(r<=o||d<=o)&&(m.push(t.id),h.handles.activeOperation=S),e++}for(let e=0;e<u.length-1;++e){const t=u[e][1];if(m.find((e=>e===t.id)))continue;const a=this._getReferenceLineControllable(t.id),s=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!a||!s)continue;const r=u[e][2],l=u[e][3],d=i.Zc.create();i.Zc.add(d,r,l),i.Zc.scale(d,d,.5);const g=i.Zc.create();i.Zc.subtract(g,r,d),i.Zc.normalize(g,g);const v=i.Zc.create();i.Zc.scale(v,g,.05*c);const E=i.Zc.create(),f=i.Zc.create();i.Zc.add(E,d,v),i.Zc.subtract(f,d,v);const w={start:{x:E[0],y:E[1]},end:{x:r[0],y:r[1]}},I=p.distanceToPoint([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]),C={start:{x:f[0],y:f[1]},end:{x:l[0],y:l[1]}},T=p.distanceToPoint([C.start.x,C.start.y],[C.end.x,C.end.y],[n[0],n[1]]);(I<=o||T<=o)&&(m.push(t.id),h.handles.activeOperation=null),e++}return h.activeViewportIds=[...m],this.editData={annotation:t},h.handles.activeOperation===S}}b.toolName="Crosshairs";const y=b},57424:(e,t,n)=>{n.d(t,{A:()=>d});var i=n(96214),o=n(92136),a=n(84797),s=n(88240),r=n(52610);class l extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(e,t)}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,i=(0,o.getEnabledElement)(t),{viewport:l,renderingEngine:d}=i,c=this.getTargetId(l);if(!c.startsWith("volumeId"))throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");const h=o.utilities.getVolumeId(c);let g=-1/0;const u=(0,a.getPointInLineOfSightWithCriteria)(l,n.world,h,((e,t)=>{if(e>g)return g=e,t}));if(!u||!u.length)return;const{targetViewportIds:m,toolGroupId:v}=this.configuration;d.getViewports().filter((e=>{if(m?.indexOf(e.id)>=0)return!0;const t=(0,r.getToolGroupForViewport)(e.id,d.id);return!(!v||v!==t?.id)})).forEach((e=>{e instanceof o.VolumeViewport?(0,s.A)(e,u):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}l.toolName="MIPJumpToClickTool";const d=l},93970:(e,t,n)=>{n.d(t,{A:()=>g});var i=n(96214),o=n(84901),a=n(92136),s=n(90252),r=n(23072),l=n(61738),d=n(40233);const c="magnify-viewport";class h extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(e,t),this._hasBeenRemoved=!1,this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,o=(0,a.getEnabledElement)(n),{viewport:l,renderingEngine:c}=o;if(!(l instanceof a.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const h=this._getReferencedImageId(l);if(!h)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const g=(0,s.getViewportIdsWithToolToRender)(n,this.getToolName());return this.editData={referencedImageId:h,viewportIdsToRender:g,enabledElement:o,renderingEngine:c,currentPoints:i},this._createMagnificationViewport(),this._activateDraw(n),(0,d.hideElementCursor)(n),e.preventDefault(),(0,r.A)(c,g),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:i,currentPoints:o}=this.editData,{viewport:s}=e,{element:l}=s,d=s.getProperties(),{canvas:h,world:g}=o;let u;if(u=l.querySelector(".magnifyTool"),null===u){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width=`${this.configuration.magnifyWidth}px`,e.style.height=`${this.configuration.magnifyHeight}px`,e.style.position="absolute",u=e;l.querySelector(".viewport-element").appendChild(e);const t={viewportId:c,type:a.Enums.ViewportType.STACK,element:u};i.enableElement(t)}u.style.top=h[1]-this.configuration.magnifyHeight/2+"px",u.style.left=h[0]-this.configuration.magnifyWidth/2+"px";const m=i.getViewport(c);m.setStack([t]).then((()=>{if(this._hasBeenRemoved)return;m.setProperties(d);const{parallelScale:e}=s.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:i}=m.getCamera(),o=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),a=[g[0],g[1],g[2]],r=[a[0]+o*i[0],a[1]+o*i[1],a[2]+o*i[2]];m.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:a,position:r}),m.render()})),u.style.display="block",(0,r.A)(i,n)},this._dragCallback=e=>{const t=e.detail,{deltaPoints:n,element:i,currentPoints:o}=t,s=n.world,r=o.canvas,l=(0,a.getEnabledElement)(i),{renderingEngine:d}=l,h=d.getViewport(c),g=i.querySelector(".magnifyTool");if(!g)return;g.style.top=r[1]-this.configuration.magnifyHeight/2+"px",g.style.left=r[0]-this.configuration.magnifyWidth/2+"px";const{focalPoint:u,position:m}=h.getCamera(),v=[m[0]+s[0],m[1]+s[1],m[2]+s[2]],p=[u[0]+s[0],u[1]+s[1],u[2]+s[2]];h.setCamera({focalPoint:p,position:v}),h.render()},this._dragEndCallback=e=>{const{element:t}=e.detail,n=(0,a.getEnabledElement)(t),{renderingEngine:i}=n;i.disableElement(c);const o=t.querySelector(".viewport-element"),s=o.querySelector(".magnifyTool");o.removeChild(s),this._deactivateDraw(t),(0,d.resetElementCursor)(t),this._hasBeenRemoved=!0},this._activateDraw=e=>{l.wk.isInteractingWithTool=!0,this._hasBeenRemoved=!1,e.addEventListener(o.Events.MOUSE_UP,this._dragEndCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(o.Events.TOUCH_END,this._dragEndCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{l.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._dragEndCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(o.Events.TOUCH_END,this._dragEndCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof a.StackViewport&&(n=t.split("imageId:")[1]),n}}h.toolName="Magnify";const g=h},36129:(e,t,n)=>{n.d(t,{A:()=>E});var i=n(7914),o=n(50638),a=n(65373),s=n(48987),r=n(22745),l=n(88099),d=n(27398),c=n(96214),h=n(92136),g=n(90252),u=n(52610),m=n(84901);const v={ANNOTATED_CUBE:1,AXES:2,CUSTOM:3};class p extends c.oS{constructor(e={},t={configuration:{orientationWidget:{enabled:!0,viewportCorner:i.Ay.Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:p.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[p.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"R",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"L",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[p.OVERLAY_MARKER_TYPES.AXES]:{},[p.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}){super(e,t),this._resizeObservers=new Map,this.onSetToolEnabled=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolActive=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolDisabled=()=>{this.cleanUpData(),this._unsubscribeToViewportNewVolumeSet()},this._getViewportsInfo=()=>(0,u.getToolGroup)(this.toolGroupId).viewportsInfo,this.resize=e=>{const t=this.orientationMarkers[e];if(!t)return;const{orientationWidget:n}=t;n.updateViewport()},this.orientationMarkers={}}static{this.CUBE=1}static{this.AXIS=2}static{this.VTPFILE=3}static{this.OVERLAY_MARKER_TYPES=v}_unsubscribeToViewportNewVolumeSet(){const e=()=>{this._getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,h.getEnabledElementByIds)(e,t),{element:i}=n;i.removeEventListener(h.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));this._resizeObservers.get(e).unobserve(i)}))};h.eventTarget.removeEventListener(m.Events.TOOLGROUP_VIEWPORT_ADDED,(t=>{t.detail.toolGroupId===this.toolGroupId&&(e(),this.initViewports())}))}_subscribeToViewportEvents(){const e=()=>{this._getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,h.getEnabledElementByIds)(e,t),{element:i}=n;this.initViewports(),i.addEventListener(h.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));const o=new ResizeObserver((()=>{setTimeout((()=>{const{viewport:n}=(0,h.getEnabledElementByIds)(e,t);this.resize(e),n.render()}),100)}));o.observe(i),this._resizeObservers.set(e,o)}))};e(),h.eventTarget.addEventListener(m.Events.TOOLGROUP_VIEWPORT_ADDED,(t=>{t.detail.toolGroupId===this.toolGroupId&&(e(),this.initViewports())}))}cleanUpData(){(0,h.getRenderingEngines)()[0].getViewports().forEach((e=>{const t=this.orientationMarkers[e.id];if(!t)return;const{actor:n,orientationWidget:i}=t;i?.setEnabled(!1),i?.delete(),n?.delete();e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow().render(),e.getRenderingEngine().render(),delete this.orientationMarkers[e.id]}))}initViewports(){const e=(0,h.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,g.filterViewportsWithToolEnabled)(t,this.getToolName()),t.forEach((e=>{e.getWidget(this.getToolName())||this.addAxisActorInViewport(e)}))}async addAxisActorInViewport(e){const t=e.id,n=this.configuration.overlayMarkerType,o=this.configuration.overlayConfiguration[n];if(this.orientationMarkers[t]){const{actor:n,orientationWidget:i}=this.orientationMarkers[t];e.getRenderer().removeActor(n),i.setEnabled(!1)}let s;1===n?s=this.createAnnotationCube(o):2===n?s=a.Ay.newInstance():3===n&&(s=await this.createCustomActor());const r=e.getRenderer(),l=e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow(),{enabled:d,viewportCorner:c,viewportSize:h,minPixelSize:g,maxPixelSize:u}=this.configuration.orientationWidget,m=i.Ay.newInstance({actor:s,interactor:l.getInteractor(),parentRenderer:r});m.setEnabled(d),m.setViewportCorner(c),m.setViewportSize(h),m.setMinPixelSize(g),m.setMaxPixelSize(u),m.updateMarkerOrientation(),this.orientationMarkers[t]={orientationWidget:m,actor:s},e.addWidget(this.getToolName(),m),l.render(),e.getRenderingEngine().render()}async createCustomActor(){const e=this.configuration.overlayConfiguration[v.CUSTOM].polyDataURL,t=await fetch(e),n=await t.arrayBuffer(),i=l.Ay.newInstance();i.parseAsArrayBuffer(n),i.update();const o=d.Ay.newInstance();o.shallowCopy(i.getOutputData()),o.getPointData().setActiveScalars("Color");const a=r.Ay.newInstance();a.setInputData(o),a.setColorModeToDirectScalars();const c=s.Ay.newInstance();return c.setMapper(a),c.rotateZ(180),c}createAnnotationCube(e){const t=o.Ay.newInstance();return t.setDefaultStyle({...e.defaultStyle}),t.setXPlusFaceProperty({...e.faceProperties.xPlus}),t.setXMinusFaceProperty({...e.faceProperties.xMinus}),t.setYPlusFaceProperty({...e.faceProperties.yPlus}),t.setYMinusFaceProperty({...e.faceProperties.yMinus}),t.setZPlusFaceProperty({...e.faceProperties.zPlus}),t.setZMinusFaceProperty({...e.faceProperties.zMinus}),t}async createAnnotatedCubeActor(){const e=o.Ay.newInstance(),{faceProperties:t,defaultStyle:n}=this.configuration.annotatedCube;return e.setDefaultStyle(n),Object.keys(t).forEach((n=>{const i=`set${n.charAt(0).toUpperCase()+n.slice(1)}FaceProperty`;e[i](t[n])})),e}}p.toolName="OrientationMarker";const E=p},87841:(e,t,n)=>{n.d(t,{A:()=>g});var i=n(44753),o=n(92136),a=n(38296),s=n(52610),r=n(2746),l=n(23072),d=n(28062);const{EPSILON:c}=o.CONSTANTS;class h extends d.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}){super(e,t),this.onSetToolEnabled=()=>{this._init()},this.onSetToolActive=()=>{this._init()},this._init=()=>{const e=this.configuration.sourceImageIds;if(!e?.length)return void console.warn("OverlayGridTool: No sourceImageIds provided in configuration");const t=o.metaData.get("imagePlaneModule",e[0]);if(!t)return void console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");const{frameOfReferenceUID:n}=t,i=(0,s.getToolGroup)(this.toolGroupId).viewportsInfo;if(!i?.length)return void console.warn("OverlayGridTool: No viewports found");const r=(0,a.getAnnotations)(this.getToolName(),n);if(!r?.length){const t=e.map((e=>this.calculateImageIdPointSets(e))),i={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{viewportData:new Map,pointSets:t}};(0,a.addAnnotation)(i,n)}(0,l.A)((0,o.getRenderingEngine)(i[0].renderingEngineId),i.map((({viewportId:e})=>e)))},this.calculateImageIdPointSets=e=>{const{imagePositionPatient:t,rows:n,columns:a,rowCosines:s,columnCosines:r,rowPixelSpacing:l,columnPixelSpacing:d}=o.metaData.get("imagePlaneModule",e),c=[...t],h=[...t],g=[...t],u=[...t];i.eR.scaleAndAdd(h,t,r,a*d),i.eR.scaleAndAdd(g,t,s,n*l),i.eR.scaleAndAdd(u,g,r,a*d);return{pointSet1:[c,g,h,u],pointSet2:[c,h,g,u]}},this.renderAnnotation=(e,t)=>{const n=this.configuration.sourceImageIds;let s=!1;if(!n?.length)return s;const{viewport:l,FrameOfReferenceUID:d}=e;if(l.getImageIds().length<2)return s;const c=(0,a.getAnnotations)(this.getToolName(),d);if(!c?.length)return s;const h=c[0],{annotationUID:g}=h,{focalPoint:u,viewPlaneNormal:m}=l.getCamera(),v={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},p=this.getImageIdNormal(n[0]);if(this.isParallel(m,p))return s;const E=o.utilities.planar.planeEquation(m,u),f=h.data.pointSets,w=h.data.viewportData;for(let e=0;e<n.length;e++){const{pointSet1:n,pointSet2:a}=f[e],s=w.get(l.id)||this.initializeViewportData(w,l.id);if(!s.pointSetsToUse[e]){let t=n,r=i.eR.subtract(i.eR.create(),n[0],n[1]);r=i.eR.normalize(i.eR.create(),r),this.isPerpendicular(r,m)&&(t=a),s.pointSetsToUse[e]=t,s.lineStartsWorld[e]=o.utilities.planar.linePlaneIntersection(t[0],t[1],E),s.lineEndsWorld[e]=o.utilities.planar.linePlaneIntersection(t[2],t[3],E)}const d=s.lineStartsWorld[e],c=s.lineEndsWorld[e];v.annotationUID=g;const u=this.getStyle("lineWidth",v,h),p=this.getStyle("lineDash",v,h),I=this.getStyle("color",v,h),C=this.getStyle("shadow",v,h),T=[d,c].map((e=>l.worldToCanvas(e))),_=`${g}-line`,S=`${e}`;(0,r.drawLine)(t,g,S,T[0],T[1],{color:I,width:u,lineDash:p,shadow:C},_)}return s=!0,s},this.initializeViewportData=(e,t)=>(e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)),this.isPerpendicular=(e,t)=>{const n=i.eR.dot(e,t);return Math.abs(n)<c}}isParallel(e,t){return Math.abs(i.eR.dot(e,t))>1-c}getImageIdNormal(e){const{imageOrientationPatient:t}=o.metaData.get("imagePlaneModule",e),n=i.eR.fromValues(t[0],t[1],t[2]),a=i.eR.fromValues(t[3],t[4],t[5]);return i.eR.cross(i.eR.create(),n,a)}}h.toolName="OverlayGrid";const g=h},25294:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(96214),o=n(92136);class a extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t)}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,o.getEnabledElement)(t),a=n.world,s=i.viewport.getCamera(),{focalPoint:r,position:l}=s,d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],c=[r[0]-a[0],r[1]-a[1],r[2]-a[2]];i.viewport.setCamera({focalPoint:c,position:d}),i.viewport.render()}}a.toolName="Pan";const s=a},15354:(e,t,n)=>{n.d(t,{A:()=>l});var i=n(92136),o=n(44753),a=n(96214),s=n(52475);class r extends a.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:a}=e.detail,r=n.world,l=a.world,d=(0,i.getEnabledElement)(t),{viewport:c}=d,h=c.getCamera(),g=[.5*t.clientWidth,.5*t.clientHeight],u=c.canvasToWorld(g);let m=(0,s.A)([l,u],[u,r]);const{viewPlaneNormal:v,viewUp:p}=h,E=o.eR.sub(o.eR.create(),u,l),f=o.eR.sub(o.eR.create(),u,r),w=o.eR.cross(o.eR.create(),E,f);if(o.eR.dot(v,w)>0&&(m=-m),!Number.isNaN(m)){if(c instanceof i.BaseVolumeViewport){const e=m*Math.PI/180,t=o.pB.identity(new Float32Array(16));o.pB.rotate(t,t,e,v);const n=o.eR.transformMat4(o.eR.create(),p,t);c.setCamera({viewUp:n})}else{const{rotation:e}=c.getProperties();c.setProperties({rotation:e+m})}c.render()}}}r.toolName="PlanarRotate";const l=r},1143:(e,t,n)=>{n.d(t,{A:()=>v});var i=n(92136),o=n(38296),a=n(21009),s=n(2746),r=n(90252),l=n(23072),d=n(44753),c=n(28062),h=n(61199),g=n(40233),u=n(52610);class m extends c.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(e,t),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:t}=e,{element:n,currentPoints:i}=t;this._currentCursorWorldPosition=i.world,this._currentCanvasPosition=i.canvas,this._elementWithCursor=n;const o=this.getActiveAnnotation(n);return null===o?(this.createInitialAnnotation(i.world,n),!1):(this.updateAnnotationPosition(n,o),!1)},this.createInitialAnnotation=(e,t)=>{const n=(0,i.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:a,renderingEngine:s}=n;this.isDrawing=!0;const d=a.getCamera(),{viewPlaneNormal:c,viewUp:h}=d;if(!c||!h)throw new Error("Camera not found");const g=this.getReferencedImageId(a,e,c,h),u=a.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:u,referencedImageId:g},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if((0,o.getAnnotations)(this.getToolName(),t).length>0)return null;if(null===(0,o.addAnnotation)(m,t))return;const v=(0,r.getViewportIdsWithToolToRender)(t,this.getToolName(),!1);(0,l.A)(s,v)},this.onCameraModified=e=>{const t=e.detail,{element:n,previousCamera:o,camera:a}=t,s=(0,i.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const r=o.focalPoint,l=a.viewPlaneNormal,d=a.focalPoint,c=[0,0,0];if(h.Ay.subtract(d,r,c),0===c.reduce(((e,t)=>e+t),0))return;const g=h.Ay.dot(c,l);if(Math.abs(g)<.01)return;if(!this._currentCanvasPosition)return;const u=s.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=u,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i,FrameOfReferenceUID:r}=e,l=this._elementWithCursor===i.element;this.configuration.positionSync&&!l&&this.updateViewportImage(i);const{element:d}=i;let c=(0,o.getAnnotations)(this.getToolName(),d);if(!c?.length)return n;if(c=this.filterInteractableAnnotationsForElement(d,c),!c?.length)return n;const h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<c.length;e++){const o=c[e],{annotationUID:r,data:d}=o,{handles:g}=d,{points:u}=g;if(!r)return n;h.annotationUID=r;const m=parseFloat(this.getStyle("lineWidth",h,o)),v=m,p=this.getStyle("lineDash",h,o),E=this.getStyle("color",h,o);if(u[0].some((e=>isNaN(e))))return n;const f=u.map((e=>i.worldToCanvas(e)));if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,a.isAnnotationVisible)(r))continue;const w={upper:"upper",right:"right",lower:"lower",left:"left"},[I,C]=f[0],T=l?20:7,_=l?5:7;(0,s.drawLine)(t,r,w.upper,[I,C-(T/2+_)],[I,C-T/2],{color:E,lineDash:p,lineWidth:v}),(0,s.drawLine)(t,r,w.lower,[I,C+(T/2+_)],[I,C+T/2],{color:E,lineDash:p,lineWidth:v}),(0,s.drawLine)(t,r,w.right,[I+(T/2+_),C],[I+T/2,C],{color:E,lineDash:p,lineWidth:v}),(0,s.drawLine)(t,r,w.left,[I-(T/2+_),C],[I-T/2,C],{color:E,lineDash:p,lineWidth:v}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=(0,u.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,i.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&(0,g.hideElementCursor)(e.viewport.element)}))}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=(0,u.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map((e=>(0,i.getEnabledElementByIds)(e.viewportId,e.renderingEngineId))).forEach((e=>{e&&(0,g.resetElementCursor)(e.viewport.element)}))}getActiveAnnotation(e){const t=(0,o.getAnnotations)(this.getToolName(),e);if(!t.length)return null;return t[0]}updateAnnotationPosition(e,t){const n=this._currentCursorWorldPosition;if(!n)return;if(!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;const o=(0,r.getViewportIdsWithToolToRender)(e,this.getToolName(),!1),a=(0,i.getEnabledElement)(e);if(!a)return;const{renderingEngine:s}=a;(0,l.A)(s,o)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];const n=t[0],o=(0,i.getEnabledElement)(e)?.viewport;if(!o)return[];const a=o.getCamera(),{viewPlaneNormal:s,focalPoint:r}=a;if(!s||!r)return[];const l=n.data?.handles?.points;if(!(l instanceof Array)||1!==l.length)return[];const d=l[0],c=i.utilities.planar.planeEquation(s,r);return i.utilities.planar.planeDistanceToPoint(c,d)<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some((e=>isNaN(e))))if(e instanceof i.StackViewport){const n=i.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof i.VolumeViewport){const{focalPoint:n,viewPlaneNormal:o}=e.getCamera();if(!n||!o)return;const a=i.utilities.planar.planeEquation(o,n),s=i.utilities.planar.planeDistanceToPoint(a,t,!0);if(Math.abs(s)<.5)return;const r=d.eR.normalize(d.eR.create(),d.eR.fromValues(...o)),l=d.eR.scale(d.eR.create(),r,s),c=d.eR.add(d.eR.create(),d.eR.fromValues(...n),l);if(!0){e.setCamera({focalPoint:c});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}m.toolName="ReferenceCursors";const v=m},54541:(e,t,n)=>{n.d(t,{A:()=>g});var i=n(44753),o=n(92136),a=n(38296),s=n(2746),r=n(90252),l=n(23072),d=n(28062);const{EPSILON:c}=o.CONSTANTS;class h extends d.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",showFullDimension:!1}}){super(e,t),this.editData={},this._init=()=>{const e=(0,o.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,r.filterViewportsWithToolEnabled)(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n?.getImageData())return;const{element:i}=n,{viewUp:s,viewPlaneNormal:d}=n.getCamera(),c=o.utilities.getViewportImageCornersInWorld(n);let h=this.editData.annotation;const g=n.getFrameOfReferenceUID();if(h)this.editData.annotation.data.handles.points=c;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...s],FrameOfReferenceUID:g,referencedImageId:null},data:{handles:{points:c}}};(0,a.addAnnotation)(e,i),h=e}this.editData={sourceViewportId:n.id,renderingEngine:e,annotation:h},(0,l.A)(e,t.filter((e=>e.id!==n.id)).map((e=>e.id)))},this.onSetToolEnabled=()=>{this._init()},this.onSetToolConfiguration=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n}=e,{annotation:a,sourceViewportId:r}=this.editData;let l=!1;const{viewport:d}=(0,o.getEnabledElementByViewportId)(r)||{};if(!d)return l;if(d.id===n.id)return l;if(!a||!a?.data?.handles?.points)return l;const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},h=a.data.handles.points[0],g=a.data.handles.points[1],u=a.data.handles.points[2],m=a.data.handles.points[3],{focalPoint:v,viewPlaneNormal:p,viewUp:E}=n.getCamera(),{viewPlaneNormal:f}=d.getCamera();if(this.isParallel(p,f))return l;const w=o.utilities.planar.planeEquation(p,v),I=[h,u,g,m],C=[h,g,u,m];let T=I,_=i.eR.subtract(i.eR.create(),I[0],I[1]);_=i.eR.normalize(i.eR.create(),_);let S=i.eR.subtract(i.eR.create(),I[2],I[0]);S=i.eR.normalize(i.eR.create(),S);const D=i.eR.cross(i.eR.create(),_,S);if(this.isParallel(D,p))return l;this.isPerpendicular(_,p)&&(T=C);const A=o.utilities.planar.linePlaneIntersection(T[0],T[1],w),b=o.utilities.planar.linePlaneIntersection(T[2],T[3],w),{annotationUID:y}=a;c.annotationUID=y;const R=this.getStyle("lineWidth",c,a),O=this.getStyle("lineDash",c,a),M=this.getStyle("color",c,a),x=this.getStyle("shadow",c,a);let L=[A,b].map((e=>n.worldToCanvas(e)));if(this.configuration.showFullDimension&&(L=this.handleFullDimension(n,A,p,E,b,L)),L.length<2)return l;const U=`${y}-line`;return(0,s.drawLine)(t,y,"1",L[0],L[1],{color:M,width:R,lineDash:O,shadow:x},U),l=!0,l},this.isPerpendicular=(e,t)=>{const n=i.eR.dot(e,t);return Math.abs(n)<c}}handleFullDimension(e,t,n,i,a,s){const r=e.getRenderingEngine(),l=this.getTargetId(e),d=this.getTargetIdImage(l,r),c=this.getReferencedImageId(e,t,n,i);if(c&&d)try{const{imageData:n,dimensions:i}=d,[r,l,h,g]=[n.indexToWorld([0,0,0]),n.indexToWorld([i[0]-1,0,0]),n.indexToWorld([i[0]-1,i[1]-1,0]),n.indexToWorld([0,i[1]-1,0])].map((e=>o.utilities.worldToImageCoords(c,e))),[u,m]=[t,a].map((e=>o.utilities.worldToImageCoords(c,e)));s=[[r,l],[l,h],[g,h],[r,g]].map((([e,t])=>this.intersectInfiniteLines(e,t,u,m))).filter((e=>e&&this.isInBound(e,i))).map((t=>{const n=o.utilities.imageToWorldCoords(c,t);return e.worldToCanvas(n)}))}catch(e){console.log(e)}return s}intersectInfiniteLines(e,t,n,i){const[o,a]=e,[s,r]=t,[l,d]=n,[h,g]=i,u=r-a,m=o-s,v=s*a-o*r,p=g-d,E=l-h,f=h*d-l*g;if(Math.abs(u*E-p*m)<c)return;return[(m*f-E*v)/(u*E-p*m),(p*v-u*f)/(u*E-p*m)]}isParallel(e,t){return Math.abs(i.eR.dot(e,t))>1-c}isInBound(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}h.toolName="ReferenceLines";const g=h},92807:(e,t,n)=>{n.d(t,{A:()=>h});var i=n(28062),o=n(44753),a=n(92136),s=n(38296),r=n(2746),l=n(52610);const d=[];class c extends i.A{constructor(e={},t={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(e,t),this.editData={},this._init=()=>{const e=(0,a.getRenderingEngines)()[0];if(!e)return;const t=(0,l.getToolGroup)(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map((e=>(0,a.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)));let{viewport:i}=n[0];const{FrameOfReferenceUID:o}=n[0];if(this.configuration.viewportId&&n.forEach((e=>{e.viewport.id==this.configuration.viewportId&&(i=e.viewport)})),!i)return;const{viewUp:r,viewPlaneNormal:c}=i.getCamera(),h=a.utilities.getViewportImageCornersInWorld(i);let g=this.editData.annotation;const u=(0,s.getAnnotations)(this.getToolName(),i.element);if(u.length&&(g=u.filter((e=>e.data.viewportId==i.id))[0]),d.includes(i.id))this.editData.annotation&&this.editData.annotation.data.viewportId==i.id&&(this.editData.annotation.data.handles.points=h,this.editData.annotation.data.viewportId=i.id);else{const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...r],FrameOfReferenceUID:o,referencedImageId:null},data:{handles:{points:h},viewportId:i.id}};d.push(i.id),(0,s.addAnnotation)(e,i.element),g=e}this.editData={viewport:i,renderingEngine:e,annotation:g}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{const i=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let o;return o="top"==n||"bottom"==n?i.filter((t=>t<.6*e&&t>.2*e)):i.filter((e=>e<.6*t&&e>.2*t)),o[0]},this.computeEndScaleTicks=(e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}},this.computeInnerScaleTicks=(e,t,n,i,o)=>{let a;"bottom"==t||"top"==t?a=o[0][0]-i[0][0]:"left"!=t&&"right"!=t||(a=o[0][1]-i[0][1]);const s=[],r=[],l=[];let d=e;e>=50&&(d=e/10);const c=a/d;for(let e=0;e<d-1;e++){const o={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};s.push(`${n}-tick${e}`),r.push(`tick${e}`),(e+1)%5==0?l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][0][0],i[1][1]+o[t][0][1]]]):l.push([[i[0][0]+o[t][0][0],i[0][1]+o[t][0][1]],[i[1][0]+o[t][1][0],i[1][1]+o[t][1][1]]])}return{tickIds:s,tickUIDs:r,tickCoordinates:l}},this.computeWorldScaleCoordinates=(e,t,n)=>{let i,a=o.eR.subtract(o.eR.create(),n[0],n[1]);a=o.eR.normalize(o.eR.create(),a);let s=o.eR.subtract(o.eR.create(),n[2],n[0]);s=o.eR.normalize(o.eR.create(),s);const r={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},l=o.eR.add(o.eR.create(),r[t][0],r[t][0]).map((e=>e/2)),d=e/2/Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2));return"top"==t||"bottom"==t?i=[o.eR.subtract(o.eR.create(),l,s.map((e=>e*d))),o.eR.add(o.eR.create(),l,s.map((e=>e*d)))]:"left"!=t&&"right"!=t||(i=[o.eR.add(o.eR.create(),l,a.map((e=>e*d))),o.eR.subtract(o.eR.create(),l,a.map((e=>e*d)))]),i},this.computeCanvasScaleCoordinates=(e,t,n,i,o)=>{let a;if("top"==o||"bottom"==o){const i=t[0][0]-t[1][0];a=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==o||"right"==o){const n=t[0][1]-t[1][1];a=[[i.width,e.height/2-n/2],[i.width,e.height/2+n/2]]}return a},this.computeScaleBounds=(e,t,n,i)=>{const o=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),s={bottom:[-a,-o],top:[a,o],left:[a,o],right:[-a,-o]},r={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:r[i][0]+s[i][0],width:r[i][1]+s[i][1]}}}renderAnnotation(e,t){if(!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:i}=e,a=(0,s.getAnnotations)(this.getToolName(),i.element).filter((e=>e.data.viewportId==i.id))[0],l=e.viewport.canvas,d=!1;if(!i)return d;const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},h={width:l.width,height:l.height},g=a.data.handles.points[0],u=a.data.handles.points[1],m=a.data.handles.points[2],v=a.data.handles.points[3],p=[g,m,u,v],E=o.eR.distance(m,v),f=o.eR.distance(g,m),w=this.computeScaleBounds(h,.05,.05,n),I=this.computeScaleBounds(h,.05,.05,n),C=this.computeScaleSize(E,f,n),T=this.computeWorldScaleCoordinates(C,n,p).map((e=>i.worldToCanvas(e))),_=this.computeCanvasScaleCoordinates(h,T,I,w,n),S=this.computeEndScaleTicks(_,n),{annotationUID:D}=a;c.annotationUID=D;const A=this.getStyle("lineWidth",c,a),b=this.getStyle("lineDash",c,a),y=this.getStyle("color",c,a),R=this.getStyle("shadow",c,a),O=`${D}-scaleline`;(0,r.drawLine)(t,D,"1",_[0],_[1],{color:y,width:A,lineDash:b,shadow:R},O);const M=`${D}-left`;(0,r.drawLine)(t,D,"2",S.endTick1[0],S.endTick1[1],{color:y,width:A,lineDash:b,shadow:R},M);const x=`${D}-right`;(0,r.drawLine)(t,D,"3",S.endTick2[0],S.endTick2[1],{color:y,width:A,lineDash:b,shadow:R},x);const L={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},U=[_[0][0]+L[n][0],_[0][1]+L[n][1]],N=this._getTextLines(C),{tickIds:P,tickUIDs:k,tickCoordinates:V}=this.computeInnerScaleTicks(C,n,D,S.endTick1,S.endTick2);for(let e=0;e<k.length;e++)(0,r.drawLine)(t,D,k[e],V[e][0],V[e][1],{color:y,width:A,lineDash:b,shadow:R},P[e]);return(0,r.drawTextBox)(t,D,"text0",N,[U[0],U[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:y}),d}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");return[t.toString().concat(n)]}}c.toolName="ScaleOverlay";const h=c},70494:(e,t,n)=>{n.d(t,{A:()=>m});var i=n(92136),o=n(38296),a=n(2746),s=n(52610),r=n(23072),l=n(28062),d=(n(14846),n(60438)),c=n(74119);class h extends l.A{constructor(e={},t={configuration:{opacity:.5}}){super(e,t),this._init=()=>{const e=(0,s.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e?.length)return void console.warn(this.getToolName()+"Tool: No viewports found");const t=(0,i.getRenderingEngine)(e[0].renderingEngineId)?.getViewport(e[0].viewportId);if(!t)return;const n=t.getFrameOfReferenceUID(),a=(0,o.getAnnotations)(this.getToolName(),n);if(!a?.length){const t=new Map;!function(e,t){t.forEach((({viewportId:t,renderingEngineId:n})=>{const o=(0,i.getRenderingEngine)(n)?.getViewport(t);g(e,o)}))}(t,e);const a={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{actorsWorldPointsMap:t}};(0,o.addAnnotation)(a,n)}(0,r.A)((0,i.getRenderingEngine)(e[0].renderingEngineId),e.map((({viewportId:e})=>e)))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n,FrameOfReferenceUID:i}=e;let s=!1;const r=(0,o.getAnnotations)(this.getToolName(),i);if(!r?.length)return s;const l=r[0],{annotationUID:d}=l,c=l.data.actorsWorldPointsMap;g(c,n);const h=n.getActors(),m=u(n);return h.forEach((e=>{if(!e?.clippingFilter)return;const i=c.get(e.uid);if(!i)return;if(!i.get(m))return;let o=1;const{worldPointsSet:s,color:r}=i.get(m);for(let i=0;i<s.length;i++){const l=s[i].map((e=>n.worldToCanvas(e))),c={color:r,fillColor:r,fillOpacity:this.configuration.opacity,closePath:!0,lineWidth:2},h=e.uid+"#"+o;(0,a.drawPath)(t,d,h,l,c),o++}})),s=!0,s}}}function g(e,t){const n=t.getActors(),i=u(t);n.forEach((t=>{if(!t?.clippingFilter)return;let n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(i)){const e=t.clippingFilter.getOutputData(),o=c.polyDataUtils.getPolyDataPoints(e);if(!o)return;const a=function(e){function t(e){let t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(i,{worldPointsSet:o,color:a})}}))}function u(e){const{viewPlaneNormal:t}=e.getCamera(),n=e.getCurrentImageIdIndex();return`${e.id}-${(0,d.l)(t)}-${n}`}h.toolName="SegmentationIntersection";const m=h},20132:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(92136),o=n(96214),a=n(74119);class s extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t),this.deltaY=1}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{deltaPoints:t,viewportId:n,renderingEngineId:o}=e.detail,{viewport:s}=(0,i.getEnabledElementByIds)(n,o),r=this.getTargetId(s),{debounceIfNotLoaded:l,invert:d,loop:c}=this.configuration,h=t.canvas[1];let g;s instanceof i.VolumeViewport&&(g=r.split(/volumeId:|\?/)[1]);const u=this._getPixelPerImage(s),m=h+this.deltaY;if(u)if(Math.abs(m)>=u){const e=Math.round(m/u);(0,a.scroll)(s,{delta:d?-e:e,volumeId:g,debounceLoading:l,loop:c}),this.deltaY=m%u}else this.deltaY=m}_getPixelPerImage(e){const{element:t}=e,n=e.getNumberOfSlices();return Math.max(2,t.offsetHeight/Math.max(n,8))}}s.toolName="StackScroll";const r=s},57008:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(92136),o=n(96214),a=n(21783);class s extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1,scrollSlabs:!1}}){super(e,t)}mouseWheelCallback(e){const{wheel:t,element:n}=e.detail,{direction:o}=t,{invert:s}=this.configuration,{viewport:r}=(0,i.getEnabledElement)(n),l=o*(s?-1:1),d=this.getTargetId(r),c=i.utilities.getVolumeId(d);(0,a.A)(r,{delta:l,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:c,scrollSlabs:this.configuration.scrollSlabs})}}s.toolName="StackScrollMouseWheel";const r=s},15924:(e,t,n)=>{n.d(t,{A:()=>c});var i=n(61199),o=n(84901),a=n(92136),s=n(44753),r=n(96214),l=n(52610);class d extends r.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}}){super(e,t),this._resizeObservers=new Map,this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,i=(0,a.getEnabledElement)(n),{viewport:o}=i,s=o.getDefaultActor().actor.getMapper(),r=s.getSampleDistance();return s.setSampleDistance(2*r),null!==this.cleanUp&&document.removeEventListener("mouseup",this.cleanUp),this.cleanUp=()=>{s.setSampleDistance(r),o.render()},document.addEventListener("mouseup",this.cleanUp,{once:!0}),!0},this._getViewportsInfo=()=>(0,l.getToolGroup)(this.toolGroupId).viewportsInfo,this.onSetToolActive=()=>{const e=()=>{this._getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{if(!this._resizeObservers.has(e)){const{viewport:n}=(0,a.getEnabledElementByIds)(e,t)||{viewport:null};if(!n)return;const{element:i}=n,o=new ResizeObserver((()=>{const n=(0,a.getEnabledElementByIds)(e,t);if(!n)return;const{viewport:i}=n;i.resetCamera(),i.render()}));o.observe(i),this._resizeObservers.set(e,o)}}))};e(),this._viewportAddedListener=t=>{t.detail.toolGroupId===this.toolGroupId&&e()},a.eventTarget.addEventListener(o.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener)},this.onSetToolDisabled=()=>{this._resizeObservers.forEach(((e,t)=>{e.disconnect(),this._resizeObservers.delete(t)})),this._viewportAddedListener&&(a.eventTarget.removeEventListener(o.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._viewportAddedListener=null)},this.rotateCamera=(e,t,n,i)=>{const o=e.getVtkActiveCamera(),a=o.getViewUp(),r=o.getFocalPoint(),l=o.getPosition(),d=[0,0,0],c=[0,0,0],h=[0,0,0],g=s.pB.identity(new Float32Array(16));s.pB.translate(g,g,t),s.pB.rotate(g,g,i,n),s.pB.translate(g,g,[-t[0],-t[1],-t[2]]),s.eR.transformMat4(d,l,g),s.eR.transformMat4(c,r,g),s.pB.identity(g),s.pB.rotate(g,g,i,n),s.eR.transformMat4(h,a,g),e.setCamera({position:d,viewUp:h,focalPoint:c})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:o}=e.detail,s=n.canvas,r=o.canvas,{rotateIncrementDegrees:l}=this.configuration,d=(0,a.getEnabledElement)(t),{viewport:c}=d,h=c.getCamera(),g=t.clientWidth,u=t.clientHeight,m=[s[0]/g,s[1]/u],v=[r[0]/g,r[1]/u],p=[.5*g,.5*u],E=c.canvasToWorld(p),f=(1+Math.abs(.5))**2,w=[v[0],0,0],I=[m[0],0,0],C=w[0]**2,T=I[0]**2,_=C>f?0:Math.sqrt(f-C),S=T>f?0:Math.sqrt(f-T),D=[w[0],0,_];i.Ay.normalize(D);const A=[I[0],0,S];i.Ay.normalize(A);const b=i.Ay.dot(D,A);if(Math.abs(b)>1e-4){const e=-2*Math.acos(i.Ay.clampValue(b,-1,1))*Math.sign(m[0]-v[0])*l,t=h.viewUp,n=h.viewPlaneNormal,o=[0,0,0],a=[0,0,0];i.Ay.cross(t,n,o),i.Ay.normalize(o),i.Ay.cross(n,o,a),i.Ay.normalize(a),i.Ay.normalize(t),this.rotateCamera(c,E,a,e);const s=(v[1]-m[1])*l;this.rotateCamera(c,E,o,s),c.render()}}}d.toolName="TrackballRotate";const c=d},94574:(e,t,n)=>{n.d(t,{A:()=>l});var i=n(96214),o=n(92136),a=n(44753);const s=[0,0,1];class r extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:s,rotateIncrementDegrees:30}}){super(e,t)}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,i=(0,o.getEnabledElement)(t),{viewport:s}=i,{direction:r,rotateIncrementDegrees:l}=this.configuration,d=s.getCamera(),{viewUp:c,position:h,focalPoint:g}=d,{direction:u}=n,[m,v,p]=g,[E,f,w]=r,I=u*(l*Math.PI)/180,C=[0,0,0],T=[0,0,0],_=[0,0,0],S=a.pB.identity(new Float32Array(16));a.pB.translate(S,S,[m,v,p]),a.pB.rotate(S,S,I,[E,f,w]),a.pB.translate(S,S,[-m,-v,-p]),a.eR.transformMat4(C,h,S),a.eR.transformMat4(T,g,S),a.pB.identity(S),a.pB.rotate(S,S,I,[E,f,w]),a.eR.transformMat4(_,c,S),s.setCamera({position:C,viewUp:_,focalPoint:T}),s.render()}}r.toolName="VolumeRotateMouseWheel";const l=r},455:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(96214),o=n(92136);class a extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{const n=Math.floor(t[2]/2),i=t[0]*t[1];let o,a;e instanceof Float32Array?(o=4,a=Float32Array):e instanceof Uint8Array?(o=1,a=Uint8Array):e instanceof Uint16Array?(o=2,a=Uint16Array):e instanceof Int16Array&&(o=2,a=Int16Array);const s=new a(e.buffer,n*i*o,i),{max:r,min:l}=this._getMinMax(s,i);return r-l}}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,o.getEnabledElement)(t),{renderingEngine:a,viewport:s}=i;let r,l,d,c,h,g,u=!1;const m=s.getProperties();if(s instanceof o.VolumeViewport){const e=this.getTargetId(s);r=o.utilities.getVolumeId(e),g=o.utilities.getViewportsWithVolumeId(r,a.id),({lower:l,upper:d}=m.voiRange);const t=o.cache.getVolume(r);if(!t)throw new Error("Volume not found "+r);c=t.metadata.Modality,u=t.scaling&&Object.keys(t.scaling).length>0}else{if(!m.voiRange)throw new Error("Viewport is not a valid type");{c=s.modality,({lower:l,upper:d}=m.voiRange);const{preScale:e={scaled:!1}}=s.getImageData?.()||{};u=e.scaled&&void 0!==e.scalingParameters?.suvbw}}h="PT"===c&&u?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:l,upper:d,clientHeight:t.clientHeight,isPreScaled:u,viewport:s,volumeId:r}):this.getNewRange({viewport:s,deltaPointsCanvas:n.canvas,volumeId:r,lower:l,upper:d}),h.lower>=h.upper||(s.setProperties({voiRange:h}),s.render(),s instanceof o.VolumeViewport&&g.forEach((e=>{s!==e&&e.render()})))}getPTScaledNewRange({deltaPointsCanvas:e,lower:t,upper:n,clientHeight:i,viewport:o,volumeId:a,isPreScaled:s}){let r=4;r=s?5/i:this._getMultiplierFromDynamicRange(o,a)||4;return n-=e[1]*r,{lower:t,upper:n=s?Math.max(n,.1):n}}getNewRange({viewport:e,deltaPointsCanvas:t,volumeId:n,lower:i,upper:a}){const s=this._getMultiplierFromDynamicRange(e,n)||4,r=t[0]*s,l=t[1]*s;let{windowWidth:d,windowCenter:c}=o.utilities.windowLevel.toWindowLevel(i,a);return d+=r,c+=l,d=Math.max(d,1),o.utilities.windowLevel.toLowHighRange(d,c)}_getMultiplierFromDynamicRange(e,t){let n;if(t){const e=o.cache.getVolume(t),{dimensions:i}=e,a=e.getScalarData(),s=this._getImageDynamicRangeFromMiddleSlice(a,i),r=e?.metadata?.BitsStored,l=r?2**r:1/0;n=Math.min(s,l)}else n=this._getImageDynamicRangeFromViewport(e);const i=n/1024;return i>1?Math.round(i):i}_getImageDynamicRangeFromViewport(e){const{imageData:t}=e.getImageData(),n=t.getDimensions();if(t.getRange){const e=t.getRange();return e[1]-e[0]}let i,o;if(i=t.getScalarData?t.getScalarData():t.getPointData().getScalars(),1!==n[2])return this._getImageDynamicRangeFromMiddleSlice(i,n);if(i.getRange)o=i.getRange();else{const{min:e,max:t}=this._getMinMax(i,i.length);o=[e,t]}return o[1]-o[0]}_getMinMax(e,t){let n=1/0,i=-1/0;for(let o=0;o<t;o++){const t=e[o];t<n&&(n=t),t>i&&(i=t)}return{max:i,min:n}}}a.toolName="WindowLevel";const s=a},20842:(e,t,n)=>{n.d(t,{A:()=>l});var i=n(44753),o=n(61199),a=n(92136),s=n(96214);class r extends s.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,invert:!1}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,s=o.world,r=(0,a.getEnabledElement)(n).viewport.getCamera(),{focalPoint:l}=r;this.initialMousePosWorld=s;let d=i.eR.fromValues(l[0]-s[0],l[1]-s[1],l[2]-s[2]);return d=i.eR.normalize(i.eR.create(),d),this.dirVec=d,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,t,n,o=!1)=>{const{element:a,deltaPoints:s}=e.detail,r=o?e.detail.deltaDistance.canvas:s.canvas[1],l=[a.clientWidth,a.clientHeight],{parallelScale:d,focalPoint:c,position:h}=n,g=r*(5/l[1])*(this.configuration.invert?-1:1),u=(1-g)*d;let m=c,v=h;if(!this.configuration.zoomToCenter){const e=i.eR.distance(c,this.initialMousePosWorld);v=i.eR.scaleAndAdd(i.eR.create(),h,this.dirVec,-e*g),m=i.eR.scaleAndAdd(i.eR.create(),c,this.dirVec,-e*g)}const p=t.getImageData();let E=[1,1,1];p&&(E=p.spacing);const{minZoomScale:f,maxZoomScale:w}=this.configuration,I=a.clientHeight*E[1]*.5,C=I/u;let T=u,_=!1;p&&(C<f?(T=I/f,_=!0):C>=w&&(T=I/w,_=!0)),t.setCamera({parallelScale:T,focalPoint:_?c:m,position:_?h:v})},this._dragPerspectiveProjection=(e,t,n,i=!1)=>{const{element:a,deltaPoints:s}=e.detail,r=i?e.detail.deltaDistance.canvas:s.canvas[1],l=[a.clientWidth,a.clientHeight],{position:d,focalPoint:c,viewPlaneNormal:h}=n,g=o.Ay.distance2BetweenPoints(d,c),u=Math.sqrt(g)/l[1],m=[-h[0],-h[1],-h[2]],v=this.configuration.invert?r/u:r*u;let p=v*m[0];d[0]+=p,c[0]+=p,p=v*m[1],d[1]+=p,c[1]+=p,p=v*m[2],d[2]+=p,c[2]+=p,t.setCamera({position:d,focalPoint:c})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,o=(0,a.getEnabledElement)(t),{viewport:s}=o,r=s.getCamera(),l=n.world,{focalPoint:d}=r;this.initialMousePosWorld=l;let c=i.eR.fromValues(d[0]-l[0],d[1]-l[1],d[2]-l[2]);c=i.eR.normalize(i.eR.create(),c),this.dirVec=c,r.parallelProjection?this._dragParallelProjection(e,s,r,!0):this._dragPerspectiveProjection(e,s,r,!0),s.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,a.getEnabledElement)(t),{viewport:i}=n,o=i.getCamera();o.parallelProjection?this._dragParallelProjection(e,i,o):this._dragPerspectiveProjection(e,i,o),i.render()}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,i=(0,a.getEnabledElement)(t),o=n.world,s=i.viewport.getCamera(),{focalPoint:r,position:l}=s,d=[l[0]-o[0],l[1]-o[1],l[2]-o[2]],c=[r[0]-o[0],r[1]-o[1],r[2]-o[2]];i.viewport.setCamera({focalPoint:c,position:d}),i.viewport.render()}}r.toolName="Zoom";const l=r},1368:(e,t,n)=>{n.d(t,{A:()=>I});var i=n(84901),o=n(92136),a=n(96214),s=n(21090),r=n(38296),l=n(48428),d=n(21954),c=n(52475),h=n(74119),g=n(2746),u=n(61738),m=n(90252),v=n(23072),p=n(54177),E=n(40233);class f extends a.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:w}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:d}=s;(0,E.hideElementCursor)(i),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,a,h,g),p=l.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:p,referencedImageId:u},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,r.addAnnotation)(f,i);const w=(0,m.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:w,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,v.A)(d,w),f},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,c,h]=r.handles.points,g=s.worldToCanvas(l),u=s.worldToCanvas(c),m={start:{x:g[0],y:g[1]},end:{x:u[0],y:u[1]}};if(d.distanceToPoint([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]])<=i)return!0;if(!h)return!1;const v=s.worldToCanvas(h),p={start:{x:u[0],y:u[1]},end:{x:v[0],y:v[1]}};return d.distanceToPoint([p.start.x,p.start.y],[p.end.x,p.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,m.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,E.hideElementCursor)(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,v.A)(r,a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:s,hasMoved:l}=this.editData,{data:d}=i;if(s&&!l)return;if(this.angleStartedNotYetCompleted&&2===d.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,E.resetElementCursor)(n);const c=(0,o.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,v.A)(h,a),s&&(0,p.dZ)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,v.A)(c,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,E.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const s=(0,o.getEnabledElement)(e),{renderingEngine:r}=s;return(0,v.A)(r,n),i&&(0,p.dZ)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,r.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),d=i.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const r=a[o],{annotationUID:h,data:u}=r,{points:m,activeHandleIndex:v}=u.handles;c.annotationUID=h;const{color:p,lineWidth:E,lineDash:f}=this.getAnnotationStyle({annotation:r,styleSpecifier:c}),w=m.map((e=>i.worldToCanvas(e)));let I;if(u.cachedStats[s]&&null!=u.cachedStats[s].angle?r.invalidated&&this._throttledCalculateCachedStats(r,d,e):(u.cachedStats[s]={angle:null},this._calculateCachedStats(r,d,e)),(0,l.isAnnotationLocked)(r)||this.editData||null===v||(I=[w[v]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(I){const e="0";(0,g.drawHandles)(t,h,e,w,{color:p,lineDash:f,lineWidth:E})}let C="1";if((0,g.drawLine)(t,h,C,w[0],w[1],{color:p,width:E,lineDash:f}),n=!0,3!==w.length)return n;if(C="2",(0,g.drawLine)(t,h,C,w[1],w[2],{color:p,width:E,lineDash:f}),!u.cachedStats[s]?.angle)continue;const T=this.getLinkedTextBoxStyle(c,r);if(!T.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const _=this.configuration.getTextLines(u,s);if(!u.handles.textBox.hasMoved){const e=w[1];u.handles.textBox.worldPosition=i.canvasToWorld(e)}const S=i.worldToCanvas(u.handles.textBox.worldPosition),D="1",A=(0,g.drawLinkedTextBox)(t,h,D,_,S,w,{},T),{x:b,y,width:R,height:O}=A;u.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([b,y]),topRight:i.canvasToWorld([b+R,y]),bottomLeft:i.canvasToWorld([b,y+O]),bottomRight:i.canvasToWorld([b+R,y+O])}}return n},this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,m.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,E.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:h}=c;(0,v.A)(h,d),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{element:a}=n.viewport;if(3!==i.handles.points.length)return;const s=i.handles.points[0],r=i.handles.points[1],l=i.handles.points[2],{cachedStats:d}=i,h=Object.keys(d);for(let e=0;e<h.length;e++){const n=h[e],i=(0,c.A)([s,r],[r,l]),{dimensions:a,imageData:g}=this.getTargetIdImage(n,t);this.isHandleOutsideImage=[s,r,l].map((e=>o.utilities.transformWorldToIndex(g,e))).some((e=>!o.utilities.indexWithinDimensions(e,a))),d[n]={angle:isNaN(i)?"Incomplete Angle":i}}return e.invalidated=!1,(0,p.XF)(e,a),d}}function w(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;if(isNaN(i))return[`${i}`];return[`${(0,h.roundNumber)(i)} ${String.fromCharCode(176)}`]}f.toolName="Angle";const I=f},65314:(e,t,n)=>{n.d(t,{A:()=>f});var i=n(84901),o=n(92136),a=n(96214),s=n(38296),r=n(48428),l=n(21954),d=n(2746),c=n(61738),h=n(90252),g=n(23072),u=n(54177),m=n(40233);class v extends a.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:p,changeTextCallback:E,preventHandleOutsideImage:!1,arrowFirst:!0}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:d}=r;(0,m.hideElementCursor)(i),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:u,viewUp:v}=c,p=this.getReferencedImageId(l,a,u,v),{arrowFirst:E}=this.configuration,f=l.getFrameOfReferenceUID(),w={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...u],viewUp:[...v],FrameOfReferenceUID:f,referencedImageId:p},data:{text:"",handles:{points:[[...a],[...a]],activeHandleIndex:null,arrowFirst:E,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};(0,s.addAnnotation)(w,i);const I=(0,h.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:w,viewportIdsToRender:I,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,g.A)(d,I),w},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[d,c]=r.handles.points,h=s.worldToCanvas(d),g=s.worldToCanvas(c),u={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return l.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,h.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,m.hideElementCursor)(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,g.A)(r,a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=i;if(r&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,m.resetElementCursor)(n);const{renderingEngine:c}=(0,o.getEnabledElement)(n);this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.removeAnnotation)(i.annotationUID),r?this.configuration.getTextCallback((e=>{if(!e)return(0,s.removeAnnotation)(i.annotationUID),(0,g.A)(c,a),this.editData=null,void(this.isDrawing=!1);i.data.text=e,(0,u.dZ)(i),(0,g.A)(c,a)})):(0,u.XF)(i,n),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,g.A)(c,a)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=(0,s.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const o=i.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!o)return;const a=o;this.configuration.changeTextCallback(o,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,m.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:s}=(0,o.getEnabledElement)(e);return(0,g.A)(s,n),i&&(0,u.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback)},this._activateDraw=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,s.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const o=a[e],{annotationUID:s,data:c}=o,{handles:h,text:g}=c,{points:u,activeHandleIndex:m}=h;l.annotationUID=s;const{color:v,lineWidth:p,lineDash:E}=this.getAnnotationStyle({annotation:o,styleSpecifier:l}),f=u.map((e=>i.worldToCanvas(e)));let w;if((0,r.isAnnotationLocked)(o)||this.editData||null===m||(w=[f[m]]),w){const e="0";(0,d.drawHandles)(t,s,e,f,{color:v,lineWidth:p})}const I="1";if(this.configuration.arrowFirst?(0,d.drawArrow)(t,s,I,f[1],f[0],{color:v,width:p,lineDash:E}):(0,d.drawArrow)(t,s,I,f[0],f[1],{color:v,width:p,lineDash:E}),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!g)continue;const C=this.getLinkedTextBoxStyle(l,o);if(!C.visibility){c.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!c.handles.textBox.hasMoved){const e=f[1];c.handles.textBox.worldPosition=i.canvasToWorld(e)}const T=i.worldToCanvas(c.handles.textBox.worldPosition),_="1",S=(0,d.drawLinkedTextBox)(t,s,_,[g],T,f,{},C),{x:D,y:A,width:b,height:y}=S;c.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([D,A]),topRight:i.canvasToWorld([D+b,A]),bottomLeft:i.canvasToWorld([D,A+y]),bottomRight:i.canvasToWorld([D+b,A+y])}}return n}}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,h.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,m.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:u}=c;(0,g.A)(u,d),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;const i=(0,o.getEnabledElement)(e),{renderingEngine:a}=i,s=(0,h.getViewportIdsWithToolToRender)(e,this.getToolName());(0,g.A)(a,s),(0,u.XF)(t,e)}_isInsideVolume(e,t,n){return o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n)}}function p(e){return e(prompt("Enter your annotation:"))}function E(e,t,n){return n(prompt("Enter your annotation:"))}v.toolName="ArrowAnnotate";const f=v},50720:(e,t,n)=>{n.d(t,{A:()=>S});var i=n(44753),o=n(92136),a=n(24592),s=n(74119),r=n(96214),l=n(21090),d=n(38296),c=n(48428),h=n(21009),g=n(54177),u=n(2746),m=n(61738),v=n(84901),p=n(90252),E=n(21954),f=n(10910),w=n(40233),I=n(23072);const{transformWorldToIndex:C}=o.utilities;class T extends r.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:_}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles;let d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[1]),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},g=E.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]);return g<=i||(d=s.worldToCanvas(l[2]),c=s.worldToCanvas(l[3]),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},g=E.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]),g<=i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,I.A)(r,a),(0,w.hideElementCursor)(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,s=t.data;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,p.getViewportIdsWithToolToRender)(a,this.getToolName());(0,w.hideElementCursor)(a),this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:h}=c;(0,I.A)(h,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:c}=a;if(r&&!l)return;c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const{renderingEngine:h}=(0,o.getEnabledElement)(n);if(void 0!==this.editData.handleIndex){const{points:e}=c.handles,t=i.eR.distance(e[0],e[1]);if(i.eR.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],o=[...e[1]],a=i.Zc.create();i.Zc.set(a,t[1][0]-t[0][0],t[1][1]-t[1][0]);const s=i.Zc.create();i.Zc.set(s,-a[1],a[0]);const r=i.Zc.create();let l;i.Zc.set(r,o[0]-n[0],o[1]-n[0]),l=i.Zc.dot(r,s)>0?[n,o]:[o,n],c.handles.points=[t[0],t[1],l[0],l[1]]}}this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,d.removeAnnotation)(a.annotationUID),(0,I.A)(h,s),r&&(0,g.dZ)(a),this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:a}=t,s=(0,o.getEnabledElement)(a),{renderingEngine:r,viewport:l}=s,{worldToCanvas:d}=l,{annotation:c,viewportIdsToRender:h,handleIndex:g}=this.editData,{data:u}=c,m=n.world;u.handles.points[g]=[...m];const v=u.handles.points.map(d),p={start:{x:v[0][0],y:v[0][1]},end:{x:v[1][0],y:v[1][1]}},E=(v[2][0],v[2][1],v[3][0],v[3][1],i.Zc.distance(v[0],v[1])/3),f=p.start.x-p.end.x,w=p.start.y-p.end.y,C=Math.sqrt(f*f+w*w),T=f/C,_=w/C,S=(p.start.x+p.end.x)/2,D=(p.start.y+p.end.y)/2,A=S+E*_,b=D-E*T,y=S-E*_,R=D+E*T;u.handles.points[2]=l.canvasToWorld([A,b]),u.handles.points[3]=l.canvasToWorld([y,R]),c.invalidated=!0,(0,I.A)(r,h),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n),{renderingEngine:a}=i,{annotation:s,viewportIdsToRender:r,handleIndex:l,movingTextBox:d}=this.editData,{data:c}=s;if(d){const{deltaPoints:e}=t,n=e.world,{textBox:i}=c.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===l){const{deltaPoints:e}=t,n=e.world;c.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),s.invalidated=!0}else this._dragModifyHandle(e),s.invalidated=!0;(0,I.A)(a,r)},this._dragModifyHandle=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=(0,o.getEnabledElement)(a),{viewport:r}=s,{annotation:l,handleIndex:d}=this.editData,{data:c}=l,h=n.world,g=[r.worldToCanvas(c.handles.points[0]),r.worldToCanvas(c.handles.points[1]),r.worldToCanvas(c.handles.points[2]),r.worldToCanvas(c.handles.points[3])],u={start:{x:g[0][0],y:g[0][1]},end:{x:g[1][0],y:g[1][1]}},m={start:{x:g[2][0],y:g[2][1]},end:{x:g[3][0],y:g[3][1]}},v=[...h],p=r.worldToCanvas(v);if(0===d||1===d){const e=g[0===d?1:0],t=i.Zc.set(i.Zc.create(),p[0]-e[0],p[1]-e[1]),n=i.Zc.set(i.Zc.create(),g[d][0]-e[0],g[d][1]-e[1]);i.Zc.normalize(t,t),i.Zc.normalize(n,n);const o={start:{x:e[0],y:e[1]},end:{x:p[0],y:p[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(o,m))return;const a=e,s=this._getSignedAngle(n,t);let l=g[2][0],h=g[2][1],u=g[3][0],E=g[3][1];l-=a[0],h-=a[1],u-=a[0],E-=a[1];const f=l*Math.cos(s)-h*Math.sin(s),w=l*Math.sin(s)+h*Math.cos(s),I=u*Math.cos(s)-E*Math.sin(s),C=u*Math.sin(s)+E*Math.cos(s);l=f+a[0],h=w+a[1],u=I+a[0],E=C+a[1];const T=r.canvasToWorld([l,h]),_=r.canvasToWorld([u,E]);c.handles.points[d]=v,c.handles.points[2]=T,c.handles.points[3]=_}else{const e=2===d?3:2,t={longLineSegment:{start:u.start,end:u.end},shortLineSegment:{start:m.start,end:m.end}},n=i.Zc.subtract(i.Zc.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),o=i.Zc.normalize(i.Zc.create(),n),a=i.Zc.subtract(i.Zc.create(),[p[0],p[1]],[g[d][0],g[d][1]]),s=i.Zc.length(a),l=this._getSignedAngle(o,a),h=Math.cos(l)*s,f=i.Zc.scaleAndAdd(i.Zc.create(),[g[e][0],g[e][1]],o,h);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:p[0],y:p[1]},end:{x:f[0],y:f[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!E.intersectLine([p[0],p[1]],[f[0],f[1]],[u.start.x,u.start.y],[u.end.x,u.end.y]))return;c.handles.points[e]=r.canvasToWorld(f),c.handles.points[d]=v}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:s}=(0,o.getEnabledElement)(e);return(0,I.A)(s,n),i&&(0,g.dZ)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{m.wk.isInteractingWithTool=!0,e.addEventListener(v.Events.MOUSE_UP,this._endCallback),e.addEventListener(v.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(v.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(v.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(v.Events.TOUCH_TAP,this._endCallback),e.addEventListener(v.Events.TOUCH_END,this._endCallback),e.addEventListener(v.Events.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{m.wk.isInteractingWithTool=!1,e.removeEventListener(v.Events.MOUSE_UP,this._endCallback),e.removeEventListener(v.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(v.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(v.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(v.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(v.Events.TOUCH_END,this._endCallback),e.removeEventListener(v.Events.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{m.wk.isInteractingWithTool=!0,e.addEventListener(v.Events.MOUSE_UP,this._endCallback),e.addEventListener(v.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(v.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(v.Events.TOUCH_END,this._endCallback),e.addEventListener(v.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(v.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{m.wk.isInteractingWithTool=!1,e.removeEventListener(v.Events.MOUSE_UP,this._endCallback),e.removeEventListener(v.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(v.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(v.Events.TOUCH_END,this._endCallback),e.removeEventListener(v.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(v.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:i}=e,{element:o}=i;let a=(0,d.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:g,data:m}=d,{points:v,activeHandleIndex:p}=m.handles,E=v.map((e=>i.worldToCanvas(e)));l.annotationUID=g;const{color:w,lineWidth:I,lineDash:C,shadow:T}=this.getAnnotationStyle({annotation:d,styleSpecifier:l});if(m.cachedStats[s]&&null!=m.cachedStats[s].unit?d.invalidated&&this._throttledCalculateCachedStats(d,r,e):(m.cachedStats[s]={length:null,width:null,unit:null},this._calculateCachedStats(d,r,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let _;if(!(0,h.isAnnotationVisible)(g))continue;if((0,c.isAnnotationLocked)(d)||this.editData||null===p||(_=[E[p]]),_){const e="0";(0,u.drawHandles)(t,g,e,_,{color:w})}const S=`${g}-line-1`,D=`${g}-line-2`,A="0";(0,u.drawLine)(t,g,A,E[0],E[1],{color:w,lineDash:C,lineWidth:I,shadow:T},S);const b="1";(0,u.drawLine)(t,g,b,E[2],E[3],{color:w,lineDash:C,lineWidth:I,shadow:T},D),n=!0;const y=this.getLinkedTextBoxStyle(l,d);if(!y.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const R=this.configuration.getTextLines(m,s);if(!R||0===R.length)continue;let O;m.handles.textBox.hasMoved||(O=(0,f.getTextBoxCoordsCanvas)(E),m.handles.textBox.worldPosition=i.canvasToWorld(O));const M=i.worldToCanvas(m.handles.textBox.worldPosition),x="1",L=(0,u.drawLinkedTextBox)(t,g,x,R,M,E,{},y),{x:U,y:N,width:P,height:k}=L;m.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([U,N]),topRight:i.canvasToWorld([U+P,N]),bottomLeft:i.canvasToWorld([U,N+k]),bottomRight:i.canvasToWorld([U+P,N+k])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{const n=i.Zc.create();i.Zc.set(n,t.end.x-t.start.x,t.end.y-t.start.y),i.Zc.normalize(n,n);const o={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!E.intersectLine([o.start.x,o.start.y],[o.end.x,o.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,t,n)=>{const{data:i}=e,{element:o}=n.viewport,s=i.handles.points[0],r=i.handles.points[1],l=i.handles.points[2],d=i.handles.points[3],{cachedStats:c}=i,h=Object.keys(c);for(let e=0;e<h.length;e++){const n=h[e],i=this.getTargetIdImage(n,t);if(!i)continue;const{imageData:o,dimensions:g}=i,u=C(o,s),m=C(o,r),v=C(o,l),p=C(o,d),E=[u,m],f=[v,p],{scale:w,units:I}=(0,a.Op)(i,E),{scale:T,units:_}=(0,a.Op)(i,f),S=this._calculateLength(s,r)/w,D=this._calculateLength(l,d)/T,A=S>D?S:D,b=S>D?D:S,y=S>D?I:_,R=S>D?_:I;this._isInsideVolume(u,m,v,p,g)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[n]={length:A,width:b,unit:I,lengthUnit:y,widthUnit:R}}return e.invalidated=!1,(0,g.XF)(e,o),c},this._isInsideVolume=(e,t,n,i,a)=>o.utilities.indexWithinDimensions(e,a)&&o.utilities.indexWithinDimensions(t,a)&&o.utilities.indexWithinDimensions(n,a)&&o.utilities.indexWithinDimensions(i,a),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=(0,l.A)(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:r,renderingEngine:l}=s;this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(r,a,h,g),m=r.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u},data:{handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};(0,d.addAnnotation)(v,i);const E=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:E,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,w.hideElementCursor)(i),e.preventDefault(),(0,I.A)(l,E),v}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}}function _(e,t){const{cachedStats:n,label:i}=e,{length:o,width:a,unit:r,lengthUnit:l,widthUnit:d}=n[t],c=[];return i&&c.push(i),void 0===o||c.push(`L: ${(0,s.roundNumber)(o)} ${l||r}`,`W: ${(0,s.roundNumber)(a)} ${d||r}`),c}T.toolName="Bidirectional";const S=T},42865:(e,t,n)=>{n.d(t,{A:()=>y});var i=n(96214),o=n(92136),a=n(24592),s=n(74119),r=n(21090),l=n(38296),d=n(48428),c=n(21009),h=n(54177),g=n(2746),u=n(61738),m=n(84901),v=n(90252),p=n(10910),E=n(31970),f=n(40233),w=n(23072),I=n(73801),C=n(97022),T=n(75162),_=n(2264),S=n(83112);const{transformWorldToIndex:D}=o.utilities;class A extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:b,statsCalculator:S.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:r,renderingEngine:d}=s;this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(r,a,h,g),m=r.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a]],activeHandleIndex:null},cachedStats:{}}};(0,l.addAnnotation)(p,i);const E=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:E,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,f.hideElementCursor)(i),e.preventDefault(),(0,w.A)(d,E),p},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=l.map((e=>s.worldToCanvas(e))),c=(0,T.r)(d),h=(0,T.r)([d[0],n]);return Math.abs(h-c)<i/2},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,f.hideElementCursor)(i),this._activateModify(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,w.A)(r,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;let r,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=s.handles;r=e.findIndex((e=>e===n))}const d=(0,v.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,f.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:h}=c;(0,w.A)(h,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:s,hasMoved:r}=this.editData,{data:d}=i;if(s&&!r)return;i.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,f.resetElementCursor)(n);const{renderingEngine:c}=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(i.annotationUID),(0,w.A)(c,a),s&&(0,h.dZ)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,s=(0,o.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h}=this.editData,{data:g}=c;g.handles.points=[g.handles.points[0],d(a)],c.invalidated=!0,this.editData.hasMoved=!0,(0,w.A)(r,h)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,w.A)(c,a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:s}=i.viewport,{annotation:r,handleIndex:l}=this.editData,{data:d}=r,{points:c}=d.handles,h=c.map((e=>s(e))),{currentPoints:g}=t,u=g.canvas;if(0===l){const e=u[0]-h[0][0],t=u[1]-h[0][1],n=u,i=[h[1][0]+e,h[1][1]+t];c[0]=a(n),c[1]=a(i)}else c[1]=a(u)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,f.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:s}=(0,o.getEnabledElement)(e);return(0,w.A)(s,n),i&&(0,h.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,l.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),h=i.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<s.length;a++){const l=s[a],{annotationUID:m,data:v}=l,{handles:E}=v,{points:f,activeHandleIndex:w}=E;u.annotationUID=m;const{color:I,lineWidth:C,lineDash:_}=this.getAnnotationStyle({annotation:l,styleSpecifier:u}),S=f.map((e=>i.worldToCanvas(e))),D=S[0],A=(0,T.r)(S),b=(0,T.H)(S),{centerPointRadius:y}=this.configuration;if(v.cachedStats[r]&&null!=v.cachedStats[r].areaUnit){if(l.invalidated&&(this._throttledCalculateCachedStats(l,i,h,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=l.metadata;for(const t in v.cachedStats)if(t.startsWith("imageId")){h.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete v.cachedStats[t]}}}else v.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(l,i,h,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let R;if(!(0,c.isAnnotationVisible)(m))continue;if((0,d.isAnnotationLocked)(l)||this.editData||null===w||(R=[S[w]]),R){const e="0";(0,g.drawHandles)(t,m,e,R,{color:I})}const O=`${m}-circle`,M="0";(0,g.drawCircle)(t,m,M,D,A,{color:I,lineDash:_,lineWidth:C},O),y>0&&A>3*y&&(0,g.drawCircle)(t,m,`${M}-center`,D,y,{color:I,lineDash:_,lineWidth:C}),n=!0;const x=this.getLinkedTextBoxStyle(u,l);if(!x.visibility){v.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const L=this.configuration.getTextLines(v,r);if(!L||0===L.length)continue;let U;v.handles.textBox.hasMoved||(U=(0,p.getTextBoxCoordsCanvas)(b),v.handles.textBox.worldPosition=i.canvasToWorld(U));const N=i.worldToCanvas(v.handles.textBox.worldPosition),P="1",k=(0,g.drawLinkedTextBox)(t,m,P,L,N,S,{},x),{x:V,y:W,width:H,height:B}=k;v.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([V,W]),topRight:i.canvasToWorld([V+H,W]),bottomLeft:i.canvasToWorld([V,W+B]),bottomRight:i.canvasToWorld([V+H,W+B])}}return n},this._calculateCachedStats=(e,t,n,i)=>{const o=e.data,{element:r}=t,{points:l}=o.handles,d=l.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:c,viewUp:g}=t.getCamera(),[u,m]=(0,T.H)(d),v=t.canvasToWorld(u),p=t.canvasToWorld(m),{cachedStats:f}=o,w=Object.keys(f),S=v,A=p;for(let i=0;i<w.length;i++){const o=w[i],r=this.getTargetIdImage(o,n);if(!r)continue;const{dimensions:l,imageData:d,metadata:h,hasPixelSpacing:u}=r,m=D(d,S);m[0]=Math.floor(m[0]),m[1]=Math.floor(m[1]),m[2]=Math.floor(m[2]);const T=D(d,A);if(T[0]=Math.floor(T[0]),T[1]=Math.floor(T[1]),T[2]=Math.floor(T[2]),this._isInsideVolume(m,T,l)){const n=[[Math.min(m[0],T[0]),Math.max(m[0],T[0])],[Math.min(m[1],T[1]),Math.max(m[1],T[1])],[Math.min(m[2],T[2]),Math.max(m[2],T[2])]],i={center:[(v[0]+p[0])/2,(v[1]+p[1])/2,(v[2]+p[2])/2],xRadius:Math.abs(v[0]-p[0])/2,yRadius:Math.abs(v[1]-p[1])/2,zRadius:Math.abs(v[2]-p[2])/2},{worldWidth:l,worldHeight:u}=(0,E.A)(c,g,S,A),w=0===l&&0===u,D=[m,T],{scale:b,units:y,areaUnits:R}=(0,s.getCalibratedLengthUnitsAndScale)(r,D),O=(0,a.CQ)(r),M=Math.abs(Math.PI*(l/b/2)*(u/O/b/2)),x={isPreScaled:(0,C.u)(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},L=(0,I.c)(h.Modality,e.metadata.referencedImageId,x),U=(0,s.pointInShapeCallback)(d,(e=>(0,_.pointInEllipse)(i,e,{fast:!0})),this.configuration.statsCalculator.statsCallback,n),N=this.configuration.statsCalculator.getStatistics();f[o]={Modality:h.Modality,area:M,mean:N.mean?.value,max:N.max?.value,stdDev:N.stdDev?.value,statsArray:N.array,pointsInShape:U,isEmptyArea:w,areaUnit:R,radius:l/2/b,radiusUnit:y,perimeter:2*Math.PI*(l/2)/b,modalityUnit:L}}else this.isHandleOutsideImage=!0,f[o]={Modality:h.Modality}}return e.invalidated=!1,(0,h.XF)(e,r),f},this._isInsideVolume=(e,t,n)=>o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,100,{trailing:!0})}}function b(e,t){const n=e.cachedStats[t],{radius:i,radiusUnit:o,area:a,mean:r,stdDev:l,max:d,isEmptyArea:c,areaUnit:h,modalityUnit:g}=n,u=[];if(i){const e=c?"Radius: Oblique not supported":`Radius: ${(0,s.roundNumber)(i)} ${o}`;u.push(e)}if(a){const e=c?"Area: Oblique not supported":`Area: ${(0,s.roundNumber)(a)} ${h}`;u.push(e)}return r&&u.push(`Mean: ${(0,s.roundNumber)(r)} ${g}`),d&&u.push(`Max: ${(0,s.roundNumber)(d)} ${g}`),l&&u.push(`Std Dev: ${(0,s.roundNumber)(l)} ${g}`),u}A.toolName="CircleROI";const y=A},40310:(e,t,n)=>{n.d(t,{A:()=>T});var i=n(44753),o=n(84901),a=n(92136),s=n(96214),r=n(21090),l=n(38296),d=n(48428),c=n(54177),h=n(21954),g=n(52475),u=n(76727),m=n(2746),v=n(61738),p=n(90252),E=n(10910),f=n(23072),w=n(40233);class I extends s.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:C,showArcLines:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,s=(0,a.getEnabledElement)(i),{viewport:r,renderingEngine:d}=s;(0,w.hideElementCursor)(i),this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(r,o,h,g),m=r.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u},data:{handles:{points:[[...o],[...o]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,l.addAnnotation)(v,i);const E=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:E,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,f.A)(d,E),v},this.isPointNearTool=(e,t,n,i)=>{const o=(0,a.getEnabledElement)(e),{viewport:s}=o,{data:r}=t,{distanceToPoint:l,distanceToPoint2:d}=this.distanceToLines({viewport:s,points:r.handles.points,canvasCoords:n,proximity:i});return l<=i||d<=i},this.toolSelectedCallback=(e,t,n,i,o=6)=>{const s=e.detail,{element:r}=s;t.highlighted=!0;const l=(0,p.getViewportIdsWithToolToRender)(r,this.getToolName()),d=(0,a.getEnabledElement)(r),{renderingEngine:c,viewport:h}=d,{isNearFirstLine:g,isNearSecondLine:u}=this.distanceToLines({viewport:h,points:t.data.handles.points,canvasCoords:i,proximity:o});this.editData={annotation:t,viewportIdsToRender:l,movingTextBox:!1,isNearFirstLine:g,isNearSecondLine:u},this._activateModify(r),(0,w.hideElementCursor)(r),(0,f.A)(c,l),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:s,hasMoved:r}=this.editData,{data:d}=i;if(s&&!r)return;if(this.angleStartedNotYetCompleted&&d.handles.points.length<4)return(0,w.resetElementCursor)(n),void(this.editData.handleIndex=d.handles.points.length);this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const h=(0,a.getEnabledElement)(n),{renderingEngine:g}=h;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(i.annotationUID),(0,f.A)(g,o),s&&(0,c.dZ)(i),this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:t,handleIndex:n}=this.editData,i=e.detail,{element:o,currentPoints:a}=i,s=a.world,{data:r}=t;return 1===n?(r.handles.points[1]=s,void(this.editData.hasMoved=r.handles.points[1][0]!==r.handles.points[0][0]||r.handles.points[1][1]!==r.handles.points[0][0])):3===n?(r.handles.points[3]=s,this.editData.hasMoved=r.handles.points[3][0]!==r.handles.points[2][0]||r.handles.points[3][1]!==r.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,(0,w.hideElementCursor)(o),r.handles.points[2]=r.handles.points[3]=s,void(this.editData.handleIndex=r.handles.points.length-1))},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,handleIndex:s,movingTextBox:r,isNearFirstLine:l,isNearSecondLine:d}=this.editData,{data:c}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=c.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s&&(l||d)){const{deltaPoints:e}=t,n=e.world,o=c.handles.points;if(l){[o[0],o[1]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}else if(d){[o[2],o[3]].forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}))}i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;c.handles.points[s]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const h=(0,a.getEnabledElement)(n),{renderingEngine:g}=h;(0,f.A)(g,o)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:o}=t;o.handles.points.length<4&&(0,l.removeAnnotation)(t.annotationUID),t.highlighted=!1,o.handles.activeHandleIndex=null;const s=(0,a.getEnabledElement)(e),{renderingEngine:r}=s;return(0,f.A)(r,n),i&&(0,c.dZ)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._mouseUpCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._mouseUpCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(o.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(o.Events.MOUSE_DOWN,this._mouseDownCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(o.Events.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(o.Events.MOUSE_DOWN,this._mouseDownCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,l.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const l=a[o],{annotationUID:h,data:g}=l,{points:v,activeHandleIndex:p}=g.handles;c.annotationUID=h;const{color:f,lineWidth:w,lineDash:I}=this.getAnnotationStyle({annotation:l,styleSpecifier:c}),C=v.map((e=>i.worldToCanvas(e)));let T;if(g.cachedStats[s]&&null!=g.cachedStats[s].angle?l.invalidated&&this._throttledCalculateCachedStats(l,r,e):(g.cachedStats[s]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(l,r,e)),(0,d.isAnnotationLocked)(l)||this.editData||null===p||(T=[C[p]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(T){const e="0";(0,m.drawHandles)(t,h,e,C,{color:f,lineDash:I,lineWidth:w})}const _=[C[0],C[1]],S=[C[2],C[3]];let D="line1";if((0,m.drawLine)(t,h,D,_[0],_[1],{color:f,width:w,lineDash:I}),n=!0,C.length<4)return n;D="line2",(0,m.drawLine)(t,h,D,S[0],S[1],{color:f,width:w,lineDash:I}),D="linkLine";const A=(0,u.f)(_[0],_[1]),b=(0,u.f)(S[0],S[1]);(0,m.drawLine)(t,h,D,A,b,{color:f,lineWidth:"1",lineDash:"1,4"});const{arc1Start:y,arc1End:R,arc2End:O,arc2Start:M}=g.cachedStats[s].points.canvas,{arc1Angle:x,arc2Angle:L}=g.cachedStats[s];if(this.configuration.showArcLines&&(D="arc1",(0,m.drawLine)(t,h,D,y,R,{color:f,lineWidth:"1"}),D="arc2",(0,m.drawLine)(t,h,D,M,O,{color:f,lineWidth:"1"})),!g.cachedStats[s]?.angle)continue;const U=this.getLinkedTextBoxStyle(c,l);if(!U.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const N=this.configuration.getTextLines(g,s);if(!g.handles.textBox.hasMoved){const e=(0,E.getTextBoxCoordsCanvas)(C);g.handles.textBox.worldPosition=i.canvasToWorld(e)}const P=i.worldToCanvas(g.handles.textBox.worldPosition),k="cobbAngleText",V=(0,m.drawLinkedTextBox)(t,h,k,N,P,C,{},U),{x:W,y:H,width:B,height:F}=V;if(g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([W,H]),topRight:i.canvasToWorld([W+B,H]),bottomLeft:i.canvasToWorld([W,H+F]),bottomRight:i.canvasToWorld([W+B,H+F])},this.configuration.showArcLines){const e="arcAngle1",n=[`${x.toFixed(2)} ${String.fromCharCode(176)}`],i=(0,u.f)(y,R);(0,m.drawTextBox)(t,h,e,n,i,{...U,padding:3});const o="arcAngle2",a=[`${L.toFixed(2)} ${String.fromCharCode(176)}`],s=(0,u.f)(M,O);(0,m.drawTextBox)(t,h,o,a,s,{...U,padding:3})}}return n},this.distanceToLines=({viewport:e,points:t,canvasCoords:n,proximity:i})=>{const[o,a,s,r]=t,l=e.worldToCanvas(o),d=e.worldToCanvas(a),c=e.worldToCanvas(s),g=e.worldToCanvas(r),u={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},m={start:{x:c[0],y:c[1]},end:{x:g[0],y:g[1]}},v=h.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]),p=h.distanceToPoint([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]]);let E=!1,f=!1;return v<=i?E=!0:p<=i&&(f=!0),{distanceToPoint:v,distanceToPoint2:p,isNearFirstLine:E,isNearSecondLine:f}},this.getArcsStartEndPoints=({firstLine:e,secondLine:t,mid1:n,mid2:i})=>{const o=[n,i],a=(0,g.A)(e,o),s=(0,g.A)(t,o),r=a>90?1:0,l=s>90?0:1,d=(0,u.f)(o[0],o[1]),c=Math.sqrt((o[1][0]-o[0][0])**2+(o[1][1]-o[0][1])**2),h=.1,m=(0,u.f)(e[0],e[1]),v=(0,u.f)(t[0],t[1]),p=[e[r][0]-m[0],e[r][1]-m[1]],E=Math.sqrt(p[0]**2+p[1]**2),f=[p[0]/E,p[1]/E],w=[m[0]+f[0]*c*h,m[1]+f[1]*c*h],I=[d[0]-n[0],d[1]-n[1]],C=Math.sqrt(I[0]**2+I[1]**2),T=[I[0]/C,I[1]/C],_=[n[0]+T[0]*c*h,n[1]+T[1]*c*h],S=[t[l][0]-v[0],t[l][1]-v[1]],D=Math.sqrt(S[0]**2+S[1]**2),A=[S[0]/D,S[1]/D],b=[v[0]+A[0]*c*h,v[1]+A[1]*c*h],y=[d[0]-i[0],d[1]-i[1]],R=Math.sqrt(y[0]**2+y[1]**2),O=[y[0]/R,y[1]/R];return{arc1Start:w,arc1End:_,arc2Start:b,arc2End:[i[0]+O[0]*c*h,i[1]+O[1]*c*h],arc1Angle:a>90?180-a:a,arc2Angle:s>90?180-s:s}},this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(e,t,n,i="mouse"){const o=e.detail,{element:s}=o,{data:r}=t;t.highlighted=!0;let l,d=!1;n.worldPosition?d=!0:l=r.handles.points.findIndex((e=>e===n));const c=(0,p.getViewportIdsWithToolToRender)(s,this.getToolName());this.editData={annotation:t,viewportIdsToRender:c,handleIndex:l,movingTextBox:d},this._activateModify(s),(0,w.hideElementCursor)(s);const h=(0,a.getEnabledElement)(s),{renderingEngine:g}=h;(0,f.A)(g,c),e.preventDefault()}_calculateCachedStats(e,t,n){const o=e.data;if(4!==o.handles.points.length)return;const a=[null,null],s=[null,null];let r=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=i.eR.distance(o.handles.points[e],o.handles.points[t]);n<r&&(r=n,a[1]=o.handles.points[e],a[0]=o.handles.points[(e+1)%2],s[0]=o.handles.points[t],s[1]=o.handles.points[2+(t-1)%2])}const{viewport:l}=n,{element:d}=l,h=o.handles.points.map((e=>l.worldToCanvas(e))),m=[h[0],h[1]],v=[h[2],h[3]],p=(0,u.f)(m[0],m[1]),E=(0,u.f)(v[0],v[1]),{arc1Start:f,arc1End:w,arc2End:I,arc2Start:C,arc1Angle:T,arc2Angle:_}=this.getArcsStartEndPoints({firstLine:m,secondLine:v,mid1:p,mid2:E}),{cachedStats:S}=o,D=Object.keys(S);for(let e=0;e<D.length;e++){S[D[e]]={angle:(0,g.A)(a,s),arc1Angle:T,arc2Angle:_,points:{canvas:{arc1Start:f,arc1End:w,arc2End:I,arc2Start:C},world:{arc1Start:l.canvasToWorld(f),arc1End:l.canvasToWorld(w),arc2End:l.canvasToWorld(I),arc2Start:l.canvasToWorld(C)}}}}return e.invalidated=!1,(0,c.XF)(e,d),S}}function C(e,t){const n=e.cachedStats[t],{angle:i}=n;if(void 0===i)return;return[`${i.toFixed(2)} ${String.fromCharCode(176)}`]}I.toolName="CobbAngle";const T=I},28087:(e,t,n)=>{n.d(t,{A:()=>g});var i=n(92136),o=n(2746),a=n(90252),s=n(40233),r=n(23072),l=n(30049),d=n(97022);class c extends l.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:h}}){super(e,t),this.postMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,l=n.world,d=(0,i.getEnabledElement)(o),{viewport:c,renderingEngine:h}=d;this.isDrawing=!0;const g=c.getCamera(),{viewPlaneNormal:u,viewUp:m}=g,v=this.getReferencedImageId(c,l,u,m),p={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...u],viewUp:[...m],FrameOfReferenceUID:c.getFrameOfReferenceUID(),referencedImageId:v},data:{label:"",handles:{points:[[...l]]},cachedStats:{}}},E=(0,a.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:p,newAnnotation:!0,viewportIdsToRender:E},this._activateModify(o),(0,s.hideElementCursor)(o),e.preventDefault(),(0,r.A)(h,E),p},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e;if(!this.editData)return n;const a=this.filterInteractableAnnotationsForElement(i.element,[this.editData.annotation]);if(!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},c=this.editData.annotation,h=c.annotationUID,g=c.data,u=g.handles.points[0],m=i.worldToCanvas(u);l.annotationUID=h;const{color:v}=this.getAnnotationStyle({annotation:c,styleSpecifier:l});(0,d.u)(i,s),this.isSuvScaled(i,s,c.metadata.referencedImageId);if(g.cachedStats[s]&&null!=g.cachedStats[s].value?c.invalidated&&this._calculateCachedStats(c,r,e):(g.cachedStats[s]={Modality:null,index:null,value:null},this._calculateCachedStats(c,r,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;(0,o.drawHandles)(t,h,"0",[m],{color:v}),n=!0;const p=this.configuration.getTextLines(g,s);if(p){const e=[m[0]+6,m[1]-6],n="0";(0,o.drawTextBox)(t,h,n,p,[e[0],e[1]],this.getLinkedTextBoxStyle(l,c))}return n}}}function h(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const s=[];return s.push(`(${i[0]}, ${i[1]}, ${i[2]})`),s.push(`${o.toFixed(2)} ${a}`),s}c.toolName="DragProbe";const g=c},19116:(e,t,n)=>{n.d(t,{A:()=>b});var i=n(96214),o=n(92136),a=n(24592),s=n(74119),r=n(21090),l=n(38296),d=n(48428),c=n(21009),h=n(54177),g=n(2746),u=n(61738),m=n(84901),v=n(90252),p=n(10910),E=n(31970),f=n(2264),w=n(40233),I=n(23072),C=n(73801),T=n(97022),_=n(83112);const{transformWorldToIndex:S}=o.utilities;class D extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0,getTextLines:A,statsCalculator:_.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(n.canvas,(0,o.getEnabledElement)(i)),{viewport:r,renderingEngine:d}=s;this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(r,a,h,g),m=r.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},initialRotation:r.getRotation()}};(0,l.addAnnotation)(p,i);const E=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:E,centerWorld:a,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,w.hideElementCursor)(i),e.preventDefault(),(0,I.A)(d,E),p},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=l.map((e=>s.worldToCanvas(e))),c=(0,f.getCanvasEllipseCorners)(d),[h,g]=c,u={left:Math.min(h[0],g[0])+i/2,top:Math.min(h[1],g[1])+i/2,width:Math.abs(h[0]-g[0])-i,height:Math.abs(h[1]-g[1])-i},m={left:Math.min(h[0],g[0])-i/2,top:Math.min(h[1],g[1])-i/2,width:Math.abs(h[0]-g[0])+i,height:Math.abs(h[1]-g[1])+i},v=this._pointInEllipseCanvas(u,n);return!(!this._pointInEllipseCanvas(m,n)||v)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,w.hideElementCursor)(i),this._activateModify(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,I.A)(r,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;let r,l,d,c,h,g,u=!1;if(n.worldPosition)u=!0;else{const{points:e}=s.handles,{viewport:t}=(0,o.getEnabledElement)(a),{worldToCanvas:i,canvasToWorld:u}=t;r=e.findIndex((e=>e===n));const m=e.map(i);g=m[r],c=Math.abs(m[2][0]-m[3][0]),h=Math.abs(m[0][1]-m[1][1]),l=[(m[2][0]+m[3][0])/2,(m[0][1]+m[1][1])/2],d=u(l)}const m=(0,v.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:m,handleIndex:r,canvasWidth:c,canvasHeight:h,centerWorld:d,originalHandleCanvas:g,movingTextBox:u},this._activateModify(a),(0,w.hideElementCursor)(a);const p=(0,o.getEnabledElement)(a),{renderingEngine:E}=p;(0,I.A)(E,m),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:s,hasMoved:r}=this.editData,{data:d}=i;if(s&&!r)return;i.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const{renderingEngine:c}=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(i.annotationUID),(0,I.A)(c,a),s&&(0,h.dZ)(i)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,s=(0,o.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h,centerWorld:g}=this.editData,u=l.worldToCanvas(g),{data:m}=c,v=Math.abs(a[0]-u[0]),p=Math.abs(a[1]-u[1]),E=[u[0],u[1]-p],f=[u[0],u[1]+p],w=[u[0]-v,u[1]],C=[u[0]+v,u[1]];m.handles.points=[d(E),d(f),d(w),d(C)],c.invalidated=!0,this.editData.hasMoved=!0,(0,I.A)(r,h)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else this._dragHandle(e),i.invalidated=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,I.A)(c,a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,{viewport:i}=(0,o.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:s}=i,{annotation:r,canvasWidth:l,canvasHeight:d,handleIndex:c,centerWorld:h,originalHandleCanvas:g}=this.editData,u=i.worldToCanvas(h),{data:m}=r,{points:v}=m.handles,{currentPoints:p}=t,E=p.canvas;if(0===c||1===c){const e=Math.abs(E[1]-u[1]),t=[u[0],u[1]-e],n=[u[0],u[1]+e];v[0]=a(t),v[1]=a(n);const i=l/2+(E[0]-g[0]),o=[u[0]-i,u[1]],s=[u[0]+i,u[1]];v[2]=a(o),v[3]=a(s)}else{const e=Math.abs(E[0]-u[0]),t=[u[0]-e,u[1]],n=[u[0]+e,u[1]];v[2]=a(t),v[3]=a(n);const i=d/2+(E[1]-g[1]),o=[u[0],u[1]-i],s=[u[0],u[1]+i];v[0]=a(o),v[1]=a(s)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:s}=(0,o.getEnabledElement)(e);return(0,I.A)(s,n),i&&(0,h.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,l.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),h=i.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<s.length;a++){const l=s[a],{annotationUID:m,data:v}=l,{handles:E}=v,{points:w,activeHandleIndex:I}=E;u.annotationUID=m;const{color:C,lineWidth:T,lineDash:_}=this.getAnnotationStyle({annotation:l,styleSpecifier:u}),S=w.map((e=>i.worldToCanvas(e))),D=(Math.abs(i.getRotation()-(v.initialRotation||0)),(0,f.getCanvasEllipseCorners)(S)),{centerPointRadius:A}=this.configuration;if(v.cachedStats[r]&&null!=v.cachedStats[r].areaUnit){if(l.invalidated&&(this._throttledCalculateCachedStats(l,i,h,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=l.metadata;for(const t in v.cachedStats)if(t.startsWith("imageId")){h.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete v.cachedStats[t]}}}else v.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(l,i,h);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!(0,c.isAnnotationVisible)(m))continue;if((0,d.isAnnotationLocked)(l)||this.editData||null===I||(b=[S[I]]),b){const e="0";(0,g.drawHandles)(t,m,e,b,{color:C})}const y=`${m}-ellipse`,R="0";if((0,g.drawEllipseByCoordinates)(t,m,R,S,{color:C,lineDash:_,lineWidth:T},y),A>0){if(Math.min(Math.abs(D[0][0]-D[1][0])/2,Math.abs(D[0][1]-D[1][1])/2)>3*A){const e=this._getCanvasEllipseCenter(S);(0,g.drawCircle)(t,m,`${R}-center`,e,A,{color:C,lineDash:_,lineWidth:T})}}n=!0;const O=this.getLinkedTextBoxStyle(u,l);if(!O.visibility){v.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const M=this.configuration.getTextLines(v,r);if(!M||0===M.length)continue;let x;v.handles.textBox.hasMoved||(x=(0,p.getTextBoxCoordsCanvas)(D),v.handles.textBox.worldPosition=i.canvasToWorld(x));const L=i.worldToCanvas(v.handles.textBox.worldPosition),U="1",N=(0,g.drawLinkedTextBox)(t,m,U,M,L,S,{},O),{x:P,y:k,width:V,height:W}=N;v.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,k]),topRight:i.canvasToWorld([P+V,k]),bottomLeft:i.canvasToWorld([P,k+W]),bottomRight:i.canvasToWorld([P+V,k+W])}}return n},this._calculateCachedStats=(e,t,n)=>{const i=e.data,{element:o}=t,{points:r}=i.handles,l=r.map((e=>t.worldToCanvas(e))),{viewPlaneNormal:d,viewUp:c}=t.getCamera(),[g,u]=(0,f.getCanvasEllipseCorners)(l),m=t.canvasToWorld(g),v=t.canvasToWorld(u),{cachedStats:p}=i,w=Object.keys(p),I=m,_=v;for(let i=0;i<w.length;i++){const o=w[i],r=this.getTargetIdImage(o,n);if(!r)continue;const{dimensions:l,imageData:h,metadata:g}=r,u=S(h,I);u[0]=Math.floor(u[0]),u[1]=Math.floor(u[1]),u[2]=Math.floor(u[2]);const D=S(h,_);if(D[0]=Math.floor(D[0]),D[1]=Math.floor(D[1]),D[2]=Math.floor(D[2]),this._isInsideVolume(u,D,l)){this.isHandleOutsideImage=!1;const n=[[Math.min(u[0],D[0]),Math.max(u[0],D[0])],[Math.min(u[1],D[1]),Math.max(u[1],D[1])],[Math.min(u[2],D[2]),Math.max(u[2],D[2])]],i={center:[(m[0]+v[0])/2,(m[1]+v[1])/2,(m[2]+v[2])/2],xRadius:Math.abs(m[0]-v[0])/2,yRadius:Math.abs(m[1]-v[1])/2,zRadius:Math.abs(m[2]-v[2])/2},{worldWidth:l,worldHeight:w}=(0,E.A)(d,c,I,_),S=0===l&&0===w,A=[u,D],{scale:b,areaUnits:y}=(0,a.Op)(r,A),R=Math.abs(Math.PI*(l/2)*(w/2))/b/b,O={isPreScaled:(0,T.u)(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},M=(0,C.c)(g.Modality,e.metadata.referencedImageId,O),x=(0,s.pointInShapeCallback)(h,(e=>(0,f.pointInEllipse)(i,e,{fast:!0})),this.configuration.statsCalculator.statsCallback,n),L=this.configuration.statsCalculator.getStatistics();p[o]={Modality:g.Modality,area:R,mean:L.mean?.value,max:L.max?.value,stdDev:L.stdDev?.value,statsArray:L.array,pointsInShape:x,isEmptyArea:S,areaUnit:y,modalityUnit:M}}else this.isHandleOutsideImage=!0,p[o]={Modality:g.Modality}}return e.invalidated=!1,(0,h.XF)(e,o),p},this._isInsideVolume=(e,t,n)=>o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,100,{trailing:!0})}_pointInEllipseCanvas(e,t){const n=e.width/2,i=e.height/2;if(n<=0||i<=0)return!1;const o=[e.left+n,e.top+i],a=[t[0]-o[0],t[1]-o[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(i*i)<=1}_getCanvasEllipseCenter(e){const[t,n,i,o]=e,a=[i[0],n[1]],s=[o[0],t[1]];return[(a[0]+s[0])/2,(a[1]+s[1])/2]}}function A(e,t){const n=e.cachedStats[t],{area:i,mean:o,stdDev:a,max:r,isEmptyArea:l,areaUnit:d,modalityUnit:c}=n,h=[];if(i){const e=l?"Area: Oblique not supported":`Area: ${(0,s.roundNumber)(i)} ${d}`;h.push(e)}return o&&h.push(`Mean: ${(0,s.roundNumber)(o)} ${c}`),r&&h.push(`Max: ${(0,s.roundNumber)(r)} ${c}`),a&&h.push(`Std Dev: ${(0,s.roundNumber)(a)} ${c}`),h}D.toolName="EllipticalROI";const b=D},72799:(e,t,n)=>{n.d(t,{A:()=>p});var i=n(84901),o=n(92136),a=n(96214),s=n(38296),r=n(54177),l=n(2746),d=n(61738),c=n(90252),h=n(23072),g=n(40233);class u extends a.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:m,changeTextCallback:v,canvasPosition:[10,10],canvasSize:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,l=(0,o.getEnabledElement)(i),{viewport:d,renderingEngine:g}=l,m=d.getCamera(),{viewPlaneNormal:v,viewUp:p}=m,E=this.getReferencedImageId(d,a,v,p),f=u.createAnnotation({metadata:{...d.getViewReference(),referencedImageId:E}});(0,s.addAnnotation)(f,i);const w=(0,c.getViewportIdsWithToolToRender)(i,this.getToolName());return e.preventDefault(),(0,h.A)(g,w),this.configuration.getTextCallback((e=>{if(!e)return(0,s.removeAnnotation)(f.annotationUID),(0,h.A)(g,w),void(this.isDrawing=!1);f.data.text=e,(0,r.dZ)(f),(0,h.A)(g,w)})),f},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{canvasPosition:l,canvasSize:d}=this.configuration;return!!l?.length&&(Math.abs(n[0]-l[0]+d/2)<=d/2&&Math.abs(n[1]-l[1]+d/2)<=d/2)},this.toolSelectedCallback=(e,t)=>{t.highlighted=!0,e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t;this._deactivateModify(n),(0,g.resetElementCursor)(n)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let i=(0,s.getAnnotations)(this.getToolName(),n);if(i=this.filterInteractableAnnotationsForElement(n,i),!i?.length)return;const o=i.find((e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6)));if(!o)return;const a=o;this.configuration.changeTextCallback(o,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this._activateModify=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback)},this._deactivateModify=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,s.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const o=a[e],{annotationUID:s}=o;r.annotationUID=s;const{color:d}=this.getAnnotationStyle({annotation:o,styleSpecifier:r}),{canvasPosition:c,canvasSize:h}=this.configuration;if(c?.length){const e="1";(0,l.drawArrow)(t,s,e,c.map((e=>e+h)),c,{color:d,width:1})}if(n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n}return n}}cancel(){}handleSelectedCallback(e,t,n){}_doneChangingTextCallback(e,t,n){t.data.text=n;const i=(0,o.getEnabledElement)(e),{renderingEngine:a}=i,s=(0,c.getViewportIdsWithToolToRender)(e,this.getToolName());(0,h.A)(a,s),(0,r.XF)(t,e)}_isInsideVolume(e,t,n){return o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n)}}function m(e){return e(prompt("Enter your annotation:"))}function v(e,t,n){return n(prompt("Enter your annotation:"))}u.toolName="KeyImage";const p=u},72655:(e,t,n)=>{n.d(t,{A:()=>_});var i=n(84901),o=n(92136),a=n(24592),s=n(74119),r=n(96214),l=n(21090),d=n(38296),c=n(48428),h=n(21009),g=n(54177),u=n(21954),m=n(2746),v=n(61738),p=n(90252),E=n(10910),f=n(23072),w=n(40233);const{transformWorldToIndex:I}=o.utilities;class C extends r.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:T}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:r,renderingEngine:l}=s;(0,w.hideElementCursor)(i),this.isDrawing=!0;const{viewPlaneNormal:c,viewUp:h,position:g}=r.getCamera(),u=this.getReferencedImageId(r,a,c,h),m={highlighted:!0,invalidated:!0,metadata:{...r.getViewReference({points:[a]}),toolName:this.getToolName(),referencedImageId:u,viewUp:h,cameraPosition:g},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,d.addAnnotation)(m,i);const v=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:v,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,f.A)(l,v),m},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d]=r.handles.points,c=s.worldToCanvas(l),h=s.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return u.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,p.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,w.hideElementCursor)(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,f.A)(r,a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:s,hasMoved:r}=this.editData,{data:l}=i;if(s&&!r)return;l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const c=(0,o.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,d.removeAnnotation)(i.annotationUID),(0,f.A)(h,a),s&&(0,g.dZ)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,f.A)(c,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const s=(0,o.getEnabledElement)(e),{renderingEngine:r}=s;return(0,f.A)(r,n),i&&(0,g.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,d.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),r=i.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const d=a[o],{annotationUID:g,data:u}=d,{points:v,activeHandleIndex:p}=u.handles;l.annotationUID=g;const{color:f,lineWidth:w,lineDash:I,shadow:C}=this.getAnnotationStyle({annotation:d,styleSpecifier:l}),T=v.map((e=>i.worldToCanvas(e)));let _;if(u.cachedStats[s]&&null!=u.cachedStats[s].unit?d.invalidated&&this._throttledCalculateCachedStats(d,r,e):(u.cachedStats[s]={length:null,unit:null},this._calculateCachedStats(d,r,e)),!(0,h.isAnnotationVisible)(g))continue;if((0,c.isAnnotationLocked)(d)||this.editData||null===p||(_=[T[p]]),_){const e="0";(0,m.drawHandles)(t,g,e,T,{color:f,lineDash:I,lineWidth:w})}const S=`${g}-line`,D="1";if((0,m.drawLine)(t,g,D,T[0],T[1],{color:f,width:w,lineDash:I,shadow:C},S),n=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const A=this.getLinkedTextBoxStyle(l,d);if(!A.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const b=this.configuration.getTextLines(u,s);if(!u.handles.textBox.hasMoved){const e=(0,E.getTextBoxCoordsCanvas)(T);u.handles.textBox.worldPosition=i.canvasToWorld(e)}const y=i.worldToCanvas(u.handles.textBox.worldPosition),R="1",O=(0,m.drawLinkedTextBox)(t,g,R,b,y,T,{},A),{x:M,y:x,width:L,height:U}=O;u.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([M,x]),topRight:i.canvasToWorld([M+L,x]),bottomLeft:i.canvasToWorld([M,x+U]),bottomRight:i.canvasToWorld([M+L,x+U])}}return n},this._throttledCalculateCachedStats=(0,l.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,p.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,w.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:h}=c;(0,f.A)(h,d),e.preventDefault()}_calculateLength(e,t){const n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}_calculateCachedStats(e,t,n){const i=e.data,{element:o}=n.viewport,s=i.handles.points[0],r=i.handles.points[1],{cachedStats:l}=i,d=Object.keys(l);for(let e=0;e<d.length;e++){const n=d[e],i=this.getTargetIdImage(n,t);if(!i)continue;const{imageData:o,dimensions:c}=i,h=I(o,s),g=I(o,r),u=[h,g],{scale:m,units:v}=(0,a.Op)(i,u),p=this._calculateLength(s,r)/m;this._isInsideVolume(h,g,c)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,l[n]={length:p,unit:v}}return e.invalidated=!1,(0,g.XF)(e,o),l}_isInsideVolume(e,t,n){return o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n)}}function T(e,t){const n=e.cachedStats[t],{length:i,unit:o}=n;if(null==i||isNaN(i))return;return[`${(0,s.roundNumber)(i)} ${o}`]}C.toolName="Length";const _=C},88854:(e,t,n)=>{n.d(t,{A:()=>c});var i=n(92136),o=n(19904),a=n(1320),s=n(54177),r=n(84901),l=n(2746);class d extends o.A{updateInterpolatedAnnotation(e,t){!this.editData&&e.invalidated&&e.data.handles.interpolationSources&&(e.data.contour.originalPolyline=e.data.contour.polyline,queueMicrotask((()=>{if(!e.data.handles.interpolationSources)return;const{points:n}=e.data.handles,{element:o}=t.viewport;this.setupBaseEditData(n[0],o,e);const{length:l}=n,{scissors:d}=this,{nearestEdge:c,repeatInterpolation:h}=this.configuration.interpolation;e.data.handles.originalPoints=n;const{worldToSlice:g,sliceToWorld:u}=this.editData,m=[];if(c){let e=g(n[n.length-1]);n.forEach(((t,o)=>{const a=g(t);e=a,m.push(a),d.startSearch(e),d.findPathToPoint(a),d.findPathToPoint(g(n[(o+3)%n.length]));const s=d.findMinNearby(a,c);i.utilities.isEqual(a,s)||(m[o]=s,e=s,n[o]=u(s))}))}const v=new a.j;for(let e=0;e<l;e++){d.startSearch(g(n[e]));const t=d.findPathToPoint(g(n[(e+1)%l]));v.addPoints(t)}this.updateAnnotation(v),this.scissors=null,this.scissorsRight=null,this.editData=null,e.data.handles.interpolationSources=null,h&&(0,s.XF)(e,t.viewport.element,r.ChangeTypes.InterpolationUpdated)})))}renderAnnotationInstance(e){const{enabledElement:t,svgDrawingHelper:n}=e,i=e.annotation,{annotationUID:o}=i,{viewport:a}=t,{worldToCanvas:s}=a,{showInterpolationPolyline:r}=this.configuration.interpolation||{};this.updateInterpolatedAnnotation?.(i,t);const{originalPolyline:d}=i.data.contour,c=super.renderAnnotationInstance(e);if(r&&d&&i.autoGenerated){const e=d.map(s);e.push(e[0]),(0,l.drawPolyline)(n,o,"interpolationContour-0",e,{color:"#70ffff",lineWidth:1,fillOpacity:0})}return c}isContourSegmentationTool(){return!0}}d.toolName="LivewireContourSegmentationTool";const c=d},19904:(e,t,n)=>{n.d(t,{A:()=>I});var i=n(44753),o=n(92136),a=n(38296),s=n(2746),r=n(61738),l=n(84901),d=n(40233),c=n(94750),h=n(74119),g=n(84045),u=n(96950),m=n(54177),v=n(9587),p=n(1320),E=n(90252),f=n(76840);class w extends f.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:l.KeyboardBindings.Shift,snapHandleNearby:2,interpolation:{enabled:!1,nearestEdge:2,showInterpolationPolyline:!1},decimate:{enabled:!1,epsilon:.1},actions:{undo:{method:"undo",bindings:[{key:"Escape"}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,r=i*i,l=t.data.contour.polyline.map((e=>s.worldToCanvas(e)));let d=l[l.length-1];for(let e=0;e<l.length;e++){const t=l[e];if(h.math.lineSegment.distanceToPointSquared(d,t,n)<=r)return!0;d=t}return!1},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,E.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a};const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;this._activateModify(i),(0,h.triggerAnnotationRenderForViewportIds)(r,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;const{points:r}=s.handles,l=r.findIndex((e=>e===n)),d=(0,E.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:l},this._activateModify(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,h.triggerAnnotationRenderForViewportIds)(g,d),e.preventDefault()},this._endCallback=(e,t=!1)=>{const n=e.detail,{element:i}=n,{annotation:s,viewportIdsToRender:r,newAnnotation:c,contourHoleProcessingEnabled:g}=this.editData,{data:u}=s;u.handles.activeHandleIndex=null,this._deactivateModify(i),this._deactivateDraw(i),(0,d.resetElementCursor)(i);const m=(0,o.getEnabledElement)(i),{renderingEngine:v}=m;if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage||t)return(0,a.removeAnnotation)(s.annotationUID),this.clearEditData(),void(0,h.triggerAnnotationRenderForViewportIds)(v,r);(0,h.triggerAnnotationRenderForViewportIds)(v,r);const p=c?l.ChangeTypes.Completed:l.ChangeTypes.HandlesUpdated;this.triggerChangeEvent(s,m,p,g),this.clearEditData()},this.triggerChangeEvent=(e,t,n=l.ChangeTypes.StatsUpdated,i=!1)=>{n===l.ChangeTypes.Completed?(0,m.PS)(e,i):(0,m.XF)(e,t.viewport.element,n)},this._mouseDownCallback=e=>{const t=e.type===l.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:i,worldToSlice:a,sliceToWorld:s}=this.editData;if(this.editData.closed)return;const r=e.detail,{element:d}=r,{currentPoints:c}=r,{canvas:g,world:u}=c;let m=u;const v=(0,o.getEnabledElement)(d),{viewport:E,renderingEngine:f}=v,w=this.editData.currentPath.getControlPoints();let I=w.length>=2&&t;if(w.length>=2){const e={index:-1,distSquared:1/0};for(let t=0,n=w.length;t<n;t++){const n=s(w[t]),i=E.worldToCanvas(n),o=h.math.point.distanceToPointSquared(g,i);o<=100&&o<e.distSquared&&(e.distSquared=o,e.index=t)}0===e.index&&(I=!0)}const{snapHandleNearby:C}=this.configuration;if(C&&!this.editData.closed){const e=new p.j,t=this.scissors.findMinNearby(a(u),1),n=this.scissors.findPathToPoint(t);e.addPoints(n),e.prependPath(this.editData.confirmedPath),m=s(t),this.editData.currentPath=e}this.editData.closed=this.editData.closed||I,this.editData.confirmedPath=this.editData.currentPath;const T=this.editData.currentPath.getLastPoint();this.editData.confirmedPath.addControlPoint(T),n.data.handles.points.push(s(T)),this.scissors.startSearch(a(m)),n.invalidated=!0,(0,h.triggerAnnotationRenderForViewportIds)(f,i),this.editData.closed&&(this.updateAnnotation(this.editData.confirmedPath),this._endCallback(e)),e.preventDefault()},this._mouseMoveCallback=e=>{const{element:t,currentPoints:n}=e.detail,{world:i,canvas:a}=n,{renderingEngine:s}=(0,o.getEnabledElement)(t),r=(0,E.getViewportIdsWithToolToRender)(t,this.getToolName());this.editData.lastCanvasPoint=a;const{width:l,height:d}=this.scissors,{worldToSlice:c}=this.editData,g=c(i);if(g[0]<0||g[1]<0||g[0]>=l||g[1]>=d)return;const u=this.scissors.findPathToPoint(g),m=new p.j;m.addPoints(u),m.prependPath(this.editData.confirmedPath),this.editData.currentPath=m,(0,h.triggerAnnotationRenderForViewportIds)(s,r),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s}=this.editData;if(void 0===s)console.warn("No drag implemented for livewire");else{const{currentPoints:e}=t,o=e.world;this.editHandle(o,n,i,s)}const r=(0,o.getEnabledElement)(n),{renderingEngine:l}=r;(0,h.triggerAnnotationRenderForViewportIds)(l,a)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,d.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;i&&(0,a.removeAnnotation)(t.annotationUID);const s=(0,o.getEnabledElement)(e),{renderingEngine:r}=s;return(0,h.triggerAnnotationRenderForViewportIds)(r,n),this.editData=null,this.scissors=null,t.annotationUID},this._activateModify=e=>{r.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{r.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{r.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{r.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)}}setupBaseEditData(e,t,n,a,s){const r=(0,o.getEnabledElement)(t),{viewport:l}=r;this.isDrawing=!0;const d=l.getImageData(),{imageData:c}=d;let h,g,u,m,{scalarData:f}=d;if(l instanceof o.VolumeViewport||!f){if(!(l instanceof o.VolumeViewport))throw new Error("Viewport not supported");{const e=o.utilities.getCurrentVolumeViewportSlice(l),{sliceToIndexMatrix:t,indexToSliceMatrix:n}=e;h=e=>{const t=o.utilities.transformWorldToIndex(c,e),a=i.eR.transformMat4([0,0,0],t,n);return[a[0],a[1]]},g=e=>{const n=i.eR.transformMat4([0,0,0],[e[0],e[1],0],t);return o.utilities.transformIndexToWorld(c,n)},f=e.scalarData,u=e.width,m=e.height}}else u=d.dimensions[0],m=d.dimensions[1],h=e=>{const t=o.utilities.transformWorldToIndex(c,e);return[t[0],t[1]]},g=e=>o.utilities.transformIndexToWorld(c,[e[0],e[1],0]);f=o.utilities.convertToGrayscale(f,u,m);const{voiRange:w}=l.getProperties(),I=h(e);this.scissors=v.f.createInstanceFromRawPixelData(f,u,m,w),a&&(this.scissorsRight=v.f.createInstanceFromRawPixelData(f,u,m,w),this.scissorsRight.startSearch(h(a))),this.scissors.startSearch(I);const C=!a,T=new p.j,_=new p.j,S=C?void 0:new p.j;T.addPoint(I),T.addControlPoint(I);const D=(0,E.getViewportIdsWithToolToRender)(t,this.getToolName()),A=l.worldToCanvas(e);this.editData={annotation:n,viewportIdsToRender:D,newAnnotation:C,hasMoved:!1,lastCanvasPoint:A,confirmedPath:T,currentPath:_,confirmedPathRight:S,closed:!1,handleIndex:this.editData?.handleIndex??n.handles?.activeHandleIndex,worldToSlice:h,sliceToWorld:g,contourHoleProcessingEnabled:s}}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,{world:a}=n,{renderingEngine:s}=(0,o.getEnabledElement)(i),r=this.createAnnotation(e),l=(0,c.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey;return this.setupBaseEditData(a,i,r,void 0,l),this.addAnnotation(r,i),this._activateDraw(i),e.preventDefault(),(0,h.triggerAnnotationRenderForViewportIds)(s,this.editData.viewportIdsToRender),r}clearEditData(){this.editData=null,this.scissors=null,this.scissorsRight=null,this.isDrawing=!1}editHandle(e,t,n,i){const{data:o}=n,{points:a}=o.handles,{length:s}=a,r=a[(i-1+s)%s],l=a[(i+1)%s];if(!this.editData?.confirmedPathRight){this.setupBaseEditData(r,t,n,l);const{polyline:e}=o.contour,a=new p.j,s=new p.j,{worldToSlice:d}=this.editData,c=(0,g.A)(n,i-1),h=(0,g.A)(n,i+1);if(-1===h||-1===c)throw new Error(`Can't find handle index ${-1===h&&l} ${-1===c&&r}`);if(0===i)s.addPoints(e.slice(h+1,c).map(d));else{if(h<c)throw new Error(`Expected right index after left index, but were: ${c} ${h}`);a.addPoints(e.slice(0,c+1).map(d)),s.addPoints(e.slice(h,e.length).map(d))}this.editData.confirmedPath=a,this.editData.confirmedPathRight=s}const{editData:d,scissors:c}=this,{worldToSlice:h,sliceToWorld:u}=d,{activeHandleIndex:m}=o.handles;if(null==m)o.handles.activeHandleIndex=i;else if(m!==i)throw new Error(`Trying to edit a different handle than the one currently being edited ${i}!==${o.handles.activeHandleIndex}`);const v=h(e);if(v[0]<0||v[0]>=c.width||v[1]<0||v[1]>=c.height)return;a[i]=u(v);const E=c.findPathToPoint(v),f=this.scissorsRight.findPathToPoint(v),w=new p.j;w.prependPath(d.confirmedPath),0!==i&&w.addPoints(E),w.addPoints(f.reverse()),w.appendPath(d.confirmedPathRight),0===i&&w.addPoints(E),d.currentPath=w,n.invalidated=!0,d.hasMoved=!0}renderAnnotation(e,t){return this.updateAnnotation(this.editData?.currentPath),super.renderAnnotation(e,t)}isContourSegmentationTool(){return!1}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints;return o.utilities.deepMerge(t,{data:{handles:{points:[[...n]]}}})}undo(e,t,n){this.editData&&this._endCallback(n,!0)}renderAnnotationInstance(e){const{annotation:t,enabledElement:n,svgDrawingHelper:i,annotationStyle:o}=e,{viewport:a}=n,{worldToCanvas:r}=a,{annotationUID:l,data:d,highlighted:c}=t,{handles:h}=d,g=this.editData?.newAnnotation,{lineWidth:u,lineDash:m,color:v}=o;if(c||g&&t.annotationUID===this.editData?.annotation?.annotationUID){const e="0",t=h.points.map(r);(0,s.drawHandles)(i,l,e,t,{color:v,lineDash:m,lineWidth:u})}return super.renderAnnotationInstance(e),!0}updateAnnotation(e){if(!this.editData||!e)return;const{annotation:t,sliceToWorld:n}=this.editData;let{pointArray:i}=e;i.length>1&&(i=[...i,i[0]]),this.updateContourPolyline(t,{points:i,closed:t.data.contour.closed,targetWindingDirection:u.W.Clockwise},{canvasToWorld:n})}}w.toolName="LivewireContour";const I=w},20070:(e,t,n)=>{n.d(t,{A:()=>r});var i=n(92136),o=n(87682),a=n(39244);class s extends a.A{constructor(e){super(i.utilities.deepMerge({configuration:{calculateStats:!1,allowOpenContours:!1}},e))}isContourSegmentationTool(){return!0}renderAnnotationInstance(e){const t=e.annotation,{invalidated:n}=t,i=super.renderAnnotationInstance(e);if(n){const{segmentationId:e}=t.data.segmentation;(0,o.triggerSegmentationDataModified)(e)}return i}}s.toolName="PlanarFreehandContourSegmentationTool";const r=s},30049:(e,t,n)=>{n.d(t,{A:()=>C});var i=n(44753),o=n(92136),a=n(96214),s=n(38296),r=n(54177),l=n(24592),d=n(2746),c=n(61738),h=n(84901),g=n(90252),u=n(74119),m=n(40233),v=n(23072),p=n(73801),E=n(97022);const{transformWorldToIndex:f}=o.utilities;class w extends a.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:I}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:d}=r;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:u}=c,p=this.getReferencedImageId(l,a,h,u),E=l.getFrameOfReferenceUID(),f={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...u],FrameOfReferenceUID:E,referencedImageId:p},data:{label:"",handles:{points:[[...a]]},cachedStats:{}}};(0,s.addAnnotation)(f,i);const w=(0,g.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:f,newAnnotation:!0,viewportIdsToRender:w},this._activateModify(i),(0,m.hideElementCursor)(i),e.preventDefault(),(0,v.A)(d,w),f},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:l}=this.editData,{viewportId:d,renderingEngine:c}=(0,o.getEnabledElement)(n);this.eventDispatchDetail={viewportId:d,renderingEngineId:c.id},this._deactivateModify(n),(0,m.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.removeAnnotation)(i.annotationUID),(0,v.A)(c,a),l&&(0,r.dZ)(i)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,{annotation:s,viewportIdsToRender:r}=this.editData,{data:l}=s;l.handles.points[0]=[...a],s.invalidated=!0;const d=(0,o.getEnabledElement)(i),{renderingEngine:c}=d;(0,v.A)(c,r)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,m.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:s}=(0,o.getEnabledElement)(e);return(0,v.A)(s,n),i&&(0,r.dZ)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(h.Events.MOUSE_UP,this._endCallback),e.addEventListener(h.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(h.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(h.Events.TOUCH_END,this._endCallback),e.addEventListener(h.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(h.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(h.Events.MOUSE_UP,this._endCallback),e.removeEventListener(h.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(h.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(h.Events.TOUCH_END,this._endCallback),e.removeEventListener(h.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(h.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let r=(0,s.getAnnotations)(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const l=this.getTargetId(i),c=i.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<r.length;a++){const s=r[a],g=s.annotationUID,u=s.data,m=u.handles.points[0],v=i.worldToCanvas(m);h.annotationUID=g;const{color:p}=this.getAnnotationStyle({annotation:s,styleSpecifier:h});if(u.cachedStats||(u.cachedStats={}),u.cachedStats[l]&&null!=u.cachedStats[l].value){if(s.invalidated&&(this._calculateCachedStats(s,c,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=s.metadata;for(const t in u.cachedStats)if(t.startsWith("imageId")){c.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete u.cachedStats[t]}}}else u.cachedStats[l]={Modality:null,index:null,value:null},this._calculateCachedStats(s,c,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const E="0";(0,d.drawHandles)(t,g,E,[v],{color:p}),n=!0;const f=this.getLinkedTextBoxStyle(h,s);if(!f.visibility)continue;const w=this.configuration.getTextLines(u,l);if(w){const e=[v[0]+6,v[1]-6],n="0";(0,d.drawTextBox)(t,g,n,w,[e[0],e[1]],f)}}return n}}isPointNearTool(){return!1}toolSelectedCallback(){}getHandleNearImagePoint(e,t,n,a){const s=(0,o.getEnabledElement)(e),{viewport:r}=s,{data:l}=t,d=l.handles.points[0],c=r.worldToCanvas(d);if(!0===i.Zc.distance(n,c)<a)return d}handleSelectedCallback(e,t){const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,g.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(i),(0,m.hideElementCursor)(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,v.A)(r,a),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{renderingEngineId:a,viewport:s}=n,{element:d}=s,c=i.handles.points[0],{cachedStats:h}=i,g=Object.keys(h);for(let n=0;n<g.length;n++){const i=g[n],u={isPreScaled:(0,E.u)(s,i),isSuvScaled:this.isSuvScaled(s,i,e.metadata.referencedImageId)},m=this.getTargetIdImage(i,t);if(!m)continue;const{dimensions:v,imageData:w,metadata:I}=m,C="getScalarData"in m?m.getScalarData():m.scalarData,T=I.Modality,_=f(w,c);_[0]=Math.round(_[0]),_[1]=Math.round(_[1]),_[2]=Math.round(_[2]);const S=C.length/v[2]/v[1]/v[0];if(o.utilities.indexWithinDimensions(_,v)){this.isHandleOutsideImage=!1;const t=v[0]*S,n=v[0]*v[1]*S,s=_[2]*n+_[1]*t+_[0]*S;let r,d=S>2?[C[s],C[s+1],C[s+2]]:C[s];if(i.startsWith("imageId:")){const e=i.split("imageId:")[1],t=o.utilities.imageIdToURI(e),n=o.utilities.getViewportsWithImageURI(t,a)[0];_[2]=n.getCurrentImageIdIndex()}if("US"===T){const e=(0,l.Xw)(m,[_]),t=e.values.every((e=>null!==e));d=t?e.values:d,r=t?e.units:"raw"}else r=(0,p.c)(T,e.metadata.referencedImageId,u);h[i]={index:_,value:d,Modality:T,modalityUnit:r}}else this.isHandleOutsideImage=!0,h[i]={index:_,Modality:T};e.invalidated=!1,(0,r.XF)(e,d)}return h}}function I(e,t){const n=e.cachedStats[t],{index:i,value:o,modalityUnit:a}=n;if(void 0===o)return;const s=[];if(s.push(`(${i[0]}, ${i[1]}, ${i[2]})`),o instanceof Array&&a instanceof Array)for(let e=0;e<o.length;e++)s.push(`${(0,u.roundNumber)(o[e])} ${a[e]}`);else s.push(`${(0,u.roundNumber)(o)} ${a}`);return s}w.toolName="Probe";const C=w},19994:(e,t,n)=>{n.d(t,{A:()=>b});var i=n(96214),o=n(92136),a=n(24592),s=n(74119),r=n(21090),l=n(95778),d=n(48428),c=n(21009),h=n(54177),g=n(2746),u=n(61738),m=n(84901),v=n(90252),p=n(23345),E=n(10910),f=n(78609),w=n(40233),I=n(23072),C=n(73801),T=n(97022),_=n(83112);const{transformWorldToIndex:S}=o.utilities;class D extends i.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:A,statsCalculator:_.BasicStatsCalculator}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:r,renderingEngine:d}=s;this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(r,a,h,g),m=r.getFrameOfReferenceUID(),p={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u},data:{label:"",handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};(0,l.lC)(p,i);const E=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:E,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,w.hideElementCursor)(i),e.preventDefault(),(0,I.A)(d,E),p},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[3]),h=this._getRectangleImageCoordinates([d,c]),g=[n[0],n[1]],{left:u,top:m,width:v,height:E}=h;return p.distanceToPoint([u,m,v,E],g)<=i},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:i}=n;t.highlighted=!0;const a=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(i),(0,w.hideElementCursor)(i);const s=(0,o.getEnabledElement)(i),{renderingEngine:r}=s;(0,I.A)(r,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex((e=>e===n));const d=(0,v.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,w.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:h}=c;(0,I.A)(h,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:s,hasMoved:r}=this.editData,{data:d}=i;if(s&&!r)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const{renderingEngine:c}=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.O8)(i.annotationUID),(0,I.A)(c,a),s&&(0,h.dZ)(i)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world,{points:o}=l.handles;o.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,a=(0,o.getEnabledElement)(n),{worldToCanvas:r,canvasToWorld:d}=a.viewport,c=e.world,{points:h}=l.handles;let g,u,m,v,p,E,f,w;switch(h[s]=[...c],s){case 0:case 3:g=r(h[0]),v=r(h[3]),u=[v[0],g[1]],m=[g[0],v[1]],E=d(u),f=d(m),h[1]=E,h[2]=f;break;case 1:case 2:u=r(h[1]),m=r(h[2]),g=[m[0],u[1]],v=[u[0],m[1]],p=d(g),w=d(v),h[0]=p,h[3]=w}i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,I.A)(c,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:s}=(0,o.getEnabledElement)(e);return(0,I.A)(s,n),i&&(0,h.dZ)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(m.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(m.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._activateModify=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:a}=i;let s=(0,l.Rh)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const r=this.getTargetId(i),h=i.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<s.length;a++){const l=s[a],{annotationUID:m,data:v}=l,{points:p,activeHandleIndex:f}=v.handles,w=p.map((e=>i.worldToCanvas(e)));u.annotationUID=m;const{color:I,lineWidth:C,lineDash:T}=this.getAnnotationStyle({annotation:l,styleSpecifier:u}),{viewPlaneNormal:_,viewUp:S}=i.getCamera();if(v.cachedStats[r]&&null!=v.cachedStats[r].areaUnit){if(l.invalidated&&(this._throttledCalculateCachedStats(l,_,S,h,e),i instanceof o.VolumeViewport)){const{referencedImageId:e}=l.metadata;for(const t in v.cachedStats)if(t.startsWith("imageId")){h.getStackViewports().find((t=>{const n=o.utilities.imageIdToURI(e),i=t.hasImageURI(n),a=o.utilities.imageIdToURI(t.getCurrentImageId());return i&&a!==n}))&&delete v.cachedStats[t]}}}else v.cachedStats[r]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(l,_,S,h,e);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let D;if(!(0,c.isAnnotationVisible)(m))continue;if((0,d.isAnnotationLocked)(l)||this.editData||null===f||(D=[w[f]]),D){const e="0";(0,g.drawHandles)(t,m,e,D,{color:I})}const A=`${m}-rect`,b="0";(0,g.drawRect)(t,m,b,w[0],w[3],{color:I,lineDash:T,lineWidth:C},A),n=!0;const y=this.getLinkedTextBoxStyle(u,l);if(!y.visibility){v.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const R=this.configuration.getTextLines(v,r);if(!R||0===R.length)continue;if(!v.handles.textBox.hasMoved){const e=(0,E.getTextBoxCoordsCanvas)(w);v.handles.textBox.worldPosition=i.canvasToWorld(e)}const O=i.worldToCanvas(v.handles.textBox.worldPosition),M="1",x=(0,g.drawLinkedTextBox)(t,m,M,R,O,w,{},y),{x:L,y:U,width:N,height:P}=x;v.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([L,U]),topRight:i.canvasToWorld([L+N,U]),bottomLeft:i.canvasToWorld([L,U+P]),bottomRight:i.canvasToWorld([L+N,U+P])}}return n},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,i,o)=>{const{data:r}=e,{viewport:l}=o,{element:d}=l,c=r.handles.points[0],g=r.handles.points[3],{cachedStats:u}=r,m=Object.keys(u);for(let o=0;o<m.length;o++){const r=m[o],d=this.getTargetIdImage(r,i);if(!d)continue;const{dimensions:h,imageData:v,metadata:p}=d,E=S(v,c);E[0]=Math.floor(E[0]),E[1]=Math.floor(E[1]),E[2]=Math.floor(E[2]);const w=S(v,g);if(w[0]=Math.floor(w[0]),w[1]=Math.floor(w[1]),w[2]=Math.floor(w[2]),this._isInsideVolume(E,w,h)){this.isHandleOutsideImage=!1;const i=[[Math.min(E[0],w[0]),Math.max(E[0],w[0])],[Math.min(E[1],w[1]),Math.max(E[1],w[1])],[Math.min(E[2],w[2]),Math.max(E[2],w[2])]],{worldWidth:o,worldHeight:h}=(0,f.A)(t,n,c,g),m=[E,w],{scale:I,areaUnits:_}=(0,a.Op)(d,m),S=Math.abs(o*h)/(I*I),D={isPreScaled:(0,T.u)(l,r),isSuvScaled:this.isSuvScaled(l,r,e.metadata.referencedImageId)},A=(0,C.c)(p.Modality,e.metadata.referencedImageId,D),b=(0,s.pointInShapeCallback)(v,(()=>!0),this.configuration.statsCalculator.statsCallback,i),y=this.configuration.statsCalculator.getStatistics();u[r]={Modality:p.Modality,area:S,mean:y.mean?.value,stdDev:y.stdDev?.value,max:y.max?.value,statsArray:y.array,pointsInShape:b,areaUnit:_,modalityUnit:A}}else this.isHandleOutsideImage=!0,u[r]={Modality:p.Modality}}return e.invalidated=!1,(0,h.XF)(e,d),u},this._isInsideVolume=(e,t,n)=>o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,100,{trailing:!0})}}function A(e,t){const n=e.cachedStats[t],{area:i,mean:o,max:a,stdDev:r,areaUnit:l,modalityUnit:d}=n;if(void 0===o)return;const c=[];return c.push(`Area: ${(0,s.roundNumber)(i)} ${l}`),c.push(`Mean: ${(0,s.roundNumber)(o)} ${d}`),c.push(`Max: ${(0,s.roundNumber)(a)} ${d}`),c.push(`Std Dev: ${(0,s.roundNumber)(r)} ${d}`),c}D.toolName="RectangleROI";const b=D},67540:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(92136),o=n(42058);class a extends o.A{constructor(e){super(i.utilities.deepMerge({configuration:{calculateStats:!1}},e))}isContourSegmentationTool(){return!0}}a.toolName="SplineContourSegmentationTool";const s=a},42058:(e,t,n)=>{n.d(t,{A:()=>D});var i=n(92136),o=n(44753),a=n(38296),s=n(2746),r=n(61738),l=n(84901),d=n(40233),c=n(74119),h=n(94750),g=n(90252),u=n(10910),m=n(96950),v=n(91975),p=n(95562),E=n(55067),f=n(75251),w=n(76840);const I={resolution:20,controlPointAdditionDistance:6,controlPointDeletionDistance:6,showControlPointsConnectors:!1,controlPointAdditionEnabled:!0,controlPointDeletionEnabled:!0};var C,T;!function(e){e.Cardinal="CARDINAL",e.Linear="LINEAR",e.CatmullRom="CATMULLROM",e.BSpline="BSPLINE"}(C||(C={})),function(e){e.AddControlPoint="addControlPoint",e.DeleteControlPoint="deleteControlPoint"}(T||(T={}));class _ extends w.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,calculateStats:!0,getTextLines:S,contourHoleAdditionModifierKey:l.KeyboardBindings.Shift,decimate:{enabled:!1,epsilon:.1},spline:{configuration:{[C.Cardinal]:{Class:v.A,scale:.5},[C.CatmullRom]:{Class:E.e},[C.Linear]:{Class:p.F},[C.BSpline]:{Class:f.k,controlPointAdditionEnabled:!1,controlPointDeletionEnabled:!1,showControlPointsConnectors:!0}},type:C.CatmullRom,drawPreviewEnabled:!0,lastControlPointDeletionKeys:["Backspace","Delete"]},actions:{[T.AddControlPoint]:{method:"addControlPointCallback",bindings:[{mouseButton:l.MouseBindings.Primary,modifierKey:l.KeyboardBindings.Shift}]},[T.DeleteControlPoint]:{method:"deleteControlPointCallback",bindings:[{mouseButton:l.MouseBindings.Primary,modifierKey:l.KeyboardBindings.Ctrl}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.fireChangeOnUpdate=null,this.isPointNearTool=(e,t,n,i)=>{const{instance:o}=t.data.spline;return o.isPointNearCurve(n,i)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,g.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1};const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;this._activateModify(o),(0,c.triggerAnnotationRenderForViewportIds)(r,a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=s.handles;r=e.findIndex((e=>e===n))}const d=(0,g.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a);const h=(0,i.getEnabledElement)(a),{renderingEngine:u}=h;(0,c.triggerAnnotationRenderForViewportIds)(u,d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:s,newAnnotation:r,contourHoleProcessingEnabled:h}=this.editData,{data:g}=o;o.autoGenerated=!1,g.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,d.resetElementCursor)(n);const u=(0,i.getEnabledElement)(n),{renderingEngine:m}=u,v=this.getTargetIdImage(this.getTargetId(u.viewport),u.renderingEngine),{imageData:p,dimensions:E}=v;this.isHandleOutsideImage=g.handles.points.map((e=>i.utilities.transformWorldToIndex(p,e))).some((e=>!i.utilities.indexWithinDimensions(e,E))),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,a.removeAnnotation)(o.annotationUID);const f=r?l.ChangeTypes.Completed:l.ChangeTypes.HandlesUpdated;this.fireChangeOnUpdate?(this.fireChangeOnUpdate.annotationUID=o.annotationUID,this.fireChangeOnUpdate.changeType=f):this.fireChangeOnUpdate={annotationUID:o.annotationUID,changeType:f,contourHoleProcessingEnabled:h},(0,c.triggerAnnotationRenderForViewportIds)(m,s),this.editData=null,this.isDrawing=!1},this._keyDownCallback=e=>{const t=e.detail,{element:n}=t,i=t.key??"",{lastControlPointDeletionKeys:o}=this.configuration.spline;if(!o.includes(i))return;const{annotation:a}=this.editData,{data:s}=a;if(3!==s.handles.points.length){{const e=s.handles.points.length-1;this._deleteControlPointByIndex(n,a,e)}e.preventDefault()}else this.cancel(n)},this._mouseMoveCallback=e=>{const{drawPreviewEnabled:t}=this.configuration.spline;if(!t)return;const{element:n}=e.detail,{renderingEngine:o}=(0,i.getEnabledElement)(n),a=(0,g.getViewportIdsWithToolToRender)(n,this.getToolName());this.editData.lastCanvasPoint=e.detail.currentPoints.canvas,(0,c.triggerAnnotationRenderForViewportIds)(o,a),e.preventDefault()},this._mouseDownCallback=e=>{const t=e.type===l.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:o}=this.editData,{data:a}=n;if(a.contour.closed)return;const s=e.detail,{element:r}=s,{currentPoints:d}=s,{canvas:h,world:g}=d,u=(0,i.getEnabledElement)(r),{renderingEngine:m}=u;let v=a.handles.points.length>=2&&t,p=!0;if(a.handles.points.length>=3){const{instance:e}=a.spline,t=e.getClosestControlPointWithinDistance(h,10);0===t?.index&&(p=!1,v=!0)}p&&a.handles.points.push(g),a.contour.closed=a.contour.closed||v,n.invalidated=!0,(0,c.triggerAnnotationRenderForViewportIds)(m,o),a.contour.closed&&this._endCallback(e),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;this.moveAnnotation(o,n)}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:h}=d;(0,c.triggerAnnotationRenderForViewportIds)(h,a)},this.triggerAnnotationCompleted=(e,t)=>{const n=l.Events.ANNOTATION_COMPLETED,o={annotation:e,changeType:l.ChangeTypes.Completed,contourHoleProcessingEnabled:t};(0,i.triggerEvent)(i.eventTarget,n,o)},this.triggerAnnotationModified=(e,t,n=l.ChangeTypes.StatsUpdated)=>{const{viewportId:o,renderingEngineId:a}=t,s=l.Events.ANNOTATION_MODIFIED,r={annotation:e,viewportId:o,renderingEngineId:a,changeType:n};(0,i.triggerEvent)(i.eventTarget,s,r)},this.triggerChangeEvent=(e,t,n=l.ChangeTypes.StatsUpdated,i)=>{n===l.ChangeTypes.Completed?this.triggerAnnotationCompleted(e,i):this.triggerAnnotationModified(e,t,n)},this._activateModify=e=>{r.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{r.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{r.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.KEY_DOWN,this._keyDownCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{r.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.KEY_DOWN,this._keyDownCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._renderStats=(e,t,n,i)=>{const o=e.data,a=this.getTargetId(t);if(!o.spline.instance.closed||!i.visibility)return;const r=this.configuration.getTextLines(o,a);if(!r||0===r.length)return;const l=o.handles.points.map((e=>t.worldToCanvas(e)));if(!o.handles.textBox.hasMoved){const e=(0,u.getTextBoxCoordsCanvas)(l);o.handles.textBox.worldPosition=t.canvasToWorld(e)}const d=t.worldToCanvas(o.handles.textBox.worldPosition),c=(0,s.drawLinkedTextBox)(n,e.annotationUID??"","textBox",r,d,l,{},i),{x:h,y:g,width:m,height:v}=c;o.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([h,g]),topRight:t.canvasToWorld([h+m,g]),bottomLeft:t.canvasToWorld([h,g+v]),bottomRight:t.canvasToWorld([h+m,g+v])}},this.addControlPointCallback=(e,t)=>{const{data:n}=t,o=n.spline.type,a=this._getSplineConfig(o),s=a.controlPointAdditionDistance;if(!1===a.controlPointAdditionEnabled)return;const r=e.detail,{element:l}=r,d=(0,i.getEnabledElement)(l),{renderingEngine:h,viewport:u}=d,{canvasToWorld:m}=u,{instance:v}=n.spline,p=e.detail.currentPoints.canvas,E=v.getClosestPoint(p);if(E.distance>s)return;const{index:f,point:w}=v.addControlPointAtU(E.uValue);n.handles.points.splice(f,0,m(w)),t.invalidated=!0;const I=(0,g.getViewportIdsWithToolToRender)(l,this.getToolName());(0,c.triggerAnnotationRenderForViewportIds)(h,I)},this.deleteControlPointCallback=(e,t)=>{const n=t.data.spline.type,i=this._getSplineConfig(n),o=i.controlPointDeletionDistance;if(!1===i.controlPointDeletionEnabled)return;const a=e.detail,{element:s,currentPoints:r}=a,{canvas:l}=r,{instance:d}=t.data.spline,c=d.getClosestControlPointWithinDistance(l,o);c&&this._deleteControlPointByIndex(s,t,c.index)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.contour.closed)return;const a=(0,i.getEnabledElement)(t),{viewport:s,renderingEngine:r}=a,{cachedStats:d}=n,{polyline:h}=n.contour,g=Object.keys(d);for(let e=0;e<g.length;e++){const t=g[e],n=this.getTargetIdImage(t,r);if(!n)continue;const{metadata:a}=n,l=h.map((e=>s.worldToCanvas(e))),u=l[0],m=s.canvasToWorld(u),v=s.canvasToWorld([u[0]+1,u[1]]),p=s.canvasToWorld([u[0],u[1]+1]),E=o.eR.distance(m,v),f=o.eR.distance(m,p),{imageData:w}=n,{scale:I,areaUnits:C}=(0,c.getCalibratedLengthUnitsAndScale)(n,(()=>{const{maxX:e,maxY:t,minX:n,minY:o}=c.math.polyline.getAABB(l),a=s.canvasToWorld([n,o]),r=i.utilities.transformWorldToIndex(w,a),d=s.canvasToWorld([e,t]);return[r,i.utilities.transformWorldToIndex(w,d)]}));let T=c.math.polyline.getArea(l)/I/I;T*=E*f,d[t]={Modality:a.Modality,area:T,areaUnit:C}}return this.triggerAnnotationModified(e,a,l.ChangeTypes.StatsUpdated),d},this._throttledCalculateCachedStats=(0,c.throttle)(this._calculateCachedStats,100,{trailing:!0})}static{this.SplineTypes=C}static{this.Actions=T}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:o}=t,{canvas:a}=n,s=(0,h.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey,r=(0,i.getEnabledElement)(o),{renderingEngine:l}=r,d=this.createAnnotation(e);this.isDrawing=!0,this.addAnnotation(d,o);const u=(0,g.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:d,viewportIdsToRender:u,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,lastCanvasPoint:a,contourHoleProcessingEnabled:s},this._activateDraw(o),e.preventDefault(),(0,c.triggerAnnotationRenderForViewportIds)(l,u),d}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,d.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData;o&&(0,a.removeAnnotation)(t.annotationUID),super.cancelAnnotation(t);const s=(0,i.getEnabledElement)(e),{renderingEngine:r}=s;return(0,c.triggerAnnotationRenderForViewportIds)(r,n),this.editData=null,t.annotationUID}isContourSegmentationTool(){return!1}renderAnnotationInstance(e){const{enabledElement:t,targetId:n,svgDrawingHelper:i,annotationStyle:o}=e,{viewport:r}=t,{worldToCanvas:l}=r,{element:d}=r,c=e.annotation,{annotationUID:h,data:g,highlighted:u}=c,{handles:v}=g,{points:p,activeHandleIndex:E}=v,f=this.editData?.newAnnotation,{lineWidth:w,lineDash:I,color:C,locked:T}=o,_=p.map((e=>l(e))),{drawPreviewEnabled:S}=this.configuration.spline,D=c.data.spline.type,A=this._getSplineConfig(D),b=c.data.spline.instance,y=(0,a.getChildAnnotations)(c);if(-1!==y.findIndex((e=>!e)))throw new Error(`Can't find annotation for child ${c.childAnnotationUIDs.join()}`);let R;if([c,...y].filter((e=>this._isSplineROIAnnotation(e))).forEach((e=>{const t=this._updateSplineInstance(d,e).getPolylinePoints();this.updateContourPolyline(e,{points:t,closed:g.contour.closed,targetWindingDirection:m.W.Clockwise},r)})),super.renderAnnotationInstance(e),g.cachedStats[n]&&null!=g.cachedStats[n].areaUnit?c.invalidated&&this._throttledCalculateCachedStats(c,d):(g.cachedStats[n]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(c,d)),T||this.editData||null===E||(R=[_[E]]),R||f||u){const e="0";(0,s.drawHandles)(i,h,e,_,{color:C,lineWidth:Math.max(1,w),handleRadius:"3"})}if(S&&b.numControlPoints>1&&this.editData?.lastCanvasPoint&&!b.closed){const{lastCanvasPoint:e}=this.editData,t=b.getPreviewPolylinePoints(e,10);(0,s.drawPolyline)(i,h,"previewSplineChange",t,{color:"#9EA0CA",lineDash:I,lineWidth:1})}if(A.showControlPointsConnectors){const e=[..._];b.closed&&e.push(_[0]),(0,s.drawPolyline)(i,h,"controlPointsConnectors",e,{color:"rgba(255, 255, 255, 0.5)",lineWidth:1})}return this._renderStats(c,r,i,o.textbox),this.fireChangeOnUpdate?.annotationUID===h&&(this.triggerChangeEvent(c,t,this.fireChangeOnUpdate.changeType,this.fireChangeOnUpdate.contourHoleProcessingEnabled),this.fireChangeOnUpdate=null),c.invalidated=!1,!0}createInterpolatedSplineControl(e){if(e.data.handles.points?.length)return;const{polyline:t}=e.data.contour;if(!t||!t.length)return;e.data.handles.points=[];const{points:n}=e.data.handles,i=Math.max(10,Math.floor(t.length/20));for(let e=0;e<t.length-i;e+=i)n.push(t[e]);n.push(t[t.length-1])}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints,{type:o}=this.configuration.spline,a=this._getSplineConfig(o),s=new a.Class,r=()=>({type:a.type,instance:s,resolution:a.resolution});let l;return this.configuration.interpolation?.enabled&&(l=e=>{e.data.spline||=r(),this.createInterpolatedSplineControl(e)}),i.utilities.deepMerge(t,{data:{handles:{points:[[...n]]},spline:r(),cachedStats:{}},onInterpolationComplete:l})}_deleteControlPointByIndex(e,t,n){const o=(0,i.getEnabledElement)(e),{points:s}=t.data.handles;3===s.length?(0,a.removeAnnotation)(t.annotationUID):s.splice(n,1);const{renderingEngine:r}=o,l=(0,g.getViewportIdsWithToolToRender)(e,this.getToolName());t.invalidated=!0,(0,c.triggerAnnotationRenderForViewportIds)(r,l)}_isSplineROIAnnotation(e){return!!e.data?.spline}_getSplineConfig(e){const{configuration:t}=this,n=t.spline.configuration;return Object.assign({type:e},I,n[e])}_updateSplineInstance(e,t){const n=(0,i.getEnabledElement)(e),{viewport:o}=n,{worldToCanvas:a}=o,{data:s}=t,{type:r,instance:l}=t.data.spline,d=this._getSplineConfig(r),c=s.handles.points.map(a),h=void 0!==d.resolution?parseInt(d.resolution):void 0,g=void 0!==d.scale?parseFloat(d.scale):void 0;return l.setControlPoints(c),l.closed=!!s.contour.closed,l.fixedResolution||void 0===h||l.resolution===h||(l.resolution=h,t.invalidated=!0),l instanceof v.A&&!l.fixedScale&&void 0!==g&&l.scale!==g&&(l.scale=g,t.invalidated=!0),l}}function S(e,t){const n=e.cachedStats[t],{area:i,isEmptyArea:o,areaUnit:a}=n,s=[];if(i){const e=o?"Area: Oblique not supported":`Area: ${(0,c.roundNumber)(i)} ${a}`;s.push(e)}return s}_.toolName="SplineROI";const D=_},95608:(e,t,n)=>{n.d(t,{A:()=>I});var i=n(84901),o=n(92136),a=n(96214),s=n(21090),r=n(38296),l=n(54177),d=n(2746),c=n(61738),h=n(90252),g=n(74119),u=n(14846),m=n(23072),v=n(40233),p=n(24592);const{transformWorldToIndex:E}=o.utilities;class f extends a.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:w,displayBothAxesDistances:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.startedDrawing)return;this.startedDrawing=!0;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:d}=s;if(!(l instanceof o.StackViewport))throw new Error("UltrasoundDirectionalTool can only be used on a StackViewport");(0,v.hideElementCursor)(i),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:g,viewUp:u}=c,p=this.getReferencedImageId(l,a,g,u),E=l.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...g],viewUp:[...u],FrameOfReferenceUID:E,referencedImageId:p},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,r.addAnnotation)(f,i);const w=(0,h.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:w,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),e.preventDefault(),(0,m.A)(d,w),f},this.isPointNearTool=(e,t,n,i)=>!1,this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:s,hasMoved:d}=this.editData,{data:c}=i;if(s&&!d)return;if(this.startedDrawing&&1===c.handles.points.length)return void(this.editData.handleIndex=1);this.startedDrawing=!1,c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,v.resetElementCursor)(n);const h=(0,o.getEnabledElement)(n),{renderingEngine:g}=h;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(i.annotationUID),(0,m.A)(g,a),s&&(0,l.dZ)(i),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:i}=l.handles,{worldPosition:o}=i;o[0]+=n[0],o[1]+=n[1],o[2]+=n[2],i.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const d=(0,o.getEnabledElement)(n),{renderingEngine:c}=d;(0,m.A)(c,a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,v.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const s=(0,o.getEnabledElement)(e),{renderingEngine:r}=s;return(0,m.A)(r,n),i&&(0,l.dZ)(t),this.editData=null,this.startedDrawing=!1,t.annotationUID}},this._activateModify=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,r.getAnnotations)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s=this.getTargetId(i),l=i.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let o=0;o<a.length;o++){const r=a[o],{annotationUID:h,data:g}=r,{points:u}=g.handles;c.annotationUID=h;const m=this.getStyle("color",c,r),v=u.map((e=>i.worldToCanvas(e)));if(g.cachedStats[s]&&null!=g.cachedStats[s].xValues?r.invalidated&&this._throttledCalculateCachedStats(r,l,e):(g.cachedStats[s]={xValues:[0,0],yValues:[0,0],isHorizontal:!1,units:[""],isUnitless:!1},this._calculateCachedStats(r,l,e)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let p="0";if((0,d.drawHandle)(t,h,p,v[0],{color:m},0),n=!0,2!==v.length)return n;p="1",(0,d.drawHandle)(t,h,p,v[1],{color:m},1);if(g.cachedStats[s].isUnitless){const e=`${h}-line-1`,n="1";(0,d.drawLine)(t,h,n,v[0],v[1],{color:m,width:1,shadow:this.configuration.shadow},e)}else{const e=v[0],n=v[1],i=n[1]-e[1],o=n[0]-e[0];let a=[0,0];a=g.cachedStats[s].isHorizontal?[e[0]+o,e[1]]:[e[0],e[1]+i];let r=`${h}-line-1`,l="1";(0,d.drawLine)(t,h,l,v[0],a,{color:m,width:1,shadow:this.configuration.shadow},r),r=`${h}-line-2`,l="2",(0,d.drawLine)(t,h,l,v[1],a,{color:m,width:1,lineDash:[1,1],shadow:this.configuration.shadow},r)}const E=this.getLinkedTextBoxStyle(c,r);if(!E.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const f=this.configuration.getTextLines(g,s,this.configuration);if(!g.handles.textBox.hasMoved){const e=v[1];g.handles.textBox.worldPosition=i.canvasToWorld(e)}const w=i.worldToCanvas(g.handles.textBox.worldPosition),I="1",C=(0,d.drawLinkedTextBox)(t,h,I,f,w,v,{},E),{x:T,y:_,width:S,height:D}=C;g.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([T,_]),topRight:i.canvasToWorld([T+S,_]),bottomLeft:i.canvasToWorld([T,_+D]),bottomRight:i.canvasToWorld([T+S,_+D])}}return n},this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}toolSelectedCallback(e,t,n,i){}handleSelectedCallback(e,t,n){const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;const r=(0,h.getViewportIdsWithToolToRender)(a,this.getToolName());let l,d=!1;n.worldPosition?d=!0:l=s.handles.points.findIndex((e=>e===n)),this.editData={handleIndex:l,annotation:t,viewportIdsToRender:r},this._activateModify(a),(0,v.hideElementCursor)(a);const c=(0,o.getEnabledElement)(a),{renderingEngine:g}=c;(0,m.A)(g,r),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{element:o}=n.viewport;if(2!==i.handles.points.length)return;const{cachedStats:a}=i,s=Object.keys(a);for(let e=0;e<s.length;e++){const o=s[e],r=this.getTargetIdImage(o,t);if(!r)continue;const{imageData:l}=r,d=i.handles.points[0],c=i.handles.points[1],h=E(l,d),g=E(l,c),{values:m,units:v}=(0,p.Xw)(r,[h]),{values:f,units:w}=(0,p.Xw)(r,[g]);let I,C,T,_,S=!1;if(v[0]!==w[0]||v[1]!==w[1]||"raw"===v[0]&&"raw"===w[0]){const e=(0,u.distanceToPoint)(d,c);I=[e,0],C=[e,0],T=["px"],S=!0}else{const e=n.viewport.worldToCanvas(d),t=n.viewport.worldToCanvas(c),i=t[1]-e[1],o=t[0]-e[0];_=Math.abs(o)>Math.abs(i),I=[m[0],f[0]],C=[m[1],f[1]],T=[v[0],v[1]]}a[o]={xValues:I,yValues:C,isHorizontal:_,units:T,isUnitless:S}}return e.invalidated=!1,(0,l.XF)(e,o),a}}function w(e,t,n){const i=e.cachedStats[t],{xValues:o,yValues:a,units:s,isUnitless:r,isHorizontal:l}=i;if(r)return[`${(0,g.roundNumber)(o[0])} px`];if(n.displayBothAxesDistances){const e=Math.abs(o[1]-o[0]),t=Math.abs(a[1]-a[0]);return[`${(0,g.roundNumber)(e)} ${s[0]}`,`${(0,g.roundNumber)(t)} ${s[1]}`]}if(l){const e=Math.abs(o[1]-o[0]);return[`${(0,g.roundNumber)(e)} ${s[0]}`]}{const e=Math.abs(a[1]-a[0]);return[`${(0,g.roundNumber)(e)} ${s[1]}`]}}f.toolName="UltrasoundDirectionalTool";const I=f},65043:(e,t,n)=>{n.d(t,{A:()=>E});var i=n(44753),o=n(92136),a=n(96214),s=n(21090),r=n(95778),l=n(2746),d=n(61738),c=n(84901),h=n(90252),g=n(23345),u=n(40233),m=n(23072),v=n(31970);class p extends a.EC{constructor(e={}){super(e,{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:d}=s;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:g,viewUp:v}=c,p=this.getReferencedImageId(l,a,g,v),E={metadata:{viewPlaneNormal:[0,0,1],viewUp:[0,1,0],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:p,toolName:this.getToolName()},data:{invalidated:!0,handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},active:!0}};(0,r.lC)(E,i);const f=(0,h.getViewportIdsWithToolToRender)(i,this.getToolName(),!1);return this.editData={annotation:E,viewportUIDsToRender:f,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,u.hideElementCursor)(i),e.preventDefault(),(0,m.A)(d,f),E},this.getHandleNearImagePoint=(e,t,n,a)=>{const s=(0,o.getEnabledElement)(e),{viewport:r}=s,{data:l}=t,{points:d}=l.handles;for(let e=0;e<d.length;e++){const t=d[e],o=r.worldToCanvas(t);if(!0===i.Zc.distance(n,o)<a)return l.handles.activeHandleIndex=e,t}l.handles.activeHandleIndex=null},this.isPointNearTool=(e,t,n,i)=>{const a=(0,o.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[3]),h=this._getRectangleImageCoordinates([d,c]),u=[n[0],n[1]],{left:m,top:v,width:p,height:E}=h;if(g.distanceToPoint([m,v,p,E],u)<=i)return!0},this.toolSelectedCallback=(e,t,n="mouse")=>{const i=e.detail,{element:a}=i,{data:s}=t;s.active=!0;const r=(0,h.getViewportIdsWithToolToRender)(a,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:r},this._activateModify(a),(0,u.hideElementCursor)(a);const l=(0,o.getEnabledElement)(a),{renderingEngine:d}=l;(0,m.A)(d,r),e.preventDefault()},this.handleSelectedCallback=(e,t,n,i="mouse")=>{const a=e.detail,{element:s}=a,{data:r}=t;r.active=!0;let l,d=!1;n.worldPosition?d=!0:l=r.handles.points.findIndex((e=>e===n));const c=(0,h.getViewportIdsWithToolToRender)(s,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:c,handleIndex:l},this._activateModify(s),(0,u.hideElementCursor)(s);const g=(0,o.getEnabledElement)(s),{renderingEngine:v}=g;(0,m.A)(v,c),e.preventDefault()},this._mouseUpCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:a,newAnnotation:s,hasMoved:l}=this.editData,{data:d}=i;if(s&&!l)return;d.active=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,u.resetElementCursor)(n);const c=(0,o.getEnabledElement)(n),{renderingEngine:h}=c;this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.O8)(i.annotationUID),(0,m.A)(h,a)},this._mouseDragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportUIDsToRender:a,handleIndex:s}=this.editData,{data:r}=i;if(void 0===s){const{deltaPoints:e}=t,n=e.world,{points:i}=r.handles;i.forEach((e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})),r.invalidated=!0}else{const{currentPoints:e}=t,i=(0,o.getEnabledElement)(n),{worldToCanvas:a,canvasToWorld:l}=i.viewport,d=e.world,{points:c}=r.handles;let h,g,u,m,v,p,E,f;switch(c[s]=[...d],s){case 0:case 3:h=a(c[0]),m=a(c[3]),g=[m[0],h[1]],u=[h[0],m[1]],p=l(g),E=l(u),c[1]=p,c[2]=E;break;case 1:case 2:g=a(c[1]),u=a(c[2]),h=[u[0],g[1]],m=[g[0],u[1]],v=l(h),f=l(m),c[0]=v,c[3]=f}r.invalidated=!0}this.editData.hasMoved=!0;const l=(0,o.getEnabledElement)(n),{renderingEngine:d}=l;(0,m.A)(d,a)},this._activateDraw=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(c.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(c.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(c.Events.TOUCH_END,this._mouseUpCallback),e.addEventListener(c.Events.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateDraw=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(c.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(c.Events.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(c.Events.TOUCH_END,this._mouseUpCallback),e.removeEventListener(c.Events.TOUCH_DRAG,this._mouseDragCallback)},this._activateModify=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(c.Events.MOUSE_UP,this._mouseUpCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(c.Events.TOUCH_END,this._mouseUpCallback),e.addEventListener(c.Events.TOUCH_DRAG,this._mouseDragCallback)},this._deactivateModify=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(c.Events.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(c.Events.TOUCH_END,this._mouseUpCallback),e.removeEventListener(c.Events.TOUCH_DRAG,this._mouseDragCallback)},this.renderAnnotation=(e,t)=>{const n=!1,{viewport:i}=e,{element:o}=i;let a=(0,r.Rh)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;this.getTargetId(i),i.getRenderingEngine();const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const n=a[e],{annotationUID:o}=n,r=(n.metadata,n.data),{points:d,activeHandleIndex:c}=r.handles,h=d.map((e=>i.worldToCanvas(e))),g=this.getStyle("lineWidth",s,n),u=this.getStyle("lineDash",s,n),m=this.getStyle("color",s,n);if(!i.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");let v;if(this.editData||null===c||(v=[h[c]]),v){const e="0";(0,l.drawHandles)(t,o,e,v,{color:m})}const p="0";(0,l.drawRedactionRect)(t,o,p,h[0],h[3],{color:"black",lineDash:u,lineWidth:g})}},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,a,s)=>{const{data:r}=e,{viewportUID:l,renderingEngineUID:d,sceneUID:h}=s,g=r.handles.points[0],u=r.handles.points[3],{cachedStats:m}=r,p=Object.keys(m);for(let e=0;e<p.length;e++){const o=p[e],{imageVolume:s}=this._getImageVolumeFromTargetUID(o,a),{dimensions:r,scalarData:l,vtkImageData:d,metadata:c}=s,h=i.eR.fromValues(0,0,0),E=i.eR.fromValues(0,0,0);if(d.worldToIndexVec3(g,h),h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]),d.worldToIndexVec3(u,E),E[0]=Math.floor(E[0]),E[1]=Math.floor(E[1]),E[2]=Math.floor(E[2]),this._isInsideVolume(h,E,r)){this.isHandleOutsideImage=!1;const e=Math.min(h[0],E[0]),i=Math.max(h[0],E[0]),a=Math.min(h[1],E[1]),s=Math.max(h[1],E[1]),d=Math.min(h[2],E[2]),p=Math.max(h[2],E[2]),{worldWidth:f,worldHeight:w}=(0,v.A)(t,n,g,u),I=f*w;let C=0,T=0,_=0;const S=r[0],D=r[0]*r[1];for(let t=d;t<=p;t++)for(let n=a;n<=s;n++)for(let o=e;o<=i;o++){C++,T+=l[t*D+n*S+o]}T/=C;for(let t=d;t<=p;t++)for(let n=a;n<=s;n++)for(let o=e;o<=i;o++){const e=l[t*D+n*S+o]-T;_+=e*e}_/=C,_=Math.sqrt(_),m[o]={Modality:c.Modality,area:I,mean:T,stdDev:_}}else this.isHandleOutsideImage=!0,m[o]={Modality:c.Modality}}r.invalidated=!1;const E=c.Events.ANNOTATION_MODIFIED,f={annotation:e,viewportUID:l,renderingEngineUID:d,sceneUID:h};return(0,o.triggerEvent)(o.eventTarget,E,f),m},this._isInsideVolume=(e,t,n)=>o.utilities.indexWithinDimensions(e,n)&&o.utilities.indexWithinDimensions(t,n),this._getTargetVolumeUID=e=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const t=e.getVolumeActors();return t||t.length?t[0].uid:void 0},this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,u.resetElementCursor)(e);const{annotation:t,viewportUIDsToRender:n}=this.editData,{data:i}=t;i.active=!1,i.handles.activeHandleIndex=null;const a=(0,o.getEnabledElement)(e),{renderingEngine:s}=a;return(0,m.A)(s,n),this.editData=null,t.metadata.annotationUID}_getImageVolumeFromTargetUID(e,t){let n;if(e.startsWith("stackTarget")){const i=e.indexOf(":"),o=e.substring(i+1);n=t.getViewport(o).getImageData()}else n=o.cache.getVolume(e);return{imageVolume:n,viewport:undefined}}_getTargetStackUID(e){return`stackTarget:${e.uid}`}}p.toolName="VideoRedaction";const E=p},28062:(e,t,n)=>{n.d(t,{A:()=>h});var i=n(92136),o=n(22338),a=n(38296),s=n(6805),r=n(65826),l=n(28664),d=n(35837);class c extends o.A{constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{const{element:t,imageId:n}=e.detail,o=i.utilities.imageIdToURI(n),r=(0,a.getAnnotationManager)();r.getFramesOfReference().forEach((e=>{const n=r.getAnnotations(e)[this.getToolName()];n&&n.length&&(n.forEach((e=>{if(!e.metadata?.referencedImageId)return;i.utilities.imageIdToURI(e.metadata.referencedImageId)===o&&(e.invalidated=!0,e.data.cachedStats={})})),(0,s.Ay)(t))}))}}filterInteractableAnnotationsForElement(e,t){if(!t||!t.length)return;const n=(0,i.getEnabledElement)(e),{viewport:o}=n;return(0,r.A)(o,t)}getReferencedImageId(e,t,n,o){const a=this.getTargetId(e);let s;if(e instanceof i.StackViewport)s=a.split("imageId:")[1];else if(e instanceof i.VideoViewport)s=a.split("videoId:")[1];else{const e=i.utilities.getVolumeId(a),o=i.cache.getVolume(e);s=i.utilities.getClosestImageId(o,t,n)}return s}getStyle(e,t,n){return(0,l.h)(e,t,(0,d.getState)(n),this.mode)}}c.toolName="AnnotationDisplayTool";const h=c},22338:(e,t,n)=>{n.d(t,{A:()=>s});var i=n(92136),o=n(12468);class a{constructor(e,t){const n=i.utilities.deepMerge(t,e),{configuration:a={},supportedInteractionTypes:s,toolGroupId:r}=n;a.strategies||(a.strategies={},a.defaultStrategy=void 0,a.activeStrategy=void 0,a.strategyOptions={}),this.toolGroupId=r,this.supportedInteractionTypes=s||[],this.configuration=Object.assign({},a),this.mode=o.A.Disabled}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){const{strategies:n,activeStrategy:i}=this.configuration;return n[i]?.call(this,e,t)}applyActiveStrategyCallback(e,t,n){const{strategies:i,activeStrategy:o}=this.configuration;if(!i[o])throw new Error(`applyActiveStrategyCallback: active strategy ${o} not found, check tool configuration or spellings`);return i[o][n]?.call(this,e,t)}setConfiguration(e){this.configuration=i.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetVolumeId(e){if(this.configuration.volumeId)return this.configuration.volumeId;const t=e.getActors();return t?t.find((e=>"vtkVolume"===e.actor.getClassName()))?.uid:void 0}getTargetIdImage(e,t){if(e.startsWith("imageId:")){const n=e.split("imageId:")[1],o=i.utilities.imageIdToURI(n);let a=i.utilities.getViewportsWithImageURI(o,t.id);if(!a||!a.length)return;if(a=a.filter((e=>e.getCurrentImageId()===n)),!a||!a.length)return;return a[0].getImageData()}if(e.startsWith("volumeId:")){const n=i.utilities.getVolumeId(e),o=i.utilities.getViewportsWithVolumeId(n,t.id);if(!o||!o.length)return;return o[0].getImageData()}if(e.startsWith("videoId:")){const n=i.utilities.imageIdToURI(e),o=i.utilities.getViewportsWithImageURI(n,t.id);if(!o||!o.length)return;return o[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){const t=e.getReferenceId?.();if(t)return t;if(e instanceof i.BaseVolumeViewport)return`volumeId:${this.getTargetVolumeId(e)}`;throw new Error("getTargetId: viewport must have a getTargetId method")}}a.toolName="BaseTool";const s=a},96214:(e,t,n)=>{n.d(t,{EC:()=>o.A,oS:()=>i.A,wh:()=>a.A});var i=n(22338),o=n(52454),a=n(28062)},2884:(e,t,n)=>{n.d(t,{T:()=>i.A});var i=n(69714)},94318:(e,t,n)=>{n.d(t,{Zy:()=>i.Ay,ji:()=>o.t});var i=n(44956),o=(n(44350),n(11654))},44956:(e,t,n)=>{n.d(t,{Ay:()=>I,iA:()=>v});var i=n(29853),o=n(37452),a=n(92136),s=n(83946),r=n(30322),l=n(52610),d=n(3006),c=n(29306),h=n(16124),g=n(63421);const u=255,m=new Map;function v(){const e=o.Ay.newInstance(),t=i.Ay.newInstance();return t.addPoint(0,0),{ofun:t,cfun:e}}let p=!1;function E(e,t,n,i){const o={...e,...t,...i||{}};return{fillAlpha:n?o.fillAlpha:o.fillAlphaInactive,outlineWidth:n?o.outlineWidthActive:o.outlineWidthInactive,renderFill:n?o.renderFill:o.renderFillInactive,renderOutline:o.renderOutline,outlineOpacity:n?o.outlineOpacity:o.outlineOpacityInactive}}function f(e,t,n,{fillAlpha:i,renderFill:o,renderOutline:a,segmentColor:s,outlineWidth:r,segmentsHidden:l}){const d=`${e}-${t}-${n}`,c=m.get(d);if(!c)return m.set(d,{fillAlpha:i,renderFill:o,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(l)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:h,renderFill:g,renderOutline:u,outlineWidth:v,segmentColor:p,segmentsHidden:E}=c,f=p[0]!==s[0]||p[1]!==s[1]||p[2]!==s[2],w=p[3]!==s[3]||h!==i||g!==o||u!==a||v!==r||E.has(n)!==l.has(n);return m.set(d,{fillAlpha:i,renderFill:o,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(l)}),{forceOpacityUpdate:w,forceColorUpdate:f}}async function w(e,t,n){await(0,d.A)(e.element,t,n)}const I={getRepresentationRenderingConfig:v,render:async function(e,t,n){const{colorLUTIndex:i,active:o,segmentationId:l,segmentationRepresentationUID:d,segmentsHidden:c,config:m}=t,v=r.getSegmentation(l);if(!v)return void console.warn("No segmentation found for segmentationId: ",l);let I=v.representationData[s.A.Labelmap],C=e.getActor(d);if(!I&&g.polySeg.canComputeRequestedRepresentation(d)&&!p){if(p=!0,I=await g.polySeg.computeAndAddLabelmapRepresentation(l,{segmentationRepresentationUID:d,viewport:e}),!I)throw new Error(`No labelmap data found for segmentationId ${l}.`);p=!1}if(!I)return;if((0,h.r)(I,e)){if(e instanceof a.StackViewport)return;const{volumeId:t}=I;if(!a.cache.getVolume(t))throw new Error(`No Labelmap found for volumeId: ${t}`);if(!function(e,t){if(!t)return!0;const n=e.getDefaultActor();if(!n)return!1;const{uid:i}=n,o=a.cache.getVolume(i);if(o){const e=a.cache.getVolume(t);if(e&&o.metadata.FrameOfReferenceUID===e.metadata.FrameOfReferenceUID)return!0}return!1}(e,I?.referencedVolumeId))return;C||await w(e,I,d),C=e.getActor(d)}else{if(e instanceof a.VolumeViewport)return;const t=e.getCurrentImageId(),{imageIdReferenceMap:n}=I;if(!n.has(t))return;C||await w(e,I,d),C=e.getActor(d)}if(!C)return;const{cfun:T,ofun:_}=m,S=n.renderInactiveSegmentations;!function(e,t,n,i,o,a,l,d,c,h){const{segmentSpecificConfig:g,segmentationRepresentationSpecificConfig:m}=l,v=m[s.A.Labelmap],p=r.getColorLUT(o),w=Math.min(256,p.length),{uid:I}=t,{outlineWidth:C,renderOutline:T,outlineOpacity:_}=E(a,v,d);for(let t=0;t<w;t++){const o=t,r=p[o],l=g[o]?.[s.A.Labelmap],{fillAlpha:c,outlineWidth:m,renderFill:w,renderOutline:C}=E(a,v,d,l),{forceOpacityUpdate:T,forceColorUpdate:_}=f(e,I,o,{fillAlpha:c,renderFill:w,renderOutline:C,segmentColor:r,outlineWidth:m,segmentsHidden:h});if(_&&n.addRGBPoint(o,r[0]/u,r[1]/u,r[2]/u),T)if(w){const e=h.has(o)?0:r[3]/255*c;i.removePoint(o),i.addPointLong(o,e,.5,1)}else i.addPointLong(o,.01,.5,1)}const S=t.actor;S.getProperty().setRGBTransferFunction(0,n),i.setClamping(!1),S.getProperty().setScalarOpacity(0,i),S.getProperty().setInterpolationTypeToNearest(),S.getProperty().setUseLabelOutline(T),S.getProperty().setLabelOutlineOpacity(_);const{activeSegmentIndex:D}=r.getSegmentation(l.segmentationId),A=new Array(w-1);for(let e=1;e<w;e++){h.has(e)?A[e-1]=0:A[e-1]=e===D?C+a.activeSegmentOutlineWidthDelta:C}S.getProperty().setLabelOutlineThickness(A);const b=d||c;S.setVisibility(b)}(e.id,C,T,_,i,n.representations[s.A.Labelmap],t,o,S,c)},removeSegmentationRepresentation:function(e,t,n=!1){if(function(e,t){const n=(0,l.getToolGroup)(e);if(void 0===n)throw new Error(`ToolGroup with ToolGroupId ${e} does not exist`);const{viewportsInfo:i}=n;for(const e of i){const{viewportId:n,renderingEngineId:i}=e,o=(0,a.getEnabledElementByIds)(n,i);(0,c.A)(o.viewport.element,t)}}(e,t),r.removeSegmentationRepresentation(e,t),n){(0,l.getToolGroup)(e).getViewportsInfo().forEach((({viewportId:e,renderingEngineId:t})=>{(0,a.getEnabledElementByIds)(e,t).viewport.render()}))}}}},81848:(e,t,n)=>{n.d(t,{M$:()=>v.A,yT:()=>N.A,wh:()=>i.wh,EC:()=>i.EC,ao:()=>U.A,oS:()=>i.oS,Mu:()=>C.A,ls:()=>le.A,pq:()=>re.A,Vl:()=>b.A,G2:()=>F.A,EV:()=>P.A,ep:()=>u.A,j$:()=>S.A,qD:()=>A.A,dB:()=>W.A,Np:()=>V.A,LW:()=>T.A,Ix:()=>L.A,Ys:()=>x.A,uJ:()=>g.A,eh:()=>m.A,Xr:()=>ce.A,Nk:()=>E.A,Uj:()=>de.A,CH:()=>o.A,PlanarFreehandContourSegmentationTool:()=>M.A,ex:()=>O.A,A5:()=>l.A,N7:()=>_.A,mX:()=>se,TR:()=>ee,E0:()=>D.A,td:()=>B.A,xI:()=>w.A,LL:()=>p.A,X8:()=>p.A,FE:()=>I.A,IX:()=>he.A,t0:()=>H.A,cN:()=>f.A,zH:()=>G.A,qT:()=>R.A,J2:()=>y.A,uf:()=>d.A,ae:()=>r.A,So:()=>a.A,oi:()=>k.A,Y1:()=>h.A,Du:()=>s.A,OQ:()=>c.A});var i=n(96214),o=n(25294),a=n(15924),s=n(455),r=n(20132),l=n(15354),d=n(57008),c=n(20842),h=n(94574),g=n(57424),u=n(91976),m=n(93970),v=n(73168),p=n(54541),E=n(87841),f=n(70494),w=n(1143),I=n(92807),C=n(50720),T=n(72655),_=n(30049),S=n(28087),D=n(19994),A=n(19116),b=n(42865),y=n(42058),R=n(67540),O=n(39244),M=n(20070),x=n(19904),L=n(88854),U=n(65314),N=n(1368),P=n(40310),k=n(95608),V=n(72799),W=n(7336),H=n(31163),B=n(81502),F=n(34229),G=n(55108),$=n(92136),q=n(95778),z=n(48428),Z=n(2746),K=n(90252),j=n(40233),Y=n(23072),X=n(21009),J=n(54177);class Q extends D.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,$.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l,h=this.getTargetId(s);let g,u;if(s instanceof $.StackViewport)g=h.split("imageId:")[1];else{u=$.utilities.getVolumeId(h);const e=$.cache.getVolume(u);g=$.utilities.getClosestImageId(e,o,d)}const m=s.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:m,referencedImageId:g,toolName:this.getToolName(),volumeId:u},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},segmentationId:null}};(0,q.lC)(v,i);const p=(0,K.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:p,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,j.hideElementCursor)(i),e.preventDefault(),(0,Y.A)(r,p),v},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,{element:o}=i;let a=(0,q.Rh)(this.getToolName(),o);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(o,a),!a?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const r=a[e],{annotationUID:l,data:d}=r,{points:c,activeHandleIndex:h}=d.handles,g=c.map((e=>i.worldToCanvas(e)));s.annotationUID=l;const u=this.getStyle("lineWidth",s,r),m=this.getStyle("lineDash",s,r),v=this.getStyle("color",s,r);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let p;if((0,J.XF)(r,o),!(0,X.isAnnotationVisible)(l))continue;if((0,z.isAnnotationLocked)(r)||this.editData||null===h||(p=[g[h]]),p){const e="0";(0,Z.drawHandles)(t,l,e,p,{color:v})}const E="0";(0,Z.drawRect)(t,l,E,g[0],g[3],{color:v,lineDash:m,lineWidth:u}),n=!0}return n}}}Q.toolName="RectangleROIThreshold";const ee=Q;var te=n(44753),ne=n(21090),ie=n(74119);const{transformWorldToIndex:oe}=$.utilities;class ae extends D.A{constructor(e={},t={configuration:{numSlicesToPropagate:10,computePointsInsideVolume:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,o=n.world,a=(0,$.getEnabledElement)(i),{viewport:s,renderingEngine:r}=a;this.isDrawing=!0;const l=s.getCamera(),{viewPlaneNormal:d,viewUp:c}=l;let h,g,u;if(s instanceof $.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(s);u=$.utilities.getVolumeId(e),g=$.cache.getVolume(u),h=$.utilities.getClosestImageId(g,o,d)}if(!h)throw new Error("This tool does not work on non-acquisition planes");const m=s.getCurrentImageIdIndex(),v=$.utilities.getSpacingInNormalDirection(g,d),p=this._getEndSliceIndex(g,o,v,d),E=s.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...d],enabledElement:a,viewUp:[...c],FrameOfReferenceUID:E,referencedImageId:h,toolName:this.getToolName(),volumeId:u,spacingInNormal:v},data:{label:"",startSlice:m,endSlice:p,cachedStats:{pointsInVolume:[],projectionPoints:[],projectionPointsImageIds:[h]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...o],[...o],[...o],[...o]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(f,g),(0,q.lC)(f,i);const w=(0,K.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:w,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,j.hideElementCursor)(i),e.preventDefault(),(0,Y.A)(r,w),f},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,j.resetElementCursor)(n);const l=(0,$.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,q.O8)(i.annotationUID);const d=this.getTargetId(l.viewport),c=$.cache.getVolume(d.split(/volumeId:|\?/)[1]);this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(i,c,l),(0,Y.A)(l.renderingEngine,o),a&&(0,J.dZ)(i)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,o=(0,q.Rh)(this.getToolName(),i.element);if(!o?.length)return n;const a=i.getCurrentImageIdIndex(),s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let r=0;r<o.length;r++){const l=o[r],{annotationUID:d,data:c}=l,{startSlice:h,endSlice:g}=c,{points:u,activeHandleIndex:m}=c.handles,v=u.map((e=>i.worldToCanvas(e)));s.annotationUID=d;const p=this.getStyle("lineWidth",s,l),E=this.getStyle("lineDash",s,l),f=this.getStyle("color",s,l);if(a<Math.min(h,g)||a>Math.max(h,g))continue;l.invalidated&&this._throttledCalculateCachedStats(l,e);let w,I=!1;if(a!==h&&a!==g||(I=!0),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,X.isAnnotationVisible)(d))continue;if((0,z.isAnnotationLocked)(l)||this.editData||null===m||!I||(w=[v[m]]),w){const e="0";(0,Z.drawHandles)(t,d,e,w,{color:f})}let C=E;I||(C=2);const T="0";(0,Z.drawRect)(t,d,T,v[0],v[3],{color:f,lineDash:C,lineWidth:p}),n=!0}return n},this._throttledCalculateCachedStats=(0,ne.A)(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:i}=e,{viewPlaneNormal:o,spacingInNormal:a}=i,{imageData:s}=t,{startSlice:r,endSlice:l}=n,{points:d}=n.handles,c=oe(s,d[0]);if(c[2]!==r)throw new Error("Start slice does not match");const h=te.eR.fromValues(c[0],c[1],l),g=te.eR.create();s.indexToWorldVec3(c,g);const u=te.eR.create();s.indexToWorldVec3(h,u);const m=te.eR.distance(g,u),v=[];for(let e=0;e<m;e+=a)v.push(d.map((t=>{const n=te.eR.create();return te.eR.scaleAndAdd(n,t,o,e),Array.from(n)})));n.cachedStats.projectionPoints=v;const p=[];for(const e of v){const n=$.utilities.getClosestImageId(t,e[0],o);p.push(n)}n.cachedStats.projectionPointsImageIds=p}_computePointsInsideVolume(e,t,n){const{data:i}=e,o=i.cachedStats.projectionPoints,a=[[]];for(let e=0;e<o.length;e++){if(!t)continue;const n=o[e][0],s=i.handles.points[0],r=i.handles.points[3],{dimensions:l,imageData:d}=t,c=oe(d,s),h=oe(d,n);c[0]=Math.floor(c[0]),c[1]=Math.floor(c[1]),c[2]=Math.floor(h[2]);const g=oe(d,r);if(g[0]=Math.floor(g[0]),g[1]=Math.floor(g[1]),g[2]=Math.floor(h[2]),this._isInsideVolume(c,g,l)){this.isHandleOutsideImage=!1;const e=[[Math.min(c[0],g[0]),Math.max(c[0],g[0])],[Math.min(c[1],g[1]),Math.max(c[1],g[1])],[Math.min(c[2],g[2]),Math.max(c[2],g[2])]],t=(0,ie.pointInShapeCallback)(d,(()=>!0),null,e);a.push(t)}}i.cachedStats.pointsInVolume=a}_calculateCachedStatsTool(e,t){const n=e.data,{viewport:i}=t,{cachedStats:o}=n,a=this.getTargetId(i),s=$.cache.getVolume(a.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(e,s),e.invalidated=!1,(0,J.XF)(e,i.element),o}_getEndSliceIndex(e,t,n,i){const o=this.configuration.numSlicesToPropagate,a=te.eR.create();te.eR.scaleAndAdd(a,t,i,o*n);const s=n/2,{imageIds:r}=e;let l;for(let e=0;e<r.length;e++){const t=r[e],{imagePositionPatient:n}=$.metaData.get("imagePlaneModule",t),o=te.eR.create();te.eR.sub(o,a,n);const d=te.eR.dot(o,i);Math.abs(d)<s&&(l=e)}return l}}ae.toolName="RectangleROIStartEndThreshold";const se=ae;var re=n(94932),le=n(53712),de=n(70817),ce=n(36129),he=n(34041)},53712:(e,t,n)=>{n.d(t,{A:()=>E});var i=n(92136),o=n(44753),a=n(96214),s=n(61604),r=n(4373),l=n(4069),d=n(11852),c=n(84901),h=n(2746),g=n(40233),u=n(23072),m=n(63421),v=n(16124);class p extends a.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:l.kr,ERASE_INSIDE_CIRCLE:d.r,FILL_INSIDE_SPHERE:s.Jq,ERASE_INSIDE_SPHERE:r._,THRESHOLD_INSIDE_CIRCLE:l.q,THRESHOLD_INSIDE_SPHERE:s.rd},strategySpecificConfiguration:{THRESHOLD:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",thresholdVolumeId:null,brushSize:25,preview:{enabled:!1,previewColors:{},previewTimeMs:250,previewMoveDistance:8,dragMoveDistance:4,dragTimeMs:500},actions:{[c.StrategyCallbacks.AcceptPreview]:{method:c.StrategyCallbacks.AcceptPreview,bindings:[{key:"Enter"}]},[c.StrategyCallbacks.RejectPreview]:{method:c.StrategyCallbacks.RejectPreview,bindings:[{key:"Escape"}]}}}}){super(e,t),this._previewData={preview:null,element:null,timerStart:0,timer:null,startPoint:[NaN,NaN],isDrag:!1},this.onSetToolPassive=e=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=e=>{this.disableCursor()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{renderingEngine:a}=o;this._editData=this.createEditData(n),this._activateDraw(n),(0,g.hideElementCursor)(n),e.preventDefault(),this._previewData.isDrag=!1,this._previewData.timerStart=Date.now();const s=this._hoverData||this.createHoverData(n);return(0,u.A)(a,s.viewportIdsToRender),this.applyActiveStrategyCallback(o,this.getOperationData(n),c.StrategyCallbacks.OnInteractionStart),!0},this.mouseMoveCallback=e=>{if(this.mode===c.ToolModes.Active){if(this.updateCursor(e),!this.configuration.preview.enabled)return;const{previewTimeMs:t,previewMoveDistance:n,dragMoveDistance:i}=this.configuration.preview,{currentPoints:a,element:s}=e.detail,{canvas:r}=a,{preview:l,startPoint:d,timer:c,timerStart:h,isDrag:g}=this._previewData,u=o.Zc.distance(r,d),m=Date.now()-h;if((u>n||m>t&&u>i)&&(c&&(window.clearTimeout(c),this._previewData.timer=null),l&&!g&&this.rejectPreview(s)),!this._previewData.timer){const e=window.setTimeout(this.previewCallback,250);Object.assign(this._previewData,{timerStart:Date.now(),timer:e,startPoint:r,element:s})}}},this.previewCallback=()=>{this._previewData.preview||(this._previewData.timer=null,this._previewData.preview=this.applyActiveStrategyCallback((0,i.getEnabledElement)(this._previewData.element),this.getOperationData(this._previewData.element),c.StrategyCallbacks.Preview))},this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:a}=t,s=(0,i.getEnabledElement)(n),{renderingEngine:r}=s;this.updateCursor(e);const{viewportIdsToRender:l}=this._hoverData;(0,u.A)(r,l);const d=o.Zc.distance(a.canvas,this._previewData.startPoint),{dragTimeMs:c,dragMoveDistance:h}=this.configuration.preview;!this._previewData.isDrag&&this._previewData.preview&&Date.now()-this._previewData.timerStart<c&&d<h||(this._previewData.preview=this.applyActiveStrategy(s,this.getOperationData(n)),this._previewData.element=n,this._previewData.timerStart=Date.now()+c,this._previewData.isDrag=!0,this._previewData.startPoint=a.canvas)},this._endCallback=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),a=this.getOperationData(n);this._previewData.preview||this._previewData.isDrag||this.applyActiveStrategy(o,a),this._deactivateDraw(n),(0,g.resetElementCursor)(n),this.updateCursor(e),this._editData=null,this.applyActiveStrategyCallback(o,a,c.StrategyCallbacks.OnInteractionEnd),this._previewData.isDrag||this.acceptPreview(n)},this._activateDraw=e=>{e.addEventListener(c.Events.MOUSE_UP,this._endCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(c.Events.MOUSE_UP,this._endCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0,this.rejectPreview()}createEditData(e){const t=(0,i.getEnabledElement)(e),{viewport:n}=t,o=this.toolGroupId,a=m.activeSegmentation.getActiveSegmentationRepresentation(o);if(!a)throw new Error("No active segmentation detected, create a segmentation representation before using the brush tool");const{segmentationId:s,type:r,segmentationRepresentationUID:l}=a;if(r===c.SegmentationRepresentations.Contour)throw new Error("Not implemented yet");const d=m.segmentLocking.getLockedSegments(s),{representationData:h}=m.state.getSegmentation(s),g=h[c.SegmentationRepresentations.Labelmap];if((0,v.r)(g,n)){const{volumeId:e}=h[r],t=n.getActors();if(n instanceof i.StackViewport){const e=new CustomEvent(i.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"Cannot perform brush operation on the selected viewport"},cancelable:!0});return i.eventTarget.dispatchEvent(e),null}const o=t.map((e=>i.cache.getVolume(e.referenceId))),a=i.cache.getVolume(e),s=o.find((e=>i.utilities.isEqual(e.dimensions,a.dimensions)))?.volumeId||o[0]?.volumeId;return{volumeId:e,referencedVolumeId:this.configuration.thresholdVolumeId??s,segmentsLocked:d,segmentationRepresentationUID:l}}{const{imageIdReferenceMap:e}=g,t=n.getCurrentImageId();if(!e.get(t))return;if(this.configuration.activeStrategy.includes("SPHERE"))throw new Error("Sphere manipulation is not supported for stacks of image segmentations yet");return{imageIdReferenceMap:e,segmentsLocked:d,segmentationRepresentationUID:l}}}createHoverData(e,t){const n=(0,i.getEnabledElement)(e),{viewport:o}=n,a=o.getCamera(),{viewPlaneNormal:s,viewUp:r}=a,l=[o.id],{segmentIndex:d,segmentationId:c,segmentationRepresentationUID:h,segmentColor:g}=this.getActiveSegmentationData()||{};return{brushCursor:{metadata:{viewPlaneNormal:[...s],viewUp:[...r],FrameOfReferenceUID:o.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:g},data:{}},centerCanvas:t,segmentIndex:d,segmentationId:c,segmentationRepresentationUID:h,segmentColor:g,viewportIdsToRender:l}}getActiveSegmentationData(){const e=this.toolGroupId,t=m.activeSegmentation.getActiveSegmentationRepresentation(e);if(!t)return void console.warn("No active segmentation detected, create one before using the brush tool");const{segmentationRepresentationUID:n,segmentationId:i}=t,o=m.segmentIndex.getActiveSegmentIndex(i);return{segmentIndex:o,segmentationId:i,segmentationRepresentationUID:n,segmentColor:m.config.color.getColorForSegmentIndex(e,n,o)}}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas;this._hoverData=this.createHoverData(n,a),this._calculateCursor(n,a),this._hoverData&&(0,u.A)((0,i.getEnabledElement)(n).renderingEngine,this._hoverData.viewportIdsToRender)}getOperationData(e){const t=this._editData||this.createEditData(e),{segmentIndex:n,segmentationId:i,segmentationRepresentationUID:o,brushCursor:a}=this._hoverData||this.createHoverData(e),{data:s,metadata:r={}}=a||{},{viewPlaneNormal:l,viewUp:d}=r;return{...t,points:s?.handles?.points,segmentIndex:n,previewColors:this.configuration.preview.enabled?this.configuration.preview.previewColors:null,viewPlaneNormal:l,toolGroupId:this.toolGroupId,segmentationId:i,segmentationRepresentationUID:o,viewUp:d,strategySpecificConfiguration:this.configuration.strategySpecificConfiguration,preview:this._previewData?.preview}}_calculateCursor(e,t){const n=(0,i.getEnabledElement)(e),{viewport:a}=n,{canvasToWorld:s}=a,r=a.getCamera(),{brushSize:l}=this.configuration,d=o.eR.fromValues(r.viewUp[0],r.viewUp[1],r.viewUp[2]),c=o.eR.fromValues(r.viewPlaneNormal[0],r.viewPlaneNormal[1],r.viewPlaneNormal[2]),h=o.eR.create();o.eR.cross(h,d,c);const g=s([t[0],t[1]]),u=o.eR.create(),m=o.eR.create(),v=o.eR.create(),p=o.eR.create();for(let e=0;e<=2;e++)u[e]=g[e]-d[e]*l,m[e]=g[e]+d[e]*l,v[e]=g[e]-h[e]*l,p[e]=g[e]+h[e]*l;if(!this._hoverData)return;const{brushCursor:E}=this._hoverData,{data:f}=E;void 0===f.handles&&(f.handles={}),f.handles.points=[u,m,v,p];const w=this.configuration.activeStrategy,I=this.configuration.strategies[w];"function"==typeof I.computeInnerCircleRadius&&I.computeInnerCircleRadius({configuration:this.configuration,viewport:a}),f.invalidated=!1}rejectPreview(e=this._previewData.element){if(!e||!this._previewData.preview)return;const t=(0,i.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),c.StrategyCallbacks.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1}acceptPreview(e=this._previewData.element){if(!e)return;const t=(0,i.getEnabledElement)(e);this.applyActiveStrategyCallback(t,this.getOperationData(e),c.StrategyCallbacks.AcceptPreview),this._previewData.isDrag=!1,this._previewData.preview=null}invalidateBrushCursor(){if(void 0===this._hoverData)return;const{data:e}=this._hoverData.brushCursor;e.invalidated=!0;const{segmentColor:t}=this.getActiveSegmentationData()||{};this._hoverData.brushCursor.metadata.segmentColor=t}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const i=this._hoverData.brushCursor;if(!0===i.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const o=i.metadata;if(!o)return;const a=o.brushCursorUID,s=i.data,{points:r}=s.handles,l=r.map((e=>n.worldToCanvas(e))),d=l[0],c=l[1],g=[Math.floor((d[0]+c[0])/2),Math.floor((d[1]+c[1])/2)],u=Math.abs(d[1]-Math.floor((d[1]+c[1])/2)),m=`rgb(${o.segmentColor?.slice(0,3)||[0,0,0]})`;if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");(0,h.drawCircle)(t,a,"0",g,u,{color:m});const v=this.configuration.activeStrategy,{dynamicRadiusInCanvas:p}=this.configuration.strategySpecificConfiguration[v]||{dynamicRadiusInCanvas:0};if(p){const e="1";(0,h.drawCircle)(t,a,e,g,p,{color:m})}}}p.toolName="Brush";const E=p},94932:(e,t,n)=>{n.d(t,{A:()=>C});var i=n(92136),o=n(44753),a=n(84901),s=n(38296),r=n(48428),l=n(2746),d=n(90252),c=n(21090),h=n(21009),g=n(40233),u=n(23072),m=n(54177),v=n(42865),p=n(75162),E=n(2264),f=n(74119);const{transformWorldToIndex:w}=i.utilities;class I extends v.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{numSlicesToPropagate:10,calculatePointsInsideVolume:!1}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,r=(0,i.getEnabledElement)(o),{viewport:l,renderingEngine:c}=r;this.isDrawing=!0;const h=l.getCamera(),{viewPlaneNormal:m,viewUp:v}=h;let p,E,f;if(l instanceof i.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(l);f=i.utilities.getVolumeId(e),E=i.cache.getVolume(f),p=i.utilities.getClosestImageId(E,a,m)}const w=i.utilities.getSpacingInNormalDirection(E,m),I=this._getStartSliceIndex(E,a,w,m),C=this._getEndSliceIndex(E,a,w,m),T=l.getFrameOfReferenceUID(),_={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...m],viewUp:[...v],FrameOfReferenceUID:T,referencedImageId:p,volumeId:f,spacingInNormal:w,enabledElement:r},data:{label:"",startSlice:I,endSlice:C,handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...a],[...a]],activeHandleIndex:null},cachedStats:{pointsInVolume:[],projectionPoints:[]},labelmapUID:null}};(0,s.addAnnotation)(_,o);const S=(0,d.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:_,viewportIdsToRender:S,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),(0,g.hideElementCursor)(o),e.preventDefault(),(0,u.A)(c,S),_},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=o;if(r&&!l)return;o.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,g.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.removeAnnotation)(o.annotationUID);const h=this.getTargetId(c.viewport),v=i.cache.getVolume(h.split(/volumeId:|\?/)[1]);this.configuration.calculatePointsInsideVolume&&this._computePointsInsideVolume(o,v,c),(0,u.A)(c.renderingEngine,a),r&&(0,m.dZ)(o)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e,o=(0,s.getAnnotations)(this.getToolName(),i.element);if(!o?.length)return n;const a=i.getCurrentImageIdIndex(),d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let s=0;s<o.length;s++){const c=o[s],{annotationUID:g,data:u}=c,{startSlice:m,endSlice:v}=u,{points:E,activeHandleIndex:f}=u.handles;d.annotationUID=g;const w=this.getStyle("lineWidth",d,c),I=this.getStyle("lineDash",d,c),C=this.getStyle("color",d,c),T=E.map((e=>i.worldToCanvas(e))),_=T[0],S=(0,p.r)(T),{centerPointRadius:D}=this.configuration;if(a<Math.min(m,v)||a>Math.max(m,v))continue;c.invalidated&&this._throttledCalculateCachedStats(c,e);let A,b=!1;if(a===Math.round((m+v)/2)&&(b=!0),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,h.isAnnotationVisible)(g))continue;if((0,r.isAnnotationLocked)(c)||this.editData||null===f||!b||(A=[T[f]]),A){const e="0";(0,l.drawHandles)(t,g,e,A,{color:C})}let y=w;b&&(y=3);const R="0";(0,l.drawCircle)(t,g,R,_,S,{color:C,lineDash:I,lineWidth:y}),D>0&&S>3*D&&(0,l.drawCircle)(t,g,`${R}-center`,_,D,{color:C,lineDash:I,lineWidth:w}),n=!0}return n},this._throttledCalculateCachedStats=(0,c.A)(this._calculateCachedStatsTool,100,{trailing:!0})}_computeProjectionPoints(e,t){const{data:n,metadata:i}=e,{viewPlaneNormal:a,spacingInNormal:s}=i,{imageData:r}=t,{startSlice:l,endSlice:d}=n,{points:c}=n.handles,h=w(r,c[0]);if(h[2]=l,h[2]!==l)throw new Error("Start slice does not match");const g=o.eR.fromValues(h[0],h[1],d),u=o.eR.create();r.indexToWorldVec3(h,u);const m=o.eR.create();r.indexToWorldVec3(g,m);const v=o.eR.distance(u,m),p=[];for(let e=0;e<v;e+=s)p.push(c.map((t=>{const n=o.eR.create();return o.eR.scaleAndAdd(n,t,a,e),Array.from(n)})));n.cachedStats.projectionPoints=p}_computePointsInsideVolume(e,t,n){const{data:i}=e,{viewport:o}=n,a=i.cachedStats.projectionPoints,s=[[]];for(let e=0;e<a.length;e++){if(!t)continue;const n=a[e][0],i=a[e].map((e=>o.worldToCanvas(e))),[r,l]=(0,p.H)(i),d=o.canvasToWorld(r),c=o.canvasToWorld(l),h=d,g=c,{dimensions:u,imageData:m}=t,v=w(m,h),I=w(m,n);v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(I[2]);const C=w(m,g);if(C[0]=Math.floor(C[0]),C[1]=Math.floor(C[1]),C[2]=Math.floor(I[2]),this._isInsideVolume(v,C,u)){const e=[[Math.min(v[0],C[0]),Math.max(v[0],C[0])],[Math.min(v[1],C[1]),Math.max(v[1],C[1])],[Math.min(v[2],C[2]),Math.max(v[2],C[2])]],t={center:n,xRadius:Math.abs(d[0]-c[0])/2,yRadius:Math.abs(d[1]-c[1])/2,zRadius:Math.abs(d[2]-c[2])/2},i=(0,f.pointInShapeCallback)(m,(e=>(0,E.pointInEllipse)(t,e)),null,e);s.push(i)}}i.cachedStats.pointsInVolume=s}_calculateCachedStatsTool(e,t){const n=e.data,{viewportId:o,renderingEngineId:s,viewport:r}=t,{cachedStats:l}=n,d=this.getTargetId(r),c=i.cache.getVolume(d.split(/volumeId:|\?/)[1]);this._computeProjectionPoints(e,c),e.invalidated=!1;const h=a.Events.ANNOTATION_MODIFIED,g={annotation:e,viewportId:o,renderingEngineId:s};return(0,i.triggerEvent)(i.eventTarget,h,g),l}_getStartSliceIndex(e,t,n,i){const a=this.configuration.numSlicesToPropagate,s=Math.round(a/2),r=o.eR.create();o.eR.scaleAndAdd(r,t,i,s*-n);return this._getImageIdIndex(e,r,n,i)}_getEndSliceIndex(e,t,n,i){const a=this.configuration.numSlicesToPropagate,s=Math.round(a/2),r=o.eR.create();o.eR.scaleAndAdd(r,t,i,s*n);return this._getImageIdIndex(e,r,n,i)}_getImageIdIndex(e,t,n,a){const s=n/2,{imageIds:r}=e;let l;for(let e=0;e<r.length;e++){const n=r[e],{imagePositionPatient:d}=i.metaData.get("imagePlaneModule",n),c=o.eR.create();o.eR.sub(c,t,d);const h=o.eR.dot(c,a);Math.abs(h)<s&&(l=e)}return l}}I.toolName="CircleROIStartEndThreshold";const C=I},34229:(e,t,n)=>{n.d(t,{A:()=>v});var i=n(92136),o=n(96214),a=n(4069),s=n(11852),r=n(84901),l=n(2746),d=n(40233),c=n(23072),h=n(63421),g=n(30322),u=n(16124);class m extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:a.kr,ERASE_INSIDE:s.r},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=n.canvas,r=(0,i.getEnabledElement)(o),{viewport:l,renderingEngine:m}=r;this.isDrawing=!0;const v=l.getCamera(),{viewPlaneNormal:p,viewUp:E}=v,f=this.toolGroupId,w=h.activeSegmentation.getActiveSegmentationRepresentation(f);if(!w)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:I,segmentationId:C,type:T}=w,_=h.segmentIndex.getActiveSegmentIndex(C),S=h.segmentLocking.getLockedSegments(C),D=h.config.color.getColorForSegmentIndex(f,I,_),{representationData:A}=(0,g.getSegmentation)(C),b=A[T];if(!b)throw new Error("No labelmap data found for the active segmentation, create one before using scissors tool");const y={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...p],viewUp:[...E],FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:D},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},R=[l.id];if(this.editData={annotation:y,centerCanvas:s,segmentIndex:_,segmentationId:C,segmentsLocked:S,segmentColor:D,viewportIdsToRender:R,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,segmentationRepresentationUID:I},(0,u.r)(b,l)){const{volumeId:e}=b,t=i.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=b;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(o),(0,d.hideElementCursor)(o),e.preventDefault(),(0,c.A)(m,R),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:h,viewportIdsToRender:g,centerCanvas:u}=this.editData,{data:m}=h,v=Math.abs(a[0]-u[0]),p=Math.abs(a[1]-u[1]),E=Math.sqrt(v*v+p*p),f=[u[0],u[1]+E],w=[u[0],u[1]-E],I=[u[0]-E,u[1]],C=[u[0]+E,u[1]];m.handles.points=[d(f),d(w),d(I),d(C)],h.invalidated=!0,this.editData.hasMoved=!0,(0,c.A)(r,g)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=o,{viewPlaneNormal:l,viewUp:c}=o.metadata;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,d.resetElementCursor)(n);const h=(0,i.getEnabledElement)(n),g={...this.editData,points:r.handles.points,viewPlaneNormal:l,viewUp:c,strategySpecificConfiguration:{}};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(h,g)},this._activateDraw=e=>{e.addEventListener(r.Events.MOUSE_UP,this._endCallback),e.addEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(r.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(r.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(r.Events.TOUCH_TAP,this._endCallback),e.addEventListener(r.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(r.Events.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(r.Events.MOUSE_UP,this._endCallback),e.removeEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(r.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(r.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(r.Events.TOUCH_END,this._endCallback),e.removeEventListener(r.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(r.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,s=a.metadata,r=a.annotationUID,d=a.data,{points:c}=d.handles,h=c.map((e=>i.worldToCanvas(e))),g=h[0],u=h[1],m=[Math.floor((g[0]+u[0])/2),Math.floor((g[1]+u[1])/2)],v=Math.abs(g[1]-Math.floor((g[1]+u[1])/2)),p=`rgb(${s.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,l.drawCircle)(t,r,"0",m,v,{color:p}),n=!0,n}}}m.toolName="CircleScissor";const v=m},70817:(e,t,n)=>{n.d(t,{A:()=>m});var i=n(92136),o=n(96214),a=n(84901),s=n(87682),r=n(63421),l=n(27650),d=n(30322),c=n(16124);const{transformWorldToIndex:h,isEqual:g}=i.utilities;class u extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,g=n.world,u=(0,i.getEnabledElement)(o),{viewport:m}=u,v=m.getCamera(),{viewPlaneNormal:p}=v,E=this.toolGroupId,f=r.activeSegmentation.getActiveSegmentationRepresentation(E);if(!f)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:w,type:I}=f,C=r.segmentIndex.getActiveSegmentIndex(w),T=r.segmentLocking.getLockedSegments(w),{representationData:_}=(0,d.getSegmentation)(w),S=_[a.SegmentationRepresentations.Labelmap];let D,A,b,y;if((0,c.r)(S,m)){const{volumeId:e}=_[I],t=i.cache.getVolume(e);({dimensions:D,direction:A}=t),b=t.getScalarData(),y=h(t.imageData,g)}else{const{imageIdReferenceMap:e}=S,t=u.viewport.getCurrentImageId(),n=e.get(t);if(!n)throw new Error("No active segmentation imageId detected, create one before using scissors tool");const o=i.cache.getImage(n);b=o.getPixelData();const{imageData:a}=m.getImageData();D=a.getDimensions(),A=a.getDirection(),y=h(a,g)}const R=this.getFixedDimension(p,A);if(void 0===R)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:O,getLabelValue:M,getScalarDataPositionFromPlane:x,inPlaneSeedPoint:L,fixedDimensionValue:U}=this.generateHelpers(b,D,y,R);if(y[0]<0||y[0]>=D[0]||y[1]<0||y[1]>=D[1]||y[2]<0||y[2]>=D[2])return;const N=M(y[0],y[1],y[2]);if(T.includes(N))return;const P=(0,l.A)(O,L),{flooded:k}=P;k.forEach((e=>{const t=x(e[0],e[1]);b[t]=C}));const V=this.getFramesModified(R,U,P);return(0,s.triggerSegmentationDataModified)(w,V),!0},this.getFramesModified=(e,t,n)=>{const{boundaries:i}=n;if(2===e)return[t];let o=1/0,a=-1/0;for(let e=0;e<i.length;e++){const t=i[e][1];t<o&&(o=t),t>a&&(a=t)}const s=[];for(let e=o;e<=a;e++)s.push(e);return s},this.generateHelpers=(e,t,n,i=2)=>{let o,a;switch(i){case 0:o=n[0],a=[n[1],n[2]];break;case 1:o=n[1],a=[n[0],n[2]];break;case 2:o=n[2],a=[n[0],n[1]];break;default:throw new Error(`Invalid fixedDimension: ${i}`)}const s=(e,n,i)=>i*t[1]*t[0]+n*t[0]+e,r=(t,n,i)=>e[s(t,n,i)],l=this.generateFloodFillGetter(t,i,o,r);return{getScalarDataPositionFromPlane:this.generateGetScalarDataPositionFromPlane(s,i,o),getLabelValue:r,floodFillGetter:l,inPlaneSeedPoint:a,fixedDimensionValue:o}},this.generateFloodFillGetter=(e,t,n,i)=>{let o;switch(t){case 0:o=(t,o)=>{if(!(t>=e[1]||t<0||o>=e[2]||o<0))return i(n,t,o)};break;case 1:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[2]||o<0))return i(t,n,o)};break;case 2:o=(t,o)=>{if(!(t>=e[0]||t<0||o>=e[1]||o<0))return i(t,o,n)};break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return o},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let i;switch(t){case 0:i=(t,i)=>e(n,t,i);break;case 1:i=(t,i)=>e(t,n,i);break;case 2:i=(t,i)=>e(t,i,n);break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return i}}getFixedDimension(e,t){const n=t.slice(0,3),i=t.slice(3,6),o=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],s=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(g(a,s))return 0;const r=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];if(g(a,r))return 1;const l=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];return g(a,l)?2:void 0}}u.toolName="PaintFill";const m=u},81502:(e,t,n)=>{n.d(t,{A:()=>p});var i=n(92136),o=n(96214),a=n(21080),s=n(66211),r=n(90252),l=n(84901),d=n(2746),c=n(40233),h=n(23072),g=n(63421),u=n(30322),m=n(16124);class v extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:a.p,ERASE_INSIDE:s.M},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:d,renderingEngine:v}=s;this.isDrawing=!0;const p=d.getCamera(),{viewPlaneNormal:E,viewUp:f}=p,w=this.toolGroupId,I=g.activeSegmentation.getActiveSegmentationRepresentation(w);if(!I)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:C,segmentationId:T,type:_}=I,S=g.segmentIndex.getActiveSegmentIndex(T),D=g.segmentLocking.getLockedSegments(T),A=g.config.color.getColorForSegmentIndex(w,C,S),{representationData:b}=(0,u.getSegmentation)(T),y=b[l.SegmentationRepresentations.Labelmap],R={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...E],viewUp:[...f],FrameOfReferenceUID:d.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:A},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null}}},O=(0,r.getViewportIdsWithToolToRender)(o,this.getToolName());if(this.editData={annotation:R,segmentIndex:S,segmentationId:T,segmentsLocked:D,segmentColor:A,viewportIdsToRender:O,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,segmentationRepresentationUID:C},(0,m.r)(y,d)){const{volumeId:e}=y,t=i.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=y;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(o),(0,c.hideElementCursor)(o),e.preventDefault(),(0,h.A)(v,O),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s}=this.editData,{data:r}=o,{currentPoints:l}=t,d=(0,i.getEnabledElement)(n),{worldToCanvas:c,canvasToWorld:g}=d.viewport,u=l.world,{points:m}=r.handles;let v,p,E,f,w,I,C,T;switch(m[s]=[...u],s){case 0:case 3:v=c(m[0]),f=c(m[3]),p=[f[0],v[1]],E=[v[0],f[1]],I=g(p),C=g(E),m[1]=I,m[2]=C;break;case 1:case 2:p=c(m[1]),E=c(m[2]),v=[E[0],p[1]],f=[p[0],E[1]],w=g(v),T=g(f),m[0]=w,m[3]=T}o.invalidated=!0,this.editData.hasMoved=!0;const{renderingEngine:_}=d;(0,h.A)(_,a)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=o;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,c.resetElementCursor)(n);const l=(0,i.getEnabledElement)(n),d={...this.editData,points:r.handles.points};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(l,d)},this._activateDraw=e=>{e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{annotation:o}=this.editData,a=o.metadata,s=o.annotationUID,r=o.data,{points:l}=r.handles,c=l.map((e=>i.worldToCanvas(e))),h=`rgb(${a.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,d.drawRect)(t,s,"0",c[0],c[3],{color:h}),n=!0,n}}}v.toolName="RectangleScissor";const p=v},34041:(e,t,n)=>{n.d(t,{A:()=>u});var i=n(92136),o=n(96214),a=n(87682),s=n(23072),r=n(71065),l=n(83946),d=n(96834),c=n(10351),h=n(61738);class g extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,mode:g.SelectMode.Border,searchRadius:6}}){super(e,t),this.mouseMoveCallback=e=>(this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout((()=>{this._setActiveSegment(e),this.hoverTimer=null}),this.configuration.hoverTimeout),!0),this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.hoverTimer=null}static{this.SelectMode={Inside:"Inside",Border:"Border"}}_setActiveSegment(e={}){if(h.wk.isInteractingWithTool)return;const{element:t,currentPoints:n}=e.detail,o=n.world,a=(0,i.getEnabledElement)(t);if(!a)return;const{viewport:s}=a,d=(0,r.getActiveSegmentationRepresentation)(this.toolGroupId);if(!d)return;[l.A.Labelmap,l.A.Contour].includes(d.type)?this._setActiveSegmentForType(d,o,s):console.warn("SegmentSelectTool does not support the current segmentation type.")}_setActiveSegmentForType(e,t,n){if(!n.getImageData())return;const{segmentationId:i,type:o}=e;let r;if(this.configuration.mode===g.SelectMode.Inside)r=(0,c.getSegmentAtWorldPoint)(i,t,{viewport:n});else switch(o){case l.A.Labelmap:r=(0,c.getSegmentAtLabelmapBorder)(i,t,{viewport:n,searchRadius:this.configuration.searchRadius});break;case l.A.Contour:r=(0,c.getHoveredContourSegmentationAnnotation)(i)}if(!r||0===r)return;(0,d.setActiveSegmentIndex)(i,r);const h=n.getRenderingEngine(),u=h.getViewports().map((e=>e.id));(0,a.triggerSegmentationModified)(i),(0,s.A)(h,u)}}g.toolName="SegmentSelectTool";const u=g},55108:(e,t,n)=>{n.d(t,{A:()=>v});var i=n(92136),o=n(96214),a=n(61604),s=n(4373),r=n(84901),l=n(2746),d=n(40233),c=n(23072),h=n(63421),g=n(30322),u=n(16124);class m extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:a.Jq,ERASE_INSIDE:s._},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=n.canvas,l=(0,i.getEnabledElement)(o),{viewport:m,renderingEngine:v}=l;this.isDrawing=!0;const p=m.getCamera(),{viewPlaneNormal:E,viewUp:f}=p,w=this.toolGroupId,I=h.activeSegmentation.getActiveSegmentationRepresentation(w);if(!I)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationRepresentationUID:C,segmentationId:T}=I,_=h.segmentIndex.getActiveSegmentIndex(T),S=h.segmentLocking.getLockedSegments(T),D=h.config.color.getColorForSegmentIndex(w,C,_);this.isDrawing=!0;const A={metadata:{viewPlaneNormal:[...E],viewUp:[...f],FrameOfReferenceUID:m.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:D},data:{invalidated:!0,handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},b=[m.id];this.editData={annotation:A,centerCanvas:s,segmentationRepresentationUID:C,segmentIndex:_,segmentationId:T,segmentsLocked:S,segmentColor:D,toolGroupId:w,viewportIdsToRender:b,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1};const{representationData:y}=(0,g.getSegmentation)(T),R=y[r.SegmentationRepresentations.Labelmap];if((0,u.r)(R,m)){const{volumeId:e}=R,t=i.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const{imageIdReferenceMap:e}=R;this.editData={...this.editData,imageIdReferenceMap:e}}return this._activateDraw(o),(0,d.hideElementCursor)(o),e.preventDefault(),(0,c.A)(v,b),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:h,viewportIdsToRender:g,centerCanvas:u}=this.editData,{data:m}=h,v=Math.abs(a[0]-u[0]),p=Math.abs(a[1]-u[1]),E=Math.sqrt(v*v+p*p),f=[u[0],u[1]+E],w=[u[0],u[1]-E],I=[u[0]-E,u[1]],C=[u[0]+E,u[1]];m.handles.points=[d(f),d(w),d(I),d(C)],h.invalidated=!0,this.editData.hasMoved=!0,(0,c.A)(r,g)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,newAnnotation:a,hasMoved:s,segmentIndex:r,segmentationRepresentationUID:l,segmentsLocked:c}=this.editData,{data:h}=o,{viewPlaneNormal:g,viewUp:u}=o.metadata;if(a&&!s)return;o.highlighted=!1,h.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,d.resetElementCursor)(n);const m=(0,i.getEnabledElement)(n),v={...this.editData,points:h.handles.points,segmentIndex:r,segmentationRepresentationUID:l,segmentsLocked:c,viewPlaneNormal:g,viewUp:u};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(m,v)},this._activateDraw=e=>{e.addEventListener(r.Events.MOUSE_UP,this._endCallback),e.addEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(r.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(r.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(r.Events.TOUCH_END,this._endCallback),e.addEventListener(r.Events.TOUCH_TAP,this._endCallback),e.addEventListener(r.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(r.Events.MOUSE_UP,this._endCallback),e.removeEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(r.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(r.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(r.Events.TOUCH_END,this._endCallback),e.removeEventListener(r.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(r.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:i}=e,{viewportIdsToRender:o}=this.editData;if(!o.includes(i.id))return n;const{annotation:a}=this.editData,s=a.metadata,r=a.annotationUID,d=a.data,{points:c}=d.handles,h=c.map((e=>i.worldToCanvas(e))),g=h[0],u=h[1],m=[Math.floor((g[0]+u[0])/2),Math.floor((g[1]+u[1])/2)],v=Math.abs(g[1]-Math.floor((g[1]+u[1])/2)),p=`rgb(${s.segmentColor.slice(0,3)})`;if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,l.drawCircle)(t,r,"0",m,v,{color:p}),n=!0,n}}}m.toolName="SphereScissor";const v=m},16124:(e,t,n)=>{n.d(t,{r:()=>o});var i=n(92136);function o(e,t){const{imageIdReferenceMap:n}=e,{volumeId:o}=e;if(o&&!n)return!0;if(n&&!o)return!1;if(o&&n&&!t)throw new Error("isVolumeSegmentation: viewport is required when both volumeId and imageIdReferenceMap are provided");return t instanceof i.VolumeViewport}},96950:(e,t,n)=>{var i;n.d(t,{W:()=>i}),function(e){e[e.CounterClockwise=-1]="CounterClockwise",e[e.Unknown=0]="Unknown",e[e.Clockwise=1]="Clockwise"}(i||(i={}))},40969:(e,t,n)=>{n.r(t)},7259:(e,t,n)=>{n.r(t),n.d(t,{addContourSegmentationAnnotation:()=>a.V,areSameSegment:()=>i.A,isContourSegmentationAnnotation:()=>o.A,removeContourSegmentationAnnotation:()=>s.M});var i=n(3030),o=n(84354),a=n(32415),s=n(78170)},75534:(e,t,n)=>{n.r(t),n.d(t,{AnnotationToPointData:()=>l.A,acceptAutogeneratedInterpolations:()=>g.A,areCoplanarContours:()=>i.A,calculatePerimeter:()=>v.A,contourFinder:()=>o.Ay,detectContourHoles:()=>s.A,findHandlePolylineIndex:()=>m.A,generateContourSetsFromLabelmap:()=>r.d,getContourHolesDataCanvas:()=>c.A,getContourHolesDataWorld:()=>d.A,getDeduplicatedVTKPolyDataPoints:()=>a.v,interpolation:()=>u,updateContourPolyline:()=>h.A});var i=n(14633),o=n(11716),a=n(19866),s=n(92806),r=n(36392),l=n(93712),d=n(98043),c=n(88267),h=n(89111),g=n(65864),u=n(69115),m=n(84045),v=n(53891)},65903:(e,t,n)=>{n.d(t,{A:()=>a});var i=n(92136);const{isEqual:o}=i.utilities;function a(e){const{metadata:t}=e;return(0,i.getEnabledElements)().filter((e=>{if(e.FrameOfReferenceUID===t.FrameOfReferenceUID){const n=e.viewport,{viewPlaneNormal:i,viewUp:a}=n.getCamera();return o(i,t.viewPlaneNormal)&&(!t.viewUp||o(a,t.viewUp))}})).map((e=>e.viewport))}},74119:(e,t,n)=>{n.r(t),n.d(t,{annotationFrameRange:()=>I.A,boundingBox:()=>x,calibrateImageSpacing:()=>c.A,cine:()=>M,clip:()=>d.Ay,contourSegmentation:()=>B,contours:()=>_,debounce:()=>s.A,drawing:()=>D,dynamicVolume:()=>V,getAnnotationNearPoint:()=>a.S,getAnnotationNearPointOnEnabledElement:()=>a.s,getCalibratedAspect:()=>h.CQ,getCalibratedLengthUnitsAndScale:()=>h.Op,getCalibratedProbeUnitsAndValue:()=>h.Xw,getSphereBoundsInfo:()=>E.R,getViewportForAnnotation:()=>T.A,isObject:()=>l.A,jumpToSlice:()=>v.A,math:()=>A,orientation:()=>i,planar:()=>b,planarFreehandROITool:()=>L,pointInShapeCallback:()=>p.A,pointInSurroundingSphereCallback:()=>C.A,pointToString:()=>w.l,polyDataUtils:()=>W,rectangleROITool:()=>U,roundNumber:()=>F,scroll:()=>f.A,segmentation:()=>S,stackContextPrefetch:()=>N.N,stackPrefetch:()=>N.S,throttle:()=>r.A,touch:()=>k,triggerAnnotationRender:()=>m.Ay,triggerAnnotationRenderForToolGroupIds:()=>u.A,triggerAnnotationRenderForViewportIds:()=>g.A,triggerEvent:()=>o.triggerEvent,viewport:()=>P,viewportFilters:()=>y,voi:()=>H});var i={};n.r(i),n.d(i,{getOrientationStringLPS:()=>R.A,invertOrientationStringLPS:()=>O.A});var o=n(92136),a=n(66429),s=n(64857),r=n(21090),l=n(11857),d=n(88484),c=n(17167),h=n(24592),g=n(23072),u=n(27819),m=n(6805),v=n(11666),p=n(75403),E=n(96760),f=n(21783),w=n(60438),I=n(41209),C=n(5093),T=n(39490),_=n(75534),S=n(10351),D=n(10910),A=n(73047),b=n(84797),y=n(90252),R=n(80393),O=n(39365),M=n(60001),x=n(15306),L=n(44074),U=n(15874),N=n(90387),P=n(31555),k=n(54868),V=n(16390),W=n(46514),H=n(10413),B=n(7259);const F=o.utilities.roundNumber},73047:(e,t,n)=>{n.r(t),n.d(t,{BasicStatsCalculator:()=>o,aabb:()=>i,ellipse:()=>a,lineSegment:()=>s,point:()=>r,polyline:()=>l,rectangle:()=>d,vec2:()=>c});var i=n(27924),o=n(83112),a=n(2264),s=n(21954),r=n(14846),l=n(56634),d=n(23345),c=n(73100)},87658:(e,t,n)=>{function i(e,t){let n=[0,0],i=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){const o=function(e,t){const[n,i]=e,[o,a]=t;return Math.sqrt(Math.pow(n-o,2)+Math.pow(i-a,2))}(t,e);o<i&&(i=o,n=[...e])})),n}n.d(t,{A:()=>i})},94510:(e,t,n)=>{n.d(t,{HM:()=>l,OX:()=>d});var i=n(92136),o=n(30322),a=n(16124),s=n(84901);const r=new Map,l=e=>{const t=r.get(e);t&&(t.isDirty=!0)};function d(e){const t=function(e){const t=r.get(e);return t&&!t.isDirty?t.indices:null}(e);if(t)return t;const n=(0,o.getSegmentation)(e);if(!n)throw new Error(`No segmentation found for segmentationId ${e}`);let l;switch(n.type){case s.SegmentationRepresentations.Labelmap:l=function(e,t){const n=e.representationData[s.SegmentationRepresentations.Labelmap],o=new Set;(0,a.r)(n)?function(e,t){const n=i.cache.getVolume(t);n.getScalarData().forEach((t=>{0!==t&&e.add(t)}))}(o,t):function(e,t){t.forEach((t=>{i.cache.getImage(t).getPixelData().forEach((t=>{0!==t&&e.add(t)}))}))}(o,n.imageIdReferenceMap);return Array.from(o).map(Number).sort(((e,t)=>e-t))}(n,e);break;case s.SegmentationRepresentations.Contour:l=function(e){const{annotationUIDsMap:t,geometryIds:n}=e.representationData.CONTOUR||{};if(!n)throw new Error(`No geometryIds found for segmentationId ${e.segmentationId}`);const o=new Set([...t.keys()]);return n.forEach((e=>{const t=i.cache.getGeometry(e);o.add(t.data.getSegmentIndex())})),Array.from(o).sort(((e,t)=>e-t))}(n);break;case s.SegmentationRepresentations.Surface:l=function(e){const t=e.representationData.SURFACE?.geometryIds??[];return Array.from(t.keys()).map(Number).sort(((e,t)=>e-t))}(n);break;default:throw new Error(`Unsupported segmentation type: ${n.type}`)}return r.set(e,{indices:l,isDirty:!1}),l}},10351:(e,t,n)=>{n.r(t),n.d(t,{contourAndFindLargestBidirectional:()=>v.A,createBidirectionalToolData:()=>p.A,createImageIdReferenceMap:()=>m.c,createLabelmapVolumeForViewport:()=>l.A,createMergedLabelmapForIndex:()=>a.A,floodFill:()=>c.A,getBrushSizeForToolGroup:()=>h.A,getBrushThresholdForToolGroup:()=>g.Q,getBrushToolInstances:()=>_.n7,getDefaultRepresentationConfig:()=>r.A,getHoveredContourSegmentationAnnotation:()=>T.L,getSegmentAtLabelmapBorder:()=>C.F,getSegmentAtWorldPoint:()=>I.Z5,getUniqueSegmentIndices:()=>w.OX,invalidateBrushCursor:()=>f.E,isValidRepresentationConfig:()=>s.A,rectangleROIThresholdVolumeByRange:()=>o.A,segmentContourAction:()=>E.A,setBrushSizeForToolGroup:()=>h.M,setBrushThresholdForToolGroup:()=>g.K,thresholdSegmentationByRange:()=>u.A,thresholdVolumeByRange:()=>i.A,triggerSegmentationRender:()=>d.h6});var i=n(32854),o=n(71411),a=n(86398),s=n(19434),r=n(50969),l=n(5092),d=n(49521),c=n(27650),h=n(87590),g=n(7300),u=n(92922),m=n(82914),v=n(41196),p=n(96610),E=n(10032),f=n(15818),w=n(94510),I=n(2465),C=n(54117),T=n(4863),_=n(77071)},49521:(e,t,n)=>{n.d(t,{Ay:()=>d,h6:()=>l,px:()=>r});var i=n(92136),o=n(84901),a=n(52610),s=n(81848);const r=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedToolGroups=()=>{this._throwIfDestroyed();const e=Array.from(this._needsRender.values());for(const t of e)if(this._triggerRender(t),this._needsRender.delete(t),0===this._needsRender.size)return this._animationFrameSet=!1,void(this._animationFrameHandle=null)}}removeToolGroup(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}renderToolGroupSegmentations(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setToolGroupSegmentationToBeRenderedNextFrame(e){e.forEach((e=>{this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,a.getToolGroup)(e);if(!t)return void console.warn(`No tool group found with toolGroupId: ${e}`);const{viewportsInfo:n}=t,r=n.map((({viewportId:e,renderingEngineId:t})=>{const n=(0,i.getRenderingEngine)(t);if(!n)return void console.warn("rendering Engine has been destroyed");const o=n.getViewport(e);return o||void 0})).filter(Boolean),l=t.getToolInstance(s.t0.toolName);function d(e){const{element:t,viewportId:n,renderingEngineId:s}=e.detail;t.removeEventListener(i.Enums.Events.IMAGE_RENDERED,d);const r=(0,a.getToolGroupForViewport)(n,s);if(!r)return void console.warn("toolGroup has been destroyed");const l={toolGroupId:r.id,viewportId:n};(0,i.triggerEvent)(i.eventTarget,o.Events.SEGMENTATION_RENDERED,{...l})}l?(r.forEach((({element:e})=>{e.addEventListener(i.Enums.Events.IMAGE_RENDERED,d)})),l.renderSegmentation(e)):console.warn("No segmentation tool found inside",e)}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}};function l(e){r.renderToolGroupSegmentations(e)}const d=l},6805:(e,t,n)=>{n.d(t,{Ay:()=>h,ou:()=>c});var i=n(92136),o=n(84901),a=n(2746),s=n(42360);const{Active:r,Passive:l,Enabled:d}=o.ToolModes;const c=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){const n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))break}this._animationFrameSet=!1,this._animationFrameHandle=null,this._render()},this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach((e=>{this._needsRender.add(e)})),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){const t=[...this._viewportElements.values()];e.forEach((e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)})),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,i.getEnabledElement)(e);if(!t)return;if(!(0,i.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");const n=(0,s.A)(e,[r,l,d]),{renderingEngineId:c,viewportId:h}=t,g={element:e,renderingEngineId:c,viewportId:h};(0,a.draw)(e,(a=>{let s=!1;n.forEach((e=>{if(e.renderAnnotation){const n=e.renderAnnotation(t,a);s=s||n}})),s&&(0,i.triggerEvent)(e,o.Events.ANNOTATION_RENDERED,{...g})}))}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}};const h=function(e){c.renderViewport(e)}},23072:(e,t,n)=>{n.d(t,{A:()=>o});var i=n(6805);const o=function(e,t){t.length&&e&&t.forEach((t=>{const n=e.getViewport(t);if(!n)return void console.warn(`Viewport not available for ${t}`);const{element:o}=n;(0,i.Ay)(o)}))}},64690:(e,t,n)=>{n.r(t),n.d(t,{Colorbar:()=>o.P,Enums:()=>i,ViewportColorbar:()=>a.b});var i=n(73231),o=n(50112),a=n(81034)}}]);
//# sourceMappingURL=236.bundle.18d97dc207557e7bef47.js.map