/*! For license information please see ohif-extension-tmtv.umd.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@cornerstonejs/adapters"),require("@cornerstonejs/core"),require("@cornerstonejs/tools"),require("@ohif/core"),require("@ohif/ui"),require("dcmjs"),require("gl-matrix")):"function"==typeof define&&define.amd?define(["@cornerstonejs/adapters","@cornerstonejs/core","@cornerstonejs/tools","@ohif/core","@ohif/ui","dcmjs","gl-matrix"],t):"object"==typeof exports?exports["ohif-extension-tmtv"]=t(require("@cornerstonejs/adapters"),require("@cornerstonejs/core"),require("@cornerstonejs/tools"),require("@ohif/core"),require("@ohif/ui"),require("dcmjs"),require("gl-matrix")):e["ohif-extension-tmtv"]=t(e["@cornerstonejs/adapters"],e["@cornerstonejs/core"],e["@cornerstonejs/tools"],e["@ohif/core"],e["@ohif/ui"],e.dcmjs,e["gl-matrix"])}(globalThis,((e,t,n,a,o,r,i)=>(()=>{var s={854:e=>{"use strict";var t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable;e.exports=function(){try{if(!Object.assign)return!1;var e=new String("abc");if(e[5]="de","5"===Object.getOwnPropertyNames(e)[0])return!1;for(var t={},n=0;n<10;n++)t["_"+String.fromCharCode(n)]=n;if("0123456789"!==Object.getOwnPropertyNames(t).map((function(e){return t[e]})).join(""))return!1;var a={};return"abcdefghijklmnopqrst".split("").forEach((function(e){a[e]=e})),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},a)).join("")}catch(e){return!1}}()?Object.assign:function(e,o){for(var r,i,s=function(e){if(null==e)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(e)}(e),c=1;c<arguments.length;c++){for(var l in r=Object(arguments[c]))n.call(r,l)&&(s[l]=r[l]);if(t){i=t(r);for(var u=0;u<i.length;u++)a.call(r,i[u])&&(s[i[u]]=r[i[u]])}}return s}},216:(e,t,n)=>{"use strict";var a=n(151);function o(){}function r(){}r.resetWarningCache=o,e.exports=function(){function e(e,t,n,o,r,i){if(i!==a){var s=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw s.name="Invariant Violation",s}}function t(){return e}e.isRequired=e;var n={array:e,bigint:e,bool:e,func:e,number:e,object:e,string:e,symbol:e,any:e,arrayOf:t,element:e,elementType:e,instanceOf:t,node:e,objectOf:t,oneOf:t,oneOfType:t,shape:t,exact:t,checkPropTypes:r,resetWarningCache:o};return n.PropTypes=n,n}},374:(e,t,n)=>{e.exports=n(216)()},151:e=>{"use strict";e.exports="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED"},377:(e,t,n)=>{"use strict";var a=n(854),o=60103,r=60106;t.Fragment=60107,t.StrictMode=60108,t.Profiler=60114;var i=60109,s=60110,c=60112;t.Suspense=60113;var l=60115,u=60116;if("function"==typeof Symbol&&Symbol.for){var p=Symbol.for;o=p("react.element"),r=p("react.portal"),t.Fragment=p("react.fragment"),t.StrictMode=p("react.strict_mode"),t.Profiler=p("react.profiler"),i=p("react.provider"),s=p("react.context"),c=p("react.forward_ref"),t.Suspense=p("react.suspense"),l=p("react.memo"),u=p("react.lazy")}var m="function"==typeof Symbol&&Symbol.iterator;function d(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var g={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},f={};function y(e,t,n){this.props=e,this.context=t,this.refs=f,this.updater=n||g}function h(){}function v(e,t,n){this.props=e,this.context=t,this.refs=f,this.updater=n||g}y.prototype.isReactComponent={},y.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error(d(85));this.updater.enqueueSetState(this,e,t,"setState")},y.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},h.prototype=y.prototype;var S=v.prototype=new h;S.constructor=v,a(S,y.prototype),S.isPureReactComponent=!0;var b={current:null},T=Object.prototype.hasOwnProperty,w={key:!0,ref:!0,__self:!0,__source:!0};function I(e,t,n){var a,r={},i=null,s=null;if(null!=t)for(a in void 0!==t.ref&&(s=t.ref),void 0!==t.key&&(i=""+t.key),t)T.call(t,a)&&!w.hasOwnProperty(a)&&(r[a]=t[a]);var c=arguments.length-2;if(1===c)r.children=n;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];r.children=l}if(e&&e.defaultProps)for(a in c=e.defaultProps)void 0===r[a]&&(r[a]=c[a]);return{$$typeof:o,type:e,key:i,ref:s,props:r,_owner:b.current}}function x(e){return"object"==typeof e&&null!==e&&e.$$typeof===o}var E=/\/+/g;function R(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function O(e,t,n,a,i){var s=typeof e;"undefined"!==s&&"boolean"!==s||(e=null);var c=!1;if(null===e)c=!0;else switch(s){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case o:case r:c=!0}}if(c)return i=i(c=e),e=""===a?"."+R(c,0):a,Array.isArray(i)?(n="",null!=e&&(n=e.replace(E,"$&/")+"/"),O(i,t,n,"",(function(e){return e}))):null!=i&&(x(i)&&(i=function(e,t){return{$$typeof:o,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(i,n+(!i.key||c&&c.key===i.key?"":(""+i.key).replace(E,"$&/")+"/")+e)),t.push(i)),1;if(c=0,a=""===a?".":a+":",Array.isArray(e))for(var l=0;l<e.length;l++){var u=a+R(s=e[l],l);c+=O(s,t,n,u,i)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=m&&e[m]||e["@@iterator"])?e:null}(e),"function"==typeof u)for(e=u.call(e),l=0;!(s=e.next()).done;)c+=O(s=s.value,t,n,u=a+R(s,l++),i);else if("object"===s)throw t=""+e,Error(d(31,"[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t));return c}function D(e,t,n){if(null==e)return e;var a=[],o=0;return O(e,a,"","",(function(e){return t.call(n,e,o++)})),a}function N(e){if(-1===e._status){var t=e._result;t=t(),e._status=0,e._result=t,t.then((function(t){0===e._status&&(t=t.default,e._status=1,e._result=t)}),(function(t){0===e._status&&(e._status=2,e._result=t)}))}if(1===e._status)return e._result;throw e._result}var C={current:null};function M(){var e=C.current;if(null===e)throw Error(d(321));return e}var P={ReactCurrentDispatcher:C,ReactCurrentBatchConfig:{transition:0},ReactCurrentOwner:b,IsSomeRendererActing:{current:!1},assign:a};t.Children={map:D,forEach:function(e,t,n){D(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return D(e,(function(){t++})),t},toArray:function(e){return D(e,(function(e){return e}))||[]},only:function(e){if(!x(e))throw Error(d(143));return e}},t.Component=y,t.PureComponent=v,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=P,t.cloneElement=function(e,t,n){if(null==e)throw Error(d(267,e));var r=a({},e.props),i=e.key,s=e.ref,c=e._owner;if(null!=t){if(void 0!==t.ref&&(s=t.ref,c=b.current),void 0!==t.key&&(i=""+t.key),e.type&&e.type.defaultProps)var l=e.type.defaultProps;for(u in t)T.call(t,u)&&!w.hasOwnProperty(u)&&(r[u]=void 0===t[u]&&void 0!==l?l[u]:t[u])}var u=arguments.length-2;if(1===u)r.children=n;else if(1<u){l=Array(u);for(var p=0;p<u;p++)l[p]=arguments[p+2];r.children=l}return{$$typeof:o,type:e.type,key:i,ref:s,props:r,_owner:c}},t.createContext=function(e,t){return void 0===t&&(t=null),(e={$$typeof:s,_calculateChangedBits:t,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null}).Provider={$$typeof:i,_context:e},e.Consumer=e},t.createElement=I,t.createFactory=function(e){var t=I.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:c,render:e}},t.isValidElement=x,t.lazy=function(e){return{$$typeof:u,_payload:{_status:-1,_result:e},_init:N}},t.memo=function(e,t){return{$$typeof:l,type:e,compare:void 0===t?null:t}},t.useCallback=function(e,t){return M().useCallback(e,t)},t.useContext=function(e,t){return M().useContext(e,t)},t.useDebugValue=function(){},t.useEffect=function(e,t){return M().useEffect(e,t)},t.useImperativeHandle=function(e,t,n){return M().useImperativeHandle(e,t,n)},t.useLayoutEffect=function(e,t){return M().useLayoutEffect(e,t)},t.useMemo=function(e,t){return M().useMemo(e,t)},t.useReducer=function(e,t,n){return M().useReducer(e,t,n)},t.useRef=function(e){return M().useRef(e)},t.useState=function(e){return M().useState(e)},t.version="17.0.2"},766:(e,t,n)=>{"use strict";e.exports=n(377)},501:e=>{e.exports={area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}},142:t=>{"use strict";t.exports=e},557:e=>{"use strict";e.exports=t},713:e=>{"use strict";e.exports=n},2:e=>{"use strict";e.exports=a},307:e=>{"use strict";e.exports=o},111:e=>{"use strict";e.exports=r},155:e=>{"use strict";e.exports=i}},c={};function l(e){var t=c[e];if(void 0!==t)return t.exports;var n=c[e]={exports:{}};return s[e](n,n.exports,l),n.exports}l.m=s,l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},l.u=e=>"dist/"+e+".ohif-extension-tmtv.umd.js",l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.p="/",l.b=document.baseURI||self.location.href;var u={};return(()=>{"use strict";l.r(u),l.d(u,{default:()=>ye});const e=JSON.parse('{"UU":"@ohif/extension-tmtv"}').UU,t={viewportOptions:{viewportId:"ctAXIAL",viewportType:"volume",orientation:"axial",toolGroupId:"ctToolGroup",initialImageOptions:{preset:"first"},syncGroups:[{type:"cameraPosition",id:"axialSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}}]},displaySets:[{id:"ctDisplaySet"}]},n={viewportOptions:{viewportId:"ctSAGITTAL",viewportType:"volume",orientation:"sagittal",toolGroupId:"ctToolGroup",syncGroups:[{type:"cameraPosition",id:"sagittalSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}}]},displaySets:[{id:"ctDisplaySet"}]},a={viewportOptions:{viewportId:"ctCORONAL",viewportType:"volume",orientation:"coronal",toolGroupId:"ctToolGroup",syncGroups:[{type:"cameraPosition",id:"coronalSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!0,target:!0,options:{syncColormap:!0}}]},displaySets:[{id:"ctDisplaySet"}]},o={viewportOptions:{viewportId:"ptAXIAL",viewportType:"volume",background:[1,1,1],orientation:"axial",toolGroupId:"ptToolGroup",initialImageOptions:{preset:"first"},syncGroups:[{type:"cameraPosition",id:"axialSync",source:!0,target:!0},{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncInvertState:!1}}]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},r={viewportOptions:{viewportId:"ptSAGITTAL",viewportType:"volume",orientation:"sagittal",background:[1,1,1],toolGroupId:"ptToolGroup",syncGroups:[{type:"cameraPosition",id:"sagittalSync",source:!0,target:!0},{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncInvertState:!1}}]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},i={viewportOptions:{viewportId:"ptCORONAL",viewportType:"volume",orientation:"coronal",background:[1,1,1],toolGroupId:"ptToolGroup",syncGroups:[{type:"cameraPosition",id:"coronalSync",source:!0,target:!0},{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncInvertState:!1}}]},displaySets:[{options:{voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},s={viewportOptions:{viewportId:"fusionAXIAL",viewportType:"volume",orientation:"axial",toolGroupId:"fusionToolGroup",initialImageOptions:{preset:"first"},syncGroups:[{type:"cameraPosition",id:"axialSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncInvertState:!1}}]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.9},{value:1,opacity:.95}]},voi:{custom:"getPTVOIRange"}}}]},c={viewportOptions:{viewportId:"fusionSAGITTAL",viewportType:"volume",orientation:"sagittal",toolGroupId:"fusionToolGroup",syncGroups:[{type:"cameraPosition",id:"sagittalSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncInvertState:!1}}]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.9},{value:1,opacity:.95}]},voi:{custom:"getPTVOIRange"}}}]},p={viewportOptions:{viewportId:"fusionCoronal",viewportType:"volume",orientation:"coronal",toolGroupId:"fusionToolGroup",syncGroups:[{type:"cameraPosition",id:"coronalSync",source:!0,target:!0},{type:"voi",id:"ctWLSync",source:!1,target:!0},{type:"voi",id:"fusionWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!1,target:!0,options:{syncInvertState:!1}}]},displaySets:[{id:"ctDisplaySet"},{id:"ptDisplaySet",options:{colormap:{name:"hsv",opacity:[{value:0,opacity:0},{value:.1,opacity:.9},{value:1,opacity:.95}]},voi:{custom:"getPTVOIRange"}}}]},m={viewportOptions:{viewportId:"mipSagittal",viewportType:"volume",orientation:"sagittal",background:[1,1,1],toolGroupId:"mipToolGroup",syncGroups:[{type:"voi",id:"ptWLSync",source:!0,target:!0,options:{syncColormap:!0}},{type:"voi",id:"ptFusionWLSync",source:!0,target:!1,options:{syncInvertState:!1}}],customViewportProps:{hideOverlays:!0}},displaySets:[{options:{blendMode:"MIP",slabThickness:"fullVolume",voi:{custom:"getPTVOIRange"},voiInverted:!0},id:"ptDisplaySet"}]},d={id:"@ohif/extension-tmtv.hangingProtocolModule.ptCT",locked:!0,name:"Default",createdDate:"2021-02-23T19:22:08.894Z",modifiedDate:"2022-10-04T19:22:08.894Z",availableTo:{},editableBy:{},imageLoadStrategy:"interleaveTopToBottom",protocolMatchingRules:[{attribute:"ModalitiesInStudy",constraint:{contains:["CT","PT"]}},{attribute:"StudyDescription",constraint:{contains:"PETCT"}},{attribute:"StudyDescription",constraint:{contains:"PET/CT"}}],displaySetSelectors:{ctDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:{value:"CT"}},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"SeriesDescription",constraint:{contains:"CT"}},{attribute:"SeriesDescription",constraint:{contains:"CT WB"}}]},ptDisplaySet:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"PT"},required:!0},{attribute:"isReconstructable",constraint:{equals:{value:!0}},required:!0},{attribute:"SeriesDescription",constraint:{contains:"Corrected"}},{weight:2,attribute:"SeriesDescription",constraint:{doesNotContain:{value:"Uncorrected"}}}]}},stages:[{name:"default",viewportStructure:{layoutType:"grid",properties:{rows:3,columns:4,layoutOptions:[{x:0,y:0,width:1/4,height:1/3},{x:1/4,y:0,width:1/4,height:1/3},{x:.5,y:0,width:1/4,height:1/3},{x:0,y:1/3,width:1/4,height:1/3},{x:1/4,y:1/3,width:1/4,height:1/3},{x:.5,y:1/3,width:1/4,height:1/3},{x:0,y:2/3,width:1/4,height:1/3},{x:1/4,y:2/3,width:1/4,height:1/3},{x:.5,y:2/3,width:1/4,height:1/3},{x:3/4,y:0,width:1/4,height:1}]}},viewports:[t,n,a,o,r,i,s,c,p,m],createdDate:"2021-02-23T18:32:42.850Z"},{name:"Fusion 2x2",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:2}},viewports:[t,s,o,m]},{name:"2x3-layout",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:3}},viewports:[t,n,a,o,r,i]},{name:"2x4-layout",viewportStructure:{layoutType:"grid",properties:{rows:2,columns:4,layoutOptions:[{x:0,y:0,width:1/4,height:.5},{x:1/4,y:0,width:1/4,height:.5},{x:.5,y:0,width:1/4,height:.5},{x:3/4,y:0,width:1/4,height:1},{x:0,y:.5,width:1/4,height:.5},{x:1/4,y:.5,width:1/4,height:.5},{x:.5,y:.5,width:1/4,height:.5}]}},viewports:[i,r,o,m,p,c,s]}],numberOfPriorsReferenced:-1};var g=l(766),f=l(374),y=l.n(f),h=l(307),v=l(2),S=l.n(v);function b(e){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},b(e)}function T(e){var t=function(e,t){if("object"!=b(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var a=n.call(e,"string");if("object"!=b(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==b(t)?t:t+""}function w(e,t,n){return(t=T(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function I(){if(console&&console.warn){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];"string"==typeof n[0]&&(n[0]="react-i18next:: ".concat(n[0])),(e=console).warn.apply(e,n)}}l(501),Object.create(null);var x={};function E(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];"string"==typeof t[0]&&x[t[0]]||("string"==typeof t[0]&&(x[t[0]]=new Date),I.apply(void 0,t))}var R=function(e,t){return function(){e.isInitialized?t():e.on("initialized",(function n(){setTimeout((function(){e.off("initialized",n)}),0),t()}))}};function O(e,t,n){e.loadNamespaces(t,R(e,n))}function D(e,t,n,a){"string"==typeof n&&(n=[n]),n.forEach((function(t){e.options.ns.indexOf(t)<0&&e.options.ns.push(t)})),e.loadLanguages(t,R(e,a))}var N,C=/&(?:amp|#38|lt|#60|gt|#62|apos|#39|quot|#34|nbsp|#160|copy|#169|reg|#174|hellip|#8230|#x2F|#47);/g,M={"&amp;":"&","&#38;":"&","&lt;":"<","&#60;":"<","&gt;":">","&#62;":">","&apos;":"'","&#39;":"'","&quot;":'"',"&#34;":'"',"&nbsp;":" ","&#160;":" ","&copy;":"©","&#169;":"©","&reg;":"®","&#174;":"®","&hellip;":"…","&#8230;":"…","&#x2F;":"/","&#47;":"/"},P=function(e){return M[e]},L={bindI18n:"languageChanged",bindI18nStore:"",transEmptyNodeValue:"",transSupportBasicHtmlNodes:!0,transWrapTextNodes:"",transKeepBasicHtmlNodesFor:["br","strong","i","p"],useSuspense:!0,unescape:function(e){return e.replace(C,P)}};function j(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,T(a.key),a)}}var k=(0,g.createContext)(),V=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.usedNamespaces={}}var t,n;return t=e,(n=[{key:"addUsedNamespaces",value:function(e){var t=this;e.forEach((function(e){t.usedNamespaces[e]||(t.usedNamespaces[e]=!0)}))}},{key:"getUsedNamespaces",value:function(){return Object.keys(this.usedNamespaces)}}])&&j(t.prototype,n),Object.defineProperty(t,"prototype",{writable:!1}),e}();function U(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function A(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function F(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?A(Object(n),!0).forEach((function(t){w(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):A(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var _=function(e,t){var n=(0,g.useRef)();return(0,g.useEffect)((function(){n.current=t?n.current:e}),[e,t]),n.current};function q(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.i18n,a=(0,g.useContext)(k)||{},o=a.i18n,r=a.defaultNS,i=n||o||N;if(i&&!i.reportNamespaces&&(i.reportNamespaces=new V),!i){E("You will need to pass in an i18next instance by using initReactI18next");var s=function(e,t){return"string"==typeof t?t:t&&"object"===b(t)&&"string"==typeof t.defaultValue?t.defaultValue:Array.isArray(e)?e[e.length-1]:e},c=[s,{},!1];return c.t=s,c.i18n={},c.ready=!1,c}i.options.react&&void 0!==i.options.react.wait&&E("It seems you are still using the old wait option, you may migrate to the new useSuspense behaviour.");var l=F(F(F({},L),i.options.react),t),u=l.useSuspense,p=l.keyPrefix,m=e||r||i.options&&i.options.defaultNS;m="string"==typeof m?[m]:m||["translation"],i.reportNamespaces.addUsedNamespaces&&i.reportNamespaces.addUsedNamespaces(m);var d=(i.isInitialized||i.initializedStoreOnce)&&m.every((function(e){return function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return t.languages&&t.languages.length?void 0!==t.options.ignoreJSONStructure?t.hasLoadedNamespace(e,{lng:n.lng,precheck:function(t,a){if(n.bindI18n&&n.bindI18n.indexOf("languageChanging")>-1&&t.services.backendConnector.backend&&t.isLanguageChangingTo&&!a(t.isLanguageChangingTo,e))return!1}}):function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=t.languages[0],o=!!t.options&&t.options.fallbackLng,r=t.languages[t.languages.length-1];if("cimode"===a.toLowerCase())return!0;var i=function(e,n){var a=t.services.backendConnector.state["".concat(e,"|").concat(n)];return-1===a||2===a};return!(n.bindI18n&&n.bindI18n.indexOf("languageChanging")>-1&&t.services.backendConnector.backend&&t.isLanguageChangingTo&&!i(t.isLanguageChangingTo,e)||!t.hasResourceBundle(a,e)&&t.services.backendConnector.backend&&(!t.options.resources||t.options.partialBundledLanguages)&&(!i(a,e)||o&&!i(r,e)))}(e,t,n):(E("i18n.languages were undefined or empty",t.languages),!0)}(e,i,l)}));function f(){return i.getFixedT(t.lng||null,"fallback"===l.nsMode?m:m[0],p)}var y=function(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var a,o,r,i,s=[],c=!0,l=!1;try{if(r=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(a=r.call(n)).done)&&(s.push(a.value),s.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(l)throw o}}return s}}(e,t)||function(e,t){if(e){if("string"==typeof e)return U(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?U(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}((0,g.useState)(f),2),h=y[0],v=y[1],S=m.join();t.lng&&(S="".concat(t.lng).concat(S));var T=_(S),w=(0,g.useRef)(!0);(0,g.useEffect)((function(){var e=l.bindI18n,n=l.bindI18nStore;function a(){w.current&&v(f)}return w.current=!0,d||u||(t.lng?D(i,t.lng,m,(function(){w.current&&v(f)})):O(i,m,(function(){w.current&&v(f)}))),d&&T&&T!==S&&w.current&&v(f),e&&i&&i.on(e,a),n&&i&&i.store.on(n,a),function(){w.current=!1,e&&i&&e.split(" ").forEach((function(e){return i.off(e,a)})),n&&i&&n.split(" ").forEach((function(e){return i.store.off(e,a)}))}}),[i,S]);var I=(0,g.useRef)(!0);(0,g.useEffect)((function(){w.current&&!I.current&&v(f),I.current=!1}),[i,p]);var x=[h,i,d];if(x.t=h,x.i18n=i,x.ready=d,d)return x;if(!d&&!u)return x;throw new Promise((function(e){t.lng?D(i,t.lng,m,(function(){return e()})):O(i,m,(function(){return e()}))}))}const G={PatientWeight:null,PatientSex:null,SeriesTime:null,RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:null,RadionuclideHalfLife:null,RadiopharmaceuticalStartTime:null}};function W({servicesManager:e,commandsManager:t}){const{t:n}=q("PanelSUV"),{displaySetService:a,toolGroupService:o,toolbarService:r,hangingProtocolService:i}=e.services,[s,c]=(0,g.useState)(G),[l,u]=(0,g.useState)(null),p=e=>{c((t=>{const n={...t};return Object.keys(e).forEach((a=>{"object"==typeof e[a]?n[a]={...t[a],...e[a]}:n[a]=e[a]})),n}))},m=e=>{const n=t.runCommand("getMatchingPTDisplaySet",{viewportMatchDetails:e});if(n)return{ptDisplaySet:n,metadata:t.runCommand("getPTMetadata",{ptDisplaySet:n})}};return(0,g.useEffect)((()=>{const e=a.getActiveDisplaySets(),{viewportMatchDetails:t}=i.getMatchDetails();if(!e.length)return;const n=m(t);if(!n)return;const{ptDisplaySet:o,metadata:r}=n;u(o),c(r)}),[]),(0,g.useEffect)((()=>{const{unsubscribe:e}=i.subscribe(i.EVENTS.PROTOCOL_CHANGED,(({viewportMatchDetails:e})=>{const t=m(e);if(!t)return;const{ptDisplaySet:n,metadata:a}=t;u(n),c(a)}));return()=>{e()}}),[]),g.createElement("div",{className:"ohif-scrollbar flex min-h-0 flex-auto select-none flex-col justify-between overflow-auto"},g.createElement("div",{className:"flex min-h-0 flex-1 flex-col bg-black text-[13px] font-[300]"},g.createElement(h.PanelSection,{title:n("Patient Information")},g.createElement("div",{className:"flex flex-col"},g.createElement("div",{className:"bg-primary-dark flex flex-col gap-4 p-2"},g.createElement(h.Input,{containerClassName:"!flex-row !justify-between items-center",label:n("Patient Sex"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.PatientSex||"",onChange:e=>{p({PatientSex:e.target.value})}}),g.createElement(h.Input,{containerClassName:"!flex-row !justify-between items-center",label:n("Weight"),labelChildren:g.createElement("span",{className:"text-aqua-pale"}," kg"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.PatientWeight||"",onChange:e=>{p({PatientWeight:e.target.value})}}),g.createElement(h.Input,{containerClassName:"!flex-row !justify-between items-center",label:n("Total Dose"),labelChildren:g.createElement("span",{className:"text-aqua-pale"}," bq"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.RadiopharmaceuticalInformationSequence.RadionuclideTotalDose||"",onChange:e=>{p({RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:e.target.value}})}}),g.createElement(h.Input,{containerClassName:"!flex-row !justify-between items-center",label:n("Half Life"),labelChildren:g.createElement("span",{className:"text-aqua-pale"}," s"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.RadiopharmaceuticalInformationSequence.RadionuclideHalfLife||"",onChange:e=>{p({RadiopharmaceuticalInformationSequence:{RadionuclideHalfLife:e.target.value}})}}),g.createElement(h.Input,{containerClassName:"!flex-row !justify-between items-center",label:n("Injection Time"),labelChildren:g.createElement("span",{className:"text-aqua-pale"}," s"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.RadiopharmaceuticalInformationSequence.RadiopharmaceuticalStartTime||"",onChange:e=>{p({RadiopharmaceuticalInformationSequence:{RadiopharmaceuticalStartTime:e.target.value}})}}),g.createElement(h.Input,{containerClassName:"!flex-row !justify-between items-center",label:n("Acquisition Time"),labelChildren:g.createElement("span",{className:"text-aqua-pale"}," s"),labelClassName:"text-[13px] font-inter text-white",className:"!m-0 !h-[26px] !w-[117px]",value:s.SeriesTime||"",onChange:()=>{}}),g.createElement(h.Button,{className:"!h-[26px] !w-[115px] self-end !p-0",onClick:function(){if(!l)throw new Error("No ptDisplaySet found");v.DicomMetadataStore.updateMetadataForSeries(l.StudyInstanceUID,l.SeriesInstanceUID,s),a.setDisplaySetMetadataInvalidated(l.displaySetInstanceUID),setTimeout((()=>{t.runCommand("resetCrosshairs")}),0)}},"Reload Data"))))))}W.propTypes={servicesManager:y().shape({services:y().shape({measurementService:y().shape({getMeasurements:y().func.isRequired,subscribe:y().func.isRequired,EVENTS:y().object.isRequired,VALUE_TYPES:y().object.isRequired}).isRequired}).isRequired}).isRequired};var $=l(557),B=l(713);function H({servicesManager:e,commandsManager:t}){const{segmentationService:n,uiNotificationService:a}=e.services,{t:o}=q("PanelSUVExport"),[r,i]=(0,g.useState)((()=>n.getSegmentations())),[s,c]=(0,g.useState)(null);if((0,g.useEffect)((()=>{const e=n.EVENTS.SEGMENTATION_ADDED,t=n.EVENTS.SEGMENTATION_UPDATED,a=n.EVENTS.SEGMENTATION_REMOVED,o=[];return[e,t,a].forEach((e=>{const{unsubscribe:t}=n.subscribe(e,(()=>{const e=n.getSegmentations();i(e);const t=e.filter((e=>e.isActive));c(t[0])}));o.push(t)})),()=>{o.forEach((e=>{e()}))}}),[]),(0,g.useEffect)((()=>{const e=async e=>{const{detail:o}=e,{segmentationId:r}=o;if(!r)return;await(async({segmentationId:e,commandsManager:t,segmentationService:n,config:a={}})=>{const o=n.getSegmentation(e),r={};o.segments=await Promise.all(o.segments.map((async n=>{if(!n||!n.segmentIndex)return n;const a=$.cache.getVolume(e),o=n.segmentIndex,i=t.run("getLesionStats",{labelmap:a,segmentIndex:o}),s=await t.run("calculateSuvPeak",{labelmap:a,segmentIndex:o}),c={lesionStats:i,suvPeak:s,lesionGlyoclysisStats:i.volume*i.meanValue};return n.cachedStats=c,n.displayText=[`SUV Peak: ${s.suvPeak.toFixed(2)}`,`Volume: ${i.volume.toFixed(2)} mm3`],r[o]=c,n})));const i=n.getSegmentations(),s=t.run("calculateTMTV",{segmentations:i});o.cachedStats=Object.assign(o.cachedStats,r,{tmtv:{value:s.toFixed(3),config:{...a}}}),n.addOrUpdateSegmentation({...o},!1,!0)})({segmentationId:r,commandsManager:t,segmentationService:n});const i=n.getSegmentation(r),{cachedStats:s}=i;if(!s)return;const c=s?.[1]?.suvPeak?.suvPeak;Number.isNaN(c)&&a.show({title:"SUV Peak",message:"Segmented volume does not allow SUV Peak calculation",type:"warning"})};return $.eventTarget.addEventListenerDebounced(B.Enums.Events.SEGMENTATION_DATA_MODIFIED,e,250),()=>{$.eventTarget.removeEventListenerDebounced(B.Enums.Events.SEGMENTATION_DATA_MODIFIED,e)}}),[]),!s)return null;const l=s.cachedStats?.tmtv?.value||null,u=s.cachedStats?.tmtv?.config||{},p=[{label:"Export CSV",onClick:()=>{t.runCommand("exportTMTVReportCSV",{segmentations:r,tmtv:l,config:u})},disabled:null===l},{label:"Export RT Report",onClick:()=>{t.runCommand("createTMTVRTReport")},disabled:null===l}];return g.createElement(g.Fragment,null,g.createElement("div",{className:"mt-2 mb-10 flex flex-col"},g.createElement("div",{className:"invisible-scrollbar overflow-y-auto overflow-x-hidden"},null!==l?g.createElement("div",{className:"bg-secondary-dark flex items-baseline justify-between px-2 py-1"},g.createElement("span",{className:"text-base font-bold uppercase tracking-widest text-white"},"TMTV:"),g.createElement("div",{className:"text-white"},`${l} mL`)):null,g.createElement("div",{className:"mt-2 flex justify-center"},g.createElement(h.ActionButtons,{actions:p,t:o})))),g.createElement("div",{className:"absolute bottom-1 left-[50px] flex cursor-pointer items-center justify-center text-blue-400 opacity-50 hover:opacity-80",onClick:()=>{window.open("https://github.com/OHIF/Viewers/blob/master/modes/tmtv/README.md","_blank")}},g.createElement(h.Icon,{width:"15px",height:"15px",name:"info",className:"text-primary-active ml-4 mr-3"}),g.createElement("span",null,"User Guide")))}H.propTypes={commandsManager:y().shape({runCommand:y().func.isRequired}),servicesManager:y().shape({services:y().shape({segmentationService:y().shape({getSegmentation:y().func.isRequired,getSegmentations:y().func.isRequired,toggleSegmentationVisibility:y().func.isRequired,subscribe:y().func.isRequired,EVENTS:y().object.isRequired}).isRequired}).isRequired}).isRequired};const z=H,J=["RectangleROIStartEndThreshold"];const Y={toAnnotation:(e,t)=>{},toMeasurement:(e,t,n)=>{const{annotation:a,viewportId:o}=e,{metadata:r,data:i,annotationUID:s}=a;if(!r||!i)return console.warn("Length tool: Missing metadata or data"),null;const{toolName:c,referencedImageId:l,FrameOfReferenceUID:u}=r;if(!J.includes(c))throw new Error("Tool not supported");const{SOPInstanceUID:p,SeriesInstanceUID:m,StudyInstanceUID:d}=function(e){if(e)return function(e){const t=$.metaData.get("instance",e);return{SOPInstanceUID:t.SOPInstanceUID,SeriesInstanceUID:t.SeriesInstanceUID,StudyInstanceUID:t.StudyInstanceUID,frameNumber:t.frameNumber||1}}(e)}(l);let g;return g=p?t.getDisplaySetForSOPInstanceUID(p,m):t.getDisplaySetsForSeries(m),{uid:s,SOPInstanceUID:p,FrameOfReferenceUID:u,metadata:r,referenceSeriesUID:m,referenceStudyUID:d,toolName:r.toolName,displaySetInstanceUID:g.displaySetInstanceUID,label:r.label,data:i.cachedStats,type:"RectangleROIStartEndThreshold"}}};var K=l(155);function X(e,t){const{imageData:n}=e,a=n.getPointData().getScalars().getData(),{fn:o,baseValue:r}={fn:(e,t)=>(e>t&&(t=e),t),baseValue:-1/0};let i=r;const s=B.utilities.rectangleROITool.getBoundsIJKFromRectangleAnnotations(t,e),[[c,l],[u,p],[m,d]]=s;for(let e=c;e<=l;e++)for(let t=u;t<=p;t++)for(let r=m;r<=d;r++)i=o(a[n.computeOffsetIndex([e,t,r])],i);return i}var Z=l(111),Q=l.n(Z),ee=l(142);const{datasetToBlob:te}=Q().data,ne=v.classes.MetadataProvider,ae=v.classes.MetadataProvider,oe=["RectangleROIStartEndThreshold","RectangleROIThreshold"],re=B.Enums.SegmentationRepresentations.Labelmap,ie=(0,$.getWebWorkerManager)(),se={maxWorkerInstances:1,autoTerminateOnIdle:{enabled:!0,idleTimeThreshold:3e3}},ce=()=>new Worker(new URL(l.p+l.u(584),l.b),{name:"suv-peak-worker"}),le=({servicesManager:e,commandsManager:t,extensionManager:n})=>{const{viewportGridService:a,uiNotificationService:o,displaySetService:r,hangingProtocolService:i,toolGroupService:s,cornerstoneViewportService:c,segmentationService:l}=e.services,u=n.getModuleEntry("@ohif/extension-cornerstone.utilityModule.common"),{getEnabledElement:p}=u.exports;function m(){const{activeViewportId:e}=a.getState(),{element:t}=p(e)||{};return $.getEnabledElement(t)}function d(){const{viewportMatchDetails:e}=i.getMatchDetails(),t=[];return e.forEach((e=>{const{viewportOptions:n}=e,{toolGroupId:a}=n;-1===t.indexOf(a)&&t.push(a)})),t}function g(e){return e.reduce(((e,t)=>{const n=B.annotation.selection.getAnnotationsSelectedByToolName(t);return e.concat(n)}),[])}const f={getMatchingPTDisplaySet:({viewportMatchDetails:e})=>{let t=null;for(const[n,a]of e){const{displaySetsInfo:e}=a,n=e.map((({displaySetInstanceUID:e})=>r.getDisplaySetByUID(e)));if(n&&0!==n.length&&(t=n.find((e=>"PT"===e.Modality)),t))break}return t},getPTMetadata:({ptDisplaySet:e})=>{const t=n.getDataSources()[0].getImageIdsForDisplaySet(e)[0],a=ae.get("instance",t);if("PT"===a.Modality)return{SeriesTime:a.SeriesTime,Modality:a.Modality,PatientSex:a.PatientSex,PatientWeight:a.PatientWeight,RadiopharmaceuticalInformationSequence:{RadionuclideTotalDose:a.RadiopharmaceuticalInformationSequence[0].RadionuclideTotalDose,RadionuclideHalfLife:a.RadiopharmaceuticalInformationSequence[0].RadionuclideHalfLife,RadiopharmaceuticalStartTime:a.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartTime,RadiopharmaceuticalStartDateTime:a.RadiopharmaceuticalInformationSequence[0].RadiopharmaceuticalStartDateTime}}},createNewLabelmapFromPT:async({label:e})=>{const{viewportMatchDetails:t}=i.getMatchDetails(),n=f.getMatchingPTDisplaySet({viewportMatchDetails:t});if(!n)return void o.error("No matching PT display set found");const a=l.getSegmentations(),r=await l.createSegmentationForDisplaySet(n.displaySetInstanceUID,{label:`Segmentation ${a.length+1}`}),s=d(),c=re;for(const e of s){const t=!0;await l.addSegmentationRepresentationToToolGroup(e,r,t,c),l.setActiveSegmentationForToolGroup(r,e)}return l.addSegment(r,{segmentIndex:1,properties:{label:"Segment 1"}}),r},setSegmentationActiveForToolGroups:({segmentationId:e})=>{d().forEach((t=>{l.setActiveSegmentationForToolGroup(e,t)}))},thresholdSegmentationByRectangleROITool:({segmentationId:e,config:t,segmentIndex:n})=>{const r=B.segmentation.state.getSegmentation(e),{representationData:s}=r,{displaySetMatchDetails:c}=i.getMatchDetails(),l=`cornerstoneStreamingImageVolume:${c.get("ctDisplaySet").displaySetInstanceUID}`,{volumeId:u}=s[re],{referencedVolumeId:p}=$.cache.getVolume(u),m=g(oe);if(0===m.length)return void o.show({title:"Commands Module",message:"No ROIThreshold Tool is Selected",type:"error"});const d=$.cache.getVolume(e);let f=$.cache.getVolume(p);const y=$.cache.getVolume(l);if(!f)throw new Error("No Reference volume found");if(!d)throw new Error("No Reference labelmap found");const h=B.annotation.state.getAnnotation(m[0]),{metadata:{enabledElement:{viewport:v}}}=h;v.hasVolumeId(p)||a.getDisplaySetsUIDsForViewport(v.id).forEach((e=>{const t=$.cache.getVolumes().find((t=>t.volumeId.includes(e)));$.utilities.isEqual(t.dimensions,d.dimensions)&&$.utilities.isEqual(t.spacing,d.spacing)&&(f=t)}));const{ptLower:S,ptUpper:b,ctLower:T,ctUpper:w}=function(e,t,n){if("range"===n.strategy)return{ptLower:Number(n.ptLower),ptUpper:Number(n.ptUpper),ctLower:Number(n.ctLower),ctUpper:Number(n.ctUpper)};const{weight:a}=n,o=e.map((e=>B.annotation.state.getAnnotation(e)));return{ctLower:-1/0,ctUpper:1/0,ptLower:a*X(t[0],o),ptUpper:1/0}}(m,[f,y],t);return B.utilities.segmentation.rectangleROIThresholdVolumeByRange(m,d,[{volume:f,lower:S,upper:b},{volume:y,lower:T,upper:w}],{overwrite:!0,segmentIndex:n})},calculateSuvPeak:async({labelmap:e,segmentIndex:t})=>{ie.registerWorker("suv-peak-worker",ce,se);const{referencedVolumeId:n}=e,a=$.cache.getVolume(n),o=g(oe).map((e=>B.annotation.state.getAnnotation(e))),r={dimensions:e.dimensions,origin:e.origin,direction:e.direction,spacing:e.spacing,scalarData:e.scalarData,metadata:e.metadata},i={dimensions:a.dimensions,origin:a.origin,direction:a.direction,spacing:a.spacing,scalarData:a.scalarData,metadata:a.metadata},s=o.map((e=>({...e,metadata:{...e.metadata,enabledElement:{...e.metadata.enabledElement,viewport:null,renderingEngine:null,element:null}}}))),c=await ie.executeTask("suv-peak-worker","calculateSuvPeak",{labelmapProps:r,referenceVolumeProps:i,annotations:s,segmentIndex:t});return{suvPeak:c.mean,suvMax:c.max,suvMaxIJK:c.maxIJK,suvMaxLPS:c.maxLPS}},getLesionStats:({labelmap:e,segmentIndex:t=1})=>{const{scalarData:n,spacing:a}=e,o=$.cache.getVolume(e.referencedVolumeId).getScalarData();let r=-1/0,i=1/0,s=[],c=0;for(let e=0;e<n.length;e++)if(n[e]===t){const t=o[e];s.push(t),t>r&&(r=t),t<i&&(i=t),c++}const l={minValue:i,maxValue:r,meanValue:s.reduce(((e,t)=>e+t),0)/c,stdValue:Math.sqrt(s.reduce(((e,t)=>e+t*t),0)/c-s.reduce(((e,t)=>e+t),0)/c**2),volume:c*a[0]*a[1]*a[2]*.001};return l},calculateLesionGlycolysis:({lesionStats:e})=>{const{meanValue:t,volume:n}=e;return{lesionGlyoclysisStats:n*t}},calculateTMTV:({segmentations:e})=>{const t=e.map((e=>l.getLabelmapVolume(e.id)));if(t.length)return function(e,t=1){const n=B.utilities.segmentation.createMergedLabelmapForIndex(e,t,"mergedLabelmap"),{imageData:a,spacing:o}=n;return.001*a.getPointData().getScalars().getData().reduce(((e,t)=>t>0?e+1:e),0)*o[0]*o[1]*o[2]}(t)},exportTMTVReportCSV:({segmentations:e,tmtv:n,config:a,options:o})=>{const r=t.runCommand("getSegmentationCSVReport",{segmentations:e}),i=[{key:"Total Lesion Glycolysis",value:{tlg:f.getTotalLesionGlycolysis({segmentations:e}).toFixed(4)}},{key:"Threshold Configuration",value:{...a}}];void 0!==n&&i.unshift({key:"Total Metabolic Tumor Volume",value:{tmtv:n}}),function(e,t,n={}){const a=e[Object.keys(e)[0]],o=Object.keys(a),r=[o.join(",")];Object.values(e).forEach((e=>{const t=[];o.forEach((n=>{t.push(Array.isArray(e[n])?e[n].join(" "):e[n])})),r.push(t.join(","))})),r.push(""),r.push(""),r.push(""),r.push(`Patient ID,${a.PatientID}`),r.push(`Study Date,${a.StudyDate}`),r.push(""),t.forEach((({key:e,value:t})=>{const n=[];n.push(`${e}`),Object.keys(t).forEach((e=>{n.push(`${e}`),n.push(`${t[e]}`)})),r.push(n.join(","))}));const i=new Blob([r.join("\n")],{type:"text/csv;charset=utf-8"}),s=URL.createObjectURL(i),c=document.createElement("a");c.href=s,c.download=n.filename??`${a.PatientID}_tmtv.csv`,c.click()}(r,i,o)},getTotalLesionGlycolysis:({segmentations:e})=>{const t=e.map((e=>l.getLabelmapVolume(e.id)));let n;try{n=B.utilities.segmentation.createMergedLabelmapForIndex(t)}catch(e){return void console.error("commandsModule::getTotalLesionGlycolysis",e)}const{referencedVolumeId:a,spacing:o}=t[0];a||console.error("commandsModule::getTotalLesionGlycolysis:No referencedVolumeId found");const r=$.cache.getVolume(a),i=n.getScalarData();i.length!==r.getScalarData().length&&console.error("commandsModule::getTotalLesionGlycolysis:Labelmap and ptVolume are not the same size");let s=0,c=0;for(let e=0;e<i.length;e++)0!==i[e]&&(s+=r.getScalarData()[e],c+=1);return s/c*c*o[0]*o[1]*o[2]*.001},setStartSliceForROIThresholdTool:()=>{const{viewport:e}=m(),{focalPoint:t,viewPlaneNormal:n}=e.getCamera(),a=g(oe)[0],o=B.annotation.state.getAnnotation(a),{handles:r}=o.data,{points:i}=r,s=e.getCurrentImageIdIndex();o.data.startSlice=s;const c=i.map((e=>{const a=K.vec3.create();K.vec3.subtract(a,t,e);const o=K.vec3.dot(a,n),r=K.vec3.create();return K.vec3.scaleAndAdd(r,e,n,o),r}));r.points=c,o.invalidated=!0,e.render()},setEndSliceForROIThresholdTool:()=>{const{viewport:e}=m(),t=g(oe)[0],n=B.annotation.state.getAnnotation(t),a=e.getCurrentImageIdIndex();n.data.endSlice=a,n.invalidated=!0,e.render()},createTMTVRTReport:()=>{const e=B.annotation.state.getAnnotationManager(),n=[];Object.keys(e.annotations).forEach((t=>{const a=e.annotations[t],o=oe.reduce(((e,t)=>[...e,...a[t]??[]]),[]);n.push(...o)})),t.runCommand("exportRTReportForAnnotations",{annotations:n})},getSegmentationCSVReport:({segmentations:e})=>{e&&e.length||(e=l.getSegmentations());let t={};for(const n of e){const{id:e,label:a,cachedStats:o}=n,r={id:e,label:a};if(!o){t[e]=r;continue}Object.keys(o).forEach((e=>{"object"!=typeof o[e]?r[e]=o[e]:Object.keys(o[e]).forEach((t=>{r[`${e}_${t}`]=o[e][t]}))}));const i=l.getLabelmapVolume(e);if(!i){t[e]=r;continue}const s=i.referencedVolumeId;r.referencedVolumeId=s;const c=l.getLabelmapVolume(s);if(!c){t[e]=r;continue}if(!c.imageIds||!c.imageIds.length){t[e]=r;continue}const u=c.imageIds[0],p=S().classes.MetadataProvider.get("instance",u);t[e]=p?{...r,PatientID:p.PatientID??"000000",PatientName:p.PatientName.Alphabetic,StudyInstanceUID:p.StudyInstanceUID,SeriesInstanceUID:p.SeriesInstanceUID,StudyDate:p.StudyDate}:r}return t},exportRTReportForAnnotations:({annotations:e})=>{!function(e){const t=ee.adaptersRT.Cornerstone3D.RTSS.generateRTSSFromAnnotations(e,ne,v.DicomMetadataStore),n=te(t);var a=URL.createObjectURL(n);window.location.assign(a)}(e)},setFusionPTColormap:({toolGroupId:e,colormap:n})=>{const a=s.getToolGroup(e),{viewportMatchDetails:o}=i.getMatchDetails(),r=f.getMatchingPTDisplaySet({viewportMatchDetails:o});if(!r)return;const l=a.getViewportIds();let u=[];l.forEach((e=>{t.runCommand("setViewportColormap",{viewportId:e,displaySetInstanceUID:r.displaySetInstanceUID,colormap:{name:n}}),u.push(c.getCornerstoneViewport(e))})),u.forEach((e=>{e.render()}))}},y={setEndSliceForROIThresholdTool:{commandFn:f.setEndSliceForROIThresholdTool},setStartSliceForROIThresholdTool:{commandFn:f.setStartSliceForROIThresholdTool},getMatchingPTDisplaySet:{commandFn:f.getMatchingPTDisplaySet},getPTMetadata:{commandFn:f.getPTMetadata},createNewLabelmapFromPT:{commandFn:f.createNewLabelmapFromPT},setSegmentationActiveForToolGroups:{commandFn:f.setSegmentationActiveForToolGroups},thresholdSegmentationByRectangleROITool:{commandFn:f.thresholdSegmentationByRectangleROITool},getTotalLesionGlycolysis:{commandFn:f.getTotalLesionGlycolysis},calculateSuvPeak:{commandFn:f.calculateSuvPeak},getLesionStats:{commandFn:f.getLesionStats},calculateTMTV:{commandFn:f.calculateTMTV},exportTMTVReportCSV:{commandFn:f.exportTMTVReportCSV},createTMTVRTReport:{commandFn:f.createTMTVRTReport},getSegmentationCSVReport:{commandFn:f.getSegmentationCSVReport},exportRTReportForAnnotations:{commandFn:f.exportRTReportForAnnotations},setFusionPTColormap:{commandFn:f.setFusionPTColormap}};return{actions:f,definitions:y,defaultContext:"TMTV:CORNERSTONE"}},ue="roi_stat",pe=[{value:ue,label:"Max",placeHolder:"Max"},{value:"range",label:"Range",placeHolder:"Range"}],me=function({config:e,dispatch:t,runCommand:n}){const{t:a}=q("ROIThresholdConfiguration");return g.createElement("div",{className:"bg-primary-dark flex flex-col space-y-4"},g.createElement("div",{className:"flex items-end space-x-2"},g.createElement("div",{className:"flex w-1/2 flex-col"},g.createElement(h.Select,{label:a("Strategy"),closeMenuOnSelect:!0,className:"border-primary-main mr-2 bg-black text-white ",options:pe,placeholder:pe.find((t=>t.value===e.strategy)).placeHolder,value:e.strategy,onChange:({value:e})=>{t({type:"setStrategy",payload:{strategy:e}})}})),g.createElement("div",{className:"w-1/2"},g.createElement(h.LegacyButtonGroup,null,g.createElement(h.LegacyButton,{size:"initial",className:"px-2 py-2 text-base text-white",color:"primaryLight",variant:"outlined",onClick:()=>n("setStartSliceForROIThresholdTool")},a("Start")),g.createElement(h.LegacyButton,{size:"initial",color:"primaryLight",variant:"outlined",className:"px-2 py-2 text-base text-white",onClick:()=>n("setEndSliceForROIThresholdTool")},a("End"))))),e.strategy===ue&&g.createElement(h.Input,{label:a("Percentage of Max SUV"),labelClassName:"text-[13px] font-inter text-white",className:"border-primary-main bg-black",type:"text",containerClassName:"mr-2",value:e.weight,onChange:e=>{t({type:"setWeight",payload:{weight:e.target.value}})}}),e.strategy!==ue&&g.createElement("div",{className:"mr-2 text-sm"},g.createElement("table",null,g.createElement("tbody",null,g.createElement("tr",{className:"mt-2"},g.createElement("td",{className:"pr-4",colSpan:"3"},g.createElement(h.Label,{className:"font-inter text-[13px] text-white",text:"Lower & Upper Ranges"}))),g.createElement("tr",{className:"mt-2"},g.createElement("td",{className:"pr-4 pt-2 text-center"},g.createElement(h.Label,{className:"text-white",text:"CT"})),g.createElement("td",null,g.createElement("div",{className:"flex justify-between"},g.createElement(h.Input,{label:a(""),labelClassName:"text-white",className:"border-primary-main mt-2 bg-black",type:"text",containerClassName:"mr-2",value:e.ctLower,onChange:e=>{t({type:"setThreshold",payload:{ctLower:e.target.value}})}}),g.createElement(h.Input,{label:a(""),labelClassName:"text-white",className:"border-primary-main mt-2 bg-black",type:"text",containerClassName:"mr-2",value:e.ctUpper,onChange:e=>{t({type:"setThreshold",payload:{ctUpper:e.target.value}})}})))),g.createElement("tr",null,g.createElement("td",{className:"pr-4 pt-2 text-center"},g.createElement(h.Label,{className:"text-white",text:"PT"})),g.createElement("td",null,g.createElement("div",{className:"flex justify-between"},g.createElement(h.Input,{label:a(""),labelClassName:"text-white",className:"border-primary-main mt-2 bg-black",type:"text",containerClassName:"mr-2",value:e.ptLower,onChange:e=>{t({type:"setThreshold",payload:{ptLower:e.target.value}})}}),g.createElement(h.Input,{label:a(""),labelClassName:"text-white",className:"border-primary-main mt-2 bg-black",type:"text",containerClassName:"mr-2",value:e.ptUpper,onChange:e=>{t({type:"setThreshold",payload:{ptUpper:e.target.value}})}}))))))))},de=ue;function ge(e,t){const{payload:n}=t,{strategy:a,ctLower:o,ctUpper:r,ptLower:i,ptUpper:s,weight:c}=n;switch(t.type){case"setStrategy":return{...e,strategy:a};case"setThreshold":return{...e,ctLower:o||e.ctLower,ctUpper:r||e.ctUpper,ptLower:i||e.ptLower,ptUpper:s||e.ptUpper};case"setWeight":return{...e,weight:c};default:return e}}const fe={id:e,preRegistration({servicesManager:e,commandsManager:t,extensionManager:n,configuration:a={}}){!function({servicesManager:e}){const{measurementService:t,displaySetService:n,cornerstoneViewportService:a}=e.services;(0,B.addTool)(B.RectangleROIStartEndThresholdTool);const{RectangleROIStartEndThreshold:o}=((e,t,n)=>({RectangleROIStartEndThreshold:{toAnnotation:Y.toAnnotation,toMeasurement:e=>Y.toMeasurement(e,t,n),matchingCriteria:[{valueType:e.VALUE_TYPES.ROI_THRESHOLD_MANUAL}]}}))(t,n,a),r=t.getSource("Cornerstone3DTools","0.1");t.addMapping(r,"RectangleROIStartEndThreshold",o.matchingCriteria,o.toAnnotation,o.toMeasurement)}({servicesManager:e,commandsManager:t,extensionManager:n,configuration:a})},getToolbarModule:function({commandsManager:e,servicesManager:t}){return[{name:"tmtv.RectangleROIThresholdOptions",defaultComponent:()=>function({servicesManager:e,commandsManager:t}){const{segmentationService:n}=e.services,[a,o]=(0,g.useState)(null),r=(0,g.useCallback)(((e,n={})=>t.runCommand(e,n)),[t]),[i,s]=(0,g.useReducer)(ge,{strategy:de,ctLower:-1024,ctUpper:1024,ptLower:2.5,ptUpper:100,weight:.41}),c=(0,g.useCallback)((()=>{const e=a,t=B.segmentation.segmentIndex.getActiveSegmentIndex(e);r("thresholdSegmentationByRectangleROITool",{segmentationId:e,config:i,segmentIndex:t})}),[a,i]);return(0,g.useEffect)((()=>{const e=n.getSegmentations();if(!e.length)return;const t=e.find((e=>e.isActive));o(t.id)}),[]),(0,g.useEffect)((()=>{const e=n.EVENTS.SEGMENTATION_ADDED,t=n.EVENTS.SEGMENTATION_UPDATED,a=[];return[e,t].forEach((e=>{const{unsubscribe:t}=n.subscribe(e,(()=>{const e=n.getSegmentations();if(!e.length)return;const t=e.find((e=>e.isActive));o(t.id)}));a.push(t)})),()=>{a.forEach((e=>{e()}))}}),[]),g.createElement("div",{className:"invisible-scrollbar mb-2 flex flex-col overflow-y-auto overflow-x-hidden"},g.createElement(me,{config:i,dispatch:s,runCommand:r}),null!==a&&g.createElement(h.Button,{className:"mt-2 !h-[26px] !w-[75px]",onClick:c},"Run"))}({commandsManager:e,servicesManager:t})}]},getPanelModule:function({commandsManager:e,extensionManager:t,servicesManager:n}){return[{name:"petSUV",iconName:"tab-patient-info",iconLabel:"Patient Info",label:"Patient Info",component:()=>g.createElement(W,{commandsManager:e,servicesManager:n})},{name:"tmtvBox",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation Toolbox",component:()=>g.createElement(g.Fragment,null,g.createElement(h.Toolbox,{commandsManager:e,servicesManager:n,extensionManager:t,buttonSectionId:"ROIThresholdToolbox",title:"Threshold Tools"}))},{name:"tmtvExport",iconName:"tab-segmentation",iconLabel:"Segmentation",label:"Segmentation Export",component:()=>g.createElement(g.Fragment,null,g.createElement(z,{commandsManager:e,servicesManager:n}))}]},getHangingProtocolModule:function(){return[{name:d.id,protocol:d}]},getCommandsModule:({servicesManager:e,commandsManager:t,extensionManager:n})=>le({servicesManager:e,commandsManager:t,extensionManager:n})},ye=fe})(),u})()));